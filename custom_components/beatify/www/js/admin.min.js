(()=>{var Y=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var f=(e,t,n)=>new Promise((a,s)=>{var i=l=>{try{o(n.next(l))}catch(d){s(d)}},r=l=>{try{o(n.throw(l))}catch(d){s(d)}},o=l=>l.done?a(l.value):Promise.resolve(l.value).then(i,r);o((n=n.apply(e,t)).next())});var ke=Y(V=>{let m=[],b=[],C="",g=null,v="",_="setup",y=null,M=null,E="en",x=45,j="normal",p="spotify",T=!1,B=[],I=null;const $=["media-players","playlists","provider-section","language-section","timer-section","difficulty-section"];function Z(e=3e3,t=50){return f(this,null,function*(){const n=Date.now();for(;typeof BeatifyI18n=="undefined";){if(Date.now()-n>e)return!1;yield new Promise(a=>setTimeout(a,t))}return!0})}document.addEventListener("DOMContentLoaded",()=>f(V,null,function*(){var a,s,i,r,o;(yield Z())?(yield BeatifyI18n.init(),BeatifyI18n.initPageTranslations(),E=BeatifyI18n.getLanguage()):console.error("[Beatify] BeatifyI18n module failed to load - UI will use fallback text"),U(E),(a=document.getElementById("start-game"))==null||a.addEventListener("click",se),(s=document.getElementById("print-qr"))==null||s.addEventListener("click",ce),(i=document.getElementById("rejoin-game"))==null||i.addEventListener("click",re);var t=window.location.origin+"/beatify/dashboard",n=document.getElementById("admin-dashboard-url");n&&(n.textContent=t,n.href=t),(r=document.getElementById("end-game"))==null||r.addEventListener("click",H),(o=document.getElementById("end-game-lobby"))==null||o.addEventListener("click",H),me(),le(),fe(),ge(),be(),Be(),yield K()}));function K(){return f(this,null,function*(){try{const e=yield fetch("/beatify/api/status");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=yield e.json();C=t.playlist_docs_url||"",v=t.media_player_docs_url||"",T=t.has_music_assistant===!0,ee(t.media_players),we(),D(t.playlists,t.playlist_dir),k(),t.active_game?ie(t.active_game):N()}catch(e){console.error("Failed to load status:",e);const t=document.getElementById("media-players-list");t&&(t.innerHTML='<span class="status-error">Failed to load status</span>')}})}function ee(e){const t=document.getElementById("media-players-list");t==null||t.removeAttribute("data-i18n");const n=e?e.length:0;g=null;const a=(e||[]).filter(i=>i.state!=="unavailable"),s=document.getElementById("media-player-validation-msg");if(n===0){const i=v?`<a href="${c(v)}" target="_blank" rel="noopener">Setup Guide</a>`:"";t.innerHTML=`
            <div class="empty-state">
                <p class="status-error">No media players found. Configure a media player in Home Assistant.</p>
                ${i?`<p style="margin-top: 12px;">${i}</p>`:""}
            </div>
        `,s&&s.classList.add("hidden");return}if(a.length===0){const i=v?`<a href="${c(v)}" target="_blank" rel="noopener">Troubleshooting</a>`:"";t.innerHTML=`
            <div class="empty-state">
                <p class="status-error">All media players are unavailable. Check your devices are powered on.</p>
                ${i?`<p style="margin-top: 12px;">${i}</p>`:""}
            </div>
        `,s&&s.classList.add("hidden");return}t.innerHTML=a.map(i=>{const r=i.is_mass?'<span class="mass-badge" title="Music Assistant - Apple Music enabled">Music Assistant</span>':"";return`
        <div class="media-player-item list-item is-selectable${i.is_mass?" is-mass-player":""}">
            <label class="radio-label">
                <input type="radio"
                       class="media-player-radio"
                       name="media-player"
                       data-entity-id="${c(i.entity_id)}"
                       data-state="${c(i.state)}"
                       data-is-mass="${i.is_mass?"true":"false"}">
                <span class="player-name">${c(i.friendly_name)}${r}</span>
            </label>
            <span class="meta">
                <span class="state-dot state-${c(i.state)}"></span>
                ${c(i.state)}
            </span>
        </div>
    `}).join(""),t.querySelectorAll(".media-player-radio").forEach(i=>{i.addEventListener("change",function(){te(this)})})}function te(e){const t=e.dataset.entityId,n=e.dataset.state;g={entityId:t,state:n},document.querySelectorAll(".media-player-item").forEach(a=>{a.classList.remove("is-selected")}),e.closest(".media-player-item").classList.add("is-selected"),k()}function D(e,t){var s,i,r;const n=document.getElementById("playlists-list");n==null||n.removeAttribute("data-i18n"),m=[],b=e||[];const a=b.some(o=>o.is_valid);if(!e||e.length===0){const o=C?`<a href="${c(C)}" target="_blank" rel="noopener">How to create playlists</a>`:"";n.innerHTML=`
            <div class="empty-state">
                <p class="status-error">No playlists found. Add playlist JSON files to:</p>
                <p style="font-size: 14px;"><code>${c(t)}</code></p>
                ${o?`<p style="margin-top: 12px;">${o}</p>`:""}
            </div>
        `,(s=document.getElementById("start-game"))==null||s.classList.add("hidden");return}n.innerHTML=e.map(o=>{if(o.is_valid){const l=o.song_count||0,d=p==="apple_music"?o.apple_music_count||0:o.spotify_count||l;let u="";return d<l&&(u=`<span class="${d===0?"playlist-coverage playlist-coverage--none":"playlist-coverage playlist-coverage--warning"}">${d}/${l}</span>`),`
                <div class="playlist-item list-item is-selectable">
                    <label class="checkbox-label">
                        <input type="checkbox"
                               class="playlist-checkbox"
                               data-path="${c(o.path)}"
                               data-song-count="${c(String(l))}">
                        <span class="playlist-name">${c(o.name)}</span>
                    </label>
                    <span class="meta">${u||c(String(l))} songs</span>
                </div>
            `}else{const l=o.errors&&o.errors[0]||"Unknown error";return`
                <div class="list-item is-invalid">
                    <span class="name">${c(o.name)}</span>
                    <span class="meta">Invalid: ${c(l)}</span>
                </div>
            `}}).join(""),n.querySelectorAll(".playlist-checkbox").forEach(o=>{o.addEventListener("change",function(){ne(this)})}),a?(i=document.getElementById("start-game"))==null||i.classList.remove("hidden"):(r=document.getElementById("start-game"))==null||r.classList.add("hidden"),G()}function ne(e){const t=e.dataset.path,n=parseInt(e.dataset.songCount,10)||0,a=e.closest(".playlist-item");e.checked?(m.some(s=>s.path===t)||m.push({path:t,songCount:n}),a.classList.add("is-selected")):(m=m.filter(s=>s.path!==t),a.classList.remove("is-selected")),G(),k()}function ae(){return m.reduce((e,t)=>e+t.songCount,0)}function G(){const e=document.getElementById("playlist-summary"),t=document.getElementById("selected-count"),n=document.getElementById("total-songs");!e||!t||!n||(m.length===0?e.classList.add("hidden"):(e.classList.remove("hidden"),t.textContent=m.length,n.textContent=ae()))}function k(){const e=document.getElementById("start-game"),t=document.getElementById("playlist-validation-msg"),n=document.getElementById("media-player-validation-msg");if(!e)return;const a=m.length===0,s=g===null;e.disabled=a||s,t&&t.classList.toggle("hidden",!a),n&&n.classList.toggle("hidden",!s)}function c(e){if(e==null)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}function N(){var t,n,a;_="setup",y=null,P(),B=[],$.forEach(s=>{const i=document.getElementById(s);i&&i.classList.remove("hidden")}),b.some(s=>s.is_valid)&&((t=document.getElementById("start-game"))==null||t.classList.remove("hidden")),(n=document.getElementById("lobby-section"))==null||n.classList.add("hidden"),(a=document.getElementById("existing-game-section"))==null||a.classList.add("hidden")}function J(e){var a,s,i,r;_="lobby",y=e,$.forEach(o=>{const l=document.getElementById(o);l&&l.classList.add("hidden")}),(a=document.getElementById("start-game"))==null||a.classList.add("hidden"),(s=document.getElementById("playlist-validation-msg"))==null||s.classList.add("hidden"),(i=document.getElementById("existing-game-section"))==null||i.classList.add("hidden"),(r=document.getElementById("lobby-section"))==null||r.classList.remove("hidden");const t=document.getElementById("qr-code");t&&e.join_url&&M!==e.join_url&&(t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:e.join_url,width:300,height:300,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',M=e.join_url);const n=document.getElementById("join-url");n&&e.join_url&&(n.textContent=e.join_url),F(e.players||[]),_e()}function ie(e){var s,i,r,o,l;_="existing-game",y=e,$.forEach(d=>{const u=document.getElementById(d);u&&u.classList.add("hidden")}),(s=document.getElementById("start-game"))==null||s.classList.add("hidden"),(i=document.getElementById("playlist-validation-msg"))==null||i.classList.add("hidden"),(r=document.getElementById("lobby-section"))==null||r.classList.add("hidden"),(o=document.getElementById("existing-game-section"))==null||o.classList.remove("hidden");const t=document.getElementById("existing-game-id"),n=document.getElementById("existing-game-phase"),a=document.getElementById("existing-game-players");t&&(t.textContent=e.game_id||"Unknown"),n&&(n.textContent=e.phase||"Unknown"),a&&(a.textContent=(l=e.player_count)!=null?l:0)}function se(){return f(this,null,function*(){const e=document.getElementById("start-game");if(!e||e.disabled)return;e.disabled=!0;const t=e.textContent;e.textContent="Starting...";try{const n=yield fetch("/beatify/api/start-game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playlists:m.map(s=>s.path),media_player:g==null?void 0:g.entityId,language:E,round_duration:x,difficulty:j,provider:p})}),a=yield n.json();if(!n.ok){L(a.message||"Failed to start game");return}a.warnings&&a.warnings.length>0&&console.warn("Game started with warnings:",a.warnings),J(a)}catch(n){L("Network error. Please try again."),console.error("Start game error:",n)}finally{e.disabled=!1,e.textContent=t,k()}})}function oe(){const e=document.getElementById("end-game-modal");e&&e.classList.remove("hidden")}function w(){const e=document.getElementById("end-game-modal");e&&e.classList.add("hidden")}function H(){oe()}function de(){return f(this,null,function*(){w();try{const e=yield fetch("/beatify/api/end-game",{method:"POST"});if(e.ok)M=null,N();else{const t=yield e.json();L(t.message||"Failed to end game")}}catch(e){console.error("End game error:",e),L("Network error. Please try again.")}})}function le(){const e=document.getElementById("end-game-confirm-btn"),t=document.getElementById("end-game-cancel-btn"),n=document.querySelector("#end-game-modal .modal-backdrop");e==null||e.addEventListener("click",de),t==null||t.addEventListener("click",w),n==null||n.addEventListener("click",w)}function re(){return f(this,null,function*(){if(y){try{var e=yield fetch("/beatify/api/status");if(e.ok){var t=yield e.json();t.active_game&&(y=t.active_game)}}catch(n){console.error("Failed to refresh game status:",n)}J(y)}})}function ce(){window.print()}function L(e){alert(e)}function ue(){var t;const e=document.getElementById("admin-join-modal");e&&(e.classList.remove("hidden"),(t=document.getElementById("admin-name-input"))==null||t.focus())}function S(){const e=document.getElementById("admin-join-modal");e&&e.classList.add("hidden");const t=document.getElementById("admin-name-input"),n=document.getElementById("admin-join-btn"),a=document.getElementById("admin-name-error");t&&(t.value=""),n&&(n.disabled=!0,n.textContent="Join"),a&&a.classList.add("hidden")}function me(){const e=document.getElementById("participate-btn"),t=document.getElementById("admin-cancel-btn"),n=document.getElementById("admin-join-btn"),a=document.getElementById("admin-name-input"),s=document.querySelector("#admin-join-modal .modal-backdrop");e==null||e.addEventListener("click",ue),t==null||t.addEventListener("click",S),s==null||s.addEventListener("click",S),a==null||a.addEventListener("input",function(){const i=this.value.trim();n.disabled=!i||i.length>20}),a==null||a.addEventListener("keypress",function(i){i.key==="Enter"&&!n.disabled&&q()}),n==null||n.addEventListener("click",q),document.addEventListener("keydown",function(i){if(i.key==="Escape"){const r=document.getElementById("admin-join-modal"),o=document.getElementById("end-game-modal");r&&!r.classList.contains("hidden")&&S(),o&&!o.classList.contains("hidden")&&w()}})}function q(){const e=document.getElementById("admin-name-input"),t=document.getElementById("admin-join-btn"),n=e==null?void 0:e.value.trim();if(n){t.disabled=!0,t.textContent="Joining...";try{sessionStorage.setItem("beatify_admin_name",n),sessionStorage.setItem("beatify_is_admin","true");const a=y==null?void 0:y.game_id;a?window.location.href="/beatify/play?game="+encodeURIComponent(a):(L("No active game found"),t.disabled=!1,t.textContent="Join")}catch(a){console.error("Admin join failed:",a),t.disabled=!1,t.textContent="Join"}}}function fe(){var e=document.querySelectorAll(".lang-btn");e.forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-lang");n&&n!==E&&ye(n)})})}function U(e){var t=document.querySelectorAll(".lang-btn");t.forEach(function(n){var a=n.getAttribute("data-lang");a===e?n.classList.add("lang-btn--active"):n.classList.remove("lang-btn--active")})}function ye(e){return f(this,null,function*(){e!=="en"&&e!=="de"&&e!=="es"&&(e="en"),E=e,U(e),yield BeatifyI18n.setLanguage(e),BeatifyI18n.initPageTranslations()})}function ge(){var e=document.querySelectorAll(".timer-btn");e.forEach(function(t){t.addEventListener("click",function(){var n=parseInt(t.getAttribute("data-duration"),10);n&&n!==x&&ve(n)})})}function pe(e){var t=document.querySelectorAll(".timer-btn");t.forEach(function(n){var a=parseInt(n.getAttribute("data-duration"),10);a===e?n.classList.add("timer-btn--active"):n.classList.remove("timer-btn--active")})}function ve(e){(typeof e!="number"||e<10||e>60)&&(e=30),x=e,pe(e)}const he={easy:"admin.difficultyEasyDesc",normal:"admin.difficultyNormalDesc",hard:"admin.difficultyHardDesc"};function be(){var e=document.querySelectorAll(".difficulty-btn");e.forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-difficulty");n&&n!==j&&Le(n)})})}function Ee(e){var t=document.querySelectorAll(".difficulty-btn");t.forEach(function(n){var a=n.getAttribute("data-difficulty");a===e?n.classList.add("difficulty-btn--active"):n.classList.remove("difficulty-btn--active")})}function Le(e){var t=["easy","normal","hard"];t.indexOf(e)===-1&&(e="normal"),j=e,Ee(e);var n=document.getElementById("difficulty-description");if(n){var a=he[e];n.setAttribute("data-i18n",a),typeof BeatifyI18n!="undefined"&&BeatifyI18n.t&&(n.textContent=BeatifyI18n.t(a))}}function Be(){var e=document.querySelectorAll(".provider-btn");e.forEach(function(t){t.addEventListener("click",function(){if(!t.classList.contains("provider-btn--disabled")){var n=t.getAttribute("data-provider");n&&n!==p&&O(n)}})})}function Ie(e){var t=document.querySelectorAll(".provider-btn");t.forEach(function(n){var a=n.getAttribute("data-provider");a===e?n.classList.add("provider-btn--active"):n.classList.remove("provider-btn--active")})}function O(e){var t=["spotify","apple_music"];t.indexOf(e)===-1&&(e="spotify"),p=e,Ie(e),R(),b.length>0&&D(b,"")}function we(){var e=document.querySelector('.provider-btn[data-provider="apple_music"]');e&&(T?(e.classList.remove("provider-btn--disabled"),e.removeAttribute("disabled"),e.removeAttribute("aria-disabled")):(e.classList.add("provider-btn--disabled"),e.setAttribute("disabled","disabled"),e.setAttribute("aria-disabled","true"),p==="apple_music"&&O("spotify")),R())}function R(){var e=document.getElementById("provider-help-link");if(e){var t="https://github.com/markusholzhaeuser/beatify/blob/main/docs/apple-music-setup.md";if(p==="apple_music")if(T){var n=h("admin.appleSetupLink","How to set up Apple Music \u2192");e.innerHTML='<a href="'+c(t)+'" target="_blank" rel="noopener">'+c(n)+"</a>",e.classList.remove("hidden")}else{var a=h("admin.providerRequiresMA","Requires Music Assistant");e.innerHTML="<span>"+c(a)+'</span> - <a href="https://music-assistant.io/integration/installation/" target="_blank" rel="noopener">Setup Guide</a>',e.classList.remove("hidden")}else e.classList.add("hidden")}}function h(e,t){return typeof BeatifyI18n!="undefined"&&BeatifyI18n.t&&BeatifyI18n.t(e)||t}function F(e){var t=document.getElementById("lobby-players"),n=document.getElementById("lobby-player-count");if(t){e=e||[];var a=h("lobby.waitingForPlayers","Waiting for players to join...");if(n){var s=e.length,i=s===1?h("lobby.player","player"):h("lobby.players","players");n.textContent=s+" "+i}if(e.length===0){t.innerHTML='<p class="empty-state">'+c(a)+"</p>",B=[];return}var r=e.slice().sort(function(d,u){return d.connected!==u.connected?d.connected?-1:1:0}),o=B.map(function(d){return d.name}),l=r.filter(function(d){return o.indexOf(d.name)===-1}).map(function(d){return d.name});t.innerHTML=r.map(function(d){var u=l.indexOf(d.name)!==-1,A=d.connected===!1,Q=d.is_admin===!0,W=["player-card",u?"is-new":"",A?"player-card--disconnected":""].filter(Boolean).join(" "),z=A?'<span class="away-badge">(away)</span>':"",X=Q?'<span class="admin-badge">\u{1F451}</span>':"";return'<div class="'+W+'" data-player="'+c(d.name)+'"><span class="player-name">'+c(d.name)+X+z+"</span></div>"}).join(""),setTimeout(function(){for(var d=t.querySelectorAll(".is-new"),u=0;u<d.length;u++)d[u].classList.remove("is-new")},2e3),B=e.slice()}}function _e(){P(),I=setInterval(function(){return f(this,null,function*(){if(_!=="lobby"){P();return}try{var e=yield fetch("/beatify/api/status");if(!e.ok)return;var t=yield e.json();t.active_game&&t.active_game.players&&F(t.active_game.players)}catch(n){console.error("Lobby polling error:",n)}})},3e3)}function P(){I&&(clearInterval(I),I=null)}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Admin] SW registered:",e.scope)}).catch(function(e){console.warn("[Admin] SW registration failed:",e)})})});ke();})();
//# sourceMappingURL=admin.min.js.map
