{
  "version": 3,
  "sources": ["utils.js"],
  "sourcesContent": ["/**\n * Beatify Shared Utilities Module\n *\n * Provides common functionality used across multiple pages:\n * - i18n helpers (waitForI18n, t)\n * - View management (showView)\n * - Localization helpers (getLocalizedSongField)\n * - WebSocket utilities (createWebSocket)\n * - HTML escaping (escapeHtml)\n *\n * This module consolidates duplicated code from admin.js, player.js, and dashboard.js.\n */\nwindow.BeatifyUtils = (function() {\n    'use strict';\n\n    // ==========================================================================\n    // i18n Helpers\n    // ==========================================================================\n\n    /**\n     * Wait for BeatifyI18n to be available (handles fallback script race condition)\n     * @param {number} timeout - Max wait time in ms (default: 3000)\n     * @param {number} interval - Check interval in ms (default: 50)\n     * @returns {Promise<boolean>} - true if available, false if timeout\n     */\n    async function waitForI18n(timeout, interval) {\n        timeout = timeout || 3000;\n        interval = interval || 50;\n        var start = Date.now();\n        while (typeof BeatifyI18n === 'undefined') {\n            if (Date.now() - start > timeout) {\n                return false;\n            }\n            await new Promise(function(resolve) { setTimeout(resolve, interval); });\n        }\n        return true;\n    }\n\n    /**\n     * Translation function with smart fallback handling\n     * Supports both interpolation params and explicit fallback strings\n     * @param {string} key - Translation key (e.g., 'lobby.playerJoined')\n     * @param {Object|string} paramsOrFallback - Interpolation params object OR fallback string\n     * @returns {string} - Translated text or fallback\n     */\n    function t(key, paramsOrFallback) {\n        var params = null;\n        var explicitFallback = null;\n\n        // Determine if second arg is params object or fallback string\n        if (typeof paramsOrFallback === 'string') {\n            explicitFallback = paramsOrFallback;\n        } else if (paramsOrFallback && typeof paramsOrFallback === 'object') {\n            params = paramsOrFallback;\n        }\n\n        // Use BeatifyI18n.t if available\n        if (typeof BeatifyI18n !== 'undefined' && BeatifyI18n.t) {\n            var result = BeatifyI18n.t(key, params);\n            // If result equals key, i18n didn't find it - use explicit fallback if provided\n            if (result === key && explicitFallback) {\n                return explicitFallback;\n            }\n            return result || explicitFallback || key;\n        }\n\n        // If explicit fallback provided, use it\n        if (explicitFallback) {\n            return explicitFallback;\n        }\n\n        // Auto-generate fallback: extract last part of key and make it readable\n        // e.g., 'lobby.playerJoined' -> 'Player Joined'\n        var fallback = key.split('.').pop()\n            .replace(/([A-Z])/g, ' $1')\n            .replace(/^./, function(str) { return str.toUpperCase(); })\n            .trim();\n\n        // Handle params substitution if provided\n        if (params) {\n            Object.keys(params).forEach(function(param) {\n                fallback = fallback.replace(new RegExp('\\\\{' + param + '\\\\}', 'g'), params[param]);\n            });\n        }\n        return fallback;\n    }\n\n    // ==========================================================================\n    // View Management\n    // ==========================================================================\n\n    /**\n     * Show a specific view and hide all others\n     * @param {Array<HTMLElement>} views - Array of view elements to manage\n     * @param {string} viewId - ID of view to show\n     */\n    function showView(views, viewId) {\n        views.forEach(function(v) {\n            if (v) {\n                v.classList.add('hidden');\n            }\n        });\n        var view = document.getElementById(viewId);\n        if (view) {\n            view.classList.remove('hidden');\n        }\n    }\n\n    // ==========================================================================\n    // Localization Helpers\n    // ==========================================================================\n\n    /**\n     * Get localized content field from song with English fallback (Story 16.1, 16.3)\n     * @param {Object} song - Song object\n     * @param {string} field - Base field name ('fun_fact' or 'awards')\n     * @returns {string|Array|null} Localized content or English fallback\n     */\n    function getLocalizedSongField(song, field) {\n        if (!song) return null;\n        // Guard: fall back to English if i18n unavailable\n        var lang = (typeof BeatifyI18n !== 'undefined') ? BeatifyI18n.getLanguage() : 'en';\n        // Try localized field first (for non-English)\n        if (lang && lang !== 'en') {\n            var localizedKey = field + '_' + lang;\n            if (song[localizedKey]) {\n                return song[localizedKey];\n            }\n        }\n        // Fallback to base field (English)\n        return song[field] || null;\n    }\n\n    // ==========================================================================\n    // HTML Utilities\n    // ==========================================================================\n\n    /**\n     * Escape HTML to prevent XSS\n     * @param {string} text - Text to escape\n     * @returns {string} Escaped text\n     */\n    function escapeHtml(text) {\n        if (text === null || text === undefined) {\n            return '';\n        }\n        var div = document.createElement('div');\n        div.textContent = String(text);\n        return div.innerHTML;\n    }\n\n    // ==========================================================================\n    // WebSocket Utilities\n    // ==========================================================================\n\n    /**\n     * Create a WebSocket connection with auto-reconnect and exponential backoff\n     * @param {Object} options - Configuration options\n     * @param {string} options.path - WebSocket path (default: '/beatify/ws')\n     * @param {number} options.maxReconnectAttempts - Max reconnect attempts (default: 20)\n     * @param {number} options.maxReconnectDelay - Max delay in ms (default: 30000)\n     * @param {string} options.logPrefix - Prefix for console logs (default: 'WebSocket')\n     * @param {Function} options.onOpen - Called when connection opens\n     * @param {Function} options.onMessage - Called with parsed JSON message\n     * @param {Function} options.onClose - Called when connection closes (after max retries)\n     * @param {Function} options.onError - Called on error\n     * @returns {Object} WebSocket manager with send(), close(), and getSocket() methods\n     */\n    function createWebSocket(options) {\n        options = options || {};\n        var path = options.path || '/beatify/ws';\n        var maxReconnectAttempts = options.maxReconnectAttempts || 20;\n        var maxReconnectDelay = options.maxReconnectDelay || 30000;\n        var logPrefix = options.logPrefix || 'WebSocket';\n\n        var ws = null;\n        var reconnectAttempts = 0;\n        var intentionallyClosed = false;\n\n        function getReconnectDelay() {\n            return Math.min(1000 * Math.pow(2, reconnectAttempts), maxReconnectDelay);\n        }\n\n        function connect() {\n            var wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n            var wsUrl = wsProtocol + '//' + window.location.host + path;\n\n            ws = new WebSocket(wsUrl);\n\n            ws.onopen = function() {\n                console.log('[' + logPrefix + '] Connected');\n                reconnectAttempts = 0;\n                if (options.onOpen) {\n                    options.onOpen(ws);\n                }\n            };\n\n            ws.onmessage = function(event) {\n                try {\n                    var data = JSON.parse(event.data);\n                    if (options.onMessage) {\n                        options.onMessage(data, ws);\n                    }\n                } catch (e) {\n                    console.error('[' + logPrefix + '] Failed to parse message:', e);\n                }\n            };\n\n            ws.onclose = function() {\n                console.log('[' + logPrefix + '] Disconnected');\n                if (intentionallyClosed) {\n                    return;\n                }\n                if (reconnectAttempts < maxReconnectAttempts) {\n                    reconnectAttempts++;\n                    var delay = getReconnectDelay();\n                    console.log('[' + logPrefix + '] Reconnecting in ' + delay + 'ms (attempt ' + reconnectAttempts + ')');\n                    setTimeout(connect, delay);\n                } else {\n                    console.log('[' + logPrefix + '] Max reconnect attempts reached');\n                    if (options.onClose) {\n                        options.onClose();\n                    }\n                }\n            };\n\n            ws.onerror = function(err) {\n                console.error('[' + logPrefix + '] Error:', err);\n                if (options.onError) {\n                    options.onError(err);\n                }\n            };\n        }\n\n        // Start connection\n        connect();\n\n        // Return manager object\n        return {\n            send: function(data) {\n                if (ws && ws.readyState === WebSocket.OPEN) {\n                    ws.send(typeof data === 'string' ? data : JSON.stringify(data));\n                    return true;\n                }\n                return false;\n            },\n            close: function() {\n                intentionallyClosed = true;\n                if (ws) {\n                    ws.close();\n                }\n            },\n            getSocket: function() {\n                return ws;\n            },\n            isConnected: function() {\n                return ws && ws.readyState === WebSocket.OPEN;\n            },\n            resetReconnect: function() {\n                reconnectAttempts = 0;\n            }\n        };\n    }\n\n    // ==========================================================================\n    // URL Utilities\n    // ==========================================================================\n\n    /**\n     * Get a query parameter from the URL\n     * @param {string} name - Parameter name\n     * @returns {string|null} Parameter value or null\n     */\n    function getQueryParam(name) {\n        var urlParams = new URLSearchParams(window.location.search);\n        return urlParams.get(name);\n    }\n\n    /**\n     * Build WebSocket URL for current host\n     * @param {string} path - Path (default: '/beatify/ws')\n     * @returns {string} Full WebSocket URL\n     */\n    function buildWebSocketUrl(path) {\n        path = path || '/beatify/ws';\n        var wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n        return wsProtocol + '//' + window.location.host + path;\n    }\n\n    // ==========================================================================\n    // Public API\n    // ==========================================================================\n\n    return {\n        // i18n\n        waitForI18n: waitForI18n,\n        t: t,\n\n        // View management\n        showView: showView,\n\n        // Localization\n        getLocalizedSongField: getLocalizedSongField,\n\n        // HTML utilities\n        escapeHtml: escapeHtml,\n\n        // WebSocket\n        createWebSocket: createWebSocket,\n        buildWebSocketUrl: buildWebSocketUrl,\n\n        // URL utilities\n        getQueryParam: getQueryParam\n    };\n})();\n"],
  "mappings": "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",
  "names": ["waitForI18n", "timeout", "interval", "__async", "start", "resolve", "t", "key", "paramsOrFallback", "params", "explicitFallback", "result", "fallback", "str", "param", "showView", "views", "viewId", "v", "view", "getLocalizedSongField", "song", "field", "lang", "localizedKey", "escapeHtml", "text", "div", "createWebSocket", "options", "path", "maxReconnectAttempts", "maxReconnectDelay", "logPrefix", "ws", "reconnectAttempts", "intentionallyClosed", "getReconnectDelay", "connect", "wsProtocol", "wsUrl", "event", "data", "e", "delay", "err", "getQueryParam", "name", "urlParams", "buildWebSocketUrl"]
}
