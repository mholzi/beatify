(()=>{var M=(k,I,h)=>new Promise((_,w)=>{var B=l=>{try{f(h.next(l))}catch(y){w(y)}},C=l=>{try{f(h.throw(l))}catch(y){w(y)}},f=l=>l.done?_(l.value):Promise.resolve(l.value).then(B,C);f((h=h.apply(k,I)).next())});(function(){"use strict";var k=document.getElementById("dashboard-loading"),I=document.getElementById("dashboard-no-game"),h=document.getElementById("dashboard-lobby"),_=document.getElementById("dashboard-playing"),w=document.getElementById("dashboard-reveal"),B=document.getElementById("dashboard-end"),C=document.getElementById("dashboard-paused"),f=null,l=0,y=20,q=3e4,S=[],E=null,T=null;function O(e,a){return M(this,null,function*(){e=e||3e3,a=a||50;for(var r=Date.now();typeof BeatifyI18n=="undefined";){if(Date.now()-r>e)return!1;yield new Promise(function(n){setTimeout(n,a)})}return!0})}function u(e,a){if(typeof BeatifyI18n!="undefined"&&BeatifyI18n.t)return BeatifyI18n.t(e,a);var r=e.split(".").pop().replace(/([A-Z])/g," $1").replace(/^./,function(n){return n.toUpperCase()}).trim();return a&&typeof a=="object"&&Object.keys(a).forEach(function(n){r=r.replace(new RegExp("\\{"+n+"\\}","g"),a[n])}),r}function U(e,a){if(!e)return null;var r=typeof BeatifyI18n!="undefined"?BeatifyI18n.getLanguage():"en";if(r&&r!=="en"){var n=a+"_"+r;if(e[n])return e[n]}return e[a]||null}function v(e){var a=[k,I,h,_,w,B,C];a.forEach(function(n){n&&n.classList.add("hidden")});var r=document.getElementById(e);r&&r.classList.remove("hidden")}function m(e){var a=document.createElement("div");return a.textContent=e,a.innerHTML}function W(){return Math.min(1e3*Math.pow(2,l),q)}function A(){var e=window.location.protocol==="https:"?"wss:":"ws:",a=e+"//"+window.location.host+"/beatify/ws";f=new WebSocket(a),f.onopen=function(){console.log("[Dashboard] WebSocket connected"),l=0,f.send(JSON.stringify({type:"get_state"}))},f.onmessage=function(r){try{var n=JSON.parse(r.data);j(n)}catch(s){console.error("[Dashboard] Failed to parse message:",s)}},f.onclose=function(){if(console.log("[Dashboard] WebSocket closed"),l<y){l++;var r=W();console.log("[Dashboard] Reconnecting in "+r+"ms (attempt "+l+")"),setTimeout(A,r)}else v("dashboard-no-game")},f.onerror=function(r){console.error("[Dashboard] WebSocket error:",r)}}function j(e){e.type==="state"?(e.game_performance&&console.log("[Dashboard] game_performance:",e.game_performance),R(e)):e.type==="error"&&console.log("[Dashboard] Server error:",e.message)}function R(e){var a=e.phase;if(typeof BeatifyI18n!="undefined"&&e.language&&e.language!==BeatifyI18n.getLanguage()){BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),R(e)});return}if(!a||a==="END"&&!e.game_id){v("dashboard-no-game"),g();return}switch(a){case"LOBBY":g(),v("dashboard-lobby"),Q(e);break;case"PLAYING":v("dashboard-playing"),X(e);break;case"REVEAL":g(),v("dashboard-reveal"),K(e);break;case"END":g(),v("dashboard-end"),se(e);break;case"PAUSED":g(),v("dashboard-paused");break;default:console.log("[Dashboard] Unknown phase:",a)}}function Q(e){var a=e.players||[];e.join_url&&Y(e.join_url),G(e);var r=document.getElementById("dashboard-player-count");if(r){var n=a.length;r.textContent=n+" player"+(n!==1?"s":"")+" joined"}J(a)}function G(e){var a=document.getElementById("dashboard-game-settings");if(a){var r=e.total_rounds||10,n=e.difficulty||"normal",s=u("admin.difficulty"+n.charAt(0).toUpperCase()+n.slice(1),n);a.textContent=r+" "+u("dashboard.rounds","rounds")+" \u2022 "+s}}function Y(e){var a=document.getElementById("dashboard-qr-code");a&&e!==T&&(T=e,a.innerHTML="",typeof QRCode!="undefined"?new QRCode(a,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):a.innerHTML="<p>QR code unavailable</p>")}function J(e){var a=document.getElementById("dashboard-player-list");if(a){var r=e.slice().sort(function(t,i){return t.connected!==i.connected?t.connected?-1:1:0}),n=S.map(function(t){return t.name}),s=r.filter(function(t){return n.indexOf(t.name)===-1}).map(function(t){return t.name});a.innerHTML=r.map(function(t){var i=s.indexOf(t.name)!==-1,d=t.connected===!1,c=["dashboard-player-card"];i&&c.push("is-new"),d&&c.push("dashboard-player-card--disconnected");var o=d?'<span class="away-badge">(away)</span>':"";return'<div class="'+c.join(" ")+'">'+m(t.name)+o+"</div>"}).join(""),setTimeout(function(){for(var t=a.querySelectorAll(".is-new"),i=0;i<t.length;i++)t[i].classList.remove("is-new")},2e3),S=e.slice()}}function X(e){var a=e.song||{},r=e.players||[],n=document.getElementById("dashboard-current-round"),s=document.getElementById("dashboard-total-rounds");n&&(n.textContent=e.round||1),s&&(s.textContent=e.total_rounds||10);var t=document.getElementById("dashboard-album-art");t&&(t.src=a.album_art||"/beatify/static/img/no-artwork.svg",t.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"}),e.deadline&&Z(e.deadline),$(e.leaderboard||[],r,"dashboard-leaderboard",!0,!0),z(e,r)}function z(e,a){console.log("[Dashboard] renderRoundStats called, players:",a),console.log("[Dashboard] data.players:",e.players);var r=0,n=a.length;a.forEach(function(d){d.submitted&&r++}),console.log("[Dashboard] Submissions:",r,"/",n);var s=document.getElementById("dashboard-submissions");s?(s.textContent=r+"/"+n,console.log("[Dashboard] Updated submissions element")):console.warn("[Dashboard] dashboard-submissions element not found");var t=document.getElementById("dashboard-time-remaining");if(t&&e.deadline){var i=Math.max(0,Math.ceil((e.deadline-Date.now())/1e3));t.textContent=i+"s"}}function Z(e){g();var a=document.getElementById("dashboard-timer"),r=document.getElementById("dashboard-time-remaining");if(!a)return;a.classList.remove("timer--warning","timer--critical");function n(){var s=Date.now(),t=Math.max(0,Math.ceil((e-s)/1e3));a.textContent=t,r&&(r.textContent=t+"s"),t<=5?(a.classList.remove("timer--warning"),a.classList.add("timer--critical")):t<=10?(a.classList.remove("timer--critical"),a.classList.add("timer--warning")):a.classList.remove("timer--warning","timer--critical"),t<=0&&g()}n(),E=setInterval(n,1e3)}function g(){E&&(clearInterval(E),E=null)}function $(e,a,r,n,s){var t=document.getElementById(r);if(t){var i={},d={};a&&a.forEach(function(o){i[o.name]=o.submitted,d[o.name]=o.bet});var c="";e.forEach(function(o){var D=o.rank<=3?"is-top-"+o.rank:"",L="";o.rank_change>0?L="leaderboard-entry--climbing":o.rank_change<0&&(L="leaderboard-entry--falling");var de=o.connected===!1?"leaderboard-entry--disconnected":"",le=o.connected===!1?'<span class="away-badge">(away)</span>':"",F="";o.rank_change>0?F='<span class="rank-up">\u25B2'+o.rank_change+"</span>":o.rank_change<0&&(F='<span class="rank-down">\u25BC'+Math.abs(o.rank_change)+"</span>");var V="";if(o.streak>=2){var fe=o.streak>=5?"streak-indicator--hot":"";V='<span class="streak-indicator '+fe+'">\u{1F525}'+o.streak+"</span>"}var H="";s&&d[o.name]&&(H='<span class="bet-badge">BET</span>');var P="";if(n){var ue=i[o.name]===!0;P='<div class="entry-submitted '+(ue?"is-submitted":"")+'"></div>'}c+='<div class="leaderboard-entry '+D+" "+L+" "+de+'"><span class="entry-rank">#'+o.rank+'</span><span class="entry-name">'+m(o.name)+le+H+'</span><span class="entry-meta">'+V+F+'</span><span class="entry-score">'+o.score+"</span>"+P+"</div>"}),t.innerHTML=c}}function K(e){var a=e.song||{},r=e.players||[],n=document.getElementById("reveal-album-art");n&&(n.src=a.album_art||"/beatify/static/img/no-artwork.svg",n.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"});var s=document.getElementById("reveal-artist"),t=document.getElementById("reveal-title"),i=document.getElementById("reveal-year");if(s&&(s.textContent=a.artist||"Unknown Artist"),t&&(t.textContent=a.title||"Unknown Song"),i&&(i.textContent=a.year||"????"),ee(a),te(r),re(e.leaderboard||[]),ae(e.game_performance),ne(e.song_difficulty),e.game_performance&&e.game_performance.is_new_record)x("record");else{var d=r.some(function(c){return c.years_off===0&&!c.missed_round});d&&x("exact")}}function ee(e){var a=document.getElementById("dashboard-fun-fact"),r=document.getElementById("dashboard-fun-fact-text"),n=U(e,"fun_fact");if(console.log("[Dashboard] renderFunFact called with song:",e),console.log("[Dashboard] fun_fact value:",n||"no fun fact"),!a||!r){console.warn("[Dashboard] Fun fact elements not found");return}if(!n||n.trim()===""){a.classList.add("hidden"),console.log("[Dashboard] No fun_fact, hiding container");return}r.textContent=n,a.classList.remove("hidden"),console.log("[Dashboard] Fun fact shown:",n)}function ae(e){var a=document.getElementById("reveal-motivational");if(a){if(!e||!e.message){a.classList.add("hidden");return}var r=e.message,n=a.querySelector(".motivational-icon"),s=a.querySelector(".motivational-text");a.className="motivational-message motivational-message--"+r.type;var t={first:"\u{1F31F}",record:"\u{1F3C6}",strong:"\u{1F525}",above:"\u{1F4C8}",close:"\u{1F4AA}"};n&&(n.textContent=t[r.type]||""),s&&(s.textContent=r.message||"")}}function ne(e){var a=document.getElementById("song-difficulty");if(a){if(!e){a.classList.add("hidden");return}for(var r="",n=0;n<e.stars;n++)r+='<span class="star">&#9733;</span>';a.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+r+'</div><span class="difficulty-label">'+u("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+u("difficulty.accuracy")+"</span>",a.classList.remove("hidden")}}function te(e){var a=document.getElementById("reveal-top-guesses-list");if(a){var r=e.filter(function(s){return!s.missed_round}).sort(function(s,t){return(t.round_score||0)-(s.round_score||0)}).slice(0,3),n="";r.forEach(function(s,t){var i=s.guess?'<span class="top-guess-year">('+s.guess+")</span>":"",d="";if(s.bet){var c="bet-badge";s.bet_outcome==="won"?c+=" bet-badge--won":s.bet_outcome==="lost"&&(c+=" bet-badge--lost"),d='<span class="'+c+'">BET</span>'}n+='<div class="top-guess-entry"><span class="top-guess-rank">#'+(t+1)+'</span><span class="top-guess-name">'+m(s.name)+i+'</span><span class="top-guess-points">+'+(s.round_score||0)+d+"</span></div>"}),a.innerHTML=n}}function re(e){var a=document.getElementById("reveal-leaderboard");if(a){var r="";e.forEach(function(n){var s=n.rank<=3?"is-top-"+n.rank:"",t="";n.rank_change>0?t="leaderboard-entry--climbing":n.rank_change<0&&(t="leaderboard-entry--falling");var i=n.connected===!1?"leaderboard-entry--disconnected":"",d=n.connected===!1?'<span class="away-badge">(away)</span>':"",c="";n.rank_change>0?c='<span class="entry-change is-positive">\u25B2'+n.rank_change+"</span>":n.rank_change<0&&(c='<span class="entry-change is-negative">\u25BC'+Math.abs(n.rank_change)+"</span>");var o="";if(n.streak>=2){var D=n.streak>=5?"streak-indicator--hot":"";o='<span class="streak-indicator '+D+'">\u{1F525}'+n.streak+"</span>"}r+='<div class="leaderboard-entry '+s+" "+t+" "+i+'"><span class="entry-rank">#'+n.rank+'</span><span class="entry-name">'+m(n.name)+d+'</span><span class="entry-meta">'+o+c+'</span><span class="entry-score">'+n.score+"</span></div>"}),a.innerHTML=r}}function se(e){var a=e.leaderboard||[];[1,2,3].forEach(function(t){var i=a.find(function(o){return o.rank===t}),d=document.getElementById("end-podium-"+t+"-name"),c=document.getElementById("end-podium-"+t+"-score");d&&(d.textContent=i?m(i.name):"---"),c&&(c.textContent=i?i.score:"0")}),oe(e.game_performance),ie(e.superlatives);var r=a.find(function(t){return t.rank===1});r&&r.score>0&&x("winner");var n=document.getElementById("end-leaderboard");if(n){var s="";a.forEach(function(t){var i=t.rank<=3?"is-top-"+t.rank:"",d=t.connected===!1?"leaderboard-entry--disconnected":"",c=t.connected===!1?'<span class="away-badge">(away)</span>':"";s+='<div class="leaderboard-entry '+i+" "+d+'"><span class="entry-rank">#'+t.rank+'</span><span class="entry-name">'+m(t.name)+c+'</span><span class="entry-score">'+t.score+"</span></div>"}),n.innerHTML=s}}function oe(e){var a=document.getElementById("end-stats-comparison");if(a){if(!e){a.classList.add("hidden");return}var r=a.querySelector(".stats-comparison-icon"),n=a.querySelector(".stats-comparison-text"),s="",t="",i="stats-comparison";e.is_first_game?(s="\u{1F31F}",t="First game recorded! Avg: "+e.current_avg.toFixed(1)+" pts/round",i+=" stats-comparison--first"):e.is_new_record?(s="\u{1F3C6}",t="NEW RECORD! "+e.current_avg.toFixed(1)+" pts/round (prev: "+e.all_time_avg.toFixed(1)+")",i+=" stats-comparison--record"):e.is_above_average?(s="\u{1F4C8}",t=e.current_avg.toFixed(1)+" pts/round (+"+e.difference.toFixed(1)+" vs all-time avg)",i+=" stats-comparison--above"):(s="\u{1F4CA}",t=e.current_avg.toFixed(1)+" pts/round ("+e.difference.toFixed(1)+" vs all-time avg)",i+=" stats-comparison--below"),a.className=i,r&&(r.textContent=s),n&&(n.textContent=t)}}function ie(e){var a=document.getElementById("superlatives-container");if(a){if(!e||e.length===0){a.classList.add("hidden");return}var r="";e.forEach(function(n,s){var t="";switch(n.value_label){case"avg_time":t=n.value+"s "+u("superlatives.avgTime");break;case"streak":t=n.value+" "+u("superlatives.streak");break;case"bets":t=n.value+" "+u("superlatives.bets");break;case"points":t=n.value+" "+u("superlatives.points");break;case"close_guesses":t=n.value+" "+u("superlatives.closeGuesses");break;default:t=n.value}r+='<div class="superlative-card superlative-card--'+n.id+'" style="animation-delay: '+s*.2+'s"><div class="superlative-emoji">'+n.emoji+'</div><div class="superlative-title">'+u("superlatives."+n.title)+'</div><div class="superlative-player">'+m(n.player_name)+'</div><div class="superlative-value">'+t+"</div></div>"}),a.innerHTML=r,a.classList.remove("hidden")}}var p=null,b=null;function x(e){if(!window.matchMedia("(prefers-reduced-motion: reduce)").matches){if(typeof confetti=="undefined"){console.warn("[Dashboard Confetti] Library not loaded");return}switch(ce(),e=e||"exact",e){case"exact":var a=2e3,r=Date.now()+a;(function o(){confetti({particleCount:15,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<r&&(p=requestAnimationFrame(o))})();break;case"record":var n=3*1e3,s=Date.now()+n;(function o(){confetti({particleCount:10,spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<s&&(p=requestAnimationFrame(o))})();break;case"winner":var t=4*1e3,i=Date.now()+t;(function o(){confetti({particleCount:10,angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:10,angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<i&&(p=requestAnimationFrame(o))})();break;case"perfect":var d=5*1e3,c=Date.now()+d;b=setInterval(function(){confetti({particleCount:30,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},500),setTimeout(function(){b&&(clearInterval(b),b=null)},d),function o(){confetti({particleCount:7,angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:7,angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<c&&(p=requestAnimationFrame(o))}();break;default:console.warn("[Dashboard Confetti] Unknown type:",e)}}}function ce(){p&&(cancelAnimationFrame(p),p=null),b&&(clearInterval(b),b=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function N(){return M(this,null,function*(){console.log("[Dashboard] Initializing...");var e=yield O();e?(yield BeatifyI18n.init(),BeatifyI18n.initPageTranslations()):console.error("[Dashboard] BeatifyI18n module failed to load - UI will use fallback text"),A()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Dashboard] SW registered:",e.scope)}).catch(function(e){console.warn("[Dashboard] SW registration failed:",e)})})})();})();
//# sourceMappingURL=dashboard.min.js.map
