(()=>{var q=(k,_,h)=>new Promise((C,w)=>{var I=f=>{try{u(h.next(f))}catch(y){w(y)}},B=f=>{try{u(h.throw(f))}catch(y){w(y)}},u=f=>f.done?C(f.value):Promise.resolve(f.value).then(I,B);u((h=h.apply(k,_)).next())});(function(){"use strict";var k=document.getElementById("dashboard-loading"),_=document.getElementById("dashboard-no-game"),h=document.getElementById("dashboard-lobby"),C=document.getElementById("dashboard-playing"),w=document.getElementById("dashboard-reveal"),I=document.getElementById("dashboard-end"),B=document.getElementById("dashboard-paused"),u=null,f=0,y=20,P=3e4,M=[],E=null,S=null;function W(e,a){if(!e)return null;var s=BeatifyI18n.getLanguage();if(s&&s!=="en"){var n=a+"_"+s;if(e[n])return e[n]}return e[a]||null}function v(e){var a=[k,_,h,C,w,I,B];a.forEach(function(n){n&&n.classList.add("hidden")});var s=document.getElementById(e);s&&s.classList.remove("hidden")}function m(e){var a=document.createElement("div");return a.textContent=e,a.innerHTML}function O(){return Math.min(1e3*Math.pow(2,f),P)}function T(){var e=window.location.protocol==="https:"?"wss:":"ws:",a=e+"//"+window.location.host+"/beatify/ws";u=new WebSocket(a),u.onopen=function(){console.log("[Dashboard] WebSocket connected"),f=0,u.send(JSON.stringify({type:"get_state"}))},u.onmessage=function(s){try{var n=JSON.parse(s.data);U(n)}catch(o){console.error("[Dashboard] Failed to parse message:",o)}},u.onclose=function(){if(console.log("[Dashboard] WebSocket closed"),f<y){f++;var s=O();console.log("[Dashboard] Reconnecting in "+s+"ms (attempt "+f+")"),setTimeout(T,s)}else v("dashboard-no-game")},u.onerror=function(s){console.error("[Dashboard] WebSocket error:",s)}}function U(e){e.type==="state"?(e.game_performance&&console.log("[Dashboard] game_performance:",e.game_performance),A(e)):e.type==="error"&&console.log("[Dashboard] Server error:",e.message)}function A(e){var a=e.phase;if(e.language&&e.language!==BeatifyI18n.getLanguage()){BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),A(e)});return}if(!a||a==="END"&&!e.game_id){v("dashboard-no-game"),g();return}switch(a){case"LOBBY":g(),v("dashboard-lobby"),j(e);break;case"PLAYING":v("dashboard-playing"),Y(e);break;case"REVEAL":g(),v("dashboard-reveal"),Z(e);break;case"END":g(),v("dashboard-end"),te(e);break;case"PAUSED":g(),v("dashboard-paused");break;default:console.log("[Dashboard] Unknown phase:",a)}}function j(e){var a=e.players||[];e.join_url&&Q(e.join_url);var s=document.getElementById("dashboard-player-count");if(s){var n=a.length;s.textContent=n+" player"+(n!==1?"s":"")+" joined"}G(a)}function Q(e){var a=document.getElementById("dashboard-qr-code");a&&e!==S&&(S=e,a.innerHTML="",typeof QRCode!="undefined"?new QRCode(a,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):a.innerHTML="<p>QR code unavailable</p>")}function G(e){var a=document.getElementById("dashboard-player-list");if(a){var s=e.slice().sort(function(r,c){return r.connected!==c.connected?r.connected?-1:1:0}),n=M.map(function(r){return r.name}),o=s.filter(function(r){return n.indexOf(r.name)===-1}).map(function(r){return r.name});a.innerHTML=s.map(function(r){var c=o.indexOf(r.name)!==-1,l=r.connected===!1,d=["dashboard-player-card"];c&&d.push("is-new"),l&&d.push("dashboard-player-card--disconnected");var i=l?'<span class="away-badge">(away)</span>':"";return'<div class="'+d.join(" ")+'">'+m(r.name)+i+"</div>"}).join(""),setTimeout(function(){for(var r=a.querySelectorAll(".is-new"),c=0;c<r.length;c++)r[c].classList.remove("is-new")},2e3),M=e.slice()}}function Y(e){var a=e.song||{},s=e.players||[],n=document.getElementById("dashboard-current-round"),o=document.getElementById("dashboard-total-rounds");n&&(n.textContent=e.round||1),o&&(o.textContent=e.total_rounds||10);var r=document.getElementById("dashboard-album-art");r&&(r.src=a.album_art||"/beatify/static/img/no-artwork.svg",r.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"}),e.deadline&&X(e.deadline),z(e.leaderboard||[],s,"dashboard-leaderboard",!0,!0),J(e,s)}function J(e,a){console.log("[Dashboard] renderRoundStats called, players:",a),console.log("[Dashboard] data.players:",e.players);var s=0,n=a.length;a.forEach(function(l){l.submitted&&s++}),console.log("[Dashboard] Submissions:",s,"/",n);var o=document.getElementById("dashboard-submissions");o?(o.textContent=s+"/"+n,console.log("[Dashboard] Updated submissions element")):console.warn("[Dashboard] dashboard-submissions element not found");var r=document.getElementById("dashboard-time-remaining");if(r&&e.deadline){var c=Math.max(0,Math.ceil((e.deadline-Date.now())/1e3));r.textContent=c+"s"}}function X(e){g();var a=document.getElementById("dashboard-timer"),s=document.getElementById("dashboard-time-remaining");if(!a)return;a.classList.remove("timer--warning","timer--critical");function n(){var o=Date.now(),r=Math.max(0,Math.ceil((e-o)/1e3));a.textContent=r,s&&(s.textContent=r+"s"),r<=5?(a.classList.remove("timer--warning"),a.classList.add("timer--critical")):r<=10?(a.classList.remove("timer--critical"),a.classList.add("timer--warning")):a.classList.remove("timer--warning","timer--critical"),r<=0&&g()}n(),E=setInterval(n,1e3)}function g(){E&&(clearInterval(E),E=null)}function z(e,a,s,n,o){var r=document.getElementById(s);if(r){var c={},l={};a&&a.forEach(function(i){c[i.name]=i.submitted,l[i.name]=i.bet});var d="";e.forEach(function(i){var D=i.rank<=3?"is-top-"+i.rank:"",L="";i.rank_change>0?L="leaderboard-entry--climbing":i.rank_change<0&&(L="leaderboard-entry--falling");var ie=i.connected===!1?"leaderboard-entry--disconnected":"",ce=i.connected===!1?'<span class="away-badge">(away)</span>':"",F="";i.rank_change>0?F='<span class="rank-up">\u25B2'+i.rank_change+"</span>":i.rank_change<0&&(F='<span class="rank-down">\u25BC'+Math.abs(i.rank_change)+"</span>");var N="";if(i.streak>=2){var de=i.streak>=5?"streak-indicator--hot":"";N='<span class="streak-indicator '+de+'">\u{1F525}'+i.streak+"</span>"}var V="";o&&l[i.name]&&(V='<span class="bet-badge">BET</span>');var H="";if(n){var le=c[i.name]===!0;H='<div class="entry-submitted '+(le?"is-submitted":"")+'"></div>'}d+='<div class="leaderboard-entry '+D+" "+L+" "+ie+'"><span class="entry-rank">#'+i.rank+'</span><span class="entry-name">'+m(i.name)+ce+V+'</span><span class="entry-meta">'+N+F+'</span><span class="entry-score">'+i.score+"</span>"+H+"</div>"}),r.innerHTML=d}}function Z(e){var a=e.song||{},s=e.players||[],n=document.getElementById("reveal-album-art");n&&(n.src=a.album_art||"/beatify/static/img/no-artwork.svg",n.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"});var o=document.getElementById("reveal-artist"),r=document.getElementById("reveal-title"),c=document.getElementById("reveal-year");if(o&&(o.textContent=a.artist||"Unknown Artist"),r&&(r.textContent=a.title||"Unknown Song"),c&&(c.textContent=a.year||"????"),$(a),ae(s),ne(e.leaderboard||[]),K(e.game_performance),ee(e.song_difficulty),e.game_performance&&e.game_performance.is_new_record)x("record");else{var l=s.some(function(d){return d.years_off===0&&!d.missed_round});l&&x("exact")}}function $(e){var a=document.getElementById("dashboard-fun-fact"),s=document.getElementById("dashboard-fun-fact-text"),n=W(e,"fun_fact");if(console.log("[Dashboard] renderFunFact called with song:",e),console.log("[Dashboard] fun_fact value:",n||"no fun fact"),!a||!s){console.warn("[Dashboard] Fun fact elements not found");return}if(!n||n.trim()===""){a.classList.add("hidden"),console.log("[Dashboard] No fun_fact, hiding container");return}s.textContent=n,a.classList.remove("hidden"),console.log("[Dashboard] Fun fact shown:",n)}function K(e){var a=document.getElementById("reveal-motivational");if(a){if(!e||!e.message){a.classList.add("hidden");return}var s=e.message,n=a.querySelector(".motivational-icon"),o=a.querySelector(".motivational-text");a.className="motivational-message motivational-message--"+s.type;var r={first:"\u{1F31F}",record:"\u{1F3C6}",strong:"\u{1F525}",above:"\u{1F4C8}",close:"\u{1F4AA}"};n&&(n.textContent=r[s.type]||""),o&&(o.textContent=s.message||"")}}function ee(e){var a=document.getElementById("song-difficulty");if(a){if(!e){a.classList.add("hidden");return}for(var s="",n=0;n<e.stars;n++)s+='<span class="star">&#9733;</span>';a.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+s+'</div><span class="difficulty-label">'+t("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+t("difficulty.accuracy")+"</span>",a.classList.remove("hidden")}}function ae(e){var a=document.getElementById("reveal-top-guesses-list");if(a){var s=e.filter(function(o){return!o.missed_round}).sort(function(o,r){return(r.round_score||0)-(o.round_score||0)}).slice(0,3),n="";s.forEach(function(o,r){var c=o.guess?'<span class="top-guess-year">('+o.guess+")</span>":"",l="";if(o.bet){var d="bet-badge";o.bet_outcome==="won"?d+=" bet-badge--won":o.bet_outcome==="lost"&&(d+=" bet-badge--lost"),l='<span class="'+d+'">BET</span>'}n+='<div class="top-guess-entry"><span class="top-guess-rank">#'+(r+1)+'</span><span class="top-guess-name">'+m(o.name)+c+'</span><span class="top-guess-points">+'+(o.round_score||0)+l+"</span></div>"}),a.innerHTML=n}}function ne(e){var a=document.getElementById("reveal-leaderboard");if(a){var s="";e.forEach(function(n){var o=n.rank<=3?"is-top-"+n.rank:"",r="";n.rank_change>0?r="leaderboard-entry--climbing":n.rank_change<0&&(r="leaderboard-entry--falling");var c=n.connected===!1?"leaderboard-entry--disconnected":"",l=n.connected===!1?'<span class="away-badge">(away)</span>':"",d="";n.rank_change>0?d='<span class="entry-change is-positive">\u25B2'+n.rank_change+"</span>":n.rank_change<0&&(d='<span class="entry-change is-negative">\u25BC'+Math.abs(n.rank_change)+"</span>");var i="";if(n.streak>=2){var D=n.streak>=5?"streak-indicator--hot":"";i='<span class="streak-indicator '+D+'">\u{1F525}'+n.streak+"</span>"}s+='<div class="leaderboard-entry '+o+" "+r+" "+c+'"><span class="entry-rank">#'+n.rank+'</span><span class="entry-name">'+m(n.name)+l+'</span><span class="entry-meta">'+i+d+'</span><span class="entry-score">'+n.score+"</span></div>"}),a.innerHTML=s}}function te(e){var a=e.leaderboard||[];[1,2,3].forEach(function(r){var c=a.find(function(i){return i.rank===r}),l=document.getElementById("end-podium-"+r+"-name"),d=document.getElementById("end-podium-"+r+"-score");l&&(l.textContent=c?m(c.name):"---"),d&&(d.textContent=c?c.score:"0")}),re(e.game_performance),se(e.superlatives);var s=a.find(function(r){return r.rank===1});s&&s.score>0&&x("winner");var n=document.getElementById("end-leaderboard");if(n){var o="";a.forEach(function(r){var c=r.rank<=3?"is-top-"+r.rank:"",l=r.connected===!1?"leaderboard-entry--disconnected":"",d=r.connected===!1?'<span class="away-badge">(away)</span>':"";o+='<div class="leaderboard-entry '+c+" "+l+'"><span class="entry-rank">#'+r.rank+'</span><span class="entry-name">'+m(r.name)+d+'</span><span class="entry-score">'+r.score+"</span></div>"}),n.innerHTML=o}}function re(e){var a=document.getElementById("end-stats-comparison");if(a){if(!e){a.classList.add("hidden");return}var s=a.querySelector(".stats-comparison-icon"),n=a.querySelector(".stats-comparison-text"),o="",r="",c="stats-comparison";e.is_first_game?(o="\u{1F31F}",r="First game recorded! Avg: "+e.current_avg.toFixed(1)+" pts/round",c+=" stats-comparison--first"):e.is_new_record?(o="\u{1F3C6}",r="NEW RECORD! "+e.current_avg.toFixed(1)+" pts/round (prev: "+e.all_time_avg.toFixed(1)+")",c+=" stats-comparison--record"):e.is_above_average?(o="\u{1F4C8}",r=e.current_avg.toFixed(1)+" pts/round (+"+e.difference.toFixed(1)+" vs all-time avg)",c+=" stats-comparison--above"):(o="\u{1F4CA}",r=e.current_avg.toFixed(1)+" pts/round ("+e.difference.toFixed(1)+" vs all-time avg)",c+=" stats-comparison--below"),a.className=c,s&&(s.textContent=o),n&&(n.textContent=r)}}function se(e){var a=document.getElementById("superlatives-container");if(a){if(!e||e.length===0){a.classList.add("hidden");return}var s="";e.forEach(function(n,o){var r="";switch(n.value_label){case"avg_time":r=n.value+"s "+t("superlatives.avgTime");break;case"streak":r=n.value+" "+t("superlatives.streak");break;case"bets":r=n.value+" "+t("superlatives.bets");break;case"points":r=n.value+" "+t("superlatives.points");break;case"close_guesses":r=n.value+" "+t("superlatives.closeGuesses");break;default:r=n.value}s+='<div class="superlative-card superlative-card--'+n.id+'" style="animation-delay: '+o*.2+'s"><div class="superlative-emoji">'+n.emoji+'</div><div class="superlative-title">'+t("superlatives."+n.title)+'</div><div class="superlative-player">'+m(n.player_name)+'</div><div class="superlative-value">'+r+"</div></div>"}),a.innerHTML=s,a.classList.remove("hidden")}}var b=null,p=null;function x(e){if(!window.matchMedia("(prefers-reduced-motion: reduce)").matches){if(typeof confetti=="undefined"){console.warn("[Dashboard Confetti] Library not loaded");return}switch(oe(),e=e||"exact",e){case"exact":var a=2e3,s=Date.now()+a;(function i(){confetti({particleCount:15,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<s&&(b=requestAnimationFrame(i))})();break;case"record":var n=3*1e3,o=Date.now()+n;(function i(){confetti({particleCount:10,spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<o&&(b=requestAnimationFrame(i))})();break;case"winner":var r=4*1e3,c=Date.now()+r;(function i(){confetti({particleCount:10,angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:10,angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<c&&(b=requestAnimationFrame(i))})();break;case"perfect":var l=5*1e3,d=Date.now()+l;p=setInterval(function(){confetti({particleCount:30,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},500),setTimeout(function(){p&&(clearInterval(p),p=null)},l),function i(){confetti({particleCount:7,angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:7,angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<d&&(b=requestAnimationFrame(i))}();break;default:console.warn("[Dashboard Confetti] Unknown type:",e)}}}function oe(){b&&(cancelAnimationFrame(b),b=null),p&&(clearInterval(p),p=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function R(){return q(this,null,function*(){console.log("[Dashboard] Initializing..."),yield BeatifyI18n.init(),BeatifyI18n.initPageTranslations(),T()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",R):R(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Dashboard] SW registered:",e.scope)}).catch(function(e){console.warn("[Dashboard] SW registration failed:",e)})})})();})();
//# sourceMappingURL=dashboard.min.js.map
