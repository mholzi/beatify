(()=>{var q=(f,_,h)=>new Promise((I,E)=>{var C=m=>{try{y(h.next(m))}catch(u){E(u)}},B=m=>{try{y(h.throw(m))}catch(u){E(u)}},y=m=>m.done?I(m.value):Promise.resolve(m.value).then(C,B);y((h=h.apply(f,_)).next())});(function(){"use strict";var f=window.BeatifyUtils||{},_=document.getElementById("dashboard-loading"),h=document.getElementById("dashboard-no-game"),I=document.getElementById("dashboard-lobby"),E=document.getElementById("dashboard-playing"),C=document.getElementById("dashboard-reveal"),B=document.getElementById("dashboard-end"),y=document.getElementById("dashboard-paused"),m=[_,h,I,E,C,B,y],u=null,w=0,P=20,U=3e4,M=[],k=null,S=null;function v(e){f.showView(m,e)}function W(){return Math.min(1e3*Math.pow(2,w),U)}function T(){var e=window.location.protocol==="https:"?"wss:":"ws:",a=e+"//"+window.location.host+"/beatify/ws";u=new WebSocket(a),u.onopen=function(){console.log("[Dashboard] WebSocket connected"),w=0,u.send(JSON.stringify({type:"get_state"}))},u.onmessage=function(s){try{var n=JSON.parse(s.data);O(n)}catch(o){console.error("[Dashboard] Failed to parse message:",o)}},u.onclose=function(){if(console.log("[Dashboard] WebSocket closed"),w<P){w++;var s=W();console.log("[Dashboard] Reconnecting in "+s+"ms (attempt "+w+")"),setTimeout(T,s)}else v("dashboard-no-game")},u.onerror=function(s){console.error("[Dashboard] WebSocket error:",s)}}function O(e){e.type==="state"?(e.game_performance&&console.log("[Dashboard] game_performance:",e.game_performance),A(e)):e.type==="error"?console.log("[Dashboard] Server error:",e.message):e.type==="player_reaction"&&ce(e.player_name,e.emoji)}function A(e){var a=e.phase;if(typeof BeatifyI18n!="undefined"&&e.language&&e.language!==BeatifyI18n.getLanguage()){BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),A(e)});return}if(!a||a==="END"&&!e.game_id){v("dashboard-no-game"),g();return}switch(a){case"LOBBY":g(),v("dashboard-lobby"),j(e);break;case"PLAYING":v("dashboard-playing"),z(e);break;case"REVEAL":g(),v("dashboard-reveal"),Z(e);break;case"END":g(),v("dashboard-end"),re(e);break;case"PAUSED":g(),v("dashboard-paused");break;default:console.log("[Dashboard] Unknown phase:",a)}}function j(e){var a=e.players||[];e.join_url&&G(e.join_url),Q(e);var s=document.getElementById("dashboard-player-count");if(s){var n=a.length;s.textContent=n+" player"+(n!==1?"s":"")+" joined"}Y(a)}function Q(e){var a=document.getElementById("dashboard-game-settings");if(a){var s=e.total_rounds||10,n=e.difficulty||"normal",o=t("admin.difficulty"+n.charAt(0).toUpperCase()+n.slice(1),n);a.textContent=s+" "+f.t("dashboard.rounds","rounds")+" \u2022 "+o}}function G(e){var a=document.getElementById("dashboard-qr-code");a&&e!==S&&(S=e,a.innerHTML="",typeof QRCode!="undefined"?new QRCode(a,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):a.innerHTML="<p>QR code unavailable</p>")}function Y(e){var a=document.getElementById("dashboard-player-list");if(a){var s=e.slice().sort(function(r,c){return r.connected!==c.connected?r.connected?-1:1:0}),n=M.map(function(r){return r.name}),o=s.filter(function(r){return n.indexOf(r.name)===-1}).map(function(r){return r.name});a.innerHTML=s.map(function(r){var c=o.indexOf(r.name)!==-1,d=r.connected===!1,l=["dashboard-player-card"];c&&l.push("is-new"),d&&l.push("dashboard-player-card--disconnected");var i=d?'<span class="away-badge">(away)</span>':"";return'<div class="'+l.join(" ")+'">'+f.escapeHtml(r.name)+i+"</div>"}).join(""),setTimeout(function(){for(var r=a.querySelectorAll(".is-new"),c=0;c<r.length;c++)r[c].classList.remove("is-new")},2e3),M=e.slice()}}function z(e){var a=e.song||{},s=e.players||[],n=document.getElementById("dashboard-current-round"),o=document.getElementById("dashboard-total-rounds");n&&(n.textContent=e.round||1),o&&(o.textContent=e.total_rounds||10);var r=document.getElementById("dashboard-album-art");r&&(r.src=a.album_art||"/beatify/static/img/no-artwork.svg",r.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"}),e.deadline&&X(e.deadline),K(e.leaderboard||[],s,"dashboard-leaderboard",!0,!0),J(e,s)}function J(e,a){console.log("[Dashboard] renderRoundStats called, players:",a),console.log("[Dashboard] data.players:",e.players);var s=0,n=a.length;a.forEach(function(d){d.submitted&&s++}),console.log("[Dashboard] Submissions:",s,"/",n);var o=document.getElementById("dashboard-submissions");o?(o.textContent=s+"/"+n,console.log("[Dashboard] Updated submissions element")):console.warn("[Dashboard] dashboard-submissions element not found");var r=document.getElementById("dashboard-time-remaining");if(r&&e.deadline){var c=Math.max(0,Math.ceil((e.deadline-Date.now())/1e3));r.textContent=c+"s"}}function X(e){g();var a=document.getElementById("dashboard-timer"),s=document.getElementById("dashboard-time-remaining");if(!a)return;a.classList.remove("timer--warning","timer--critical");function n(){var o=Date.now(),r=Math.max(0,Math.ceil((e-o)/1e3));a.textContent=r,s&&(s.textContent=r+"s"),r<=5?(a.classList.remove("timer--warning"),a.classList.add("timer--critical")):r<=10?(a.classList.remove("timer--critical"),a.classList.add("timer--warning")):a.classList.remove("timer--warning","timer--critical"),r<=0&&g()}n(),k=setInterval(n,1e3)}function g(){k&&(clearInterval(k),k=null)}function K(e,a,s,n,o){var r=document.getElementById(s);if(r){var c={},d={};a&&a.forEach(function(i){c[i.name]=i.submitted,d[i.name]=i.bet});var l="";e.forEach(function(i){var D=i.rank<=3?"is-top-"+i.rank:"",F="";i.rank_change>0?F="leaderboard-entry--climbing":i.rank_change<0&&(F="leaderboard-entry--falling");var le=i.connected===!1?"leaderboard-entry--disconnected":"",de=i.connected===!1?'<span class="away-badge">(away)</span>':"",L="";i.rank_change>0?L='<span class="rank-up">\u25B2'+i.rank_change+"</span>":i.rank_change<0&&(L='<span class="rank-down">\u25BC'+Math.abs(i.rank_change)+"</span>");var H="";if(i.streak>=2){var fe=i.streak>=5?"streak-indicator--hot":"";H='<span class="streak-indicator '+fe+'">\u{1F525}'+i.streak+"</span>"}var N="";o&&d[i.name]&&(N='<span class="bet-badge">BET</span>');var V="";if(n){var ue=c[i.name]===!0;V='<div class="entry-submitted '+(ue?"is-submitted":"")+'"></div>'}l+='<div class="leaderboard-entry '+D+" "+F+" "+le+'"><span class="entry-rank">#'+i.rank+'</span><span class="entry-name">'+f.escapeHtml(i.name)+de+N+'</span><span class="entry-meta">'+H+L+'</span><span class="entry-score">'+i.score+"</span>"+V+"</div>"}),r.innerHTML=l}}function Z(e){var a=e.song||{},s=e.players||[],n=document.getElementById("reveal-album-art");n&&(n.src=a.album_art||"/beatify/static/img/no-artwork.svg",n.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"});var o=document.getElementById("reveal-artist"),r=document.getElementById("reveal-title"),c=document.getElementById("reveal-year");if(o&&(o.textContent=a.artist||"Unknown Artist"),r&&(r.textContent=a.title||"Unknown Song"),c&&(c.textContent=a.year||"????"),$(a),ne(s),te(e.leaderboard||[]),ee(e.game_performance),ae(e.song_difficulty),e.game_performance&&e.game_performance.is_new_record)x("record");else{var d=s.some(function(l){return l.years_off===0&&!l.missed_round});d&&x("exact")}}function $(e){var a=document.getElementById("dashboard-fun-fact"),s=document.getElementById("dashboard-fun-fact-text"),n=f.getLocalizedSongField(e,"fun_fact");if(console.log("[Dashboard] renderFunFact called with song:",e),console.log("[Dashboard] fun_fact value:",n||"no fun fact"),!a||!s){console.warn("[Dashboard] Fun fact elements not found");return}if(!n||n.trim()===""){a.classList.add("hidden"),console.log("[Dashboard] No fun_fact, hiding container");return}s.textContent=n,a.classList.remove("hidden"),console.log("[Dashboard] Fun fact shown:",n)}function ee(e){var a=document.getElementById("reveal-motivational");if(a){if(!e||!e.message){a.classList.add("hidden");return}var s=e.message,n=a.querySelector(".motivational-icon"),o=a.querySelector(".motivational-text");a.className="motivational-message motivational-message--"+s.type;var r={first:"\u{1F31F}",record:"\u{1F3C6}",strong:"\u{1F525}",above:"\u{1F4C8}",close:"\u{1F4AA}"};n&&(n.textContent=r[s.type]||""),o&&(o.textContent=s.message||"")}}function ae(e){var a=document.getElementById("song-difficulty");if(a){if(!e){a.classList.add("hidden");return}for(var s="",n=0;n<e.stars;n++)s+='<span class="star">&#9733;</span>';a.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+s+'</div><span class="difficulty-label">'+f.t("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+f.t("difficulty.accuracy")+"</span>",a.classList.remove("hidden")}}function ne(e){var a=document.getElementById("reveal-top-guesses-list");if(a){var s=e.filter(function(o){return!o.missed_round}).sort(function(o,r){return(r.round_score||0)-(o.round_score||0)}).slice(0,3),n="";s.forEach(function(o,r){var c=o.guess?'<span class="top-guess-year">('+o.guess+")</span>":"",d="";if(o.bet){var l="bet-badge";o.bet_outcome==="won"?l+=" bet-badge--won":o.bet_outcome==="lost"&&(l+=" bet-badge--lost"),d='<span class="'+l+'">BET</span>'}n+='<div class="top-guess-entry"><span class="top-guess-rank">#'+(r+1)+'</span><span class="top-guess-name">'+f.escapeHtml(o.name)+c+'</span><span class="top-guess-points">+'+(o.round_score||0)+d+"</span></div>"}),a.innerHTML=n}}function te(e){var a=document.getElementById("reveal-leaderboard");if(a){var s="";e.forEach(function(n){var o=n.rank<=3?"is-top-"+n.rank:"",r="";n.rank_change>0?r="leaderboard-entry--climbing":n.rank_change<0&&(r="leaderboard-entry--falling");var c=n.connected===!1?"leaderboard-entry--disconnected":"",d=n.connected===!1?'<span class="away-badge">(away)</span>':"",l="";n.rank_change>0?l='<span class="entry-change is-positive">\u25B2'+n.rank_change+"</span>":n.rank_change<0&&(l='<span class="entry-change is-negative">\u25BC'+Math.abs(n.rank_change)+"</span>");var i="";if(n.streak>=2){var D=n.streak>=5?"streak-indicator--hot":"";i='<span class="streak-indicator '+D+'">\u{1F525}'+n.streak+"</span>"}s+='<div class="leaderboard-entry '+o+" "+r+" "+c+'"><span class="entry-rank">#'+n.rank+'</span><span class="entry-name">'+f.escapeHtml(n.name)+d+'</span><span class="entry-meta">'+i+l+'</span><span class="entry-score">'+n.score+"</span></div>"}),a.innerHTML=s}}function re(e){var a=e.leaderboard||[];[1,2,3].forEach(function(r){var c=a.find(function(i){return i.rank===r}),d=document.getElementById("end-podium-"+r+"-name"),l=document.getElementById("end-podium-"+r+"-score");d&&(d.textContent=c?f.escapeHtml(c.name):"---"),l&&(l.textContent=c?c.score:"0")}),se(e.game_performance),oe(e.superlatives);var s=a.find(function(r){return r.rank===1});s&&s.score>0&&x("winner");var n=document.getElementById("end-leaderboard");if(n){var o="";a.forEach(function(r){var c=r.rank<=3?"is-top-"+r.rank:"",d=r.connected===!1?"leaderboard-entry--disconnected":"",l=r.connected===!1?'<span class="away-badge">(away)</span>':"";o+='<div class="leaderboard-entry '+c+" "+d+'"><span class="entry-rank">#'+r.rank+'</span><span class="entry-name">'+f.escapeHtml(r.name)+l+'</span><span class="entry-score">'+r.score+"</span></div>"}),n.innerHTML=o}}function se(e){var a=document.getElementById("end-stats-comparison");if(a){if(!e){a.classList.add("hidden");return}var s=a.querySelector(".stats-comparison-icon"),n=a.querySelector(".stats-comparison-text"),o="",r="",c="stats-comparison";e.is_first_game?(o="\u{1F31F}",r="First game recorded! Avg: "+e.current_avg.toFixed(1)+" pts/round",c+=" stats-comparison--first"):e.is_new_record?(o="\u{1F3C6}",r="NEW RECORD! "+e.current_avg.toFixed(1)+" pts/round (prev: "+e.all_time_avg.toFixed(1)+")",c+=" stats-comparison--record"):e.is_above_average?(o="\u{1F4C8}",r=e.current_avg.toFixed(1)+" pts/round (+"+e.difference.toFixed(1)+" vs all-time avg)",c+=" stats-comparison--above"):(o="\u{1F4CA}",r=e.current_avg.toFixed(1)+" pts/round ("+e.difference.toFixed(1)+" vs all-time avg)",c+=" stats-comparison--below"),a.className=c,s&&(s.textContent=o),n&&(n.textContent=r)}}function oe(e){var a=document.getElementById("superlatives-container");if(a){if(!e||e.length===0){a.classList.add("hidden");return}var s="";e.forEach(function(n,o){var r="";switch(n.value_label){case"avg_time":r=n.value+"s "+f.t("superlatives.avgTime");break;case"streak":r=n.value+" "+f.t("superlatives.streak");break;case"bets":r=n.value+" "+f.t("superlatives.bets");break;case"points":r=n.value+" "+f.t("superlatives.points");break;case"close_guesses":r=n.value+" "+f.t("superlatives.closeGuesses");break;default:r=n.value}s+='<div class="superlative-card superlative-card--'+n.id+'" style="animation-delay: '+o*.2+'s"><div class="superlative-emoji">'+n.emoji+'</div><div class="superlative-title">'+f.t("superlatives."+n.title)+'</div><div class="superlative-player">'+f.escapeHtml(n.player_name)+'</div><div class="superlative-value">'+r+"</div></div>"}),a.innerHTML=s,a.classList.remove("hidden")}}var p=null,b=null;function x(e){if(!window.matchMedia("(prefers-reduced-motion: reduce)").matches){if(typeof confetti=="undefined"){console.warn("[Dashboard Confetti] Library not loaded");return}switch(ie(),e=e||"exact",e){case"exact":var a=2e3,s=Date.now()+a;(function i(){confetti({particleCount:15,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<s&&(p=requestAnimationFrame(i))})();break;case"record":var n=3*1e3,o=Date.now()+n;(function i(){confetti({particleCount:10,spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<o&&(p=requestAnimationFrame(i))})();break;case"winner":var r=4*1e3,c=Date.now()+r;(function i(){confetti({particleCount:10,angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:10,angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<c&&(p=requestAnimationFrame(i))})();break;case"perfect":var d=5*1e3,l=Date.now()+d;b=setInterval(function(){confetti({particleCount:30,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},500),setTimeout(function(){b&&(clearInterval(b),b=null)},d),function i(){confetti({particleCount:7,angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:7,angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<l&&(p=requestAnimationFrame(i))}();break;default:console.warn("[Dashboard Confetti] Unknown type:",e)}}}function ie(){p&&(cancelAnimationFrame(p),p=null),b&&(clearInterval(b),b=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function ce(e,a){var s=document.getElementById("reaction-container");if(s){var n=document.createElement("div");n.className="reaction-bubble",n.textContent=e+" "+a,n.style.left=20+Math.random()*60+"%",s.appendChild(n),setTimeout(function(){n.remove()},3e3)}}function R(){return q(this,null,function*(){console.log("[Dashboard] Initializing...");var e=yield f.waitForI18n();e?(yield BeatifyI18n.init(),BeatifyI18n.initPageTranslations()):console.error("[Dashboard] BeatifyI18n module failed to load - UI will use fallback text"),T()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",R):R(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Dashboard] SW registered:",e.scope)}).catch(function(e){console.warn("[Dashboard] SW registration failed:",e)})})})();})();
//# sourceMappingURL=dashboard.min.js.map
