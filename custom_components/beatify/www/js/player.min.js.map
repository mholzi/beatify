{
  "version": 3,
  "sources": ["player.js"],
  "sourcesContent": ["/**\n * Beatify Player Page\n * Validates game and shows appropriate state\n */\n(function() {\n    'use strict';\n\n    // Alias BeatifyUtils for convenience\n    var utils = window.BeatifyUtils || {};\n\n    // Get game ID from URL\n    const urlParams = new URLSearchParams(window.location.search);\n    const gameId = urlParams.get('game');\n\n    // View elements\n    const loadingView = document.getElementById('loading-view');\n    const notFoundView = document.getElementById('not-found-view');\n    const endedView = document.getElementById('ended-view');\n    const inProgressView = document.getElementById('in-progress-view');\n    const joinView = document.getElementById('join-view');\n    const lobbyView = document.getElementById('lobby-view');\n    const gameView = document.getElementById('game-view');\n    const revealView = document.getElementById('reveal-view');\n    const pausedView = document.getElementById('paused-view');\n    const endView = document.getElementById('end-view');\n    const connectionLostView = document.getElementById('connection-lost-view');\n\n    // All views array for showView helper\n    const allViews = [loadingView, notFoundView, endedView, inProgressView, joinView, lobbyView, gameView, revealView, pausedView, endView, connectionLostView];\n\n    /**\n     * Show a specific view and hide all others\n     * @param {string} viewId - ID of view to show\n     */\n    function showView(viewId) {\n        utils.showView(allViews, viewId);\n    }\n\n    /**\n     * Validate game ID format\n     * @param {string} id - Game ID to validate\n     * @returns {boolean} - True if valid format\n     */\n    function isValidGameIdFormat(id) {\n        if (!id || typeof id !== 'string') {\n            return false;\n        }\n        // Game IDs are alphanumeric with dashes and underscores, 8-16 chars\n        // token_urlsafe(8) produces 11 characters\n        return /^[a-zA-Z0-9_-]{8,16}$/.test(id);\n    }\n\n    // waitForI18n moved to BeatifyUtils\n\n    // t() moved to BeatifyUtils - use utils.t(key, params)\n\n    /**\n     * Show a styled confirmation modal instead of browser confirm()\n     * @param {string} title - Modal title\n     * @param {string} message - Modal message\n     * @param {string} [confirmText] - Text for confirm button\n     * @param {string} [cancelText] - Text for cancel button\n     * @returns {Promise<boolean>} - Resolves to true if confirmed, false if cancelled\n     */\n    function showConfirmModal(title, message, confirmText, cancelText) {\n        return new Promise(function(resolve) {\n            var modal = document.getElementById('confirm-modal');\n            var titleEl = document.getElementById('confirm-modal-title');\n            var messageEl = document.getElementById('confirm-modal-message');\n            var yesBtn = document.getElementById('confirm-modal-yes');\n            var noBtn = document.getElementById('confirm-modal-no');\n\n            if (!modal || !titleEl || !messageEl || !yesBtn || !noBtn) {\n                // Fallback to browser confirm if modal not found\n                resolve(confirm(message || title));\n                return;\n            }\n\n            // Set content\n            titleEl.textContent = title;\n            messageEl.textContent = message;\n            yesBtn.textContent = confirmText || utils.t('common.confirm') || 'Confirm';\n            noBtn.textContent = cancelText || utils.t('common.cancel') || 'Cancel';\n\n            // Show modal\n            modal.classList.remove('hidden');\n\n            // Cleanup function\n            function cleanup() {\n                modal.classList.add('hidden');\n                yesBtn.removeEventListener('click', onConfirm);\n                noBtn.removeEventListener('click', onCancel);\n                backdrop.removeEventListener('click', onCancel);\n            }\n\n            function onConfirm() {\n                cleanup();\n                resolve(true);\n            }\n\n            function onCancel() {\n                cleanup();\n                resolve(false);\n            }\n\n            var backdrop = modal.querySelector('.modal-backdrop');\n\n            yesBtn.addEventListener('click', onConfirm);\n            noBtn.addEventListener('click', onCancel);\n            if (backdrop) backdrop.addEventListener('click', onCancel);\n        });\n    }\n\n    // getLocalizedSongField moved to BeatifyUtils\n\n    /**\n     * Check game status with the server\n     */\n    async function checkGameStatus() {\n        // Validate game ID exists\n        if (!gameId) {\n            showView('not-found-view');\n            return;\n        }\n\n        // Validate game ID format\n        if (!isValidGameIdFormat(gameId)) {\n            showView('not-found-view');\n            return;\n        }\n\n        try {\n            const response = await fetch(`/beatify/api/game-status?game=${encodeURIComponent(gameId)}`);\n            const data = await response.json();\n\n            if (!data.exists) {\n                showView('not-found-view');\n                return;\n            }\n\n            if (data.phase === 'END') {\n                showView('ended-view');\n                return;\n            }\n\n            // Check for admin redirect first (from admin.js) - let initAll() handle it\n            // Only check beatify_admin_name since beatify_is_admin may be cleared\n            // by checkAdminStatus() before this async function completes\n            var adminName = sessionStorage.getItem('beatify_admin_name');\n            if (adminName) {\n                // Admin redirect - initAll() will handle connection\n                return;\n            }\n\n            // Story 11.2: Check for session cookie to auto-reconnect\n            // This must happen BEFORE can_join check - existing players should\n            // be able to reconnect even during REVEAL/PAUSED phases\n            var sessionCookie = getSessionCookie();\n            if (sessionCookie) {\n                // Attempt session-based reconnection (works for any phase except END)\n                connectWithSession();\n                return;\n            }\n\n            // New players: can join during LOBBY, PLAYING, or REVEAL (Story 16.5)\n            if (data.can_join) {\n                showView('join-view');\n            } else {\n                // PAUSED or END - new players can't join right now\n                showView('in-progress-view');\n            }\n\n        } catch (err) {\n            console.error('Failed to check game status:', err);\n            showView('not-found-view');\n        }\n    }\n\n    // Initialize\n    checkGameStatus();\n\n    // Wire refresh/retry buttons\n    document.getElementById('refresh-btn')?.addEventListener('click', () => {\n        showView('loading-view');\n        checkGameStatus();\n    });\n\n    document.getElementById('retry-btn')?.addEventListener('click', () => {\n        showView('loading-view');\n        checkGameStatus();\n    });\n\n    // ============================================\n    // Session Cookie Management (Story 11.1)\n    // ============================================\n\n    var SESSION_COOKIE_NAME = 'beatify_session';\n\n    /**\n     * Set session cookie with session ID\n     * @param {string} sessionId - Session ID from server\n     */\n    function setSessionCookie(sessionId) {\n        // Add Secure flag when on HTTPS (security best practice)\n        var secureFlag = location.protocol === 'https:' ? '; Secure' : '';\n        document.cookie = SESSION_COOKIE_NAME + '=' + sessionId +\n            '; path=/beatify; SameSite=Strict; max-age=86400' + secureFlag;\n    }\n\n    /**\n     * Get session cookie value\n     * @returns {string|null} Session ID or null if not found\n     */\n    function getSessionCookie() {\n        var cookies = document.cookie.split(';');\n        for (var i = 0; i < cookies.length; i++) {\n            var cookie = cookies[i].trim();\n            if (cookie.indexOf(SESSION_COOKIE_NAME + '=') === 0) {\n                return cookie.substring(SESSION_COOKIE_NAME.length + 1);\n            }\n        }\n        return null;\n    }\n\n    /**\n     * Clear session cookie\n     */\n    function clearSessionCookie() {\n        document.cookie = SESSION_COOKIE_NAME + '=; path=/beatify; max-age=0';\n    }\n\n    // ============================================\n    // Score Animation Utilities (Story 13.2)\n    // ============================================\n\n    /**\n     * Check if user prefers reduced motion\n     * @returns {boolean} True if reduced motion is preferred\n     */\n    function prefersReducedMotion() {\n        return window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n    }\n\n    /**\n     * Easing function for smooth deceleration\n     * @param {number} t - Progress value 0-1\n     * @returns {number} Eased value\n     */\n    function easeOutQuart(t) {\n        return 1 - Math.pow(1 - t, 4);\n    }\n\n    /**\n     * Animate a numeric value from start to end\n     * Story 18.3: Now device-tier aware with instant updates for low-end devices\n     * @param {HTMLElement} element - Element to update textContent\n     * @param {number} start - Starting value\n     * @param {number} end - Ending value\n     * @param {number} duration - Animation duration in ms\n     * @param {Function} easing - Easing function (optional, defaults to easeOutQuart)\n     * @returns {Object} Controller with cancel() and skipToEnd() methods\n     */\n    function animateValue(element, start, end, duration, easing) {\n        // Skip animation if reduced motion or start equals end\n        if (prefersReducedMotion() || start === end) {\n            element.textContent = end;\n            return { cancel: function() {}, skipToEnd: function() { element.textContent = end; } };\n        }\n\n        // Story 18.3: Get device-aware duration\n        var quality = AnimationUtils.getQualitySettings();\n        if (quality.scoreDuration === 0) {\n            // Low-end device: instant update\n            element.textContent = end;\n            return { cancel: function() {}, skipToEnd: function() { element.textContent = end; } };\n        }\n\n        // Scale duration based on device tier\n        var adjustedDuration = Math.min(duration, quality.scoreDuration || duration);\n\n        easing = easing || easeOutQuart;\n        var startTime = null;\n        var animationId = null;\n        var cancelled = false;\n        var finalValue = end;\n\n        function step(timestamp) {\n            if (cancelled) return;\n\n            if (!startTime) startTime = timestamp;\n            var elapsed = timestamp - startTime;\n            var progress = Math.min(elapsed / adjustedDuration, 1);\n            var easedProgress = easing(progress);\n\n            var currentValue = Math.round(start + (finalValue - start) * easedProgress);\n            element.textContent = currentValue;\n\n            if (progress < 1) {\n                animationId = requestAnimationFrame(step);\n            }\n        }\n\n        animationId = requestAnimationFrame(step);\n\n        return {\n            cancel: function() {\n                cancelled = true;\n                if (animationId) {\n                    cancelAnimationFrame(animationId);\n                }\n            },\n            skipToEnd: function() {\n                cancelled = true;\n                if (animationId) {\n                    cancelAnimationFrame(animationId);\n                }\n                element.textContent = finalValue;\n            }\n        };\n    }\n\n    /**\n     * Animate score change with visual effects\n     * @param {HTMLElement} element - Score element to animate\n     * @param {number} oldScore - Previous score value\n     * @param {number} newScore - New score value\n     * @param {Object} options - Effect options: { betWon, betLost, streakMilestone, isBigScore }\n     */\n    function animateScoreChange(element, oldScore, newScore, options) {\n        options = options || {};\n\n        // Determine animation duration based on effect type\n        var duration = 500; // default\n        if (options.betWon) {\n            duration = 800;\n        } else if (options.isBigScore) {\n            duration = 700;\n        } else if (options.betLost) {\n            duration = 400;\n        }\n\n        // Add tabular-nums class for stable width during animation\n        element.classList.add('score-animating');\n\n        // Apply appropriate CSS animation class\n        var animationClass = null;\n        if (options.betWon) {\n            animationClass = 'score-glow-gold';\n        } else if (options.betLost) {\n            animationClass = 'score-shake';\n            element.classList.add('score-flash-red');\n        } else if (options.streakMilestone) {\n            animationClass = 'score-burst';\n        } else if (options.isBigScore) {\n            animationClass = 'score-pop';\n        }\n\n        if (animationClass && !prefersReducedMotion()) {\n            element.classList.add(animationClass);\n        }\n\n        // Animate the number value\n        animateValue(element, oldScore, newScore, duration);\n\n        // Remove animation classes after animation completes\n        function cleanup() {\n            element.classList.remove('score-animating');\n            if (animationClass) {\n                element.classList.remove(animationClass);\n            }\n            element.classList.remove('score-flash-red');\n        }\n\n        // Use animationend for CSS animations, or timeout for value animation only\n        if (animationClass && !prefersReducedMotion()) {\n            element.addEventListener('animationend', function onEnd() {\n                element.removeEventListener('animationend', onEnd);\n                cleanup();\n            });\n        } else {\n            setTimeout(cleanup, duration + 50);\n        }\n    }\n\n    /**\n     * Show floating points popup above target element\n     * @param {HTMLElement} targetElement - Element to position popup relative to\n     * @param {number} points - Points value to display\n     * @param {Object} options - Options: { text, isStreak, isBetWin }\n     */\n    function showPointsPopup(targetElement, points, options) {\n        options = options || {};\n\n        // Skip popup entirely for reduced motion\n        if (prefersReducedMotion()) {\n            return;\n        }\n\n        var popup = document.createElement('div');\n        popup.className = 'points-popup';\n        popup.textContent = options.text || ('+' + points);\n\n        if (options.isStreak) {\n            popup.classList.add('points-popup--streak');\n        } else if (options.isBetWin) {\n            popup.classList.add('points-popup--gold');\n        }\n\n        // Position above target\n        var rect = targetElement.getBoundingClientRect();\n        popup.style.left = (rect.left + rect.width / 2) + 'px';\n        popup.style.top = rect.top + 'px';\n\n        document.body.appendChild(popup);\n\n        // Remove after animation\n        popup.addEventListener('animationend', function() {\n            if (popup.parentNode) {\n                popup.parentNode.removeChild(popup);\n            }\n        });\n\n        // Fallback removal in case animationend doesn't fire\n        setTimeout(function() {\n            if (popup.parentNode) {\n                popup.parentNode.removeChild(popup);\n            }\n        }, 1200);\n    }\n\n    // Previous state cache for detecting score changes (Story 13.2)\n    var previousState = {\n        players: {},      // name -> { score, rank, streak }\n        leaderboard: [],  // ordered list of names\n        initialized: false // Flag to skip animations on first state (reconnect case)\n    };\n\n    /**\n     * Check if previous state has been initialized\n     * Used to skip animations when player reconnects mid-game\n     * @returns {boolean} True if state has been initialized\n     */\n    function isPreviousStateInitialized() {\n        return previousState.initialized;\n    }\n\n    // Streak milestones for bonus detection\n    var STREAK_MILESTONES = [3, 5, 10];\n\n    // ============================================\n    // Animation Performance Utilities (Story 18.3)\n    // ============================================\n\n    /**\n     * Centralized animation utilities with device-aware performance optimization\n     */\n    var AnimationUtils = (function() {\n        // Cache reduced-motion preference\n        var reducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');\n        var _prefersReducedMotion = reducedMotionQuery.matches;\n\n        // Listen for preference changes (user toggles OS setting)\n        reducedMotionQuery.addEventListener('change', function(e) {\n            _prefersReducedMotion = e.matches;\n        });\n\n        // Cache device tier (computed once on load)\n        var _deviceTier = null;\n\n        /**\n         * Detect device capability tier\n         * @returns {'high'|'medium'|'low'} Device performance tier\n         */\n        function getDeviceTier() {\n            if (_deviceTier !== null) return _deviceTier;\n\n            var cores = navigator.hardwareConcurrency || 2;\n            var memory = navigator.deviceMemory || 4;\n\n            // iOS Safari detection (often resource-constrained)\n            var isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n\n            if (cores <= 2 || memory <= 2) {\n                _deviceTier = 'low';\n            } else if (cores <= 4 || memory <= 4 || isIOSSafari) {\n                _deviceTier = 'medium';\n            } else {\n                _deviceTier = 'high';\n            }\n\n            return _deviceTier;\n        }\n\n        // Initialize tier on load\n        getDeviceTier();\n\n        return {\n            /**\n             * Check if reduced motion is preferred\n             * @returns {boolean}\n             */\n            prefersReducedMotion: function() {\n                return _prefersReducedMotion;\n            },\n\n            /**\n             * Get device performance tier\n             * @returns {'high'|'medium'|'low'}\n             */\n            getDeviceTier: getDeviceTier,\n\n            /**\n             * Get animation quality settings based on device tier\n             * @returns {Object} Quality settings for various animation types\n             */\n            getQualitySettings: function() {\n                var tier = getDeviceTier();\n                if (_prefersReducedMotion) {\n                    return {\n                        confettiParticles: 0,\n                        scoreDuration: 0,\n                        leaderboardAnimation: 'none',\n                        neonGlow: false,\n                        enableAnimations: false\n                    };\n                }\n                switch (tier) {\n                    case 'low':\n                        return {\n                            confettiParticles: 5,\n                            scoreDuration: 0,\n                            leaderboardAnimation: 'none',\n                            neonGlow: false,\n                            enableAnimations: true\n                        };\n                    case 'medium':\n                        return {\n                            confettiParticles: 10,\n                            scoreDuration: 300,\n                            leaderboardAnimation: 'simplified',\n                            neonGlow: false,\n                            enableAnimations: true\n                        };\n                    default: // high\n                        return {\n                            confettiParticles: 15,\n                            scoreDuration: 500,\n                            leaderboardAnimation: 'full',\n                            neonGlow: true,\n                            enableAnimations: true\n                        };\n                }\n            },\n\n            /**\n             * Execute animation with reduced-motion fallback\n             * @param {Function} animationFn - Animation function to run\n             * @param {Function} fallbackFn - Fallback for reduced motion (optional)\n             */\n            ifMotionAllowed: function(animationFn, fallbackFn) {\n                if (_prefersReducedMotion) {\n                    if (fallbackFn) fallbackFn();\n                } else {\n                    animationFn();\n                }\n            },\n\n            /**\n             * Apply will-change before animation, clean up after\n             * @param {HTMLElement} element - Element to optimize\n             * @param {string} properties - CSS properties (e.g., 'transform, opacity')\n             * @param {number} durationMs - Expected animation duration in milliseconds\n             */\n            withWillChange: function(element, properties, durationMs) {\n                if (!element) return;\n                element.style.willChange = properties;\n                // Schedule cleanup after animation duration + buffer\n                setTimeout(function() {\n                    if (element && element.style) {\n                        element.style.willChange = 'auto';\n                    }\n                }, (durationMs || 500) + 100);\n            }\n        };\n    })();\n\n    /**\n     * Interruptible animation queue for reveal phase (Story 18.3)\n     * Caps total animation time and allows skip-to-end\n     */\n    var AnimationQueue = (function() {\n        var queue = [];\n        var running = false;\n        var currentAnimation = null;\n        var animationTimeoutId = null;\n        var MAX_ANIMATION_DURATION = 2000; // AC4: 2 second cap per animation\n\n        function processNext() {\n            // Clear any previous timeout\n            if (animationTimeoutId) {\n                clearTimeout(animationTimeoutId);\n                animationTimeoutId = null;\n            }\n\n            if (queue.length === 0) {\n                running = false;\n                currentAnimation = null;\n                return;\n            }\n            currentAnimation = queue.shift();\n\n            // Set timeout to force skip if animation takes too long (AC4)\n            animationTimeoutId = setTimeout(function() {\n                if (currentAnimation && currentAnimation.skipToEnd) {\n                    currentAnimation.skipToEnd();\n                }\n                processNext();\n            }, MAX_ANIMATION_DURATION);\n\n            currentAnimation.run(function() {\n                // Clear timeout if animation completes normally\n                if (animationTimeoutId) {\n                    clearTimeout(animationTimeoutId);\n                    animationTimeoutId = null;\n                }\n                processNext();\n            });\n        }\n\n        return {\n            /**\n             * Add animation to queue\n             * @param {Object} animation - { run: function(done), skipToEnd: function() }\n             */\n            add: function(animation) {\n                queue.push(animation);\n                if (!running) {\n                    running = true;\n                    processNext();\n                }\n            },\n\n            /**\n             * Skip current animation and clear queue\n             */\n            skipAll: function() {\n                // Clear timeout\n                if (animationTimeoutId) {\n                    clearTimeout(animationTimeoutId);\n                    animationTimeoutId = null;\n                }\n                // Skip current animation\n                if (currentAnimation && currentAnimation.skipToEnd) {\n                    currentAnimation.skipToEnd();\n                }\n                // Skip all queued animations\n                queue.forEach(function(anim) {\n                    if (anim.skipToEnd) anim.skipToEnd();\n                });\n                queue = [];\n                running = false;\n                currentAnimation = null;\n            },\n\n            /**\n             * Clear queue without running skip callbacks\n             */\n            clear: function() {\n                // Clear timeout\n                if (animationTimeoutId) {\n                    clearTimeout(animationTimeoutId);\n                    animationTimeoutId = null;\n                }\n                queue = [];\n                running = false;\n                currentAnimation = null;\n            },\n\n            /**\n             * Check if queue is running\n             * @returns {boolean}\n             */\n            isRunning: function() {\n                return running;\n            },\n\n            /**\n             * Get max duration setting\n             * @returns {number}\n             */\n            getMaxDuration: function() {\n                return maxDuration;\n            }\n        };\n    })();\n\n    // ============================================\n    // Lazy Loading Configuration (Story 18.1)\n    // ============================================\n\n    var LEADERBOARD_LAZY_CONFIG = {\n        VISIBLE_BUFFER: 2,      // Extra entries above/below viewport\n        ENTRY_HEIGHT: 48,       // Fixed height per leaderboard entry (px)\n        MIN_PLAYERS_FOR_LAZY: 10, // Only use lazy loading with 10+ players\n        ROOT_MARGIN: '96px 0px', // 2 entries buffer for IntersectionObserver\n        DEFAULT_VIEWPORT_HEIGHT: 280 // Default viewport height for leaderboard (px)\n    };\n\n    // Lazy loading state\n    var lazyLeaderboardState = {\n        observer: null,           // IntersectionObserver instance\n        fullData: [],             // Complete leaderboard data\n        visibleRange: { start: 0, end: 10 }, // Currently rendered range\n        listEl: null,             // Reference to list element\n        isLazyEnabled: false      // Whether lazy loading is active\n    };\n\n    /**\n     * Initialize IntersectionObserver for lazy leaderboard loading\n     * @param {Element} listEl - Leaderboard list element\n     */\n    function initLeaderboardObserver(listEl) {\n        if (!listEl) return;\n\n        // Clean up existing observer if list element changed (prevents memory leak)\n        if (lazyLeaderboardState.observer && lazyLeaderboardState.listEl !== listEl) {\n            lazyLeaderboardState.observer.disconnect();\n            lazyLeaderboardState.observer = null;\n        }\n\n        if (lazyLeaderboardState.observer) return;\n\n        lazyLeaderboardState.listEl = listEl;\n\n        // Observer callback for lazy loading (sentinels created inline in renderLazyLeaderboardRange)\n        lazyLeaderboardState.observer = new IntersectionObserver(function(entries) {\n            entries.forEach(function(entry) {\n                if (!entry.isIntersecting || !lazyLeaderboardState.isLazyEnabled) return;\n\n                var fullData = lazyLeaderboardState.fullData;\n                var range = lazyLeaderboardState.visibleRange;\n                var buffer = LEADERBOARD_LAZY_CONFIG.VISIBLE_BUFFER;\n\n                if (entry.target.classList.contains('leaderboard-sentinel--top')) {\n                    // Scrolled to top - load more entries above\n                    if (range.start > 0) {\n                        var newStart = Math.max(0, range.start - buffer);\n                        lazyLeaderboardState.visibleRange.start = newStart;\n                        renderLazyLeaderboardRange();\n                    }\n                } else if (entry.target.classList.contains('leaderboard-sentinel--bottom')) {\n                    // Scrolled to bottom - load more entries below\n                    if (range.end < fullData.length) {\n                        var newEnd = Math.min(fullData.length, range.end + buffer);\n                        lazyLeaderboardState.visibleRange.end = newEnd;\n                        renderLazyLeaderboardRange();\n                    }\n                }\n            });\n        }, {\n            root: listEl,\n            rootMargin: LEADERBOARD_LAZY_CONFIG.ROOT_MARGIN,\n            threshold: 0\n        });\n    }\n\n    /**\n     * Render the visible range of leaderboard entries with spacers\n     */\n    function renderLazyLeaderboardRange() {\n        var listEl = lazyLeaderboardState.listEl;\n        var fullData = lazyLeaderboardState.fullData;\n        var range = lazyLeaderboardState.visibleRange;\n\n        if (!listEl || !fullData.length) return;\n\n        var entryHeight = LEADERBOARD_LAZY_CONFIG.ENTRY_HEIGHT;\n        var topSpacerHeight = range.start * entryHeight;\n        var bottomSpacerHeight = (fullData.length - range.end) * entryHeight;\n\n        // Preserve scroll position\n        var scrollTop = listEl.scrollTop;\n\n        // Build HTML with spacers\n        var html = '';\n\n        // Top spacer\n        if (topSpacerHeight > 0) {\n            html += '<div class=\"leaderboard-spacer-top\" style=\"height: ' + topSpacerHeight + 'px;\"></div>';\n        }\n\n        // Top sentinel for IntersectionObserver\n        html += '<div class=\"leaderboard-sentinel leaderboard-sentinel--top\" style=\"height: 1px;\"></div>';\n\n        // Render visible entries\n        for (var i = range.start; i < range.end && i < fullData.length; i++) {\n            html += renderLeaderboardEntry(fullData[i]);\n        }\n\n        // Bottom sentinel for IntersectionObserver\n        html += '<div class=\"leaderboard-sentinel leaderboard-sentinel--bottom\" style=\"height: 1px;\"></div>';\n\n        // Bottom spacer\n        if (bottomSpacerHeight > 0) {\n            html += '<div class=\"leaderboard-spacer-bottom\" style=\"height: ' + bottomSpacerHeight + 'px;\"></div>';\n        }\n\n        listEl.innerHTML = html;\n\n        // Restore scroll position\n        listEl.scrollTop = scrollTop;\n\n        // Re-attach observer to sentinels\n        if (lazyLeaderboardState.observer) {\n            var sentinels = listEl.querySelectorAll('.leaderboard-sentinel');\n            sentinels.forEach(function(sentinel) {\n                lazyLeaderboardState.observer.observe(sentinel);\n            });\n        }\n    }\n\n    /**\n     * Render a single leaderboard entry HTML\n     * @param {Object} entry - Leaderboard entry data\n     * @returns {string} HTML string\n     */\n    function renderLeaderboardEntry(entry) {\n        // Validate entry exists\n        if (!entry) return '';\n\n        if (entry.separator) {\n            return '<div class=\"leaderboard-separator\">...</div>';\n        }\n\n        // Validate required fields with safe defaults\n        var name = entry.name || 'Unknown';\n        var rank = entry.rank || 0;\n        var score = entry.score || 0;\n\n        var rankClass = rank <= 3 ? 'is-top-' + rank : '';\n        var currentClass = entry.is_current ? 'is-current' : '';\n\n        // Rank change animation class\n        var animationClass = '';\n        if (entry.rank_change > 0 || entry._rankChange === 'up') {\n            animationClass = 'leaderboard-entry--climbing leaderboard-entry--slide-up';\n        } else if (entry.rank_change < 0 || entry._rankChange === 'down') {\n            animationClass = 'leaderboard-entry--falling leaderboard-entry--slide-down';\n        }\n\n        // Rank change indicator\n        var changeIndicator = '';\n        if (entry.rank_change > 0) {\n            changeIndicator = '<span class=\"rank-up\">\u25B2' + entry.rank_change + '</span>';\n        } else if (entry.rank_change < 0) {\n            changeIndicator = '<span class=\"rank-down\">\u25BC' + Math.abs(entry.rank_change) + '</span>';\n        }\n\n        // Streak indicator with hot glow for 5+\n        var streakIndicator = '';\n        if (entry.streak >= 2) {\n            var hotClass = entry.streak >= 5 ? 'streak-indicator--hot' : '';\n            streakIndicator = '<span class=\"streak-indicator ' + hotClass + '\">\uD83D\uDD25' + entry.streak + '</span>';\n        }\n\n        // Disconnected player styling\n        var disconnectedClass = entry.connected === false ? 'leaderboard-entry--disconnected' : '';\n        var awayBadge = entry.connected === false ? '<span class=\"away-badge\">(away)</span>' : '';\n\n        // Score display (use validated score variable)\n        var displayScore = entry._displayScore !== undefined ? entry._displayScore : score;\n\n        return '<div class=\"leaderboard-entry ' + rankClass + ' ' + currentClass + ' ' + animationClass + ' ' + disconnectedClass + '\" data-rank=\"' + rank + '\" data-name=\"' + escapeHtml(name) + '\">' +\n            '<span class=\"entry-rank\">#' + rank + '</span>' +\n            '<span class=\"entry-name\">' + escapeHtml(name) + awayBadge + '</span>' +\n            '<span class=\"entry-meta\">' +\n                streakIndicator +\n                changeIndicator +\n            '</span>' +\n            '<span class=\"entry-score\" data-prev-score=\"' + (entry._prevScore || score) + '\">' + displayScore + '</span>' +\n        '</div>';\n    }\n\n    /**\n     * Calculate initial visible range based on viewport and current player position\n     * @param {Array} displayList - Processed leaderboard data\n     * @param {string} currentPlayerName - Name of current player\n     * @returns {Object} Range object with start and end indices\n     */\n    function calculateInitialVisibleRange(displayList, currentPlayerName) {\n        var config = LEADERBOARD_LAZY_CONFIG;\n        // Use actual list element height if available, otherwise fall back to config default\n        var viewportHeight = lazyLeaderboardState.listEl\n            ? lazyLeaderboardState.listEl.clientHeight || config.DEFAULT_VIEWPORT_HEIGHT\n            : config.DEFAULT_VIEWPORT_HEIGHT;\n        var viewportEntries = Math.ceil(viewportHeight / config.ENTRY_HEIGHT);\n        var buffer = config.VISIBLE_BUFFER;\n\n        // Find current player index\n        var currentIdx = -1;\n        for (var i = 0; i < displayList.length; i++) {\n            if (displayList[i].name === currentPlayerName) {\n                currentIdx = i;\n                break;\n            }\n        }\n\n        var start, end;\n        if (currentIdx === -1 || currentIdx < viewportEntries) {\n            // Current player at top or not found - start from beginning\n            start = 0;\n            end = Math.min(displayList.length, viewportEntries + buffer * 2);\n        } else if (currentIdx >= displayList.length - viewportEntries) {\n            // Current player near bottom\n            start = Math.max(0, displayList.length - viewportEntries - buffer);\n            end = displayList.length;\n        } else {\n            // Current player in middle - center around them\n            start = Math.max(0, currentIdx - Math.floor(viewportEntries / 2) - buffer);\n            end = Math.min(displayList.length, currentIdx + Math.ceil(viewportEntries / 2) + buffer);\n        }\n\n        return { start: start, end: end };\n    }\n\n    /**\n     * Clean up lazy loading observer\n     */\n    function cleanupLeaderboardObserver() {\n        if (lazyLeaderboardState.observer) {\n            lazyLeaderboardState.observer.disconnect();\n            lazyLeaderboardState.observer = null;\n        }\n        lazyLeaderboardState.isLazyEnabled = false;\n        lazyLeaderboardState.fullData = [];\n    }\n\n    /**\n     * Setup resize/orientation change handler for lazy leaderboard (Story 18.1)\n     * Recalculates visible range when viewport size changes\n     */\n    function setupLeaderboardResizeHandler() {\n        var resizeTimeout;\n\n        function handleResize() {\n            // Debounce resize events\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(function() {\n                if (lazyLeaderboardState.isLazyEnabled && lazyLeaderboardState.fullData.length > 0) {\n                    // Recalculate visible range based on new viewport\n                    lazyLeaderboardState.visibleRange = calculateInitialVisibleRange(\n                        lazyLeaderboardState.fullData,\n                        playerName\n                    );\n                    renderLazyLeaderboardRange();\n                }\n            }, 150);\n        }\n\n        window.addEventListener('resize', handleResize);\n        window.addEventListener('orientationchange', handleResize);\n    }\n\n    // ============================================\n    // QR Section - Responsive Collapse (Story 18.8)\n    // ============================================\n\n    /**\n     * Initialize QR section collapsible behavior\n     * AC1: Mobile (<768px) starts collapsed by default\n     * AC4: Tablet/desktop (\u2265768px) starts expanded by default\n     * AC3: Expansion state persists during session via sessionStorage\n     */\n    function initQrCollapsible() {\n        var qrSection = document.getElementById('qr-share-area');\n        if (!qrSection || qrSection.tagName !== 'DETAILS') return;\n\n        var STORAGE_KEY = 'beatify_qr_expanded';\n        var MOBILE_BREAKPOINT = 768;\n\n        // Check for saved state first\n        var savedState = sessionStorage.getItem(STORAGE_KEY);\n\n        if (savedState !== null) {\n            // Use saved state\n            qrSection.open = savedState === 'true';\n        } else {\n            // Default: collapsed on mobile, expanded on desktop\n            qrSection.open = window.innerWidth >= MOBILE_BREAKPOINT;\n        }\n\n        // Save state on toggle\n        qrSection.addEventListener('toggle', function() {\n            sessionStorage.setItem(STORAGE_KEY, qrSection.open.toString());\n        });\n    }\n\n    // ============================================\n    // Lobby Collapsible Sections (New Compact Layout)\n    // ============================================\n\n    /**\n     * Setup collapsible sections in the new compact lobby layout\n     * Uses button-based toggle instead of <details> element\n     */\n    function setupLobbyCollapsible() {\n        // Find all collapsible section headers in lobby\n        var collapsibleHeaders = document.querySelectorAll('.lobby-container--compact .section-header-collapsible');\n\n        collapsibleHeaders.forEach(function(header) {\n            header.addEventListener('click', function() {\n                var section = header.closest('.section-collapsible');\n                if (!section) return;\n\n                var isCollapsed = section.classList.contains('collapsed');\n                section.classList.toggle('collapsed');\n                header.setAttribute('aria-expanded', isCollapsed ? 'true' : 'false');\n            });\n        });\n    }\n\n    // ============================================\n    // Virtual List for Player Lists (Story 18.2)\n    // ============================================\n\n    var VIRTUAL_LIST_CONFIG = {\n        ITEM_HEIGHT: 60,        // Player card height + gap (52px card + 8px gap)\n        OVERSCAN: 3,            // Extra items above/below viewport\n        THRESHOLD: 15,          // Min players before virtualizing\n        CONTAINER_HEIGHT: 320   // Default container height\n    };\n\n    // Virtual list state\n    var virtualPlayerList = {\n        container: null,\n        items: [],\n        scrollTop: 0,\n        isVirtual: false,\n        topSpacer: null,\n        bottomSpacer: null,\n        contentWrapper: null,\n        scrollHandler: null,\n        resizeHandler: null\n    };\n\n    /**\n     * Initialize virtual list for player list container\n     * @param {Element} container - The player list container element\n     */\n    function initVirtualPlayerList(container) {\n        if (!container) return;\n\n        virtualPlayerList.container = container;\n\n        // Create scroll handler with requestAnimationFrame batching\n        var ticking = false;\n        virtualPlayerList.scrollHandler = function() {\n            virtualPlayerList.scrollTop = container.scrollTop;\n            if (!ticking) {\n                requestAnimationFrame(function() {\n                    renderVirtualPlayerList();\n                    ticking = false;\n                });\n                ticking = true;\n            }\n        };\n\n        // Create resize handler with debouncing\n        var resizeTimeout;\n        virtualPlayerList.resizeHandler = function() {\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(function() {\n                if (virtualPlayerList.isVirtual) {\n                    renderVirtualPlayerList();\n                }\n            }, 100);\n        };\n\n        container.addEventListener('scroll', virtualPlayerList.scrollHandler, { passive: true });\n        window.addEventListener('resize', virtualPlayerList.resizeHandler);\n    }\n\n    /**\n     * Set items for virtual list and render\n     * @param {Array} items - Array of player objects\n     * @param {Function} renderItemFn - Function to render a single item HTML\n     */\n    function setVirtualPlayerListItems(items, renderItemFn) {\n        virtualPlayerList.items = items;\n        virtualPlayerList.renderItem = renderItemFn;\n\n        var container = virtualPlayerList.container;\n        if (!container) return;\n\n        // Preserve scroll position when crossing threshold\n        var prevScrollTop = container.scrollTop;\n        var wasVirtual = virtualPlayerList.isVirtual;\n\n        if (items.length < VIRTUAL_LIST_CONFIG.THRESHOLD) {\n            // Below threshold: render all (non-virtual)\n            virtualPlayerList.isVirtual = false;\n            container.classList.remove('player-list--virtual');\n            renderAllPlayerCards(items, renderItemFn);\n        } else {\n            // Above threshold: use virtual scrolling\n            virtualPlayerList.isVirtual = true;\n            container.classList.add('player-list--virtual');\n            setupVirtualContainer();\n            renderVirtualPlayerList();\n        }\n\n        // Restore scroll position after mode change\n        if (wasVirtual !== virtualPlayerList.isVirtual && prevScrollTop > 0) {\n            container.scrollTop = prevScrollTop;\n            virtualPlayerList.scrollTop = prevScrollTop;\n        }\n    }\n\n    /**\n     * Setup virtual container with spacers\n     */\n    function setupVirtualContainer() {\n        var container = virtualPlayerList.container;\n        if (!container) return;\n\n        // Clear and create structure\n        container.innerHTML = '';\n\n        // Create top spacer\n        var topSpacer = document.createElement('div');\n        topSpacer.className = 'virtual-spacer-top';\n        virtualPlayerList.topSpacer = topSpacer;\n\n        // Create content wrapper for positioned items\n        var contentWrapper = document.createElement('div');\n        contentWrapper.className = 'virtual-content-wrapper';\n        virtualPlayerList.contentWrapper = contentWrapper;\n\n        // Create bottom spacer\n        var bottomSpacer = document.createElement('div');\n        bottomSpacer.className = 'virtual-spacer-bottom';\n        virtualPlayerList.bottomSpacer = bottomSpacer;\n\n        container.appendChild(topSpacer);\n        container.appendChild(contentWrapper);\n        container.appendChild(bottomSpacer);\n    }\n\n    /**\n     * Render visible items in virtual list\n     */\n    function renderVirtualPlayerList() {\n        var config = VIRTUAL_LIST_CONFIG;\n        var items = virtualPlayerList.items;\n        var container = virtualPlayerList.container;\n        var contentWrapper = virtualPlayerList.contentWrapper;\n\n        if (!container || !contentWrapper || !items.length) return;\n\n        var containerHeight = container.clientHeight || config.CONTAINER_HEIGHT;\n        var scrollTop = virtualPlayerList.scrollTop;\n        var itemHeight = config.ITEM_HEIGHT;\n        var overscan = config.OVERSCAN;\n\n        // Calculate visible range\n        var startIdx = Math.max(0, Math.floor(scrollTop / itemHeight) - overscan);\n        var endIdx = Math.min(\n            items.length,\n            Math.ceil((scrollTop + containerHeight) / itemHeight) + overscan\n        );\n\n        // Update spacer heights\n        if (virtualPlayerList.topSpacer) {\n            virtualPlayerList.topSpacer.style.height = (startIdx * itemHeight) + 'px';\n        }\n        if (virtualPlayerList.bottomSpacer) {\n            virtualPlayerList.bottomSpacer.style.height = ((items.length - endIdx) * itemHeight) + 'px';\n        }\n\n        // Build HTML for visible items\n        var html = '';\n        for (var i = startIdx; i < endIdx; i++) {\n            html += virtualPlayerList.renderItem(items[i], i);\n        }\n\n        contentWrapper.innerHTML = html;\n    }\n\n    /**\n     * Render all player cards (non-virtual mode)\n     * @param {Array} items - Player items\n     * @param {Function} renderItemFn - Render function\n     */\n    function renderAllPlayerCards(items, renderItemFn) {\n        var container = virtualPlayerList.container;\n        if (!container) return;\n\n        var html = '';\n        for (var i = 0; i < items.length; i++) {\n            html += renderItemFn(items[i], i);\n        }\n        container.innerHTML = html;\n    }\n\n    /**\n     * Clean up virtual player list\n     */\n    function cleanupVirtualPlayerList() {\n        var container = virtualPlayerList.container;\n        if (container && virtualPlayerList.scrollHandler) {\n            container.removeEventListener('scroll', virtualPlayerList.scrollHandler);\n        }\n        if (virtualPlayerList.resizeHandler) {\n            window.removeEventListener('resize', virtualPlayerList.resizeHandler);\n        }\n        virtualPlayerList.container = null;\n        virtualPlayerList.items = [];\n        virtualPlayerList.isVirtual = false;\n        virtualPlayerList.topSpacer = null;\n        virtualPlayerList.bottomSpacer = null;\n        virtualPlayerList.contentWrapper = null;\n    }\n\n    /**\n     * Check if a streak milestone was just reached\n     * @param {number} oldStreak - Previous streak value\n     * @param {number} newStreak - Current streak value\n     * @returns {number|null} Milestone reached or null\n     */\n    function isStreakMilestone(oldStreak, newStreak) {\n        for (var i = 0; i < STREAK_MILESTONES.length; i++) {\n            var milestone = STREAK_MILESTONES[i];\n            if (oldStreak < milestone && newStreak >= milestone) {\n                return milestone;\n            }\n        }\n        return null;\n    }\n\n    /**\n     * Detect rank changes in leaderboard\n     * @param {Array} newLeaderboard - New leaderboard array\n     * @returns {Object} Map of name -> 'up', 'down', 'new', or undefined\n     */\n    function detectRankChanges(newLeaderboard) {\n        var newOrder = newLeaderboard.map(function(entry) { return entry.name; });\n        var changes = {};\n\n        newOrder.forEach(function(name, newRank) {\n            var oldRank = previousState.leaderboard.indexOf(name);\n            if (oldRank === -1) {\n                changes[name] = 'new';\n            } else if (newRank < oldRank) {\n                changes[name] = 'up';\n            } else if (newRank > oldRank) {\n                changes[name] = 'down';\n            }\n        });\n\n        return changes;\n    }\n\n    /**\n     * Update previous state cache after rendering\n     * @param {Array} players - Current players array\n     * @param {Array} leaderboard - Current leaderboard array\n     */\n    function updatePreviousState(players, leaderboard) {\n        // Update players cache\n        previousState.players = {};\n        players.forEach(function(player) {\n            previousState.players[player.name] = {\n                score: player.score,\n                rank: player.rank || 0,\n                streak: player.streak || 0\n            };\n        });\n\n        // Update leaderboard order\n        if (leaderboard) {\n            previousState.leaderboard = leaderboard.map(function(entry) {\n                return entry.name;\n            });\n        }\n\n        // Mark as initialized after first update (Story 13.2 - reconnect fix)\n        previousState.initialized = true;\n    }\n\n    /**\n     * Reset previous state (called on game end/new game)\n     */\n    function resetPreviousState() {\n        previousState.players = {};\n        previousState.leaderboard = [];\n        previousState.initialized = false;\n    }\n\n    /**\n     * Validate UUID format (basic check)\n     * @param {string} str - String to validate\n     * @returns {boolean} True if valid UUID format\n     */\n    function isValidUUID(str) {\n        if (!str || typeof str !== 'string') return false;\n        // UUID v4 format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx (36 chars with dashes)\n        // Python uuid.uuid4() without dashes: 32 hex chars\n        // Allow both formats\n        return /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(str) ||\n               /^[a-f0-9]{32}$/i.test(str);\n    }\n\n    /**\n     * Attempt to connect with existing session (Story 11.2)\n     * Called when page loads and session cookie exists\n     */\n    function connectWithSession() {\n        var sessionId = getSessionCookie();\n        if (!sessionId || !isValidUUID(sessionId)) {\n            // No session or invalid format, clear and show join form\n            if (sessionId) clearSessionCookie();\n            showView('join-view');\n            return;\n        }\n\n        var wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n        var wsUrl = wsProtocol + '//' + window.location.host + '/beatify/ws';\n\n        ws = new WebSocket(wsUrl);\n\n        ws.onopen = function() {\n            reconnectAttempts = 0;\n            isReconnecting = false;\n            hideReconnectingOverlay();\n\n            // Send reconnect message with session ID\n            ws.send(JSON.stringify({\n                type: 'reconnect',\n                session_id: sessionId\n            }));\n        };\n\n        ws.onmessage = function(event) {\n            try {\n                var data = JSON.parse(event.data);\n                handleServerMessage(data);\n            } catch (e) {\n                console.error('Failed to parse WebSocket message:', e);\n            }\n        };\n\n        ws.onclose = function() {\n            // If we have a playerName (reconnect succeeded), try to reconnect\n            if (playerName && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n                isReconnecting = true;\n                reconnectAttempts++;\n                showReconnectingOverlay();\n                updateReconnectStatus(reconnectAttempts);\n\n                var delay = getReconnectDelay();\n                console.log('WebSocket closed. Reconnecting in ' + delay + 'ms... (attempt ' + reconnectAttempts + ')');\n                setTimeout(function() { connectWithSession(); }, delay);\n            } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {\n                isReconnecting = false;\n                hideReconnectingOverlay();\n                showConnectionLostView();\n            } else {\n                // No playerName means reconnect failed, show join form\n                showView('join-view');\n            }\n        };\n\n        ws.onerror = function(err) {\n            console.error('WebSocket error:', err);\n        };\n    }\n\n    /**\n     * Show welcome back toast (Story 11.2)\n     * @param {string} name - Player name\n     */\n    function showWelcomeBackToast(name) {\n        var indicator = document.getElementById('volume-indicator');\n        if (indicator) {\n            indicator.textContent = 'Welcome back, ' + name + '!';\n            indicator.classList.remove('hidden');\n            indicator.classList.add('is-visible');\n            setTimeout(function() {\n                indicator.classList.remove('is-visible');\n                setTimeout(function() {\n                    indicator.classList.add('hidden');\n                }, 300);\n            }, 2000);\n        }\n    }\n\n    // ============================================\n    // Name Entry & Join Form (Story 3.1)\n    // ============================================\n\n    const MAX_NAME_LENGTH = 20;\n\n    // ============================================\n    // Player List Rendering (Story 3.3)\n    // ============================================\n\n    let previousPlayers = [];\n\n    /**\n     * Escape HTML to prevent XSS\n     * @param {string} text - Text to escape\n     * @returns {string} Escaped text\n     */\n    function escapeHtml(text) {\n        const div = document.createElement('div');\n        div.textContent = text;\n        return div.innerHTML;\n    }\n\n    /**\n     * Render player list in lobby (Story 18.2: Virtual scrolling for 15+ players)\n     * @param {Array} players - Array of player objects\n     */\n    function renderPlayerList(players) {\n        const listEl = document.getElementById('player-list');\n        const countEl = document.getElementById('player-count');\n        const countBadgeEl = document.getElementById('player-count-badge');\n        const playersSummaryEl = document.getElementById('players-summary');\n        const playersEmptyEl = document.getElementById('players-empty');\n        if (!listEl) return;\n        // Guard: ensure players is an array\n        if (!players || !Array.isArray(players)) {\n            players = [];\n        }\n\n        const count = players.length;\n\n        // Update player count (Story 16.3 - i18n) - old format\n        if (countEl) {\n            countEl.textContent = count === 1\n                ? utils.t('lobby.playerJoined')\n                : t('lobby.playersJoined', { count: count });\n        }\n\n        // Update compact count badge (new layout)\n        if (countBadgeEl) {\n            countBadgeEl.textContent = count;\n        }\n\n        // Update players section summary\n        if (playersSummaryEl) {\n            playersSummaryEl.textContent = count;\n        }\n\n        // Show/hide empty state\n        if (playersEmptyEl) {\n            playersEmptyEl.classList.toggle('hidden', count > 0);\n        }\n\n        // Story 11.4: Sort players - connected first, then disconnected\n        var sortedPlayers = players.slice().sort(function(a, b) {\n            if (a.connected !== b.connected) {\n                return a.connected ? -1 : 1;\n            }\n            return 0;  // Preserve order within groups\n        });\n\n        // Find new players by comparing with previous list\n        const previousNames = previousPlayers.map(function(p) { return p.name; });\n        const newNames = sortedPlayers\n            .filter(function(p) { return previousNames.indexOf(p.name) === -1; })\n            .map(function(p) { return p.name; });\n\n        // Story 18.2: Initialize virtual list if not already done\n        if (!virtualPlayerList.container) {\n            initVirtualPlayerList(listEl);\n        }\n\n        // Create render function for player cards\n        var renderPlayerCard = function(player) {\n            var isNew = newNames.indexOf(player.name) !== -1;\n            var isYou = player.name === playerName;\n            var isDisconnected = player.connected === false;\n            var classes = [\n                'player-card',\n                isNew ? 'is-new' : '',\n                isYou ? 'player-card--you' : '',\n                isDisconnected ? 'player-card--disconnected' : ''\n            ].filter(Boolean).join(' ');\n\n            // Story 11.4: Add \"(away)\" badge for disconnected players\n            var awayBadge = isDisconnected ? '<span class=\"away-badge\">(away)</span>' : '';\n\n            return '<div class=\"' + classes + '\" data-player=\"' + escapeHtml(player.name) + '\">' +\n                '<span class=\"player-name\">' +\n                    escapeHtml(player.name) +\n                    (isYou ? '<span class=\"you-badge\">' + utils.t('leaderboard.you') + '</span>' : '') +\n                    awayBadge +\n                '</span>' +\n            '</div>';\n        };\n\n        // Story 18.2: Use virtual list (threshold-based)\n        setVirtualPlayerListItems(sortedPlayers, renderPlayerCard);\n\n        // Remove .is-new class after animation\n        setTimeout(function() {\n            var container = virtualPlayerList.isVirtual ? virtualPlayerList.contentWrapper : listEl;\n            if (!container) return;\n            const newCards = container.querySelectorAll('.is-new');\n            for (let i = 0; i < newCards.length; i++) {\n                newCards[i].classList.remove('is-new');\n            }\n        }, 2000);\n\n        previousPlayers = players.slice();\n    }\n\n    // ============================================\n    // Difficulty Badge (Story 14.1)\n    // ============================================\n\n    /**\n     * Render difficulty badge in lobby and game views\n     * @param {string} difficulty - Difficulty level ('easy', 'normal', or 'hard')\n     */\n    function renderDifficultyBadge(difficulty) {\n        var labelKey = {\n            easy: 'game.difficultyEasy',\n            normal: 'game.difficultyNormal',\n            hard: 'game.difficultyHard'\n        }[difficulty] || 'game.difficultyNormal';\n\n        var label = t(labelKey);\n\n        // Update both lobby and game view badges\n        var lobbyBadge = document.getElementById('lobby-difficulty-badge');\n        var gameBadge = document.getElementById('game-difficulty-badge');\n\n        if (lobbyBadge) {\n            lobbyBadge.textContent = label;\n            lobbyBadge.className = 'difficulty-badge difficulty-badge--' + (difficulty || 'normal');\n        }\n\n        if (gameBadge) {\n            gameBadge.textContent = label;\n            gameBadge.className = 'difficulty-badge difficulty-badge--' + (difficulty || 'normal');\n        }\n    }\n\n    // ============================================\n    // QR Code Sharing (Story 3.4)\n    // ============================================\n\n    let currentJoinUrl = null;\n\n    /**\n     * Render QR code for sharing\n     * @param {string} joinUrl - URL to encode in QR\n     */\n    function renderQRCode(joinUrl) {\n        if (!joinUrl) return;\n        currentJoinUrl = joinUrl;\n\n        var container = document.getElementById('player-qr-code');\n        if (!container) return;\n\n        // Clear previous QR\n        container.innerHTML = '';\n\n        // Generate QR code using qrcodejs (matches admin.js pattern)\n        if (typeof QRCode !== 'undefined') {\n            new QRCode(container, {\n                text: joinUrl,\n                width: 128,\n                height: 128,\n                colorDark: '#000000',\n                colorLight: '#ffffff',\n                correctLevel: QRCode.CorrectLevel.M\n            });\n        } else {\n            container.innerHTML = '<p class=\"status-error\">QR code library not loaded</p>';\n        }\n\n        // Add click handler for modal\n        container.onclick = openQRModal;\n        container.onkeydown = function(e) {\n            if (e.key === 'Enter' || e.key === ' ') {\n                e.preventDefault();\n                openQRModal();\n            }\n        };\n    }\n\n    /**\n     * Open QR modal with enlarged code\n     */\n    function openQRModal() {\n        if (!currentJoinUrl) return;\n\n        var modal = document.getElementById('qr-modal');\n        var modalCode = document.getElementById('qr-modal-code');\n        if (!modal || !modalCode) return;\n\n        // Clear and render larger QR\n        modalCode.innerHTML = '';\n\n        // Generate larger QR code using qrcodejs (matches admin.js pattern)\n        if (typeof QRCode !== 'undefined') {\n            new QRCode(modalCode, {\n                text: currentJoinUrl,\n                width: 256,\n                height: 256,\n                colorDark: '#000000',\n                colorLight: '#ffffff',\n                correctLevel: QRCode.CorrectLevel.M\n            });\n        } else {\n            modalCode.innerHTML = '<p class=\"status-error\">QR code library not loaded</p>';\n        }\n\n        modal.classList.remove('hidden');\n        document.body.style.overflow = 'hidden';\n\n        // Focus close button for accessibility\n        var closeBtn = document.getElementById('qr-modal-close');\n        if (closeBtn) closeBtn.focus();\n    }\n\n    /**\n     * Close QR modal\n     */\n    function closeQRModal() {\n        var modal = document.getElementById('qr-modal');\n        if (modal) {\n            modal.classList.add('hidden');\n            document.body.style.overflow = '';\n        }\n    }\n\n    /**\n     * Setup QR modal event handlers\n     */\n    function setupQRModal() {\n        var modal = document.getElementById('qr-modal');\n        var backdrop = modal ? modal.querySelector('.qr-modal-backdrop') : null;\n        var closeBtn = document.getElementById('qr-modal-close');\n\n        if (backdrop) {\n            backdrop.addEventListener('click', closeQRModal);\n        }\n        if (closeBtn) {\n            closeBtn.addEventListener('click', closeQRModal);\n        }\n\n        // Close on Escape key\n        document.addEventListener('keydown', function(e) {\n            if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {\n                closeQRModal();\n            }\n        });\n    }\n\n    // ============================================\n    // Invite Modal (Story 16.5)\n    // ============================================\n\n    /**\n     * Open invite modal with QR code and URL for late joiners\n     */\n    function openInviteModal() {\n        if (!currentJoinUrl) return;\n\n        var modal = document.getElementById('invite-modal');\n        var modalCode = document.getElementById('invite-modal-code');\n        var urlInput = document.getElementById('invite-modal-url');\n        if (!modal || !modalCode) return;\n\n        // Clear and render QR code\n        modalCode.innerHTML = '';\n\n        if (typeof QRCode !== 'undefined') {\n            new QRCode(modalCode, {\n                text: currentJoinUrl,\n                width: 256,\n                height: 256,\n                colorDark: '#000000',\n                colorLight: '#ffffff',\n                correctLevel: QRCode.CorrectLevel.M\n            });\n        } else {\n            modalCode.innerHTML = '<p class=\"status-error\">QR code library not loaded</p>';\n        }\n\n        // Set URL in input field\n        if (urlInput) {\n            urlInput.value = currentJoinUrl;\n        }\n\n        modal.classList.remove('hidden');\n        document.body.style.overflow = 'hidden';\n\n        // Focus close button for accessibility\n        var closeBtn = document.getElementById('invite-modal-close');\n        if (closeBtn) closeBtn.focus();\n    }\n\n    /**\n     * Close invite modal\n     */\n    function closeInviteModal() {\n        var modal = document.getElementById('invite-modal');\n        if (modal) {\n            modal.classList.add('hidden');\n            document.body.style.overflow = '';\n        }\n        // Hide copy feedback\n        var feedback = document.getElementById('invite-copy-feedback');\n        if (feedback) feedback.classList.add('hidden');\n    }\n\n    /**\n     * Copy join URL to clipboard\n     */\n    function copyJoinUrl() {\n        var urlInput = document.getElementById('invite-modal-url');\n        var feedback = document.getElementById('invite-copy-feedback');\n        if (!urlInput || !currentJoinUrl) return;\n\n        // Use Clipboard API if available, otherwise fallback to select/copy\n        if (navigator.clipboard && navigator.clipboard.writeText) {\n            navigator.clipboard.writeText(currentJoinUrl).then(function() {\n                showCopyFeedback(feedback);\n            }).catch(function() {\n                fallbackCopy(urlInput, feedback);\n            });\n        } else {\n            fallbackCopy(urlInput, feedback);\n        }\n    }\n\n    /**\n     * Fallback copy method for older browsers\n     * @param {HTMLInputElement} urlInput - The input element\n     * @param {HTMLElement} feedback - The feedback element\n     */\n    function fallbackCopy(urlInput, feedback) {\n        urlInput.select();\n        urlInput.setSelectionRange(0, 99999); // For mobile\n        try {\n            document.execCommand('copy');\n            showCopyFeedback(feedback);\n        } catch (e) {\n            console.warn('[Beatify] Copy failed:', e);\n        }\n    }\n\n    /**\n     * Show copy success feedback\n     * @param {HTMLElement} feedback - The feedback element\n     */\n    function showCopyFeedback(feedback) {\n        if (!feedback) return;\n        feedback.classList.remove('hidden');\n        // Auto-hide after animation\n        setTimeout(function() {\n            feedback.classList.add('hidden');\n        }, 2000);\n    }\n\n    /**\n     * Setup invite modal event handlers\n     */\n    function setupInviteModal() {\n        var modal = document.getElementById('invite-modal');\n        var backdrop = modal ? modal.querySelector('.invite-modal-backdrop') : null;\n        var closeBtn = document.getElementById('invite-modal-close');\n        var inviteBtn = document.getElementById('invite-players-btn');\n        var copyBtn = document.getElementById('invite-copy-btn');\n\n        if (backdrop) {\n            backdrop.addEventListener('click', closeInviteModal);\n        }\n        if (closeBtn) {\n            closeBtn.addEventListener('click', closeInviteModal);\n        }\n        if (inviteBtn) {\n            inviteBtn.addEventListener('click', openInviteModal);\n        }\n        if (copyBtn) {\n            copyBtn.addEventListener('click', copyJoinUrl);\n        }\n\n        // Close on Escape key\n        document.addEventListener('keydown', function(e) {\n            if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {\n                closeInviteModal();\n            }\n        });\n    }\n\n    // ============================================\n    // Countdown Timer (Story 4.2)\n    // ============================================\n\n    let countdownInterval = null;\n\n    /**\n     * Start countdown timer\n     * @param {number} deadline - Server deadline timestamp in milliseconds\n     */\n    function startCountdown(deadline) {\n        // Clear any existing countdown\n        stopCountdown();\n\n        var timerElement = document.getElementById('timer');\n        if (!timerElement) return;\n\n        // Remove previous state classes\n        timerElement.classList.remove('timer--warning', 'timer--critical');\n\n        function updateCountdown() {\n            var now = Date.now();\n            var remaining = Math.max(0, Math.ceil((deadline - now) / 1000));\n\n            timerElement.textContent = remaining;\n\n            // Update timer color based on remaining time\n            if (remaining <= 5) {\n                timerElement.classList.remove('timer--warning');\n                timerElement.classList.add('timer--critical');\n            } else if (remaining <= 10) {\n                timerElement.classList.remove('timer--critical');\n                timerElement.classList.add('timer--warning');\n            } else {\n                timerElement.classList.remove('timer--warning', 'timer--critical');\n            }\n\n            // ARIA announcements at key moments (Story 9.7)\n            if (remaining === 10) {\n                timerElement.setAttribute('aria-label', '10 seconds remaining');\n            } else if (remaining === 5) {\n                timerElement.setAttribute('aria-label', '5 seconds!');\n            } else if (remaining === 0) {\n                timerElement.setAttribute('aria-label', 'Time is up!');\n            } else {\n                timerElement.setAttribute('aria-label', 'Time remaining: ' + remaining + ' seconds');\n            }\n\n            // Stop countdown when reaching 0\n            if (remaining <= 0) {\n                stopCountdown();\n            }\n        }\n\n        // Initial update immediately\n        updateCountdown();\n\n        // Then update every second\n        countdownInterval = setInterval(updateCountdown, 1000);\n    }\n\n    /**\n     * Stop countdown timer\n     */\n    function stopCountdown() {\n        if (countdownInterval) {\n            clearInterval(countdownInterval);\n            countdownInterval = null;\n        }\n    }\n\n    /**\n     * Update game view with round data\n     * @param {Object} data - State data from server\n     */\n    function updateGameView(data) {\n        // Update round indicator\n        var currentRound = document.getElementById('current-round');\n        var totalRounds = document.getElementById('total-rounds');\n        var lastRoundBanner = document.getElementById('last-round-banner');\n\n        if (currentRound) currentRound.textContent = data.round || 1;\n        if (totalRounds) totalRounds.textContent = data.total_rounds || 10;\n\n        // Show/hide last round banner\n        if (lastRoundBanner) {\n            if (data.last_round) {\n                lastRoundBanner.classList.remove('hidden');\n            } else {\n                lastRoundBanner.classList.add('hidden');\n            }\n        }\n\n        // Update album cover\n        var albumCover = document.getElementById('album-cover');\n        var albumLoading = document.getElementById('album-loading');\n\n        if (albumCover && data.song) {\n            // Show loading state\n            if (albumLoading) albumLoading.classList.remove('hidden');\n\n            var newSrc = data.song.album_art || '/beatify/static/img/no-artwork.svg';\n\n            // Handle image load\n            albumCover.onload = function() {\n                if (albumLoading) albumLoading.classList.add('hidden');\n            };\n\n            // Handle image error - fallback to placeholder\n            albumCover.onerror = function() {\n                albumCover.src = '/beatify/static/img/no-artwork.svg';\n                if (albumLoading) albumLoading.classList.add('hidden');\n            };\n\n            albumCover.src = newSrc;\n        }\n\n        // Render submission tracker\n        renderSubmissionTracker(data.players);\n\n        // Update leaderboard (Story 5.5)\n        if (data.leaderboard) {\n            updateLeaderboard(data, 'leaderboard-list');\n        }\n\n        // Update steal UI (Story 15.3)\n        updateStealUI(data.players);\n\n        // Render artist challenge (Story 20.5)\n        if (data.artist_challenge !== undefined) {\n            renderArtistChallenge(data.artist_challenge, 'PLAYING');\n        }\n    }\n\n    // ============================================\n    // Submission Tracker (Story 4.4)\n    // ============================================\n\n    /**\n     * Get initials from player name\n     * @param {string} name - Player name\n     * @returns {string} Initials (1-2 characters)\n     */\n    function getInitials(name) {\n        if (!name) return '?';\n        var trimmed = name.trim();\n        if (!trimmed) return '?';\n\n        // Handle hyphenated names: \"Mary-Jane\" -> \"MJ\"\n        var parts = trimmed.split(/[\\s-]+/).filter(Boolean);\n        if (parts.length >= 2) {\n            return (parts[0][0] + parts[1][0]).toUpperCase();\n        }\n        // Single word: take first 2 chars, or 1 if single char name\n        return trimmed.slice(0, Math.min(2, trimmed.length)).toUpperCase();\n    }\n\n    /**\n     * Render submission tracker showing who has submitted\n     * @param {Array} players - Array of player objects\n     */\n    function renderSubmissionTracker(players) {\n        var tracker = document.getElementById('submission-tracker');\n        var container = document.getElementById('submitted-players');\n\n        if (!tracker || !container) return;\n\n        var playerList = players || [];\n        var submittedCount = playerList.filter(function(p) {\n            return p.submitted;\n        }).length;\n        var totalCount = playerList.length;\n\n        // Check if all submitted\n        var allSubmitted = submittedCount === totalCount && totalCount > 0;\n        tracker.classList.toggle('all-submitted', allSubmitted);\n\n        // Render player indicators with bet/steal badges\n        container.innerHTML = playerList.map(function(player) {\n            var initials = getInitials(player.name);\n            var isCurrentPlayer = player.name === playerName;\n            var isDisconnected = player.connected === false;\n            var classes = [\n                'player-indicator',\n                player.submitted ? 'is-submitted' : '',\n                isCurrentPlayer ? 'is-current-player' : '',\n                isDisconnected ? 'player-indicator--disconnected' : ''\n            ].filter(Boolean).join(' ');\n\n            // Build badge HTML\n            var badges = '';\n            if (player.steal_used) {\n                badges += '<span class=\"player-badge player-badge--steal\">\uD83E\uDD77</span>';\n            }\n            if (player.bet) {\n                badges += '<span class=\"player-badge player-badge--bet\">\uD83C\uDFB2</span>';\n            }\n\n            return '<div class=\"' + classes + '\">' +\n                badges +\n                '<div class=\"player-avatar\">' +\n                    '<span class=\"player-initials\">' + escapeHtml(initials) + '</span>' +\n                '</div>' +\n                '<span class=\"player-name\">' + escapeHtml(player.name) + '</span>' +\n            '</div>';\n        }).join('');\n    }\n\n    // ============================================\n    // Leaderboard (Story 5.5)\n    // ============================================\n\n    /**\n     * Update leaderboard display (Story 18.1: Lazy loading for 10+ players)\n     * @param {Object} data - State data containing leaderboard\n     * @param {string} targetListId - ID of list container (for different views)\n     * @param {boolean} isRevealPhase - True if rendering during REVEAL phase (animate scores)\n     */\n    function updateLeaderboard(data, targetListId, isRevealPhase) {\n        var leaderboard = data.leaderboard || [];\n        var listEl = document.getElementById(targetListId || 'leaderboard-list');\n        if (!listEl) return;\n\n        // Story 13.2: Skip animations on first state (reconnect case)\n        var shouldAnimate = isRevealPhase && isPreviousStateInitialized();\n\n        // Detect rank changes using Story 13.2 utilities (only if animating)\n        var rankChanges = shouldAnimate ? detectRankChanges(leaderboard) : {};\n\n        // Mark is_current client-side and add metadata for rendering\n        leaderboard.forEach(function(entry) {\n            entry.is_current = (entry.name === playerName);\n\n            // Add rank change class for renderLeaderboardEntry\n            var rankChange = rankChanges[entry.name];\n            if (rankChange) {\n                entry._rankChange = rankChange;\n            }\n\n            // Get previous score for animation (Story 13.2)\n            var prevPlayer = previousState.players[entry.name];\n            var prevScore = prevPlayer ? prevPlayer.score : entry.score;\n            entry._prevScore = prevScore;\n            entry._displayScore = isRevealPhase ? prevScore : entry.score;\n        });\n\n        // Smart compression for >10 players (Story 9.5)\n        var displayList = compressLeaderboard(leaderboard, playerName);\n\n        // Story 18.1: Use lazy loading for large player lists\n        var useLazyLoading = leaderboard.length >= LEADERBOARD_LAZY_CONFIG.MIN_PLAYERS_FOR_LAZY;\n\n        if (useLazyLoading) {\n            // Initialize observer if not already done\n            if (!lazyLeaderboardState.observer) {\n                initLeaderboardObserver(listEl);\n            }\n\n            // Store full data for lazy rendering\n            lazyLeaderboardState.fullData = displayList;\n            lazyLeaderboardState.isLazyEnabled = true;\n            lazyLeaderboardState.listEl = listEl;\n\n            // Calculate initial visible range centered on current player\n            lazyLeaderboardState.visibleRange = calculateInitialVisibleRange(displayList, playerName);\n\n            // Render visible range with spacers\n            renderLazyLeaderboardRange();\n        } else {\n            // Disable lazy loading for small lists\n            lazyLeaderboardState.isLazyEnabled = false;\n\n            // Standard rendering for small lists\n            var html = '';\n            displayList.forEach(function(entry) {\n                html += renderLeaderboardEntry(entry);\n            });\n\n            listEl.innerHTML = html;\n        }\n\n        // Store entries that need score animation (Story 13.2)\n        var scoreAnimations = [];\n        if (shouldAnimate) {\n            displayList.forEach(function(entry) {\n                if (!entry.separator && entry._prevScore !== entry.score) {\n                    scoreAnimations.push({\n                        name: entry.name,\n                        prevScore: entry._prevScore,\n                        newScore: entry.score\n                    });\n                }\n            });\n        }\n\n        // Animate score values within leaderboard entries (Story 13.2)\n        if (shouldAnimate && scoreAnimations.length > 0) {\n            // Use requestAnimationFrame for batched DOM updates (Story 18.1)\n            requestAnimationFrame(function() {\n                // Build a map of name -> entry element for safe lookup (avoids CSS selector injection)\n                var entryMap = {};\n                var entries = listEl.querySelectorAll('.leaderboard-entry[data-name]');\n                for (var i = 0; i < entries.length; i++) {\n                    var entry = entries[i];\n                    var name = entry.getAttribute('data-name');\n                    if (name) {\n                        entryMap[name] = entry;\n                    }\n                }\n\n                scoreAnimations.forEach(function(anim) {\n                    var entryEl = entryMap[anim.name];\n                    if (entryEl) {\n                        var scoreEl = entryEl.querySelector('.entry-score');\n                        if (scoreEl) {\n                            animateValue(scoreEl, anim.prevScore, anim.newScore, 500);\n                        }\n                    }\n                });\n            });\n        }\n\n        // Scroll to current player if many players\n        if (leaderboard.length > 8) {\n            scrollToCurrentPlayer(listEl);\n        }\n\n        // Update quick indicator\n        updateYouIndicator(leaderboard);\n\n        // Update leaderboard summary badge for collapsed view\n        updateLeaderboardSummary(leaderboard);\n\n        // Update previous state for next comparison (Story 13.2)\n        updatePreviousState(data.players || [], leaderboard);\n    }\n\n    /**\n     * Compress leaderboard for display when >10 players (Story 9.5)\n     * Shows: top 5, separator, current player if not in top/bottom, separator, bottom 3\n     * @param {Array} players - Full leaderboard\n     * @param {string} currentPlayerName - Name of current player\n     * @returns {Array} Compressed display list\n     */\n    function compressLeaderboard(players, currentPlayerName) {\n        if (players.length <= 10) return players;\n\n        var top5 = players.slice(0, 5);\n        var bottom3 = players.slice(-3);\n        var currentIdx = -1;\n\n        // Find current player index\n        for (var i = 0; i < players.length; i++) {\n            if (players[i].name === currentPlayerName) {\n                currentIdx = i;\n                break;\n            }\n        }\n\n        // If current player in top 5 or bottom 3, no middle section needed\n        if (currentIdx < 5 || currentIdx >= players.length - 3) {\n            return [].concat(top5, [{ separator: true }], bottom3);\n        }\n\n        // Show current player in middle\n        return [].concat(\n            top5,\n            [{ separator: true }],\n            [players[currentIdx]],\n            [{ separator: true }],\n            bottom3\n        );\n    }\n\n    /**\n     * Scroll leaderboard to show current player\n     * @param {Element} listEl - Leaderboard list element\n     */\n    function scrollToCurrentPlayer(listEl) {\n        var currentEntry = listEl.querySelector('.leaderboard-entry.is-current');\n        if (currentEntry) {\n            currentEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });\n        }\n    }\n\n    /**\n     * Update \"You: #X\" quick indicator\n     * @param {Array} leaderboard - Leaderboard entries\n     */\n    function updateYouIndicator(leaderboard) {\n        var youEl = document.getElementById('leaderboard-you');\n        var currentPlayer = leaderboard.find(function(e) { return e.is_current; });\n        if (youEl && currentPlayer) {\n            youEl.textContent = utils.t('leaderboard.you') + ' #' + currentPlayer.rank;\n            youEl.classList.remove('hidden');\n        }\n    }\n\n    /**\n     * Setup leaderboard toggle behavior (collapsible section pattern)\n     */\n    function setupLeaderboardToggle() {\n        var toggle = document.getElementById('leaderboard-toggle');\n        var leaderboard = document.getElementById('game-leaderboard');\n        if (toggle && leaderboard && !toggle.hasAttribute('data-initialized')) {\n            toggle.setAttribute('data-initialized', 'true');\n            toggle.addEventListener('click', function() {\n                var isCollapsed = leaderboard.classList.toggle('collapsed');\n                toggle.setAttribute('aria-expanded', !isCollapsed);\n            });\n        }\n    }\n\n    /**\n     * Update leaderboard summary badge with leader info\n     * @param {Array} leaderboard - Leaderboard array\n     * @param {string} summaryId - Optional specific summary element ID\n     */\n    function updateLeaderboardSummary(leaderboard, summaryId) {\n        // Update both game and reveal summaries if no specific ID\n        var summaryIds = summaryId ? [summaryId] : ['leaderboard-summary', 'reveal-leaderboard-summary'];\n\n        summaryIds.forEach(function(id) {\n            var summaryEl = document.getElementById(id);\n            if (!summaryEl || !leaderboard || leaderboard.length === 0) return;\n\n            var leader = leaderboard[0];\n            if (leader) {\n                summaryEl.textContent = leader.name + ': ' + leader.score;\n            }\n        });\n    }\n\n    /**\n     * Setup reveal leaderboard toggle behavior (collapsible section pattern)\n     */\n    function setupRevealLeaderboardToggle() {\n        var toggle = document.getElementById('reveal-leaderboard-toggle');\n        var leaderboard = document.getElementById('reveal-leaderboard');\n        if (toggle && leaderboard && !toggle.hasAttribute('data-initialized')) {\n            toggle.setAttribute('data-initialized', 'true');\n            toggle.addEventListener('click', function() {\n                var isCollapsed = leaderboard.classList.toggle('collapsed');\n                toggle.setAttribute('aria-expanded', !isCollapsed);\n            });\n        }\n    }\n\n    /**\n     * Setup toggle for round analytics section (collapsed by default)\n     */\n    function setupRoundAnalyticsToggle() {\n        var toggle = document.getElementById('round-analytics-toggle');\n        var section = document.getElementById('round-analytics');\n        if (toggle && section && !toggle.hasAttribute('data-initialized')) {\n            toggle.setAttribute('data-initialized', 'true');\n            toggle.addEventListener('click', function() {\n                var isCollapsed = section.classList.toggle('collapsed');\n                toggle.setAttribute('aria-expanded', !isCollapsed);\n            });\n        }\n    }\n\n    // ============================================\n    // Year Selector & Submission (Story 4.3)\n    // ============================================\n\n    let hasSubmitted = false;\n    let betActive = false;  // Betting state (Story 5.3)\n    let currentRoundNumber = 0;  // Track round to detect new rounds\n    let hasStealAvailable = false;  // Steal power-up state (Story 15.3)\n\n    // Artist Challenge state (Story 20.5)\n    var artistChallengeComplete = false;\n    var pendingArtistGuess = null;\n    var winningArtist = null;  // Track locally which artist won\n    var ARTIST_DEBOUNCE_MS = 300;\n    var lastArtistGuessTime = 0;\n\n    /**\n     * Initialize year selector interaction\n     */\n    function initYearSelector() {\n        var slider = document.getElementById('year-slider');\n        var yearDisplay = document.getElementById('selected-year');\n\n        if (!slider || !yearDisplay) return;\n\n        // Update display on slider change\n        slider.addEventListener('input', function() {\n            yearDisplay.textContent = this.value;\n        });\n\n        // Bet toggle handler (Story 5.3)\n        var betToggle = document.getElementById('bet-toggle');\n        if (betToggle) {\n            betToggle.addEventListener('click', function() {\n                if (hasSubmitted) return;\n                betActive = !betActive;\n                betToggle.classList.toggle('is-active', betActive);\n            });\n        }\n\n        // Submit button handler\n        var submitBtn = document.getElementById('submit-btn');\n        if (submitBtn) {\n            submitBtn.addEventListener('click', handleSubmitGuess);\n        }\n\n        // Steal button handler (Story 15.3)\n        var stealBtn = document.getElementById('steal-btn');\n        if (stealBtn) {\n            stealBtn.addEventListener('click', handleStealClick);\n        }\n\n        // Steal modal close handler\n        var stealModalClose = document.getElementById('steal-modal-close');\n        if (stealModalClose) {\n            stealModalClose.addEventListener('click', closeStealModal);\n        }\n\n        // Steal modal backdrop click to close\n        var stealModal = document.getElementById('steal-modal');\n        if (stealModal) {\n            var backdrop = stealModal.querySelector('.steal-modal-backdrop');\n            if (backdrop) {\n                backdrop.addEventListener('click', closeStealModal);\n            }\n        }\n    }\n\n    /**\n     * Handle guess submission\n     */\n    function handleSubmitGuess() {\n        if (hasSubmitted) return;\n\n        var slider = document.getElementById('year-slider');\n        var submitBtn = document.getElementById('submit-btn');\n\n        if (!slider || !submitBtn) return;\n\n        var year = parseInt(slider.value, 10);\n\n        // Disable and show loading\n        submitBtn.disabled = true;\n        submitBtn.classList.add('is-loading');\n\n        // Send submission via WebSocket (with bet flag - Story 5.3)\n        if (ws && ws.readyState === WebSocket.OPEN) {\n            ws.send(JSON.stringify({\n                type: 'submit',\n                year: year,\n                bet: betActive\n            }));\n        } else {\n            // WebSocket not connected\n            showSubmitError('Connection lost. Please refresh.');\n            submitBtn.disabled = false;\n            submitBtn.classList.remove('is-loading');\n        }\n    }\n\n    /**\n     * Handle server acknowledgment of submission\n     */\n    function handleSubmitAck() {\n        hasSubmitted = true;\n\n        var yearSelector = document.getElementById('year-selector');\n        var submitBtn = document.getElementById('submit-btn');\n        var confirmation = document.getElementById('submitted-confirmation');\n        var betToggle = document.getElementById('bet-toggle');\n\n        if (yearSelector) {\n            yearSelector.classList.add('is-submitted');\n        }\n\n        if (submitBtn) {\n            submitBtn.classList.add('hidden');\n        }\n\n        // Hide bet toggle after submission (Story 5.3)\n        if (betToggle) {\n            betToggle.classList.add('hidden');\n        }\n\n        if (confirmation) {\n            confirmation.classList.remove('hidden');\n        }\n    }\n\n    /**\n     * Handle submission error\n     * @param {Object} data - Error data from server\n     */\n    function handleSubmitError(data) {\n        var submitBtn = document.getElementById('submit-btn');\n\n        if (submitBtn) {\n            submitBtn.disabled = false;\n            submitBtn.classList.remove('is-loading');\n        }\n\n        if (data.code === 'ROUND_EXPIRED') {\n            showSubmitError(\"Time's up!\");\n            // Disable further attempts\n            hasSubmitted = true;\n            if (submitBtn) submitBtn.disabled = true;\n        } else if (data.code === 'ALREADY_SUBMITTED') {\n            // Already submitted, update UI\n            handleSubmitAck();\n        } else {\n            showSubmitError(data.message || 'Submission failed');\n        }\n    }\n\n    /**\n     * Show error on submit button\n     * @param {string} message - Error message\n     */\n    function showSubmitError(message) {\n        var submitBtn = document.getElementById('submit-btn');\n        if (submitBtn) {\n            submitBtn.textContent = message;\n            submitBtn.classList.add('is-error');\n            setTimeout(function() {\n                submitBtn.textContent = utils.t('game.submitGuess');\n                submitBtn.classList.remove('is-error');\n            }, 2000);\n        }\n    }\n\n    /**\n     * Reset submission state for new round\n     */\n    function resetSubmissionState() {\n        hasSubmitted = false;\n        betActive = false;  // Reset bet (Story 5.3)\n\n        var yearSelector = document.getElementById('year-selector');\n        var submitBtn = document.getElementById('submit-btn');\n        var confirmation = document.getElementById('submitted-confirmation');\n        var slider = document.getElementById('year-slider');\n        var betToggle = document.getElementById('bet-toggle');\n\n        if (yearSelector) {\n            yearSelector.classList.remove('is-submitted');\n        }\n\n        if (submitBtn) {\n            submitBtn.disabled = false;\n            submitBtn.classList.remove('hidden', 'is-loading', 'is-error');\n            submitBtn.textContent = utils.t('game.submitGuess');\n        }\n\n        // Reset bet toggle (Story 5.3)\n        if (betToggle) {\n            betToggle.classList.remove('hidden', 'is-active');\n        }\n\n        if (confirmation) {\n            confirmation.classList.add('hidden');\n        }\n\n        // Reset slider to middle value\n        if (slider) {\n            slider.value = 1990;\n            var yearDisplay = document.getElementById('selected-year');\n            if (yearDisplay) yearDisplay.textContent = '1990';\n        }\n\n        // Reset steal UI (Story 15.3)\n        hasStealAvailable = false;\n        hideStealUI();\n\n        // Reset artist challenge state (Story 20.5)\n        resetArtistChallengeState();\n    }\n\n    // ============================================\n    // Artist Challenge (Story 20.5)\n    // ============================================\n\n    /**\n     * Render artist challenge UI\n     * @param {Object} artistChallenge - Artist challenge data from server\n     * @param {string} phase - Current game phase (PLAYING, REVEAL)\n     */\n    function renderArtistChallenge(artistChallenge, phase) {\n        var container = document.getElementById('artist-challenge-container');\n        if (!container) return;\n\n        // Hide if no challenge active\n        if (!artistChallenge || !artistChallenge.options) {\n            container.classList.add('hidden');\n            return;\n        }\n\n        container.classList.remove('hidden');\n\n        var optionsEl = document.getElementById('artist-options');\n        var resultEl = document.getElementById('artist-result');\n\n        // Only rebuild buttons if options changed\n        var currentOptions = Array.from(optionsEl.querySelectorAll('.artist-option-btn'))\n            .map(function(btn) { return btn.dataset.artist; });\n        var newOptions = artistChallenge.options;\n\n        if (JSON.stringify(currentOptions) !== JSON.stringify(newOptions)) {\n            optionsEl.innerHTML = '';\n            newOptions.forEach(function(artist, index) {\n                var btn = document.createElement('button');\n                btn.className = 'artist-option-btn';\n                btn.dataset.artist = artist;\n                btn.dataset.index = index;\n                btn.textContent = artist;\n                btn.addEventListener('click', function() {\n                    handleArtistGuess(artist);\n                });\n                optionsEl.appendChild(btn);\n            });\n        }\n\n        // Handle winner state\n        if (artistChallenge.winner) {\n            var buttons = optionsEl.querySelectorAll('.artist-option-btn');\n            buttons.forEach(function(btn) {\n                btn.classList.add('is-disabled');\n                btn.classList.remove('is-loading', 'is-wrong');\n\n                // Highlight winning artist (tracked locally or from REVEAL phase)\n                var correctArtist = artistChallenge.correct_artist || winningArtist;\n                if (correctArtist && btn.dataset.artist === correctArtist) {\n                    btn.classList.add('is-winner');\n                }\n            });\n\n            // Show result\n            if (artistChallenge.winner === playerName) {\n                resultEl.textContent = utils.t('artistChallenge.youGotIt') || 'You got it! +5 points';\n                resultEl.className = 'artist-result is-winner';\n            } else {\n                var msg = (utils.t('artistChallenge.someoneBeatYou') || '{winner} got it first!')\n                    .replace('{winner}', artistChallenge.winner);\n                resultEl.textContent = msg;\n                resultEl.className = 'artist-result is-late';\n            }\n            resultEl.classList.remove('hidden');\n            artistChallengeComplete = true;\n        } else if (!artistChallengeComplete) {\n            resultEl.classList.add('hidden');\n        }\n    }\n\n    /**\n     * Handle artist guess button click\n     * @param {string} artist - The artist name that was clicked\n     */\n    function handleArtistGuess(artist) {\n        var now = Date.now();\n        if (now - lastArtistGuessTime < ARTIST_DEBOUNCE_MS) return;\n        lastArtistGuessTime = now;\n\n        if (artistChallengeComplete) return;\n\n        // Visual feedback\n        var btn = document.querySelector('.artist-option-btn[data-artist=\"' + CSS.escape(artist) + '\"]');\n        if (btn) {\n            btn.classList.add('is-loading');\n        }\n\n        pendingArtistGuess = artist;\n\n        try {\n            if (ws && ws.readyState === WebSocket.OPEN) {\n                ws.send(JSON.stringify({\n                    type: 'artist_guess',\n                    artist: artist\n                }));\n            }\n        } catch (e) {\n            console.error('Artist guess send failed:', e);\n            if (btn) {\n                btn.classList.remove('is-loading');\n            }\n            pendingArtistGuess = null;\n        }\n    }\n\n    /**\n     * Handle artist_guess_ack from server (Story 20.3 protocol)\n     * @param {Object} data - Ack response from server\n     */\n    function handleArtistGuessAck(data) {\n        var btn = pendingArtistGuess\n            ? document.querySelector('.artist-option-btn[data-artist=\"' + CSS.escape(pendingArtistGuess) + '\"]')\n            : null;\n\n        if (data.correct && data.first) {\n            // We won!\n            winningArtist = pendingArtistGuess;  // Track locally\n            if (btn) {\n                btn.classList.remove('is-loading');\n                btn.classList.add('is-correct');\n                var badge = document.createElement('span');\n                badge.className = 'artist-points-badge';\n                badge.textContent = '+' + (data.bonus_points || 5);\n                btn.appendChild(badge);\n            }\n            disableAllArtistButtons();\n            var bonusText = (utils.t('artistChallenge.youGotIt') || 'You got it! +{points} points')\n                .replace('{points}', data.bonus_points || 5);\n            showArtistResult(bonusText, true);\n            artistChallengeComplete = true;\n\n        } else if (data.correct && !data.first) {\n            // Correct but late\n            winningArtist = pendingArtistGuess;  // Track correct artist\n            if (btn) {\n                btn.classList.remove('is-loading');\n                btn.classList.add('is-correct');\n            }\n            disableAllArtistButtons();\n            var msg = (utils.t('artistChallenge.someoneBeatYou') || '{winner} got it first!')\n                .replace('{winner}', data.winner || 'Someone');\n            showArtistResult(msg, false);\n            artistChallengeComplete = true;\n\n        } else {\n            // Wrong guess - lock selection (one guess only)\n            if (btn) {\n                btn.classList.remove('is-loading');\n                btn.classList.add('is-wrong', 'is-selected');\n            }\n            disableAllArtistButtons();\n            showArtistResult(utils.t('artistChallenge.wrongGuess') || 'Wrong guess!', false);\n            artistChallengeComplete = true;\n        }\n\n        pendingArtistGuess = null;\n    }\n\n    /**\n     * Disable all artist option buttons\n     */\n    function disableAllArtistButtons() {\n        document.querySelectorAll('.artist-option-btn').forEach(function(btn) {\n            btn.classList.add('is-disabled');\n            btn.classList.remove('is-loading');\n        });\n    }\n\n    /**\n     * Show artist challenge result message\n     * @param {string} message - Result message to display\n     * @param {boolean} isWinner - Whether current player won\n     */\n    function showArtistResult(message, isWinner) {\n        var resultEl = document.getElementById('artist-result');\n        if (resultEl) {\n            resultEl.textContent = message;\n            resultEl.className = 'artist-result ' + (isWinner ? 'is-winner' : 'is-late');\n            resultEl.classList.remove('hidden');\n        }\n    }\n\n    /**\n     * Reset artist challenge state for new round\n     */\n    function resetArtistChallengeState() {\n        artistChallengeComplete = false;\n        pendingArtistGuess = null;\n        winningArtist = null;\n\n        var container = document.getElementById('artist-challenge-container');\n        if (container) container.classList.add('hidden');\n\n        var optionsEl = document.getElementById('artist-options');\n        if (optionsEl) optionsEl.innerHTML = '';\n\n        var resultEl = document.getElementById('artist-result');\n        if (resultEl) {\n            resultEl.classList.add('hidden');\n            resultEl.className = 'artist-result hidden';\n        }\n    }\n\n    /**\n     * Render artist challenge reveal section (Story 20.6)\n     * @param {Object} artistChallenge - Artist challenge data with correct_artist and winner\n     * @param {string} currentPlayerName - Current player's name for comparison\n     */\n    function renderArtistReveal(artistChallenge, currentPlayerName) {\n        var section = document.getElementById('artist-reveal-section');\n        if (!section) return;\n\n        // Hide if no artist challenge data\n        if (!artistChallenge || !artistChallenge.correct_artist) {\n            section.classList.add('hidden');\n            return;\n        }\n\n        // Show section\n        section.classList.remove('hidden');\n\n        // Display correct artist\n        var nameEl = document.getElementById('artist-reveal-name');\n        if (nameEl) {\n            nameEl.textContent = artistChallenge.correct_artist;\n        }\n\n        // Display winner info\n        var winnerEl = document.getElementById('artist-reveal-winner');\n        if (winnerEl) {\n            if (artistChallenge.winner) {\n                winnerEl.classList.remove('hidden');\n                if (artistChallenge.winner === currentPlayerName) {\n                    // Current player won\n                    winnerEl.textContent = utils.t('artistChallenge.youGotIt') || 'You got it! +5 points';\n                    winnerEl.className = 'artist-reveal-winner is-you';\n                } else {\n                    // Someone else won\n                    var msg = (utils.t('artistChallenge.winnerWas') || '{winner} got it first!')\n                        .replace('{winner}', artistChallenge.winner);\n                    winnerEl.textContent = msg;\n                    winnerEl.className = 'artist-reveal-winner is-other';\n                }\n            } else {\n                // No winner\n                winnerEl.textContent = utils.t('artistChallenge.noWinner') || 'No one guessed the artist';\n                winnerEl.className = 'artist-reveal-winner artist-reveal-no-winner';\n                winnerEl.classList.remove('hidden');\n            }\n        }\n    }\n\n    // ============================================\n    // Steal Power-up (Story 15.3)\n    // ============================================\n\n    /**\n     * Update steal UI based on player state\n     * @param {Array} players - Array of player objects\n     */\n    function updateStealUI(players) {\n        if (!playerName || !players) return;\n\n        // Find current player's data\n        var currentPlayer = players.find(function(p) {\n            return p.name === playerName;\n        });\n\n        if (!currentPlayer) return;\n\n        hasStealAvailable = currentPlayer.steal_available && !hasSubmitted;\n\n        var stealIndicator = document.getElementById('steal-indicator');\n        var stealBtn = document.getElementById('steal-btn');\n\n        if (hasStealAvailable) {\n            // Show steal indicator and button\n            if (stealIndicator) stealIndicator.classList.remove('hidden');\n            if (stealBtn) stealBtn.classList.remove('hidden');\n        } else {\n            // Hide steal UI\n            hideStealUI();\n        }\n    }\n\n    /**\n     * Hide all steal UI elements\n     */\n    function hideStealUI() {\n        var stealIndicator = document.getElementById('steal-indicator');\n        var stealBtn = document.getElementById('steal-btn');\n\n        if (stealIndicator) stealIndicator.classList.add('hidden');\n        if (stealBtn) stealBtn.classList.add('hidden');\n    }\n\n    /**\n     * Handle steal button click - request targets and open modal\n     */\n    function handleStealClick() {\n        if (!hasStealAvailable || hasSubmitted) return;\n\n        // Request available steal targets from server\n        if (ws && ws.readyState === WebSocket.OPEN) {\n            ws.send(JSON.stringify({ type: 'get_steal_targets' }));\n        }\n    }\n\n    /**\n     * Open steal modal with available targets\n     * @param {Array} targets - Array of player names who have submitted\n     */\n    function openStealModal(targets) {\n        var modal = document.getElementById('steal-modal');\n        var targetList = document.getElementById('steal-target-list');\n\n        if (!modal || !targetList) return;\n\n        // Clear previous targets\n        targetList.innerHTML = '';\n\n        if (!targets || targets.length === 0) {\n            // No valid targets - show waiting message\n            var noTargets = document.createElement('p');\n            noTargets.className = 'steal-no-targets';\n            noTargets.textContent = utils.t('steal.waitForSubmit');\n            targetList.appendChild(noTargets);\n        } else {\n            // Render target buttons\n            targets.forEach(function(target) {\n                var btn = document.createElement('button');\n                btn.className = 'steal-target-btn';\n                btn.textContent = target;\n                btn.addEventListener('click', function() {\n                    selectStealTarget(target);\n                });\n                targetList.appendChild(btn);\n            });\n        }\n\n        modal.classList.remove('hidden');\n    }\n\n    /**\n     * Close steal modal\n     */\n    function closeStealModal() {\n        var modal = document.getElementById('steal-modal');\n        if (modal) modal.classList.add('hidden');\n    }\n\n    /**\n     * Select a steal target and confirm\n     * @param {string} targetName - Name of player to steal from\n     */\n    async function selectStealTarget(targetName) {\n        // Show confirmation dialog\n        var confirmMsg = utils.t('steal.confirm').replace('{name}', targetName);\n        var confirmed = await showConfirmModal(\n            utils.t('steal.confirmTitle') || 'Steal Answer?',\n            confirmMsg,\n            utils.t('steal.confirmButton') || 'Steal',\n            utils.t('common.cancel')\n        );\n        if (!confirmed) {\n            return;\n        }\n\n        // Send steal request to server\n        if (ws && ws.readyState === WebSocket.OPEN) {\n            ws.send(JSON.stringify({\n                type: 'steal',\n                target: targetName\n            }));\n        }\n\n        // Close modal\n        closeStealModal();\n    }\n\n    /**\n     * Handle steal acknowledgment from server\n     * @param {Object} data - Response data with target and year\n     */\n    function handleStealAck(data) {\n        if (data.success) {\n            // Update local state\n            hasStealAvailable = false;\n            hasSubmitted = true;\n\n            // Hide steal UI\n            hideStealUI();\n\n            // Show submit confirmation\n            var yearSelector = document.getElementById('year-selector');\n            var submitBtn = document.getElementById('submit-btn');\n            var confirmation = document.getElementById('submitted-confirmation');\n\n            if (yearSelector) yearSelector.classList.add('is-submitted');\n            if (submitBtn) submitBtn.classList.add('hidden');\n            if (confirmation) confirmation.classList.remove('hidden');\n\n            // Show steal-specific confirmation toast\n            showStealConfirmation(data.target, data.year);\n\n            // Update year display to show stolen year\n            var yearDisplay = document.getElementById('selected-year');\n            var slider = document.getElementById('year-slider');\n            if (yearDisplay) yearDisplay.textContent = data.year;\n            if (slider) slider.value = data.year;\n        }\n    }\n\n    /**\n     * Handle steal targets response from server\n     * @param {Object} data - Response data with targets array\n     */\n    function handleStealTargets(data) {\n        openStealModal(data.targets || []);\n    }\n\n    /**\n     * Show steal confirmation toast\n     * @param {string} target - Name of player stolen from\n     * @param {number} year - The stolen year guess\n     */\n    function showStealConfirmation(target, year) {\n        var toast = document.getElementById('steal-confirmation');\n        var text = document.getElementById('steal-confirmation-text');\n\n        if (!toast || !text) return;\n\n        // Set message\n        var msg = utils.t('steal.success')\n            .replace('{name}', target)\n            .replace('{year}', year);\n        text.textContent = msg;\n\n        // Show toast\n        toast.classList.remove('hidden');\n\n        // Hide after 3 seconds\n        setTimeout(function() {\n            toast.classList.add('hidden');\n        }, 3000);\n    }\n\n    // ============================================\n    // Reveal View (Story 4.6)\n    // ============================================\n\n    /**\n     * Update reveal view with round results\n     * @param {Object} data - State data from server\n     */\n    function updateRevealView(data) {\n        var song = data.song || {};\n        var players = data.players || [];\n\n        // Update round info\n        var roundEl = document.getElementById('reveal-round');\n        var totalEl = document.getElementById('reveal-total');\n        if (roundEl) roundEl.textContent = data.round || 1;\n        if (totalEl) totalEl.textContent = data.total_rounds || 10;\n\n        // Update album cover\n        var albumCover = document.getElementById('reveal-album-cover');\n        if (albumCover) {\n            albumCover.src = song.album_art || '/beatify/static/img/no-artwork.svg';\n        }\n\n        // Update correct year\n        var correctYear = document.getElementById('correct-year');\n        if (correctYear) {\n            correctYear.textContent = song.year || '????';\n        }\n\n        // Update song info\n        var titleEl = document.getElementById('song-title');\n        var artistEl = document.getElementById('song-artist');\n        if (titleEl) titleEl.textContent = song.title || 'Unknown Song';\n        if (artistEl) artistEl.textContent = song.artist || 'Unknown Artist';\n\n        // Update fun fact and rich song info (Story 14.3, 16.1, 16.3)\n        var funFactContainer = document.getElementById('fun-fact-container');\n        var funFactText = document.getElementById('fun-fact');\n        var funFactHeader = funFactContainer ? funFactContainer.querySelector('.fun-fact-header') : null;\n\n        // Get localized fun fact (Story 16.1, 16.3)\n        var localizedFunFact = utils.getLocalizedSongField(song, 'fun_fact');\n\n        // Set fun fact text\n        if (funFactText) {\n            funFactText.textContent = localizedFunFact || '';\n        }\n\n        // Show/hide fun fact header based on whether there's a fun fact\n        if (funFactHeader) {\n            funFactHeader.style.display = localizedFunFact ? 'flex' : 'none';\n        }\n\n        // Render rich song info (Story 14.3)\n        renderRichSongInfo(song);\n\n        // Render song difficulty rating (Story 15.1)\n        renderSongDifficulty(data.song_difficulty);\n\n        // Show container if there's fun fact OR rich info\n        if (funFactContainer) {\n            var richInfo = document.getElementById('song-rich-info');\n            var hasRichInfo = richInfo && richInfo.innerHTML.trim() !== '';\n            var hasFunFact = localizedFunFact && localizedFunFact.trim() !== '';\n            funFactContainer.classList.toggle('hidden', !hasFunFact && !hasRichInfo);\n        }\n\n        // Find current player's result\n        var currentPlayer = null;\n        for (var i = 0; i < players.length; i++) {\n            if (players[i].name === playerName) {\n                currentPlayer = players[i];\n                break;\n            }\n        }\n\n        // Show celebration-first reveal (Story 9.4)\n        showRevealEmotion(currentPlayer, song.year);\n        renderPersonalResult(currentPlayer, song.year);\n\n        // Story 20.6: Render artist challenge reveal\n        if (data.artist_challenge) {\n            renderArtistReveal(data.artist_challenge, playerName);\n        }\n\n        // Story 14.5: Check for new record and trigger rainbow confetti (AC2)\n        if (data.game_performance && data.game_performance.is_new_record) {\n            triggerConfetti('record');\n        }\n\n        // Render player result cards (Story 9.10)\n        renderPlayerResultCards(players);\n\n        // Render round analytics (Story 13.3)\n        if (data.round_analytics) {\n            renderRoundAnalytics(data.round_analytics, song.year);\n        }\n\n        // Update leaderboard (Story 5.5) with score animations (Story 13.2)\n        if (data.leaderboard) {\n            updateLeaderboard(data, 'reveal-leaderboard-list', true);\n        }\n\n        // Show admin controls if admin\n        var adminControls = document.getElementById('reveal-admin-controls');\n        var nextRoundBtn = document.getElementById('next-round-btn');\n        if (adminControls && currentPlayer && currentPlayer.is_admin) {\n            adminControls.classList.remove('hidden');\n\n            // Update button text for last round\n            if (nextRoundBtn) {\n                if (data.last_round) {\n                    nextRoundBtn.textContent = utils.t('leaderboard.finalResults');\n                    nextRoundBtn.classList.add('is-final');\n                } else {\n                    nextRoundBtn.textContent = utils.t('admin.nextRound');\n                    nextRoundBtn.classList.remove('is-final');\n                }\n                nextRoundBtn.disabled = false;\n            }\n        } else if (adminControls) {\n            adminControls.classList.add('hidden');\n        }\n    }\n\n    /**\n     * Render round analytics section (Story 13.3)\n     * @param {Object} analytics - Round analytics data from server\n     * @param {number} correctYear - The correct year for comparison\n     */\n    function renderRoundAnalytics(analytics, correctYear) {\n        var section = document.getElementById('round-analytics');\n        var container = document.getElementById('round-analytics-content');\n        if (!section || !container || !analytics) {\n            if (section) section.classList.add('hidden');\n            return;\n        }\n\n        // Handle empty state (AC11)\n        if (analytics.total_submitted === 0) {\n            container.innerHTML = '<div class=\"analytics-empty\">' + utils.t('analytics.noSubmissions') + '</div>';\n            section.classList.remove('hidden');\n            return;\n        }\n\n        // Average comparison (AC7)\n        var avgComparison = '';\n        if (analytics.average_guess !== null && correctYear) {\n            var diff = Math.round(analytics.average_guess - correctYear);\n            if (diff === 0) {\n                avgComparison = utils.t('analytics.onTarget');\n            } else if (diff > 0) {\n                avgComparison = utils.t('analytics.yearsLate', { years: diff });\n            } else {\n                avgComparison = utils.t('analytics.yearsEarly', { years: Math.abs(diff) });\n            }\n        }\n\n        // Render histogram with 7 dynamic year bins based on actual guesses\n        var histogramHtml = renderHistogram(analytics.all_guesses, correctYear);\n\n        // Build achievements HTML (AC9, AC10)\n        var achievementsHtml = '';\n\n        // Exact matches\n        if (analytics.exact_match_players && analytics.exact_match_players.length > 0) {\n            achievementsHtml += '<div class=\"achievement-item\">' +\n                '<span class=\"achievement-emoji\">&#127919;</span>' +\n                '<span class=\"achievement-label\">' + utils.t('analytics.exactMatches') + ':</span>' +\n                '<span class=\"achievement-names\">' + analytics.exact_match_players.join(', ') + '</span>' +\n                '</div>';\n        }\n\n        // Speed champion\n        if (analytics.speed_champion && analytics.speed_champion.names) {\n            var names = analytics.speed_champion.names.join(', ');\n            achievementsHtml += '<div class=\"achievement-item\">' +\n                '<span class=\"achievement-emoji\">&#9889;</span>' +\n                '<span class=\"achievement-label\">' + utils.t('analytics.speedChampion') + ':</span>' +\n                '<span class=\"achievement-names\">' + names + '</span>' +\n                '<span class=\"achievement-value\">(' + analytics.speed_champion.time + 's)</span>' +\n                '</div>';\n        }\n\n        // Furthest guess (for fun)\n        if (analytics.furthest_players && analytics.furthest_players.length > 0 && analytics.all_guesses && analytics.all_guesses.length > 0) {\n            var furthestOff = analytics.all_guesses[analytics.all_guesses.length - 1].years_off;\n            if (furthestOff > 0) {\n                achievementsHtml += '<div class=\"achievement-item\">' +\n                    '<span class=\"achievement-emoji\">&#128517;</span>' +\n                    '<span class=\"achievement-label\">' + utils.t('analytics.furthestGuess') + ':</span>' +\n                    '<span class=\"achievement-names\">' + analytics.furthest_players.join(', ') + '</span>' +\n                    '<span class=\"achievement-value\">(' + furthestOff + ' years)</span>' +\n                    '</div>';\n            }\n        }\n\n        // Build full HTML - stats in single row (title is now in section header)\n        var avgDisplay = analytics.average_guess !== null ? Math.round(analytics.average_guess) : '?';\n        container.innerHTML =\n            '<div class=\"analytics-stats-row\">' +\n            '<div class=\"stat-primary\">' +\n            '<span class=\"stat-label\">' + utils.t('analytics.averageGuess') + '</span>' +\n            '<span class=\"stat-value\">' + avgDisplay + '</span>' +\n            '</div>' +\n            '<div class=\"stat-secondary\">' +\n            '<span class=\"stat-value\">' + analytics.accuracy_percentage + '%</span>' +\n            '<span class=\"stat-label\">' + utils.t('analytics.accuracy', { percent: '' }).replace('%', '') + '</span>' +\n            '</div>' +\n            '</div>' +\n            '<div class=\"stat-comparison-line\">' + avgComparison + '</div>' +\n            '<div class=\"analytics-histogram\">' +\n            '<h4 class=\"histogram-title\">' + utils.t('analytics.histogram') + '</h4>' +\n            histogramHtml +\n            '</div>' +\n            (achievementsHtml ? '<div class=\"analytics-achievements\">' + achievementsHtml + '</div>' : '');\n\n        section.classList.remove('hidden');\n    }\n\n    /**\n     * Render histogram with 7 dynamic year bins based on actual guesses\n     * @param {Array} allGuesses - Array of {name, guess, years_off} sorted by years_off\n     * @param {number} correctYear - The correct year for highlighting\n     * @returns {string} HTML string for histogram\n     */\n    function renderHistogram(allGuesses, correctYear) {\n        var NUM_BINS = 7;\n\n        // Handle empty or invalid data\n        if (!allGuesses || allGuesses.length === 0) {\n            return '<div class=\"histogram-empty\">' + utils.t('analytics.noGuesses') + '</div>';\n        }\n\n        // Extract guess years\n        var guesses = allGuesses.map(function(g) { return g.guess; });\n        var minGuess = Math.min.apply(null, guesses);\n        var maxGuess = Math.max.apply(null, guesses);\n        var range = maxGuess - minGuess;\n\n        // Calculate years per bin (minimum 1 year per bin)\n        var yearsPerBin = Math.max(1, Math.ceil(range / NUM_BINS));\n\n        // Adjust range to fit exactly 7 bins, centered on guesses\n        var totalYears = yearsPerBin * NUM_BINS;\n        var extraYears = totalYears - range - 1;\n        var startYear = minGuess - Math.floor(extraYears / 2);\n\n        // Build bins\n        var bins = [];\n        for (var i = 0; i < NUM_BINS; i++) {\n            var binStart = startYear + (i * yearsPerBin);\n            var binEnd = binStart + yearsPerBin - 1;\n            bins.push({\n                start: binStart,\n                end: binEnd,\n                count: 0,\n                containsCorrect: correctYear >= binStart && correctYear <= binEnd\n            });\n        }\n\n        // Count guesses per bin\n        for (var j = 0; j < guesses.length; j++) {\n            var guess = guesses[j];\n            for (var k = 0; k < bins.length; k++) {\n                if (guess >= bins[k].start && guess <= bins[k].end) {\n                    bins[k].count++;\n                    break;\n                }\n            }\n        }\n\n        // Find max count for proportional heights\n        var maxCount = 1;\n        for (var m = 0; m < bins.length; m++) {\n            if (bins[m].count > maxCount) maxCount = bins[m].count;\n        }\n\n        // Render bars\n        var barsHtml = '';\n        for (var n = 0; n < bins.length; n++) {\n            var bin = bins[n];\n            var heightPercent = (bin.count / maxCount) * 100;\n            var delay = n * 0.05;\n\n            var barClass = 'histogram-bar' + (bin.containsCorrect ? ' is-correct' : '');\n            var barHeight = bin.count > 0 ? Math.max(heightPercent, 10) : 0;\n            var countHtml = bin.count > 0 ? '<span class=\"bar-count\">' + bin.count + '</span>' : '';\n\n            // Label: single year or range\n            var label = yearsPerBin === 1 ? String(bin.start) : bin.start + '-' + String(bin.end).slice(-2);\n\n            barsHtml += '<div class=\"histogram-bar-wrapper\" style=\"animation-delay: ' + delay + 's\">' +\n                '<div class=\"' + barClass + '\" style=\"height: ' + barHeight + '%\">' +\n                countHtml +\n                '</div>' +\n                '<span class=\"histogram-label\">' + label + '</span>' +\n                '</div>';\n        }\n\n        return '<div class=\"histogram-bars\">' + barsHtml + '</div>';\n    }\n\n    // ============================================\n    // Rich Song Info (Story 14.3)\n    // ============================================\n\n    /**\n     * Render superlatives / fun awards (Story 15.2)\n     * @param {Array|null} superlatives - Array of award objects from state\n     */\n    function renderSuperlatives(superlatives) {\n        var container = document.getElementById('superlatives-container');\n        if (!container) return;\n\n        // Hide if no superlatives\n        if (!superlatives || superlatives.length === 0) {\n            container.classList.add('hidden');\n            return;\n        }\n\n        var html = '';\n        superlatives.forEach(function(award, index) {\n            var valueText = '';\n            switch (award.value_label) {\n                case 'avg_time':\n                    valueText = award.value + 's ' + utils.t('superlatives.avgTime');\n                    break;\n                case 'streak':\n                    valueText = award.value + ' ' + utils.t('superlatives.streak');\n                    break;\n                case 'bets':\n                    valueText = award.value + ' ' + utils.t('superlatives.bets');\n                    break;\n                case 'points':\n                    valueText = award.value + ' ' + utils.t('superlatives.points');\n                    break;\n                case 'close_guesses':\n                    valueText = award.value + ' ' + utils.t('superlatives.closeGuesses');\n                    break;\n                default:\n                    valueText = award.value;\n            }\n\n            html += '<div class=\"superlative-card superlative-card--' + award.id + '\" style=\"animation-delay: ' + (index * 0.2) + 's\">' +\n                '<div class=\"superlative-emoji\">' + award.emoji + '</div>' +\n                '<div class=\"superlative-title\">' + utils.t('superlatives.' + award.title) + '</div>' +\n                '<div class=\"superlative-player\">' + escapeHtml(award.player_name) + '</div>' +\n                '<div class=\"superlative-value\">' + valueText + '</div>' +\n            '</div>';\n        });\n\n        container.innerHTML = html;\n        container.classList.remove('hidden');\n    }\n\n    /**\n     * Render song difficulty rating (Story 15.1)\n     * @param {Object|null} difficulty - Difficulty data with stars, label, accuracy, times_played\n     */\n    function renderSongDifficulty(difficulty) {\n        var el = document.getElementById('song-difficulty');\n        if (!el) return;\n\n        // Hide if no difficulty data (AC4: insufficient plays)\n        if (!difficulty) {\n            el.classList.add('hidden');\n            return;\n        }\n\n        // Build stars string\n        var stars = '';\n        for (var i = 0; i < difficulty.stars; i++) {\n            stars += '<span class=\"star\">&#9733;</span>';\n        }\n\n        // Render difficulty display\n        el.innerHTML =\n            '<div class=\"difficulty-stars difficulty-' + difficulty.stars + '\">' + stars + '</div>' +\n            '<span class=\"difficulty-label\">' + utils.t('difficulty.' + difficulty.label) + '</span>' +\n            '<span class=\"difficulty-accuracy\">' + difficulty.accuracy + '% ' + utils.t('difficulty.accuracy') + '</span>';\n\n        el.classList.remove('hidden');\n    }\n\n    /**\n     * Render rich song info (chart position, certifications, awards)\n     * Uses unified badge design - all centered with consistent styling\n     * @param {Object} song - Song data with optional chart_info, certifications, awards\n     */\n    function renderRichSongInfo(song) {\n        var container = document.getElementById('song-rich-info');\n        if (!container) return;\n\n        var badges = [];\n\n        // Collect chart badges\n        var chartBadges = renderChartBadges(song.chart_info || {});\n        if (chartBadges.length > 0) badges = badges.concat(chartBadges);\n\n        // Collect certification badges\n        var certBadges = renderCertificationBadges(song.certifications || []);\n        if (certBadges.length > 0) badges = badges.concat(certBadges);\n\n        // Collect award badges (Story 16.1, 16.3 - use localized awards)\n        var localizedAwards = utils.getLocalizedSongField(song, 'awards') || [];\n        var awardBadges = renderAwardBadges(localizedAwards);\n        if (awardBadges.length > 0) badges = badges.concat(awardBadges);\n\n        // Render all badges in a single centered row\n        if (badges.length > 0) {\n            container.innerHTML = '<div class=\"song-badges-row\">' + badges.join('') + '</div>';\n        } else {\n            container.innerHTML = '';\n        }\n    }\n\n    /**\n     * Render chart info as badges\n     * @param {Object} chartInfo - Chart info data\n     * @returns {Array} Array of badge HTML strings\n     */\n    function renderChartBadges(chartInfo) {\n        if (!chartInfo) return [];\n\n        var badges = [];\n\n        // Billboard chart\n        if (chartInfo.billboard_peak && chartInfo.billboard_peak > 0) {\n            var weeksText = chartInfo.weeks_on_chart\n                ? ' <span class=\"chart-weeks\">\u00B7 ' + chartInfo.weeks_on_chart + ' ' + utils.t('reveal.weeksShort') + '</span>'\n                : '';\n            badges.push(\n                '<span class=\"song-badge song-badge--chart\">' +\n                '<span class=\"song-badge-icon\">\uD83D\uDCCA</span>' +\n                '#' + chartInfo.billboard_peak + ' ' + utils.t('reveal.chartBillboard') + weeksText +\n                '</span>'\n            );\n        }\n\n        // German chart (if no Billboard)\n        if (chartInfo.german_peak && chartInfo.german_peak > 0 && !chartInfo.billboard_peak) {\n            badges.push(\n                '<span class=\"song-badge song-badge--chart\">' +\n                '<span class=\"song-badge-icon\">\uD83D\uDCCA</span>' +\n                '#' + chartInfo.german_peak + ' ' + utils.t('reveal.chartGerman') +\n                '</span>'\n            );\n        }\n\n        // UK chart (if no Billboard)\n        if (chartInfo.uk_peak && chartInfo.uk_peak > 0 && !chartInfo.billboard_peak) {\n            badges.push(\n                '<span class=\"song-badge song-badge--chart\">' +\n                '<span class=\"song-badge-icon\">\uD83D\uDCCA</span>' +\n                '#' + chartInfo.uk_peak + ' ' + utils.t('reveal.chartUK') +\n                '</span>'\n            );\n        }\n\n        return badges;\n    }\n\n    /**\n     * Render certifications as badges\n     * @param {Array} certifications - Array of certification strings\n     * @returns {Array} Array of badge HTML strings\n     */\n    function renderCertificationBadges(certifications) {\n        if (!certifications || certifications.length === 0) return [];\n\n        var badges = [];\n        for (var i = 0; i < certifications.length; i++) {\n            var cert = certifications[i];\n            var badgeClass = getCertificationBadgeClass(cert);\n            var icon = getCertificationIcon(cert);\n            badges.push(\n                '<span class=\"song-badge ' + badgeClass + '\">' +\n                '<span class=\"song-badge-icon\">' + icon + '</span>' +\n                escapeHtml(cert) +\n                '</span>'\n            );\n        }\n        return badges;\n    }\n\n    /**\n     * Get CSS class for certification type\n     * @param {string} cert - Certification string\n     * @returns {string} CSS class name\n     */\n    function getCertificationBadgeClass(cert) {\n        var certLower = cert.toLowerCase();\n        if (certLower.indexOf('diamond') !== -1) return 'song-badge--diamond';\n        if (certLower.indexOf('platinum') !== -1) return 'song-badge--platinum';\n        if (certLower.indexOf('gold') !== -1) return 'song-badge--gold';\n        return 'song-badge--platinum';\n    }\n\n    /**\n     * Get icon for certification type\n     * @param {string} cert - Certification string\n     * @returns {string} Emoji icon\n     */\n    function getCertificationIcon(cert) {\n        var certLower = cert.toLowerCase();\n        if (certLower.indexOf('diamond') !== -1) return '\uD83D\uDC8E';\n        if (certLower.indexOf('platinum') !== -1) return '\uD83D\uDCBF';\n        if (certLower.indexOf('gold') !== -1) return '\uD83E\uDD47';\n        return '\uD83D\uDCBF';\n    }\n\n    /**\n     * Render awards as badges (max 3)\n     * @param {Array} awards - Array of award strings\n     * @returns {Array} Array of badge HTML strings\n     */\n    function renderAwardBadges(awards) {\n        if (!awards || awards.length === 0) return [];\n\n        var badges = [];\n        var displayAwards = awards.slice(0, 3);\n\n        for (var i = 0; i < displayAwards.length; i++) {\n            var award = displayAwards[i];\n            var badgeClass = getAwardBadgeClass(award);\n            var icon = getAwardIcon(award);\n            badges.push(\n                '<span class=\"song-badge ' + badgeClass + '\">' +\n                '<span class=\"song-badge-icon\">' + icon + '</span>' +\n                escapeHtml(award) +\n                '</span>'\n            );\n        }\n\n        if (awards.length > 3) {\n            badges.push('<span class=\"song-badges-more\">+' + (awards.length - 3) + ' more</span>');\n        }\n\n        return badges;\n    }\n\n    /**\n     * Get CSS class for award type\n     * @param {string} award - Award string\n     * @returns {string} CSS class name\n     */\n    function getAwardBadgeClass(award) {\n        var awardLower = award.toLowerCase();\n        if (awardLower.indexOf('grammy') !== -1) return 'song-badge--grammy';\n        if (awardLower.indexOf('eurovision') !== -1) return 'song-badge--eurovision';\n        if (awardLower.indexOf('oscar') !== -1 || awardLower.indexOf('academy award') !== -1) return 'song-badge--oscar';\n        if (awardLower.indexOf('hall of fame') !== -1) return 'song-badge--halloffame';\n        return 'song-badge--award';\n    }\n\n    /**\n     * Get icon for award type\n     * @param {string} award - Award string\n     * @returns {string} Emoji icon\n     */\n    function getAwardIcon(award) {\n        var awardLower = award.toLowerCase();\n        if (awardLower.indexOf('eurovision') !== -1) return '\uD83C\uDFA4';\n        if (awardLower.indexOf('grammy') !== -1) return '\uD83C\uDFC6';\n        if (awardLower.indexOf('hall of fame') !== -1) return '\u2B50';\n        return '\uD83C\uDFC6';\n    }\n\n    /**\n     * Show celebration-first emotion before data (Story 9.4)\n     * @param {Object} player - Current player data\n     * @param {number} correctYear - The correct year\n     */\n    function showRevealEmotion(player, correctYear) {\n        var emotionEl = document.getElementById('reveal-emotion');\n        var personalResult = document.getElementById('personal-result');\n        if (!emotionEl) return;\n\n        // Reset emotion element - detect compact vs legacy class\n        var isCompact = emotionEl.classList.contains('reveal-emotion-inline') ||\n                        document.querySelector('.reveal-container--compact');\n        emotionEl.className = isCompact ? 'reveal-emotion-inline' : 'reveal-emotion';\n        emotionEl.innerHTML = '';\n        emotionEl.classList.add('hidden');\n\n        // Reset personal result delay\n        if (personalResult) {\n            personalResult.classList.remove('is-delayed');\n        }\n\n        // Stop any existing confetti\n        stopConfetti();\n\n        // Get translated emotion arrays using i18n\n        var emotions = utils.t('reveal.emotions');\n\n        // Helper to pick random from array\n        function randomFrom(arr) {\n            return arr[Math.floor(Math.random() * arr.length)];\n        }\n\n        // Helper for \"Off by X years\" text\n        function getOffByText(years) {\n            if (years === 1) {\n                return utils.t('reveal.offByYear');\n            }\n            return utils.t('reveal.offByYears', { years: years });\n        }\n\n        // Determine emotion category\n        var emotionType = 'missed';\n        var emotionText = randomFrom(emotions.missed);\n        var subtitle = randomFrom(emotions.missedSub);\n\n        if (player && !player.missed_round) {\n            var yearsOff = player.years_off || 0;\n\n            if (yearsOff === 0) {\n                emotionType = 'exact';\n                emotionText = randomFrom(emotions.exact);\n                subtitle = randomFrom(emotions.exactSub);\n            } else if (yearsOff <= 2) {\n                emotionType = 'close';\n                emotionText = randomFrom(emotions.close);\n                subtitle = randomFrom(emotions.closeSub) + ' ' + getOffByText(yearsOff);\n            } else if (yearsOff <= 5) {\n                emotionType = 'close';\n                emotionText = randomFrom(emotions.close);\n                subtitle = getOffByText(yearsOff);\n            } else {\n                emotionType = 'wrong';\n                emotionText = randomFrom(emotions.wrong);\n                subtitle = randomFrom(emotions.wrongSub) + ' ' + getOffByText(yearsOff);\n            }\n        } else if (player && player.missed_round) {\n            emotionType = 'missed';\n            emotionText = randomFrom(emotions.missed);\n            subtitle = randomFrom(emotions.missedSub);\n        }\n\n        // Build emotion HTML\n        var emotionHtml = '<span class=\"reveal-emotion-text\">' + emotionText + '</span>';\n        if (subtitle) {\n            emotionHtml += '<div class=\"reveal-emotion-subtitle\">' + subtitle + '</div>';\n        }\n        emotionEl.innerHTML = emotionHtml;\n\n        // Apply emotion class\n        emotionEl.classList.add('reveal-emotion--' + emotionType);\n        emotionEl.classList.remove('hidden');\n\n        // Trigger confetti for exact match\n        if (emotionType === 'exact') {\n            triggerConfetti();\n        }\n\n        // Add delay class to personal result for fade-in effect\n        if (personalResult && emotionType !== 'missed') {\n            personalResult.classList.add('is-delayed');\n        }\n    }\n\n    /**\n     * Render personal result in reveal view\n     * @param {Object} player - Current player data\n     * @param {number} correctYear - The correct year\n     */\n    function renderPersonalResult(player, correctYear) {\n        var resultContent = document.getElementById('result-content');\n        if (!resultContent) return;\n\n        if (!player) {\n            resultContent.innerHTML = '<div class=\"result-missed\">Player not found</div>';\n            return;\n        }\n\n        if (player.missed_round) {\n            // Enhanced missed round display (Story 5.4)\n            var missedHtml =\n                '<div class=\"result-missed-container\">' +\n                    '<div class=\"result-missed-icon\">\u23F0</div>' +\n                    '<div class=\"result-missed-text\">' + utils.t('reveal.noSubmission') + '</div>' +\n                '</div>';\n\n            // Show broken streak if they had one (>= 2)\n            var previousStreak = player.previous_streak || 0;\n            if (previousStreak >= 2) {\n                missedHtml +=\n                    '<div class=\"streak-broken\">' +\n                        '<span class=\"streak-broken-icon\">\uD83D\uDC94</span>' +\n                        '<span class=\"streak-broken-text\">Lost ' + previousStreak + '-streak!</span>' +\n                    '</div>';\n            }\n\n            missedHtml += '<div class=\"result-score is-zero\">0 pts</div>';\n            resultContent.innerHTML = missedHtml;\n            return;\n        }\n\n        var yearsOff = player.years_off || 0;\n        var yearsOffText = yearsOff === 0 ? utils.t('reveal.exact') :\n                           yearsOff === 1 ? utils.t('reveal.yearOff', { years: 1 }) :\n                           t('reveal.yearsOff', { years: yearsOff });\n\n        var resultClass = yearsOff === 0 ? 'is-exact' :\n                          yearsOff <= 3 ? 'is-close' : 'is-far';\n\n        // Speed bonus display (Story 5.1)\n        var speedMultiplier = player.speed_multiplier || 1.0;\n        var baseScore = player.base_score || 0;\n        var hasSpeedBonus = speedMultiplier > 1.0;\n\n        // Streak bonus display (Story 5.2)\n        var streakBonus = player.streak_bonus || 0;\n\n        // Artist bonus display (Story 20.6)\n        var artistBonus = player.artist_bonus || 0;\n\n        var scoreBreakdown = '';\n        if (hasSpeedBonus && baseScore > 0) {\n            scoreBreakdown =\n                '<div class=\"result-row\">' +\n                    '<span class=\"result-label\">' + utils.t('reveal.baseScore') + '</span>' +\n                    '<span class=\"result-value\">' + baseScore + ' pts</span>' +\n                '</div>' +\n                '<div class=\"result-row\">' +\n                    '<span class=\"result-label\">' + utils.t('reveal.speedBonus') + '</span>' +\n                    '<span class=\"result-value is-bonus\">' + speedMultiplier.toFixed(2) + 'x</span>' +\n                '</div>';\n        }\n\n        // Bet outcome row (Story 5.3)\n        var betOutcomeHtml = '';\n        if (player.bet_outcome === 'won') {\n            betOutcomeHtml =\n                '<div class=\"result-row bet-won-row\">' +\n                    '<span class=\"result-label\">\uD83C\uDFB2 ' + utils.t('reveal.betWon').replace('! 2x points', '') + '</span>' +\n                    '<span class=\"result-value is-bet-won\">2x</span>' +\n                '</div>';\n        } else if (player.bet_outcome === 'lost') {\n            betOutcomeHtml =\n                '<div class=\"result-row bet-lost-row\">' +\n                    '<span class=\"result-label\">\uD83C\uDFB2 ' + utils.t('reveal.betLost') + '</span>' +\n                    '<span class=\"result-value is-bet-lost\">-</span>' +\n                '</div>';\n        }\n\n        // Streak bonus row (Story 5.2)\n        var streakBonusHtml = '';\n        if (streakBonus > 0) {\n            streakBonusHtml =\n                '<div class=\"result-row streak-bonus-row\">' +\n                    '<span class=\"result-label\">' + player.streak + '-streak bonus!</span>' +\n                    '<span class=\"result-value is-streak\">+' + streakBonus + ' pts</span>' +\n                '</div>';\n        }\n\n        // Artist bonus row (Story 20.6)\n        var artistBonusHtml = '';\n        if (artistBonus > 0) {\n            artistBonusHtml =\n                '<div class=\"result-row artist-bonus-row\">' +\n                    '<span class=\"result-label\">\uD83C\uDFA4 ' + (utils.t('artistChallenge.artistBonus') || 'Artist Bonus') + '</span>' +\n                    '<span class=\"result-value\">+' + artistBonus + ' pts</span>' +\n                '</div>';\n        }\n\n        // Calculate total (round_score already includes bet + speed bonus, add streak + artist separately)\n        var totalScore = player.round_score + streakBonus + artistBonus;\n        var hasBonuses = streakBonus > 0 || artistBonus > 0;\n\n        // Story 13.2: Determine animation effects\n        var isBigScore = player.round_score >= 20;\n        var prevPlayer = previousState.players[player.name];\n        var prevScore = prevPlayer ? prevPlayer.score : (player.score - totalScore);\n        var prevStreak = prevPlayer ? prevPlayer.streak : 0;\n        var streakMilestone = isStreakMilestone(prevStreak, player.streak || 0);\n\n        resultContent.innerHTML =\n            '<div class=\"result-row\">' +\n                '<span class=\"result-label\">' + utils.t('reveal.yourGuess') + '</span>' +\n                '<span class=\"result-value\">' + (player.guess || 'n/a') + '</span>' +\n            '</div>' +\n            '<div class=\"result-row\">' +\n                '<span class=\"result-label\">' + utils.t('reveal.correctYear') + '</span>' +\n                '<span class=\"result-value\">' + correctYear + '</span>' +\n            '</div>' +\n            '<div class=\"result-row\">' +\n                '<span class=\"result-label\">' + utils.t('reveal.accuracy') + '</span>' +\n                '<span class=\"result-value ' + resultClass + '\">' + yearsOffText + '</span>' +\n            '</div>' +\n            scoreBreakdown +\n            betOutcomeHtml +\n            '<div class=\"result-score\" id=\"personal-result-score\">+<span class=\"score-value\">0</span> pts</div>' +\n            streakBonusHtml +\n            artistBonusHtml +\n            (hasBonuses ? '<div class=\"result-total\">' + utils.t('reveal.total') + ': +<span class=\"total-value\">0</span> pts</div>' : '');\n\n        // Story 13.2: Animate personal score with visual effects\n        var scoreValueEl = resultContent.querySelector('.score-value');\n        if (scoreValueEl) {\n            animateScoreChange(scoreValueEl, 0, player.round_score, {\n                betWon: player.bet_outcome === 'won',\n                betLost: player.bet_outcome === 'lost',\n                streakMilestone: streakMilestone,\n                isBigScore: isBigScore\n            });\n\n            // Show floating popup for bet win\n            if (player.bet_outcome === 'won' && player.round_score > 0) {\n                setTimeout(function() {\n                    var scoreEl = document.getElementById('personal-result-score');\n                    if (scoreEl) {\n                        showPointsPopup(scoreEl, player.round_score, { isBetWin: true });\n                    }\n                }, 200);\n            }\n        }\n\n        // Story 13.2: Animate total score and show streak popup\n        var totalValueEl = resultContent.querySelector('.total-value');\n        if (totalValueEl && hasBonuses) {\n            // Slight delay for total to start after round score\n            setTimeout(function() {\n                animateValue(totalValueEl, 0, totalScore, 600);\n            }, 300);\n\n            // Show streak milestone popup\n            if (streakMilestone) {\n                setTimeout(function() {\n                    var totalEl = resultContent.querySelector('.result-total');\n                    if (totalEl) {\n                        var milestoneBonus = {3: 20, 5: 50, 10: 100}[streakMilestone] || 0;\n                        showPointsPopup(totalEl, milestoneBonus, {\n                            isStreak: true,\n                            text: '+' + milestoneBonus + ' ' + streakMilestone + '-Streak!'\n                        });\n                    }\n                }, 500);\n            }\n        }\n    }\n\n    /**\n     * Render player result cards on reveal (Story 9.10)\n     * Shows all players' guesses, years off, and points in horizontal scroll\n     * @param {Array} players - All players from state\n     */\n    function renderPlayerResultCards(players) {\n        var container = document.getElementById('reveal-results-cards');\n        if (!container) return;\n\n        if (!players || players.length === 0) {\n            container.innerHTML = '';\n            return;\n        }\n\n        // Sort players by round_score descending (best first)\n        var sorted = players.slice().sort(function(a, b) {\n            return (b.round_score || 0) - (a.round_score || 0);\n        });\n\n        var html = '<div class=\"results-cards-scroll\">';\n\n        sorted.forEach(function(player) {\n            var isCurrentPlayer = player.name === playerName;\n            var isMissed = player.missed_round === true;\n            var yearsOff = player.years_off || 0;\n            var roundScore = player.round_score || 0;\n\n            // Determine score-based class per AC #13 (Code Review fix)\n            var scoreClass = isMissed ? 'is-score-zero' :\n                             roundScore >= 10 ? 'is-score-high' :\n                             roundScore >= 1 ? 'is-score-medium' : 'is-score-zero';\n\n            // Guess display\n            var guessDisplay = isMissed ? '\u2014' : (player.guess || 'n/a');\n            var yearsOffDisplay = isMissed ? utils.t('reveal.noGuessShort') :\n                                  yearsOff === 0 ? utils.t('reveal.exact') :\n                                  t('reveal.shortOff', { years: yearsOff });\n\n            // Bet indicator\n            var betIndicator = player.bet ? '<span class=\"card-bet\">\uD83C\uDFB2</span>' : '';\n\n            // Artist bonus badge (Story 20.6)\n            var artistBadge = '';\n            if (player.artist_bonus && player.artist_bonus > 0) {\n                artistBadge = '<span class=\"player-card-artist-badge\">\uD83C\uDFA4 +' + player.artist_bonus + '</span>';\n            }\n\n            // Steal indicator (Story 15.3 AC4)\n            var stealIndicator = '';\n            if (player.stole_from) {\n                stealIndicator = '<div class=\"steal-badge\"><span class=\"steal-badge-icon\">\uD83E\uDD77</span>' +\n                    t('steal.stolenFrom', { name: escapeHtml(player.stole_from) }) + '</div>';\n            } else if (player.was_stolen_by && player.was_stolen_by.length > 0) {\n                var stealerNames = player.was_stolen_by.map(escapeHtml).join(', ');\n                stealIndicator = '<div class=\"steal-badge steal-badge-victim\"><span class=\"steal-badge-icon\">\uD83C\uDFAF</span>' +\n                    t('steal.stolenBy', { name: stealerNames }) + '</div>';\n            }\n\n            html += '<div class=\"result-card ' + scoreClass + (isCurrentPlayer ? ' is-current' : '') + '\">' +\n                '<div class=\"card-name\">' + escapeHtml(player.name) + betIndicator + '</div>' +\n                '<div class=\"card-guess\">' + guessDisplay + '</div>' +\n                '<div class=\"card-accuracy\">' + yearsOffDisplay + '</div>' +\n                stealIndicator +\n                '<div class=\"card-score\">+' + roundScore + artistBadge + '</div>' +\n            '</div>';\n        });\n\n        html += '</div>';\n        container.innerHTML = html;\n    }\n\n    // ============================================\n    // End View (Story 5.6)\n    // ============================================\n\n    /**\n     * Update end view with final standings and stats\n     * @param {Object} data - State data with leaderboard and game_stats\n     */\n    function updateEndView(data) {\n        var leaderboard = data.leaderboard || [];\n\n        // Mark is_current client-side\n        leaderboard.forEach(function(entry) {\n            entry.is_current = (entry.name === playerName);\n        });\n\n        // Update podium (positions 1, 2, 3)\n        [1, 2, 3].forEach(function(place) {\n            var player = leaderboard.find(function(p) { return p.rank === place; });\n            var nameEl = document.getElementById('podium-' + place + '-name');\n            var scoreEl = document.getElementById('podium-' + place + '-score');\n            if (nameEl) nameEl.textContent = player ? escapeHtml(player.name) : '---';\n            if (scoreEl) scoreEl.textContent = player ? player.score : '0';\n        });\n\n        // Find current player's stats\n        var currentPlayer = leaderboard.find(function(p) { return p.is_current; });\n\n        // Update your result\n        var rankEl = document.getElementById('your-final-rank');\n        var scoreEl = document.getElementById('your-final-score');\n        var bestStreakEl = document.getElementById('stat-best-streak');\n        var roundsEl = document.getElementById('stat-rounds');\n        var betsEl = document.getElementById('stat-bets');\n\n        if (currentPlayer) {\n            if (rankEl) rankEl.textContent = '#' + currentPlayer.rank;\n            if (scoreEl) scoreEl.textContent = currentPlayer.score + ' ' + utils.t('leaderboard.points');\n            if (bestStreakEl) bestStreakEl.textContent = currentPlayer.best_streak || 0;\n            if (roundsEl) roundsEl.textContent = currentPlayer.rounds_played || 0;\n            if (betsEl) betsEl.textContent = currentPlayer.bets_won || 0;\n        }\n\n        // Update full leaderboard (Story 11.4: disconnected styling)\n        var listEl = document.getElementById('final-leaderboard-list');\n        if (listEl) {\n            listEl.innerHTML = leaderboard.map(function(entry) {\n                var currentClass = entry.is_current ? 'is-current' : '';\n                var disconnectedClass = entry.connected === false ? 'final-entry--disconnected' : '';\n                var awayBadge = entry.connected === false ? '<span class=\"away-badge\">(away)</span>' : '';\n                return '<div class=\"final-entry ' + currentClass + ' ' + disconnectedClass + '\">' +\n                    '<span class=\"final-rank\">#' + entry.rank + '</span>' +\n                    '<span class=\"final-name\">' + escapeHtml(entry.name) + awayBadge + '</span>' +\n                    '<span class=\"final-score\">' + entry.score + '</span>' +\n                '</div>';\n            }).join('');\n        }\n\n        // Render superlatives / fun awards (Story 15.2)\n        renderSuperlatives(data.superlatives);\n\n        // Show admin or player controls\n        var adminControls = document.getElementById('end-admin-controls');\n        var playerMessage = document.getElementById('end-player-message');\n\n        if (currentPlayer && currentPlayer.is_admin) {\n            if (adminControls) adminControls.classList.remove('hidden');\n            if (playerMessage) playerMessage.classList.add('hidden');\n            // Wire up new game button\n            var newGameBtn = document.getElementById('new-game-btn');\n            if (newGameBtn) {\n                newGameBtn.onclick = handleNewGame;\n            }\n        } else {\n            if (adminControls) adminControls.classList.add('hidden');\n            if (playerMessage) playerMessage.classList.remove('hidden');\n        }\n\n        // Story 14.5: Trigger end-game celebrations (AC3, AC4)\n        if (currentPlayer) {\n            var totalRounds = data.total_rounds || 10;\n            // H3 fix: Use best_streak === totalRounds as reliable perfect game indicator\n            // (correct_guesses field doesn't exist in backend)\n            var bestStreak = currentPlayer.best_streak || 0;\n            var isPerfectGame = bestStreak === totalRounds && totalRounds > 0;\n\n            if (isPerfectGame) {\n                // AC4: Perfect game - epic celebration\n                triggerConfetti('perfect');\n            } else if (currentPlayer.rank === 1) {\n                // AC3: Winner - fireworks celebration\n                triggerConfetti('winner');\n            }\n        }\n    }\n\n    // ============================================\n    // Paused View (Story 7-1)\n    // ============================================\n\n    /**\n     * Update paused view based on pause reason\n     * @param {Object} data - State data with pause_reason\n     */\n    function updatePausedView(data) {\n        var messageEl = document.getElementById('pause-message');\n        if (messageEl) {\n            if (data.pause_reason === 'admin_disconnected') {\n                messageEl.textContent = 'Waiting for host to reconnect...';\n            } else if (data.pause_reason === 'media_player_error') {\n                messageEl.textContent = 'Speaker unavailable. Please check your media player and try again.';\n            } else {\n                messageEl.textContent = 'Game paused. Please wait...';\n            }\n        }\n    }\n\n    /**\n     * Handle new game button click (Story 6.6)\n     */\n    async function handleNewGame() {\n        var confirmed = await showConfirmModal(\n            utils.t('admin.newGameTitle') || 'New Game?',\n            utils.t('admin.newGameConfirm') || 'Start a new game?',\n            utils.t('admin.newGame') || 'New Game',\n            utils.t('common.cancel')\n        );\n        if (!confirmed) {\n            return;\n        }\n\n        var btn = document.getElementById('new-game-btn');\n        if (btn) {\n            btn.disabled = true;\n            btn.textContent = 'Redirecting...';\n        }\n\n        // Clear admin session storage\n        try {\n            sessionStorage.removeItem('beatify_admin_name');\n            sessionStorage.removeItem('beatify_is_admin');\n        } catch (e) {\n            // Ignore storage errors\n        }\n\n        // Redirect to admin page for new game setup\n        window.location.href = '/beatify/admin';\n    }\n\n    // Debounce state to prevent rapid clicks\n    var nextRoundPending = false;\n    var NEXT_ROUND_DEBOUNCE_MS = 2000;\n\n    /**\n     * Handle next round button click\n     */\n    function handleNextRound() {\n        // Prevent rapid clicks\n        if (nextRoundPending) {\n            return;\n        }\n\n        if (ws && ws.readyState === WebSocket.OPEN) {\n            nextRoundPending = true;\n\n            // Update both buttons (reveal-view and control bar) - Story 6.3\n            var revealBtn = document.getElementById('next-round-btn');\n            var barBtn = document.getElementById('next-round-admin-btn');\n\n            if (revealBtn) {\n                revealBtn.disabled = true;\n                revealBtn.textContent = 'Loading...';\n            }\n            if (barBtn) {\n                barBtn.disabled = true;\n                var labelEl = barBtn.querySelector('.control-label');\n                if (labelEl) labelEl.textContent = 'Wait...';\n            }\n\n            ws.send(JSON.stringify({\n                type: 'admin',\n                action: 'next_round'\n            }));\n\n            // Reset after debounce period (server state change will also update UI)\n            setTimeout(function() {\n                nextRoundPending = false;\n                if (revealBtn) revealBtn.disabled = false;\n                if (barBtn) barBtn.disabled = false;\n            }, NEXT_ROUND_DEBOUNCE_MS);\n        }\n    }\n\n    // ============================================\n    // Admin Control Bar (Story 6.1)\n    // ============================================\n\n    // Debounce state for admin actions\n    let adminActionPending = false;\n    var ADMIN_ACTION_DEBOUNCE_MS = 500;\n\n    // Song stopped state (Story 6.2)\n    let songStopped = false;\n\n    // Volume state (Story 6.4)\n    let currentVolume = 0.5;\n\n    /**\n     * Debounce admin actions to prevent rapid repeated clicks\n     * @returns {boolean} True if action can proceed, false if debounced\n     */\n    function debounceAdminAction() {\n        if (adminActionPending) return false;\n        adminActionPending = true;\n        setTimeout(function() { adminActionPending = false; }, ADMIN_ACTION_DEBOUNCE_MS);\n        return true;\n    }\n\n    /**\n     * Show admin control bar for admin players\n     */\n    function showAdminControlBar() {\n        if (!isAdmin) return;\n        var bar = document.getElementById('admin-control-bar');\n        if (bar) {\n            bar.classList.remove('hidden');\n            document.body.classList.add('has-control-bar'); // M3 fix\n        }\n    }\n\n    /**\n     * Hide admin control bar\n     */\n    function hideAdminControlBar() {\n        var bar = document.getElementById('admin-control-bar');\n        if (bar) {\n            bar.classList.add('hidden');\n            document.body.classList.remove('has-control-bar'); // M3 fix\n        }\n    }\n\n    // ============================================\n    // Live Reactions (Story 18.9)\n    // ============================================\n\n    /**\n     * Show reaction bar during REVEAL phase\n     */\n    function showReactionBar() {\n        var bar = document.getElementById('reaction-bar');\n        if (bar) {\n            bar.classList.remove('hidden');\n        }\n    }\n\n    /**\n     * Hide reaction bar (non-REVEAL phases)\n     */\n    function hideReactionBar() {\n        var bar = document.getElementById('reaction-bar');\n        if (bar) {\n            bar.classList.add('hidden');\n        }\n    }\n\n    /**\n     * Send reaction via WebSocket (fire-and-forget)\n     * @param {string} emoji - The emoji to send\n     */\n    function sendReaction(emoji) {\n        // Rate limit: 1 reaction per phase\n        if (hasReactedThisPhase) {\n            return; // Silently ignore (AC: #2)\n        }\n\n        // Mark as reacted\n        hasReactedThisPhase = true;\n\n        // Send to server (fire-and-forget, no acknowledgment expected)\n        if (ws && ws.readyState === WebSocket.OPEN) {\n            ws.send(JSON.stringify({\n                type: 'reaction',\n                emoji: emoji\n            }));\n        }\n    }\n\n    /**\n     * Setup reaction bar click handlers\n     */\n    function setupReactionBar() {\n        var bar = document.getElementById('reaction-bar');\n        if (!bar) return;\n\n        var buttons = bar.querySelectorAll('.reaction-btn');\n        buttons.forEach(function(btn) {\n            btn.addEventListener('click', function() {\n                var emoji = btn.getAttribute('data-emoji');\n                if (emoji) {\n                    sendReaction(emoji);\n                }\n            });\n        });\n    }\n\n    // Initialize reaction bar handlers\n    setupReactionBar();\n\n    /**\n     * Show floating reaction bubble from another player (Story 18.9)\n     * @param {string} playerName - Name of player who sent reaction\n     * @param {string} emoji - The emoji reaction\n     */\n    function showFloatingReaction(playerName, emoji) {\n        var container = document.getElementById('reaction-container');\n        if (!container) return;\n\n        var bubble = document.createElement('div');\n        bubble.className = 'reaction-bubble';\n        bubble.textContent = playerName + ' ' + emoji;\n\n        // Random horizontal position (20% to 80% of screen width)\n        bubble.style.left = (20 + Math.random() * 60) + '%';\n\n        container.appendChild(bubble);\n\n        // Remove after animation completes (3s)\n        setTimeout(function() {\n            bubble.remove();\n        }, 3000);\n    }\n\n    /**\n     * Update control bar button states based on phase\n     * @param {string} phase - Current game phase\n     */\n    function updateControlBarState(phase) {\n        var stopBtn = document.getElementById('stop-song-btn');\n        var nextBtn = document.getElementById('next-round-admin-btn');\n\n        if (phase === 'PLAYING') {\n            // Reset song stopped state for new round (Story 6.2)\n            resetSongStoppedState();\n            // Stop Song enabled (unless already stopped)\n            if (stopBtn && !songStopped) {\n                stopBtn.classList.remove('is-disabled');\n                stopBtn.disabled = false;\n            }\n            // Next Round enabled for \"Skip\" functionality (Story 6.3)\n            if (nextBtn) {\n                nextBtn.classList.remove('is-disabled');\n                nextBtn.disabled = false;\n                var labelEl = nextBtn.querySelector('.control-label');\n                if (labelEl) labelEl.textContent = 'Skip';\n            }\n        } else if (phase === 'REVEAL') {\n            // Stop Song still enabled (song may continue during reveal), Next Round enabled\n            if (stopBtn && !songStopped) {\n                stopBtn.classList.remove('is-disabled');\n                stopBtn.disabled = false;\n            }\n            if (nextBtn) {\n                nextBtn.classList.remove('is-disabled');\n                nextBtn.disabled = false;\n                var labelEl = nextBtn.querySelector('.control-label');\n                if (labelEl) labelEl.textContent = 'Next';\n            }\n        } else {\n            // LOBBY or END: disable Next Round (Story 6.3)\n            if (nextBtn) {\n                nextBtn.classList.add('is-disabled');\n                nextBtn.disabled = true;\n                var labelEl = nextBtn.querySelector('.control-label');\n                if (labelEl) labelEl.textContent = 'Next';\n            }\n        }\n        // Volume and End Game always enabled (no changes needed)\n    }\n\n    /**\n     * Handle Stop Song button (Story 16.6)\n     */\n    function handleStopSong() {\n        // Check if already stopped (prevent redundant clicks)\n        if (songStopped) return;\n\n        if (!debounceAdminAction()) return;\n\n        if (!ws || ws.readyState !== WebSocket.OPEN) {\n            console.warn('[Beatify] Cannot stop song: WebSocket not connected');\n            return;\n        }\n\n        // Immediate visual feedback (AC1, AC3)\n        var stopBtn = document.getElementById('stop-song-btn');\n        if (stopBtn) {\n            stopBtn.classList.add('is-disabled');\n            stopBtn.disabled = true;\n            var labelEl = stopBtn.querySelector('.control-label');\n            if (labelEl) labelEl.textContent = 'Stopping...';\n        }\n\n        ws.send(JSON.stringify({\n            type: 'admin',\n            action: 'stop_song'\n        }));\n    }\n\n    /**\n     * Handle Volume Up button\n     */\n    function handleVolumeUp() {\n        // Check limit before debounce (M2 fix)\n        if (currentVolume >= 1.0) {\n            showVolumeLimitFeedback('max');\n            return;\n        }\n        if (!debounceAdminAction()) return;\n        if (!ws || ws.readyState !== WebSocket.OPEN) return;\n\n        ws.send(JSON.stringify({\n            type: 'admin',\n            action: 'set_volume',\n            direction: 'up'\n        }));\n    }\n\n    /**\n     * Handle Volume Down button\n     */\n    function handleVolumeDown() {\n        // Check limit before debounce (M2 fix)\n        if (currentVolume <= 0.0) {\n            showVolumeLimitFeedback('min');\n            return;\n        }\n        if (!debounceAdminAction()) return;\n        if (!ws || ws.readyState !== WebSocket.OPEN) return;\n\n        ws.send(JSON.stringify({\n            type: 'admin',\n            action: 'set_volume',\n            direction: 'down'\n        }));\n    }\n\n    /**\n     * Show feedback when volume is at limit (M2 fix)\n     * @param {string} limit - 'max' or 'min'\n     */\n    function showVolumeLimitFeedback(limit) {\n        var indicator = document.getElementById('volume-indicator');\n        if (!indicator) return;\n\n        indicator.textContent = limit === 'max' ? '\uD83D\uDD0A Max' : '\uD83D\uDD07 Min';\n        indicator.classList.remove('hidden');\n        indicator.classList.add('is-visible');\n\n        // Fade out after 1s (shorter than normal feedback)\n        setTimeout(function() {\n            indicator.classList.remove('is-visible');\n            setTimeout(function() {\n                indicator.classList.add('hidden');\n            }, 300);\n        }, 1000);\n    }\n\n    /**\n     * Handle End Game button\n     */\n    async function handleEndGame() {\n        var confirmed = await showConfirmModal(\n            utils.t('admin.endGameConfirm') || 'End Game?',\n            utils.t('admin.endGameWarning') || 'All players will be disconnected.',\n            utils.t('admin.endGame') || 'End Game',\n            utils.t('common.cancel')\n        );\n        if (!confirmed) return;\n        if (!debounceAdminAction()) return;\n        if (!ws || ws.readyState !== WebSocket.OPEN) {\n            alert(utils.t('errors.CONNECTION_LOST'));\n            return;\n        }\n\n        // Update button state (Story 6.5)\n        var endBtn = document.getElementById('end-game-btn');\n        if (endBtn) {\n            endBtn.disabled = true;\n            var labelEl = endBtn.querySelector('.control-label');\n            if (labelEl) labelEl.textContent = 'Ending...';\n        }\n\n        ws.send(JSON.stringify({\n            type: 'admin',\n            action: 'end_game'\n        }));\n    }\n\n    /**\n     * Handle Next Round from control bar (reuse reveal logic)\n     */\n    function handleNextRoundFromBar() {\n        handleNextRound();\n    }\n\n    /**\n     * Setup admin control bar event handlers\n     */\n    function setupAdminControlBar() {\n        var stopBtn = document.getElementById('stop-song-btn');\n        var volUpBtn = document.getElementById('volume-up-btn');\n        var volDownBtn = document.getElementById('volume-down-btn');\n        var nextBtn = document.getElementById('next-round-admin-btn');\n        var endBtn = document.getElementById('end-game-btn');\n\n        if (stopBtn) stopBtn.addEventListener('click', handleStopSong);\n        if (volUpBtn) volUpBtn.addEventListener('click', handleVolumeUp);\n        if (volDownBtn) volDownBtn.addEventListener('click', handleVolumeDown);\n        if (nextBtn) nextBtn.addEventListener('click', handleNextRoundFromBar);\n        if (endBtn) endBtn.addEventListener('click', handleEndGame);\n    }\n\n    /**\n     * Handle song stopped notification from server (Story 6.2)\n     */\n    function handleSongStopped() {\n        songStopped = true;\n        var stopBtn = document.getElementById('stop-song-btn');\n        if (stopBtn) {\n            stopBtn.classList.add('is-stopped');\n            stopBtn.classList.add('is-disabled');\n            stopBtn.disabled = true;\n            var iconEl = stopBtn.querySelector('.control-icon');\n            var labelEl = stopBtn.querySelector('.control-label');\n            if (iconEl) iconEl.textContent = '\u2713';\n            if (labelEl) labelEl.textContent = 'Stopped';\n        }\n    }\n\n    /**\n     * Reset song stopped state for new round (Story 6.2)\n     */\n    function resetSongStoppedState() {\n        songStopped = false;\n        var stopBtn = document.getElementById('stop-song-btn');\n        if (stopBtn) {\n            stopBtn.classList.remove('is-stopped');\n            stopBtn.classList.remove('is-disabled');\n            stopBtn.disabled = false;\n            var iconEl = stopBtn.querySelector('.control-icon');\n            var labelEl = stopBtn.querySelector('.control-label');\n            if (iconEl) iconEl.textContent = '\u23F9\uFE0F';\n            if (labelEl) labelEl.textContent = 'Stop';\n        }\n    }\n\n    /**\n     * Handle volume changed response from server (Story 6.4)\n     * @param {number} level - New volume level (0.0 to 1.0)\n     */\n    function handleVolumeChanged(level) {\n        currentVolume = level;\n        showVolumeIndicator(level);\n        updateVolumeLimitStates(level);\n    }\n\n    /**\n     * Show brief volume indicator popup (Story 6.4)\n     * @param {number} level - Volume level\n     */\n    function showVolumeIndicator(level) {\n        var indicator = document.getElementById('volume-indicator');\n        if (!indicator) return;\n\n        var percentage = Math.round(level * 100);\n        indicator.textContent = '\uD83D\uDD0A ' + percentage + '%';\n        indicator.classList.remove('hidden');\n        indicator.classList.add('is-visible');\n\n        // Fade out after 1.5s\n        setTimeout(function() {\n            indicator.classList.remove('is-visible');\n            setTimeout(function() {\n                indicator.classList.add('hidden');\n            }, 300);\n        }, 1500);\n    }\n\n    /**\n     * Update volume buttons when at limits (Story 6.4)\n     * @param {number} level - Current volume level\n     */\n    function updateVolumeLimitStates(level) {\n        var upBtn = document.getElementById('volume-up-btn');\n        var downBtn = document.getElementById('volume-down-btn');\n\n        if (upBtn) {\n            upBtn.classList.toggle('is-at-limit', level >= 1.0);\n        }\n        if (downBtn) {\n            downBtn.classList.toggle('is-at-limit', level <= 0.0);\n        }\n    }\n\n    // ============================================\n    // Admin Controls (Story 3.5)\n    // ============================================\n\n    let isAdmin = false;\n\n    /**\n     * Check if user is admin (from sessionStorage on redirect from admin page)\n     * @returns {boolean}\n     */\n    function checkAdminStatus() {\n        const storedAdmin = sessionStorage.getItem('beatify_is_admin');\n        const storedName = sessionStorage.getItem('beatify_admin_name');\n\n        if (storedAdmin === 'true' && storedName) {\n            isAdmin = true;\n            playerName = storedName;\n            // Clear storage after reading (keep name for reconnection)\n            sessionStorage.removeItem('beatify_is_admin');\n        }\n        return isAdmin;\n    }\n\n    /**\n     * Update admin controls visibility based on player state\n     * @param {Array} players - Players from state\n     */\n    function updateAdminControls(players) {\n        const adminControls = document.getElementById('admin-controls');\n        const lobbyStatus = document.getElementById('lobby-status');\n        if (!adminControls) return;\n        // Guard: ensure players is an array\n        if (!players || !Array.isArray(players)) {\n            players = [];\n        }\n\n        // Find if current player is admin from state\n        const currentPlayer = players.find(function(p) { return p.name === playerName; });\n        const playerIsAdmin = currentPlayer?.is_admin === true;\n\n        if (playerIsAdmin) {\n            adminControls.classList.remove('hidden');\n            if (lobbyStatus) lobbyStatus.classList.add('hidden');\n        } else {\n            adminControls.classList.add('hidden');\n            if (lobbyStatus) lobbyStatus.classList.remove('hidden');\n        }\n    }\n\n    /**\n     * Setup admin control event handlers\n     */\n    function setupAdminControls() {\n        const startBtn = document.getElementById('start-game-btn');\n\n        startBtn?.addEventListener('click', function() {\n            if (!ws || ws.readyState !== WebSocket.OPEN) return;\n\n            startBtn.disabled = true;\n            startBtn.textContent = 'Starting...';\n\n            ws.send(JSON.stringify({\n                type: 'admin',\n                action: 'start_game'\n            }));\n        });\n    }\n\n    // ============================================\n    // WebSocket Client (Story 3.2)\n    // ============================================\n\n    let ws = null;\n    let playerName = null;\n    let reconnectAttempts = 0;\n    const MAX_RECONNECT_ATTEMPTS = 10;  // Story 7-3: Increased for resilience\n    const MAX_RECONNECT_DELAY_MS = 30000;\n    const STORAGE_KEY_NAME = 'beatify_player_name';\n    const STORAGE_KEY_GAME_ID = 'beatify_game_id';\n    const STORAGE_KEY_LANGUAGE = 'beatify_language';\n\n    // Reconnection state (Story 7-3)\n    let isReconnecting = false;\n\n    // Intentional leave flag (Story 11.5) - prevents auto-reconnect after Leave Game\n    let intentionalLeave = false;\n\n    // Reaction state (Story 18.9) - rate limit: 1 reaction per reveal phase\n    let hasReactedThisPhase = false;\n\n    /**\n     * Get reconnection delay with exponential backoff\n     * @returns {number} Delay in milliseconds\n     */\n    function getReconnectDelay() {\n        // Exponential backoff: 1s, 2s, 4s, 8s, 16s, 30s max\n        return Math.min(1000 * Math.pow(2, reconnectAttempts), MAX_RECONNECT_DELAY_MS);\n    }\n\n    /**\n     * Get stored player name for this game (Story 7-3)\n     * @returns {string|null} Stored name or null\n     */\n    function getStoredPlayerName() {\n        try {\n            var storedGameId = localStorage.getItem(STORAGE_KEY_GAME_ID);\n            var storedName = localStorage.getItem(STORAGE_KEY_NAME);\n            console.log('[Beatify] Checking localStorage - storedGameId:', storedGameId, 'currentGameId:', gameId, 'storedName:', storedName);\n\n            if (storedGameId && storedGameId === gameId) {\n                console.log('[Beatify] Game ID match, returning stored name:', storedName);\n                return storedName;\n            }\n\n            if (storedGameId && storedGameId !== gameId) {\n                // Different game, clear stored name\n                console.log('[Beatify] Different game ID, clearing stored data');\n                localStorage.removeItem(STORAGE_KEY_NAME);\n                localStorage.removeItem(STORAGE_KEY_GAME_ID);\n            }\n        } catch (e) {\n            console.error('[Beatify] localStorage error:', e);\n        }\n        return null;\n    }\n\n    /**\n     * Store player name for reconnection (Story 7-3)\n     * @param {string} name - Player name to store\n     */\n    function storePlayerName(name) {\n        try {\n            localStorage.setItem(STORAGE_KEY_NAME, name);\n            localStorage.setItem(STORAGE_KEY_GAME_ID, gameId);\n            console.log('[Beatify] Stored player name:', name, 'for game:', gameId);\n        } catch (e) {\n            console.error('[Beatify] Failed to store player name:', e);\n        }\n    }\n\n    /**\n     * Clear stored player name (Story 7-3)\n     */\n    function clearStoredPlayerName() {\n        try {\n            localStorage.removeItem(STORAGE_KEY_NAME);\n            localStorage.removeItem(STORAGE_KEY_GAME_ID);\n        } catch (e) {\n            // localStorage unavailable\n        }\n    }\n\n    /**\n     * Store game language in localStorage for consistent UI on reload\n     * @param {string} lang - Language code ('en' or 'de')\n     */\n    function storeGameLanguage(lang) {\n        try {\n            localStorage.setItem(STORAGE_KEY_LANGUAGE, lang);\n        } catch (e) {\n            // localStorage unavailable\n        }\n    }\n\n    /**\n     * Get stored game language from localStorage\n     * @returns {string|null} Language code or null\n     */\n    function getStoredLanguage() {\n        try {\n            return localStorage.getItem(STORAGE_KEY_LANGUAGE);\n        } catch (e) {\n            return null;\n        }\n    }\n\n    /**\n     * Show reconnecting overlay (Story 7-3)\n     */\n    function showReconnectingOverlay() {\n        var overlay = document.getElementById('reconnecting-overlay');\n        if (overlay) {\n            overlay.classList.remove('hidden');\n        }\n    }\n\n    /**\n     * Hide reconnecting overlay (Story 7-3)\n     */\n    function hideReconnectingOverlay() {\n        var overlay = document.getElementById('reconnecting-overlay');\n        if (overlay) {\n            overlay.classList.add('hidden');\n        }\n    }\n\n    /**\n     * Update reconnecting overlay status (Story 7-3)\n     * @param {number} attempt - Current attempt number\n     */\n    function updateReconnectStatus(attempt) {\n        var statusEl = document.getElementById('reconnect-status');\n        if (statusEl) {\n            statusEl.textContent = 'Reconnecting... (Attempt ' + attempt + '/' + MAX_RECONNECT_ATTEMPTS + ')';\n        }\n    }\n\n    /**\n     * Show connection lost view (Story 7-4)\n     */\n    function showConnectionLostView() {\n        showView('connection-lost-view');\n    }\n\n    /**\n     * Setup retry connection button (Story 7-4)\n     */\n    function setupRetryConnection() {\n        var retryBtn = document.getElementById('retry-connection-btn');\n        if (retryBtn) {\n            retryBtn.addEventListener('click', function() {\n                if (playerName) {\n                    reconnectAttempts = 0;\n                    showView('loading-view');\n                    connectWebSocket(playerName);\n                } else {\n                    // No player name - go back to join view\n                    checkGameStatus();\n                }\n            });\n        }\n    }\n\n    /**\n     * Connect to WebSocket and send join message\n     * @param {string} name - Player name\n     */\n    function connectWebSocket(name) {\n        playerName = name;\n        // Store name for reconnection (Story 7-3)\n        storePlayerName(name);\n\n        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n        const wsUrl = wsProtocol + '//' + window.location.host + '/beatify/ws';\n\n        ws = new WebSocket(wsUrl);\n\n        ws.onopen = function() {\n            reconnectAttempts = 0;\n            isReconnecting = false;\n            hideReconnectingOverlay();\n\n            var joinMsg = { type: 'join', name: name };\n            if (isAdmin) {\n                joinMsg.is_admin = true;\n            }\n            ws.send(JSON.stringify(joinMsg));\n        };\n\n        ws.onmessage = function(event) {\n            try {\n                const data = JSON.parse(event.data);\n                handleServerMessage(data);\n            } catch (e) {\n                console.error('Failed to parse WebSocket message:', e);\n            }\n        };\n\n        ws.onclose = function() {\n            // Story 11.5: Skip auto-reconnect if user intentionally left\n            if (intentionalLeave) {\n                intentionalLeave = false;  // Reset flag\n                return;\n            }\n            // Attempt reconnection if we were connected and have a name\n            if (playerName && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n                isReconnecting = true;\n                reconnectAttempts++;\n                showReconnectingOverlay();\n                updateReconnectStatus(reconnectAttempts);\n\n                const delay = getReconnectDelay();\n                console.log('WebSocket closed. Reconnecting in ' + delay + 'ms... (attempt ' + reconnectAttempts + ')');\n                setTimeout(function() { connectWebSocket(playerName); }, delay);\n            } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {\n                // Max attempts reached - show connection lost view (Story 7-4)\n                isReconnecting = false;\n                hideReconnectingOverlay();\n                showConnectionLostView();\n            }\n        };\n\n        ws.onerror = function(err) {\n            console.error('WebSocket error:', err);\n        };\n    }\n\n    /**\n     * Handle messages from server\n     * @param {Object} data - Parsed message data\n     */\n    function handleServerMessage(data) {\n        const joinBtn = document.getElementById('join-btn');\n        const nameInput = document.getElementById('name-input');\n\n        if (data.type === 'state') {\n            // Update isAdmin from players list (Story 6.1)\n            var players = data.players || [];\n            var currentPlayer = players.find(function(p) { return p.name === playerName; });\n            if (currentPlayer) {\n                isAdmin = currentPlayer.is_admin === true;\n            }\n\n            // Apply language from game state (Story 12.4, 16.3)\n            // Must re-render dynamic content after language loads\n            if (data.language) {\n                // Store language for future page loads\n                storeGameLanguage(data.language);\n                // Apply if different from current (guard: skip if i18n unavailable)\n                if (typeof BeatifyI18n !== 'undefined' && data.language !== BeatifyI18n.getLanguage()) {\n                    BeatifyI18n.setLanguage(data.language).then(function() {\n                        BeatifyI18n.initPageTranslations();\n                        // Re-render dynamic content with new language\n                        renderPlayerList(players);\n                        if (data.difficulty) {\n                            renderDifficultyBadge(data.difficulty);\n                        }\n                        // Re-render reveal view for localized fun facts (Story 16.3)\n                        if (data.phase === 'REVEAL') {\n                            updateRevealView(data);\n                        }\n                    });\n                }\n            }\n\n            if (data.phase === 'LOBBY') {\n                stopCountdown();\n                hideAdminControlBar();  // Story 6.1\n                hideReactionBar();  // Story 18.9\n                currentRoundNumber = 0;  // Reset for new game\n                setEnergyLevel('warmup');  // Story 9.9\n                showView('lobby-view');\n                renderPlayerList(players);\n                // Render difficulty badge (Story 14.1)\n                if (data.difficulty) {\n                    renderDifficultyBadge(data.difficulty);\n                }\n                // Render QR code with join URL\n                if (data.join_url) {\n                    renderQRCode(data.join_url);\n                }\n                // Update admin controls visibility\n                updateAdminControls(players);\n            } else if (data.phase === 'PLAYING') {\n                // Only reset submission state when round actually changes\n                var newRound = data.round || 1;\n                if (newRound !== currentRoundNumber) {\n                    currentRoundNumber = newRound;\n                    resetSubmissionState();  // Reset for new round\n                }\n                setEnergyLevel('party');  // Story 9.9\n                showView('game-view');\n                closeInviteModal();  // Story 16.5 - auto-close invite modal when round starts\n                updateGameView(data);\n                // Render difficulty badge (Story 14.1)\n                if (data.difficulty) {\n                    renderDifficultyBadge(data.difficulty);\n                }\n                if (data.deadline) {\n                    startCountdown(data.deadline);\n                }\n                initYearSelector();\n                setupLeaderboardToggle();  // Story 5.5\n                // Show admin control bar (Story 6.1)\n                showAdminControlBar();\n                updateControlBarState('PLAYING');\n                hideReactionBar();  // Story 18.9 - only visible during REVEAL\n            } else if (data.phase === 'REVEAL') {\n                stopCountdown();\n                setEnergyLevel('party');  // Story 9.9 - maintain party for reveal\n                showView('reveal-view');\n                updateRevealView(data);\n                setupRevealLeaderboardToggle();  // Collapsible reveal leaderboard\n                setupRoundAnalyticsToggle();     // Collapsible round analytics (collapsed by default)\n                // Show admin control bar (Story 6.1)\n                showAdminControlBar();\n                updateControlBarState('REVEAL');\n                // Show reaction bar and reset rate limit (Story 18.9)\n                hasReactedThisPhase = false;\n                showReactionBar();\n            } else if (data.phase === 'PAUSED') {\n                // Story 7-1: Show paused view\n                stopCountdown();\n                hideAdminControlBar();\n                hideReactionBar();  // Story 18.9\n                setEnergyLevel('warmup');  // Story 9.9 - lower energy during pause\n                showView('paused-view');\n                updatePausedView(data);\n            } else if (data.phase === 'END') {\n                stopCountdown();\n                hideAdminControlBar();  // Story 6.1\n                hideReactionBar();  // Story 18.9\n                currentRoundNumber = 0;  // Reset for potential new game\n                setEnergyLevel('warmup');  // Story 9.9 - final standings, lower energy\n                showView('end-view');\n                updateEndView(data);  // Story 5.6\n                // Clear stored player name (game is over - Story 7-3)\n                clearStoredPlayerName();\n            }\n        } else if (data.type === 'join_ack') {\n            // Handle join acknowledgment with session_id (Story 11.1)\n            if (data.session_id) {\n                setSessionCookie(data.session_id);\n            }\n            // Clear admin redirect storage - connection established, session cookie handles reconnect\n            try {\n                sessionStorage.removeItem('beatify_admin_name');\n                sessionStorage.removeItem('beatify_is_admin');\n            } catch (e) {\n                // Ignore storage errors\n            }\n        } else if (data.type === 'reconnect_ack') {\n            // Handle session-based reconnect acknowledgment (Story 11.2)\n            if (data.success && data.name) {\n                playerName = data.name;\n                storePlayerName(data.name);\n                showWelcomeBackToast(data.name);\n                // State message will follow with full game state\n            } else {\n                // Reconnect failed - clear session and show join form\n                clearSessionCookie();\n                clearStoredPlayerName();\n                playerName = null;\n                showView('join-view');\n            }\n        } else if (data.type === 'submit_ack') {\n            // Handle successful guess submission\n            handleSubmitAck();\n        } else if (data.type === 'error') {\n            // Handle submission-related errors\n            if (data.code === 'ROUND_EXPIRED' || data.code === 'ALREADY_SUBMITTED') {\n                handleSubmitError(data);\n                return;\n            }\n            // Handle GAME_ENDED error specially\n            if (data.code === 'GAME_ENDED') {\n                showView('end-view');\n                return;\n            }\n            // Handle NOT_ADMIN error (Story 6.1)\n            if (data.code === 'NOT_ADMIN') {\n                isAdmin = false;\n                hideAdminControlBar();\n                console.warn('Admin action rejected: not admin');\n                return;\n            }\n            // Handle SESSION_TAKEOVER - another tab took over (Story 11.2)\n            if (data.code === 'SESSION_TAKEOVER') {\n                isReconnecting = false;\n                hideReconnectingOverlay();\n                // Don't clear session cookie - other tab is using it\n                playerName = null;\n                showConnectionLostView();\n                console.warn('Session taken over by another tab');\n                return;\n            }\n            // Handle SESSION_NOT_FOUND - session expired or game reset (Story 11.2)\n            if (data.code === 'SESSION_NOT_FOUND') {\n                clearSessionCookie();\n                // Prevent reconnect attempts by reusing intentionalLeave flag\n                intentionalLeave = true;\n                // Close WebSocket cleanly to prevent onclose reconnect\n                if (ws) {\n                    ws.close();\n                }\n                // Fall back to join form\n                showView('join-view');\n                return;\n            }\n            // Handle ADMIN_CANNOT_LEAVE - host tried to leave (Story 11.5)\n            if (data.code === 'ADMIN_CANNOT_LEAVE') {\n                // Reset intentional leave flag since action was blocked\n                intentionalLeave = false;\n                // Show user-friendly error message\n                alert(data.message || 'Host cannot leave. End the game instead.');\n                return;\n            }\n            // Handle INVALID_ACTION for stop_song - restore button state (Story 16.6)\n            if (data.code === 'INVALID_ACTION' && data.message === 'No song playing') {\n                // Restore stop button state if action failed\n                resetSongStoppedState();\n                console.warn('[Beatify] Stop song failed: No song playing');\n                return;\n            }\n            // Show join view first (user may be on loading-view from auto-reconnect)\n            showView('join-view');\n            // Show error, re-enable form\n            showJoinError(data.message);\n            if (joinBtn) {\n                joinBtn.disabled = false;\n                joinBtn.textContent = utils.t('join.joinButton');\n            }\n            if (nameInput) {\n                nameInput.focus();\n            }\n            // Clear stored name on join error\n            playerName = null;\n            // Clear localStorage to prevent repeated auto-reconnect failures\n            clearStoredPlayerName();\n        } else if (data.type === 'song_stopped') {\n            // Story 6.2 - handle song stopped notification\n            handleSongStopped();\n        } else if (data.type === 'volume_changed') {\n            // Story 6.4 - handle volume changed response\n            handleVolumeChanged(data.level);\n        } else if (data.type === 'game_ended') {\n            // Story 7-5 - game has fully ended\n            handleGameEnded();\n        } else if (data.type === 'left') {\n            // Story 11.5 - player left game successfully\n            handleLeftGame();\n        } else if (data.type === 'steal_targets') {\n            // Story 15.3 - handle steal targets response\n            handleStealTargets(data);\n        } else if (data.type === 'steal_ack') {\n            // Story 15.3 - handle steal acknowledgment\n            handleStealAck(data);\n        } else if (data.type === 'artist_guess_ack') {\n            // Story 20.5 - handle artist guess acknowledgment\n            handleArtistGuessAck(data);\n        } else if (data.type === 'player_reaction') {\n            // Story 18.9 - show floating reaction from other players\n            showFloatingReaction(data.player_name, data.emoji);\n        }\n    }\n\n    /**\n     * Handle successful leave game response (Story 11.5)\n     */\n    function handleLeftGame() {\n        // Clear all stored session data\n        clearStoredPlayerName();\n        clearSessionCookie();\n\n        // Reset local state\n        playerName = null;\n        isAdmin = false;\n\n        // Show join view for potential rejoin\n        showView('join-view');\n    }\n\n    /**\n     * Handle leave game button click (Story 11.5)\n     */\n    async function handleLeaveGame() {\n        if (!ws || ws.readyState !== WebSocket.OPEN) {\n            return;\n        }\n\n        // Safety check - admin shouldn't see button, but double-check\n        if (isAdmin) {\n            alert('Host cannot leave. End the game instead.');\n            return;\n        }\n\n        // Confirmation dialog per AC #1\n        var confirmed = await showConfirmModal(\n            utils.t('player.leaveGameTitle') || 'Leave Game?',\n            utils.t('player.leaveGameWarning') || 'Your score will be lost.',\n            utils.t('player.leaveGame') || 'Leave',\n            utils.t('common.cancel')\n        );\n        if (!confirmed) {\n            return;\n        }\n\n        // Set intentional leave flag to prevent auto-reconnect\n        intentionalLeave = true;\n\n        // Send leave message to server\n        ws.send(JSON.stringify({ type: 'leave' }));\n    }\n\n    /**\n     * Handle game ended notification (Story 7-5)\n     */\n    function handleGameEnded() {\n        // Save admin state before clearing (for redirect decision)\n        var wasAdmin = isAdmin;\n\n        // Clear all stored session data\n        clearStoredPlayerName();\n        clearSessionCookie();  // Story 11.1 - clear session cookie on game end\n        try {\n            sessionStorage.removeItem('beatify_admin_name');\n            sessionStorage.removeItem('beatify_is_admin');\n        } catch (e) {\n            // Ignore storage errors\n        }\n\n        // Story 18.1: Clean up lazy loading observer to prevent memory leak\n        cleanupLeaderboardObserver();\n\n        // Story 18.2: Clean up virtual player list\n        cleanupVirtualPlayerList();\n\n        // Story 18.3: Clear animation queue and stop confetti\n        AnimationQueue.clear();\n        stopConfetti();\n\n        // Reset local state\n        playerName = null;\n        isAdmin = false;\n\n        // Close WebSocket to prevent stale connections\n        if (ws && ws.readyState === WebSocket.OPEN) {\n            ws.close();\n        }\n        ws = null;\n\n        // If admin ended the game, delay redirect so they can see final results\n        if (wasAdmin) {\n            // Show end view for 5 seconds before redirecting to admin setup\n            setTimeout(function() {\n                window.location.href = '/beatify/admin';\n            }, 5000);\n            return;\n        }\n\n        // If already showing end view, just update the message\n        if (!endView || !endView.classList.contains('hidden')) {\n            return;\n        }\n\n        // Update end message with rejoin hint\n        var endMessage = document.getElementById('end-player-message');\n        if (endMessage) {\n            endMessage.innerHTML =\n                '<p>Thanks for playing!</p>' +\n                '<p class=\"rejoin-hint\">Scan the QR code again to join the next game.</p>';\n            endMessage.classList.remove('hidden');\n        }\n\n        showView('end-view');\n    }\n\n    /**\n     * Show join error message\n     * @param {string} message - Error message to display\n     */\n    function showJoinError(message) {\n        const validationMsg = document.getElementById('name-validation-msg');\n        if (validationMsg) {\n            validationMsg.textContent = message;\n            validationMsg.classList.remove('hidden');\n        }\n    }\n\n    /**\n     * Validate player name\n     * @param {string} name - Name to validate\n     * @returns {{valid: boolean, name?: string, error?: string}}\n     */\n    function validateName(name) {\n        const trimmed = (name || '').trim();\n        if (!trimmed) {\n            return { valid: false, error: 'Please enter a name' };\n        }\n        if (trimmed.length > MAX_NAME_LENGTH) {\n            return { valid: false, error: 'Name too long (max 20 characters)' };\n        }\n        return { valid: true, name: trimmed };\n    }\n\n    /**\n     * Handle join button click\n     */\n    function handleJoinClick() {\n        const nameInput = document.getElementById('name-input');\n        const joinBtn = document.getElementById('join-btn');\n        const validationMsg = document.getElementById('name-validation-msg');\n        if (!nameInput || !joinBtn) return;\n\n        const result = validateName(nameInput.value);\n        if (!result.valid) return;\n\n        joinBtn.disabled = true;\n        joinBtn.textContent = 'Joining...';\n\n        // Clear any previous error\n        if (validationMsg) {\n            validationMsg.classList.add('hidden');\n        }\n\n        connectWebSocket(result.name);\n    }\n\n    /**\n     * Setup join form event handlers\n     */\n    function setupJoinForm() {\n        const nameInput = document.getElementById('name-input');\n        const joinBtn = document.getElementById('join-btn');\n        const validationMsg = document.getElementById('name-validation-msg');\n        if (!nameInput || !joinBtn) return;\n\n        nameInput.addEventListener('input', function() {\n            const result = validateName(this.value);\n            joinBtn.disabled = !result.valid;\n            if (validationMsg) {\n                validationMsg.textContent = (!result.valid && this.value) ? result.error : '';\n                validationMsg.classList.toggle('hidden', result.valid || !this.value);\n            }\n        });\n\n        joinBtn.addEventListener('click', handleJoinClick);\n        nameInput.addEventListener('keypress', function(e) {\n            if (e.key === 'Enter' && !joinBtn.disabled) {\n                handleJoinClick();\n            }\n        });\n    }\n\n    // Wrap showView to auto-focus name input and set energy level (Story 9.9)\n    const originalShowView = showView;\n    showView = function(viewId) {\n        originalShowView(viewId);\n\n        // Set calm energy for entry screens (Story 9.9)\n        if (viewId === 'join-view' || viewId === 'loading-view' ||\n            viewId === 'not-found-view' || viewId === 'ended-view' ||\n            viewId === 'in-progress-view' || viewId === 'connection-lost-view') {\n            setEnergyLevel('calm');\n        }\n\n        if (viewId === 'join-view') {\n            setTimeout(function() {\n                var nameInput = document.getElementById('name-input');\n                if (nameInput) nameInput.focus();\n            }, 100);\n        }\n    };\n\n    // ============================================\n    // Energy Escalation System (Story 9.9)\n    // ============================================\n\n    /**\n     * Set energy level class on body based on game phase\n     * @param {string} level - 'calm', 'warmup', or 'party'\n     */\n    function setEnergyLevel(level) {\n        document.body.classList.remove('energy-calm', 'energy-warmup', 'energy-party');\n        document.body.classList.add('energy-' + level);\n    }\n\n    // ============================================\n    // Confetti System (Story 14.5 - canvas-confetti library)\n    // ============================================\n\n    // Track active animations for cleanup (M3 fix)\n    var confettiAnimationId = null;\n    var confettiIntervalId = null;\n\n    /**\n     * Trigger confetti celebration animation (Story 14.5)\n     * Uses canvas-confetti library for various celebration types\n     * Story 18.3: Now device-aware with reduced particle counts on low-end devices\n     * @param {string} type - 'exact', 'record', 'winner', or 'perfect'\n     */\n    function triggerConfetti(type) {\n        // AC5: Respect accessibility preference (Story 18.3: use cached value)\n        if (AnimationUtils.prefersReducedMotion()) {\n            showStaticCelebration();\n            return;\n        }\n\n        // Check if confetti library is loaded\n        if (typeof confetti === 'undefined') {\n            console.warn('[Confetti] Library not loaded');\n            return;\n        }\n\n        // Stop any existing animation before starting new one (M3 fix)\n        stopConfetti();\n\n        // Story 18.3: Get device-aware particle count\n        var quality = AnimationUtils.getQualitySettings();\n        var baseParticles = quality.confettiParticles;\n\n        // Skip confetti entirely for low-end devices with 0 particles\n        if (baseParticles === 0) {\n            showStaticCelebration();\n            return;\n        }\n\n        // Story 18.3: Scale durations for low-end devices\n        var tier = AnimationUtils.getDeviceTier();\n        var durationMultiplier = tier === 'low' ? 0.5 : (tier === 'medium' ? 0.75 : 1);\n\n        // Default to 'exact' for backward compatibility\n        type = type || 'exact';\n\n        switch (type) {\n            case 'exact':\n                // AC1: Gold burst for exact guess, 2 seconds (scaled by device tier)\n                var exactDuration = Math.round(2000 * durationMultiplier);\n                var exactEnd = Date.now() + exactDuration;\n                (function exactFrame() {\n                    confetti({\n                        particleCount: baseParticles,\n                        spread: 70,\n                        origin: { y: 0.6 },\n                        colors: ['#FFD700', '#FFA500', '#FFEC8B']\n                    });\n                    if (Date.now() < exactEnd) {\n                        confettiAnimationId = requestAnimationFrame(exactFrame);\n                    }\n                }());\n                break;\n\n            case 'record':\n                // AC2: Rainbow shower for new record, 3 seconds (scaled)\n                var recordDuration = Math.round(3000 * durationMultiplier);\n                var recordEnd = Date.now() + recordDuration;\n                (function recordFrame() {\n                    confetti({\n                        particleCount: Math.round(baseParticles * 0.67),\n                        spread: 180,\n                        origin: { y: 0.3, x: Math.random() },\n                        colors: ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#8b00ff']\n                    });\n                    if (Date.now() < recordEnd) {\n                        confettiAnimationId = requestAnimationFrame(recordFrame);\n                    }\n                }());\n                break;\n\n            case 'winner':\n                // AC3: Dual-side fireworks for winner, 4 seconds (scaled)\n                var winnerDuration = Math.round(4000 * durationMultiplier);\n                var winnerEnd = Date.now() + winnerDuration;\n                (function winnerFrame() {\n                    confetti({\n                        particleCount: Math.round(baseParticles * 0.67),\n                        angle: 60,\n                        spread: 55,\n                        origin: { x: 0 },\n                        colors: ['#ff2d6a', '#00f5ff', '#00ff88', '#ffdd00']\n                    });\n                    confetti({\n                        particleCount: Math.round(baseParticles * 0.67),\n                        angle: 120,\n                        spread: 55,\n                        origin: { x: 1 },\n                        colors: ['#ff2d6a', '#00f5ff', '#00ff88', '#ffdd00']\n                    });\n                    if (Date.now() < winnerEnd) {\n                        confettiAnimationId = requestAnimationFrame(winnerFrame);\n                    }\n                }());\n                break;\n\n            case 'perfect':\n                // AC4: Epic celebration for perfect game, 5 seconds (scaled)\n                var perfectDuration = Math.round(5000 * durationMultiplier);\n                var perfectEnd = Date.now() + perfectDuration;\n\n                // M4 fix: Use setInterval for reliable center bursts\n                confettiIntervalId = setInterval(function() {\n                    confetti({\n                        particleCount: baseParticles * 2,\n                        spread: 100,\n                        origin: { y: 0.6 },\n                        colors: ['#FFD700', '#FFA500', '#FFEC8B']\n                    });\n                }, tier === 'low' ? 750 : 500);\n\n                // Clear interval when duration ends\n                setTimeout(function() {\n                    if (confettiIntervalId) {\n                        clearInterval(confettiIntervalId);\n                        confettiIntervalId = null;\n                    }\n                }, perfectDuration);\n\n                (function perfectFrame() {\n                    confetti({\n                        particleCount: Math.round(baseParticles * 0.5),\n                        angle: 60,\n                        spread: 55,\n                        origin: { x: 0 },\n                        colors: ['#FFD700', '#ff2d6a', '#00f5ff', '#00ff88']\n                    });\n                    confetti({\n                        particleCount: Math.round(baseParticles * 0.5),\n                        angle: 120,\n                        spread: 55,\n                        origin: { x: 1 },\n                        colors: ['#FFD700', '#ff2d6a', '#00f5ff', '#00ff88']\n                    });\n                    if (Date.now() < perfectEnd) {\n                        confettiAnimationId = requestAnimationFrame(perfectFrame);\n                    }\n                }());\n                break;\n\n            default:\n                console.warn('[Confetti] Unknown type:', type);\n        }\n    }\n\n    /**\n     * Stop any ongoing confetti animations (M3 fix - proper cleanup)\n     */\n    function stopConfetti() {\n        // Cancel animation frame\n        if (confettiAnimationId) {\n            cancelAnimationFrame(confettiAnimationId);\n            confettiAnimationId = null;\n        }\n        // Clear interval\n        if (confettiIntervalId) {\n            clearInterval(confettiIntervalId);\n            confettiIntervalId = null;\n        }\n        // Reset library canvas\n        if (typeof confetti !== 'undefined' && confetti.reset) {\n            confetti.reset();\n        }\n    }\n\n    /**\n     * Show static celebration for reduced motion users (AC5)\n     */\n    function showStaticCelebration() {\n        var emotionEl = document.getElementById('reveal-emotion');\n        if (emotionEl) {\n            var existingIcon = emotionEl.querySelector('.celebration-icon');\n            if (!existingIcon) {\n                var icon = document.createElement('span');\n                icon.className = 'celebration-icon';\n                icon.textContent = ' \uD83C\uDF89';\n                emotionEl.appendChild(icon);\n            }\n        }\n    }\n\n    /**\n     * Setup reveal view event handlers\n     * Story 18.3: Added tap-to-skip animations (AC4)\n     */\n    function setupRevealControls() {\n        var nextRoundBtn = document.getElementById('next-round-btn');\n        if (nextRoundBtn) {\n            nextRoundBtn.addEventListener('click', handleNextRound);\n        }\n\n        // Story 18.3: Add tap-to-skip for reveal animations (AC4)\n        var revealViewEl = document.getElementById('reveal-view');\n        if (revealViewEl) {\n            revealViewEl.addEventListener('click', function(e) {\n                // Don't skip if clicking on buttons\n                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {\n                    return;\n                }\n                // Skip all queued animations and stop confetti\n                if (AnimationQueue.isRunning()) {\n                    AnimationQueue.skipAll();\n                }\n                stopConfetti();\n            });\n        }\n    }\n\n    // Initialize form, QR modal, and admin controls when DOM ready\n    async function initAll() {\n        // Story 18.3: Apply device tier class for CSS-based optimizations\n        var deviceTier = AnimationUtils.getDeviceTier();\n        document.body.classList.add('device-tier-' + deviceTier);\n\n        // Initialize i18n with stored language preference (Story 12.4)\n        // This ensures consistent UI language on page reload before WebSocket connects\n        // Guard clause: wait for BeatifyI18n in case fallback script is loading\n        var i18nAvailable = await utils.waitForI18n();\n        if (!i18nAvailable) {\n            console.error('[Player] BeatifyI18n module failed to load - UI will use fallback text');\n        } else {\n            var storedLang = getStoredLanguage();\n            await BeatifyI18n.init(storedLang);\n            BeatifyI18n.initPageTranslations();\n        }\n\n        // Set dashboard hint URL with full address (Story 16.4)\n        var dashboardHintEl = document.getElementById('dashboard-hint-url');\n        if (dashboardHintEl) {\n            dashboardHintEl.textContent = window.location.origin + '/beatify/dashboard';\n        }\n\n        // Set dashboard URL for new compact lobby layout\n        var playerDashboardUrl = document.getElementById('player-dashboard-url');\n        if (playerDashboardUrl) {\n            playerDashboardUrl.href = window.location.origin + '/beatify/dashboard';\n        }\n\n        setupJoinForm();\n        setupQRModal();\n        setupInviteModal();  // Story 16.5\n        setupAdminControls();\n        setupRevealControls();\n        setupAdminControlBar();  // Story 6.1\n        setupRetryConnection();  // Story 7-4\n        setupLeaderboardResizeHandler();  // Story 18.1\n        initQrCollapsible();  // Story 18.8\n        setupLobbyCollapsible();  // New compact lobby sections\n        // Note: canvas-confetti library (Story 14.5) needs no initialization\n\n        // Check if this is an admin redirect\n        if (checkAdminStatus() && playerName) {\n            // Auto-connect as admin\n            connectWebSocket(playerName);\n            return;\n        }\n\n        // Auto-reconnect from localStorage on page reload (Story 7-3)\n        var storedName = getStoredPlayerName();\n        if (storedName && gameId) {\n            console.log('[Beatify] Auto-reconnecting as:', storedName);\n            // Auto-connect with stored name\n            connectWebSocket(storedName);\n            return;\n        }\n\n        // No stored name - prefill form if we have a partial match\n        if (storedName) {\n            var nameInput = document.getElementById('name-input');\n            var joinBtn = document.getElementById('join-btn');\n            if (nameInput) {\n                nameInput.value = storedName;\n                if (joinBtn) {\n                    var result = validateName(storedName);\n                    joinBtn.disabled = !result.valid;\n                }\n            }\n        }\n    }\n\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', initAll);\n    } else {\n        initAll();\n    }\n\n    // ============================================\n    // Service Worker Registration (Story 18.5)\n    // ============================================\n\n    /**\n     * Register service worker for asset caching\n     * AC1: Register on first visit to cache critical assets\n     */\n    if ('serviceWorker' in navigator) {\n        window.addEventListener('load', function() {\n            navigator.serviceWorker.register('/beatify/static/sw.js', {\n                scope: '/beatify/'\n            }).then(function(registration) {\n                console.log('[Beatify] SW registered:', registration.scope);\n            }).catch(function(error) {\n                console.warn('[Beatify] SW registration failed:', error);\n            });\n        });\n    }\n\n})();\n"],
  "mappings": "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",
  "names": ["_a", "_b", "utils", "gameId", "loadingView", "notFoundView", "endedView", "inProgressView", "joinView", "lobbyView", "gameView", "revealView", "pausedView", "endView", "connectionLostView", "allViews", "showView", "viewId", "isValidGameIdFormat", "id", "showConfirmModal", "title", "message", "confirmText", "cancelText", "resolve", "modal", "titleEl", "messageEl", "yesBtn", "noBtn", "cleanup", "onConfirm", "onCancel", "backdrop", "checkGameStatus", "__async", "data", "adminName", "sessionCookie", "getSessionCookie", "connectWithSession", "err", "SESSION_COOKIE_NAME", "setSessionCookie", "sessionId", "secureFlag", "cookies", "i", "cookie", "clearSessionCookie", "prefersReducedMotion", "easeOutQuart", "t", "animateValue", "element", "start", "end", "duration", "easing", "quality", "AnimationUtils", "adjustedDuration", "startTime", "animationId", "cancelled", "finalValue", "step", "timestamp", "elapsed", "progress", "easedProgress", "currentValue", "animateScoreChange", "oldScore", "newScore", "options", "animationClass", "onEnd", "showPointsPopup", "targetElement", "points", "popup", "rect", "previousState", "isPreviousStateInitialized", "STREAK_MILESTONES", "reducedMotionQuery", "_prefersReducedMotion", "e", "_deviceTier", "getDeviceTier", "cores", "memory", "isIOSSafari", "tier", "animationFn", "fallbackFn", "properties", "durationMs", "AnimationQueue", "queue", "running", "currentAnimation", "animationTimeoutId", "MAX_ANIMATION_DURATION", "processNext", "animation", "anim", "LEADERBOARD_LAZY_CONFIG", "lazyLeaderboardState", "initLeaderboardObserver", "listEl", "entries", "entry", "fullData", "range", "buffer", "newStart", "renderLazyLeaderboardRange", "newEnd", "entryHeight", "topSpacerHeight", "bottomSpacerHeight", "scrollTop", "html", "renderLeaderboardEntry", "sentinels", "sentinel", "name", "rank", "score", "rankClass", "currentClass", "changeIndicator", "streakIndicator", "hotClass", "disconnectedClass", "awayBadge", "displayScore", "escapeHtml", "calculateInitialVisibleRange", "displayList", "currentPlayerName", "config", "viewportHeight", "viewportEntries", "currentIdx", "cleanupLeaderboardObserver", "setupLeaderboardResizeHandler", "resizeTimeout", "handleResize", "playerName", "initQrCollapsible", "qrSection", "STORAGE_KEY", "MOBILE_BREAKPOINT", "savedState", "setupLobbyCollapsible", "collapsibleHeaders", "header", "section", "isCollapsed", "VIRTUAL_LIST_CONFIG", "virtualPlayerList", "initVirtualPlayerList", "container", "ticking", "renderVirtualPlayerList", "setVirtualPlayerListItems", "items", "renderItemFn", "prevScrollTop", "wasVirtual", "renderAllPlayerCards", "setupVirtualContainer", "topSpacer", "contentWrapper", "bottomSpacer", "containerHeight", "itemHeight", "overscan", "startIdx", "endIdx", "cleanupVirtualPlayerList", "isStreakMilestone", "oldStreak", "newStreak", "milestone", "detectRankChanges", "newLeaderboard", "newOrder", "changes", "newRank", "oldRank", "updatePreviousState", "players", "leaderboard", "player", "resetPreviousState", "isValidUUID", "str", "wsProtocol", "wsUrl", "ws", "reconnectAttempts", "isReconnecting", "hideReconnectingOverlay", "event", "handleServerMessage", "MAX_RECONNECT_ATTEMPTS", "showReconnectingOverlay", "updateReconnectStatus", "delay", "getReconnectDelay", "showConnectionLostView", "showWelcomeBackToast", "indicator", "MAX_NAME_LENGTH", "previousPlayers", "text", "div", "renderPlayerList", "countEl", "countBadgeEl", "playersSummaryEl", "playersEmptyEl", "count", "sortedPlayers", "a", "b", "previousNames", "p", "newNames", "renderPlayerCard", "isNew", "isYou", "isDisconnected", "classes", "newCards", "renderDifficultyBadge", "difficulty", "labelKey", "label", "lobbyBadge", "gameBadge", "currentJoinUrl", "renderQRCode", "joinUrl", "openQRModal", "modalCode", "closeBtn", "closeQRModal", "setupQRModal", "openInviteModal", "urlInput", "closeInviteModal", "feedback", "copyJoinUrl", "showCopyFeedback", "fallbackCopy", "setupInviteModal", "inviteBtn", "copyBtn", "countdownInterval", "startCountdown", "deadline", "stopCountdown", "timerElement", "updateCountdown", "now", "remaining", "updateGameView", "currentRound", "totalRounds", "lastRoundBanner", "albumCover", "albumLoading", "newSrc", "renderSubmissionTracker", "updateLeaderboard", "updateStealUI", "renderArtistChallenge", "getInitials", "trimmed", "parts", "tracker", "playerList", "submittedCount", "totalCount", "allSubmitted", "initials", "isCurrentPlayer", "badges", "targetListId", "isRevealPhase", "shouldAnimate", "rankChanges", "rankChange", "prevPlayer", "prevScore", "compressLeaderboard", "useLazyLoading", "scoreAnimations", "entryMap", "entryEl", "scoreEl", "scrollToCurrentPlayer", "updateYouIndicator", "updateLeaderboardSummary", "top5", "bottom3", "currentEntry", "youEl", "currentPlayer", "setupLeaderboardToggle", "toggle", "summaryId", "summaryIds", "summaryEl", "leader", "setupRevealLeaderboardToggle", "setupRoundAnalyticsToggle", "hasSubmitted", "betActive", "currentRoundNumber", "hasStealAvailable", "artistChallengeComplete", "pendingArtistGuess", "winningArtist", "ARTIST_DEBOUNCE_MS", "lastArtistGuessTime", "initYearSelector", "slider", "yearDisplay", "betToggle", "submitBtn", "handleSubmitGuess", "stealBtn", "handleStealClick", "stealModalClose", "closeStealModal", "stealModal", "year", "showSubmitError", "handleSubmitAck", "yearSelector", "confirmation", "handleSubmitError", "resetSubmissionState", "hideStealUI", "resetArtistChallengeState", "artistChallenge", "phase", "optionsEl", "resultEl", "currentOptions", "btn", "newOptions", "artist", "index", "handleArtistGuess", "buttons", "correctArtist", "msg", "handleArtistGuessAck", "badge", "disableAllArtistButtons", "bonusText", "showArtistResult", "isWinner", "renderArtistReveal", "nameEl", "winnerEl", "stealIndicator", "openStealModal", "targets", "targetList", "noTargets", "target", "selectStealTarget", "targetName", "confirmMsg", "confirmed", "handleStealAck", "showStealConfirmation", "handleStealTargets", "toast", "updateRevealView", "song", "roundEl", "totalEl", "correctYear", "artistEl", "funFactContainer", "funFactText", "funFactHeader", "localizedFunFact", "renderRichSongInfo", "renderSongDifficulty", "richInfo", "hasRichInfo", "hasFunFact", "showRevealEmotion", "renderPersonalResult", "triggerConfetti", "renderPlayerResultCards", "renderRoundAnalytics", "adminControls", "nextRoundBtn", "analytics", "avgComparison", "diff", "histogramHtml", "renderHistogram", "achievementsHtml", "names", "furthestOff", "avgDisplay", "allGuesses", "NUM_BINS", "guesses", "g", "minGuess", "maxGuess", "yearsPerBin", "totalYears", "extraYears", "startYear", "bins", "binStart", "binEnd", "j", "guess", "k", "maxCount", "m", "barsHtml", "n", "bin", "heightPercent", "barClass", "barHeight", "countHtml", "renderSuperlatives", "superlatives", "award", "valueText", "el", "stars", "chartBadges", "renderChartBadges", "certBadges", "renderCertificationBadges", "localizedAwards", "awardBadges", "renderAwardBadges", "chartInfo", "weeksText", "certifications", "cert", "badgeClass", "getCertificationBadgeClass", "icon", "getCertificationIcon", "certLower", "awards", "displayAwards", "getAwardBadgeClass", "getAwardIcon", "awardLower", "emotionEl", "personalResult", "isCompact", "stopConfetti", "emotions", "randomFrom", "arr", "getOffByText", "years", "emotionType", "emotionText", "subtitle", "yearsOff", "emotionHtml", "resultContent", "missedHtml", "previousStreak", "yearsOffText", "resultClass", "speedMultiplier", "baseScore", "hasSpeedBonus", "streakBonus", "artistBonus", "scoreBreakdown", "betOutcomeHtml", "streakBonusHtml", "artistBonusHtml", "totalScore", "hasBonuses", "isBigScore", "prevStreak", "streakMilestone", "scoreValueEl", "totalValueEl", "milestoneBonus", "sorted", "isMissed", "roundScore", "scoreClass", "guessDisplay", "yearsOffDisplay", "betIndicator", "artistBadge", "stealerNames", "updateEndView", "place", "rankEl", "bestStreakEl", "roundsEl", "betsEl", "playerMessage", "newGameBtn", "handleNewGame", "bestStreak", "isPerfectGame", "updatePausedView", "nextRoundPending", "NEXT_ROUND_DEBOUNCE_MS", "handleNextRound", "revealBtn", "barBtn", "labelEl", "adminActionPending", "ADMIN_ACTION_DEBOUNCE_MS", "songStopped", "currentVolume", "debounceAdminAction", "showAdminControlBar", "isAdmin", "bar", "hideAdminControlBar", "showReactionBar", "hideReactionBar", "sendReaction", "emoji", "hasReactedThisPhase", "setupReactionBar", "showFloatingReaction", "bubble", "updateControlBarState", "stopBtn", "nextBtn", "resetSongStoppedState", "handleStopSong", "handleVolumeUp", "showVolumeLimitFeedback", "handleVolumeDown", "limit", "handleEndGame", "endBtn", "handleNextRoundFromBar", "setupAdminControlBar", "volUpBtn", "volDownBtn", "handleSongStopped", "iconEl", "handleVolumeChanged", "level", "showVolumeIndicator", "updateVolumeLimitStates", "percentage", "upBtn", "downBtn", "checkAdminStatus", "storedAdmin", "storedName", "updateAdminControls", "lobbyStatus", "setupAdminControls", "startBtn", "MAX_RECONNECT_DELAY_MS", "STORAGE_KEY_NAME", "STORAGE_KEY_GAME_ID", "STORAGE_KEY_LANGUAGE", "intentionalLeave", "getStoredPlayerName", "storedGameId", "storePlayerName", "clearStoredPlayerName", "storeGameLanguage", "lang", "getStoredLanguage", "overlay", "attempt", "statusEl", "setupRetryConnection", "retryBtn", "connectWebSocket", "joinMsg", "joinBtn", "nameInput", "setEnergyLevel", "newRound", "showJoinError", "handleGameEnded", "handleLeftGame", "handleLeaveGame", "wasAdmin", "endMessage", "validationMsg", "validateName", "handleJoinClick", "result", "setupJoinForm", "originalShowView", "confettiAnimationId", "confettiIntervalId", "type", "showStaticCelebration", "baseParticles", "durationMultiplier", "exactDuration", "exactEnd", "exactFrame", "recordDuration", "recordEnd", "recordFrame", "winnerDuration", "winnerEnd", "winnerFrame", "perfectDuration", "perfectEnd", "perfectFrame", "existingIcon", "setupRevealControls", "revealViewEl", "initAll", "deviceTier", "i18nAvailable", "storedLang", "dashboardHintEl", "playerDashboardUrl", "registration", "error"]
}
