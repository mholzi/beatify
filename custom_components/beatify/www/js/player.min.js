(()=>{var Oe=(He,C,G)=>new Promise((ye,ae)=>{var he=M=>{try{j(G.next(M))}catch(U){ae(U)}},Ee=M=>{try{j(G.throw(M))}catch(U){ae(U)}},j=M=>M.done?ye(M.value):Promise.resolve(M.value).then(he,Ee);j((G=G.apply(He,C)).next())});(function(){"use strict";var mt,vt;const C=new URLSearchParams(window.location.search).get("game"),G=document.getElementById("loading-view"),ye=document.getElementById("not-found-view"),ae=document.getElementById("ended-view"),he=document.getElementById("in-progress-view"),Ee=document.getElementById("join-view"),j=document.getElementById("lobby-view"),M=document.getElementById("game-view"),U=document.getElementById("reveal-view"),gt=document.getElementById("paused-view"),Le=document.getElementById("end-view"),pt=document.getElementById("connection-lost-view");function E(e){[G,ye,ae,he,Ee,j,M,U,gt,Le,pt].forEach(function(a){a&&a.classList.add("hidden")});const n=document.getElementById(e);n&&n.classList.remove("hidden")}function bt(e){return!e||typeof e!="string"?!1:/^[a-zA-Z0-9_-]{8,16}$/.test(e)}function De(e,n){if(!e)return null;var a=BeatifyI18n.getLanguage();if(a&&a!=="en"){var r=n+"_"+a;if(e[r])return e[r]}return e[n]||null}function re(){return Oe(this,null,function*(){if(!C){E("not-found-view");return}if(!bt(C)){E("not-found-view");return}try{const r=yield(yield fetch(`/beatify/api/game-status?game=${encodeURIComponent(C)}`)).json();if(!r.exists){E("not-found-view");return}if(r.phase==="END"){E("ended-view");return}var e=sessionStorage.getItem("beatify_admin_name");if(e)return;var n=Pe();if(n){je();return}r.can_join?E("join-view"):E("in-progress-view")}catch(a){console.error("Failed to check game status:",a),E("not-found-view")}})}re(),(mt=document.getElementById("refresh-btn"))==null||mt.addEventListener("click",()=>{E("loading-view"),re()}),(vt=document.getElementById("retry-btn"))==null||vt.addEventListener("click",()=>{E("loading-view"),re()});var ie="beatify_session";function yt(e){var n=location.protocol==="https:"?"; Secure":"";document.cookie=ie+"="+e+"; path=/beatify; SameSite=Strict; max-age=86400"+n}function Pe(){for(var e=document.cookie.split(";"),n=0;n<e.length;n++){var a=e[n].trim();if(a.indexOf(ie+"=")===0)return a.substring(ie.length+1)}return null}function z(){document.cookie=ie+"=; path=/beatify; max-age=0"}function se(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function ht(e){return 1-Math.pow(1-e,4)}function Ie(e,n,a,r,i){if(se()||n===a)return e.textContent=a,{cancel:function(){},skipToEnd:function(){e.textContent=a}};var s=Y.getQualitySettings();if(s.scoreDuration===0)return e.textContent=a,{cancel:function(){},skipToEnd:function(){e.textContent=a}};var l=Math.min(r,s.scoreDuration||r);i=i||ht;var o=null,u=null,d=!1,v=a;function c(g){if(!d){o||(o=g);var p=g-o,w=Math.min(p/l,1),y=i(w),L=Math.round(n+(v-n)*y);e.textContent=L,w<1&&(u=requestAnimationFrame(c))}}return u=requestAnimationFrame(c),{cancel:function(){d=!0,u&&cancelAnimationFrame(u)},skipToEnd:function(){d=!0,u&&cancelAnimationFrame(u),e.textContent=v}}}function Et(e,n,a,r){r=r||{};var i=500;r.betWon?i=800:r.isBigScore?i=700:r.betLost&&(i=400),e.classList.add("score-animating");var s=null;r.betWon?s="score-glow-gold":r.betLost?(s="score-shake",e.classList.add("score-flash-red")):r.streakMilestone?s="score-burst":r.isBigScore&&(s="score-pop"),s&&!se()&&e.classList.add(s),Ie(e,n,a,i);function l(){e.classList.remove("score-animating"),s&&e.classList.remove(s),e.classList.remove("score-flash-red")}s&&!se()?e.addEventListener("animationend",function o(){e.removeEventListener("animationend",o),l()}):setTimeout(l,i+50)}function Fe(e,n,a){if(a=a||{},!se()){var r=document.createElement("div");r.className="points-popup",r.textContent=a.text||"+"+n,a.isStreak?r.classList.add("points-popup--streak"):a.isBetWin&&r.classList.add("points-popup--gold");var i=e.getBoundingClientRect();r.style.left=i.left+i.width/2+"px",r.style.top=i.top+"px",document.body.appendChild(r),r.addEventListener("animationend",function(){r.parentNode&&r.parentNode.removeChild(r)}),setTimeout(function(){r.parentNode&&r.parentNode.removeChild(r)},1200)}}var x={players:{},leaderboard:[],initialized:!1};function Lt(){return x.initialized}var Ve=[3,5,10],Y=function(){var e=window.matchMedia("(prefers-reduced-motion: reduce)"),n=e.matches;e.addEventListener("change",function(i){n=i.matches});var a=null;function r(){if(a!==null)return a;var i=navigator.hardwareConcurrency||2,s=navigator.deviceMemory||4,l=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return i<=2||s<=2?a="low":i<=4||s<=4||l?a="medium":a="high",a}return r(),{prefersReducedMotion:function(){return n},getDeviceTier:r,getQualitySettings:function(){var i=r();if(n)return{confettiParticles:0,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!1};switch(i){case"low":return{confettiParticles:5,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!0};case"medium":return{confettiParticles:10,scoreDuration:300,leaderboardAnimation:"simplified",neonGlow:!1,enableAnimations:!0};default:return{confettiParticles:15,scoreDuration:500,leaderboardAnimation:"full",neonGlow:!0,enableAnimations:!0}}},ifMotionAllowed:function(i,s){n?s&&s():i()},withWillChange:function(i,s,l){i&&(i.style.willChange=s,setTimeout(function(){i&&i.style&&(i.style.willChange="auto")},(l||500)+100))}}}(),we=function(){var e=[],n=!1,a=null,r=null,i=2e3;function s(){if(r&&(clearTimeout(r),r=null),e.length===0){n=!1,a=null;return}a=e.shift(),r=setTimeout(function(){a&&a.skipToEnd&&a.skipToEnd(),s()},i),a.run(function(){r&&(clearTimeout(r),r=null),s()})}return{add:function(l){e.push(l),n||(n=!0,s())},skipAll:function(){r&&(clearTimeout(r),r=null),a&&a.skipToEnd&&a.skipToEnd(),e.forEach(function(l){l.skipToEnd&&l.skipToEnd()}),e=[],n=!1,a=null},clear:function(){r&&(clearTimeout(r),r=null),e=[],n=!1,a=null},isRunning:function(){return n},getMaxDuration:function(){return maxDuration}}}(),Q={VISIBLE_BUFFER:2,ENTRY_HEIGHT:48,MIN_PLAYERS_FOR_LAZY:10,ROOT_MARGIN:"96px 0px",DEFAULT_VIEWPORT_HEIGHT:280},b={observer:null,fullData:[],visibleRange:{start:0,end:10},listEl:null,isLazyEnabled:!1};function It(e){e&&(b.observer&&b.listEl!==e&&(b.observer.disconnect(),b.observer=null),!b.observer&&(b.listEl=e,b.observer=new IntersectionObserver(function(n){n.forEach(function(a){if(!(!a.isIntersecting||!b.isLazyEnabled)){var r=b.fullData,i=b.visibleRange,s=Q.VISIBLE_BUFFER;if(a.target.classList.contains("leaderboard-sentinel--top")){if(i.start>0){var l=Math.max(0,i.start-s);b.visibleRange.start=l,oe()}}else if(a.target.classList.contains("leaderboard-sentinel--bottom")&&i.end<r.length){var o=Math.min(r.length,i.end+s);b.visibleRange.end=o,oe()}}})},{root:e,rootMargin:Q.ROOT_MARGIN,threshold:0})))}function oe(){var e=b.listEl,n=b.fullData,a=b.visibleRange;if(!(!e||!n.length)){var r=Q.ENTRY_HEIGHT,i=a.start*r,s=(n.length-a.end)*r,l=e.scrollTop,o="";i>0&&(o+='<div class="leaderboard-spacer-top" style="height: '+i+'px;"></div>'),o+='<div class="leaderboard-sentinel leaderboard-sentinel--top" style="height: 1px;"></div>';for(var u=a.start;u<a.end&&u<n.length;u++)o+=Ge(n[u]);if(o+='<div class="leaderboard-sentinel leaderboard-sentinel--bottom" style="height: 1px;"></div>',s>0&&(o+='<div class="leaderboard-spacer-bottom" style="height: '+s+'px;"></div>'),e.innerHTML=o,e.scrollTop=l,b.observer){var d=e.querySelectorAll(".leaderboard-sentinel");d.forEach(function(v){b.observer.observe(v)})}}}function Ge(e){if(!e)return"";if(e.separator)return'<div class="leaderboard-separator">...</div>';var n=e.name||"Unknown",a=e.rank||0,r=e.score||0,i=a<=3?"is-top-"+a:"",s=e.is_current?"is-current":"",l="";e.rank_change>0||e._rankChange==="up"?l="leaderboard-entry--climbing leaderboard-entry--slide-up":(e.rank_change<0||e._rankChange==="down")&&(l="leaderboard-entry--falling leaderboard-entry--slide-down");var o="";e.rank_change>0?o='<span class="rank-up">\u25B2'+e.rank_change+"</span>":e.rank_change<0&&(o='<span class="rank-down">\u25BC'+Math.abs(e.rank_change)+"</span>");var u="";if(e.streak>=2){var d=e.streak>=5?"streak-indicator--hot":"";u='<span class="streak-indicator '+d+'">\u{1F525}'+e.streak+"</span>"}var v=e.connected===!1?"leaderboard-entry--disconnected":"",c=e.connected===!1?'<span class="away-badge">(away)</span>':"",g=e._displayScore!==void 0?e._displayScore:r;return'<div class="leaderboard-entry '+i+" "+s+" "+l+" "+v+'" data-rank="'+a+'" data-name="'+_(n)+'"><span class="entry-rank">#'+a+'</span><span class="entry-name">'+_(n)+c+'</span><span class="entry-meta">'+u+o+'</span><span class="entry-score" data-prev-score="'+(e._prevScore||r)+'">'+g+"</span></div>"}function We(e,n){for(var a=Q,r=b.listEl&&b.listEl.clientHeight||a.DEFAULT_VIEWPORT_HEIGHT,i=Math.ceil(r/a.ENTRY_HEIGHT),s=a.VISIBLE_BUFFER,l=-1,o=0;o<e.length;o++)if(e[o].name===n){l=o;break}var u,d;return l===-1||l<i?(u=0,d=Math.min(e.length,i+s*2)):l>=e.length-i?(u=Math.max(0,e.length-i-s),d=e.length):(u=Math.max(0,l-Math.floor(i/2)-s),d=Math.min(e.length,l+Math.ceil(i/2)+s)),{start:u,end:d}}function wt(){b.observer&&(b.observer.disconnect(),b.observer=null),b.isLazyEnabled=!1,b.fullData=[]}function St(){var e;function n(){clearTimeout(e),e=setTimeout(function(){b.isLazyEnabled&&b.fullData.length>0&&(b.visibleRange=We(b.fullData,h),oe())},150)}window.addEventListener("resize",n),window.addEventListener("orientationchange",n)}var qe={ITEM_HEIGHT:60,OVERSCAN:3,THRESHOLD:15,CONTAINER_HEIGHT:320},m={container:null,items:[],scrollTop:0,isVirtual:!1,topSpacer:null,bottomSpacer:null,contentWrapper:null,scrollHandler:null,resizeHandler:null};function Bt(e){if(e){m.container=e;var n=!1;m.scrollHandler=function(){m.scrollTop=e.scrollTop,n||(requestAnimationFrame(function(){Se(),n=!1}),n=!0)};var a;m.resizeHandler=function(){clearTimeout(a),a=setTimeout(function(){m.isVirtual&&Se()},100)},e.addEventListener("scroll",m.scrollHandler,{passive:!0}),window.addEventListener("resize",m.resizeHandler)}}function _t(e,n){m.items=e,m.renderItem=n;var a=m.container;if(a){var r=a.scrollTop,i=m.isVirtual;e.length<qe.THRESHOLD?(m.isVirtual=!1,a.classList.remove("player-list--virtual"),Ct(e,n)):(m.isVirtual=!0,a.classList.add("player-list--virtual"),kt(),Se()),i!==m.isVirtual&&r>0&&(a.scrollTop=r,m.scrollTop=r)}}function kt(){var e=m.container;if(e){e.innerHTML="";var n=document.createElement("div");n.className="virtual-spacer-top",m.topSpacer=n;var a=document.createElement("div");a.className="virtual-content-wrapper",m.contentWrapper=a;var r=document.createElement("div");r.className="virtual-spacer-bottom",m.bottomSpacer=r,e.appendChild(n),e.appendChild(a),e.appendChild(r)}}function Se(){var e=qe,n=m.items,a=m.container,r=m.contentWrapper;if(!(!a||!r||!n.length)){var i=a.clientHeight||e.CONTAINER_HEIGHT,s=m.scrollTop,l=e.ITEM_HEIGHT,o=e.OVERSCAN,u=Math.max(0,Math.floor(s/l)-o),d=Math.min(n.length,Math.ceil((s+i)/l)+o);m.topSpacer&&(m.topSpacer.style.height=u*l+"px"),m.bottomSpacer&&(m.bottomSpacer.style.height=(n.length-d)*l+"px");for(var v="",c=u;c<d;c++)v+=m.renderItem(n[c],c);r.innerHTML=v}}function Ct(e,n){var a=m.container;if(a){for(var r="",i=0;i<e.length;i++)r+=n(e[i],i);a.innerHTML=r}}function xt(){var e=m.container;e&&m.scrollHandler&&e.removeEventListener("scroll",m.scrollHandler),m.resizeHandler&&window.removeEventListener("resize",m.resizeHandler),m.container=null,m.items=[],m.isVirtual=!1,m.topSpacer=null,m.bottomSpacer=null,m.contentWrapper=null}function Tt(e,n){for(var a=0;a<Ve.length;a++){var r=Ve[a];if(e<r&&n>=r)return r}return null}function Mt(e){var n=e.map(function(r){return r.name}),a={};return n.forEach(function(r,i){var s=x.leaderboard.indexOf(r);s===-1?a[r]="new":i<s?a[r]="up":i>s&&(a[r]="down")}),a}function At(e,n){x.players={},e.forEach(function(a){x.players[a.name]={score:a.score,rank:a.rank||0,streak:a.streak||0}}),n&&(x.leaderboard=n.map(function(a){return a.name})),x.initialized=!0}function aa(){x.players={},x.leaderboard=[],x.initialized=!1}function Nt(e){return!e||typeof e!="string"?!1:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e)||/^[a-f0-9]{32}$/i.test(e)}function je(){var e=Pe();if(!e||!Nt(e)){e&&z(),E("join-view");return}var n=window.location.protocol==="https:"?"wss:":"ws:",a=n+"//"+window.location.host+"/beatify/ws";f=new WebSocket(a),f.onopen=function(){k=0,O=!1,te(),f.send(JSON.stringify({type:"reconnect",session_id:e}))},f.onmessage=function(r){try{var i=JSON.parse(r.data);ct(i)}catch(s){console.error("Failed to parse WebSocket message:",s)}},f.onclose=function(){if(h&&k<Z){O=!0,k++,ot(),lt(k);var r=it();console.log("WebSocket closed. Reconnecting in "+r+"ms... (attempt "+k+")"),setTimeout(function(){je()},r)}else k>=Z?(O=!1,te(),Ne()):E("join-view")},f.onerror=function(r){console.error("WebSocket error:",r)}}function Rt(e){var n=document.getElementById("volume-indicator");n&&(n.textContent="Welcome back, "+e+"!",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},2e3))}const Ot=20;let Ue=[];function _(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function ze(e){const n=document.getElementById("player-list"),a=document.getElementById("player-count");if(!n)return;if(a){const o=e.length;a.textContent=o===1?t("lobby.playerJoined"):t("lobby.playersJoined",{count:o})}var r=e.slice().sort(function(o,u){return o.connected!==u.connected?o.connected?-1:1:0});const i=Ue.map(function(o){return o.name}),s=r.filter(function(o){return i.indexOf(o.name)===-1}).map(function(o){return o.name});m.container||Bt(n);var l=function(o){var u=s.indexOf(o.name)!==-1,d=o.name===h,v=o.connected===!1,c=["player-card",u?"is-new":"",d?"player-card--you":"",v?"player-card--disconnected":""].filter(Boolean).join(" "),g=v?'<span class="away-badge">(away)</span>':"";return'<div class="'+c+'" data-player="'+_(o.name)+'"><span class="player-name">'+_(o.name)+(d?'<span class="you-badge">'+t("leaderboard.you")+"</span>":"")+g+"</span></div>"};_t(r,l),setTimeout(function(){var o=m.isVirtual?m.contentWrapper:n;if(!o)return;const u=o.querySelectorAll(".is-new");for(let d=0;d<u.length;d++)u[d].classList.remove("is-new")},2e3),Ue=e.slice()}function Be(e){var n={easy:"game.difficultyEasy",normal:"game.difficultyNormal",hard:"game.difficultyHard"}[e]||"game.difficultyNormal",a=t(n),r=document.getElementById("lobby-difficulty-badge"),i=document.getElementById("game-difficulty-badge");r&&(r.textContent=a,r.className="difficulty-badge difficulty-badge--"+(e||"normal")),i&&(i.textContent=a,i.className="difficulty-badge difficulty-badge--"+(e||"normal"))}let N=null;function Ht(e){if(e){N=e;var n=document.getElementById("player-qr-code");n&&(n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',n.onclick=Ye,n.onkeydown=function(a){(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),Ye())})}}function Ye(){if(N){var e=document.getElementById("qr-modal"),n=document.getElementById("qr-modal-code");if(!(!e||!n)){n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:N,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',e.classList.remove("hidden"),document.body.style.overflow="hidden";var a=document.getElementById("qr-modal-close");a&&a.focus()}}}function _e(){var e=document.getElementById("qr-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="")}function Dt(){var e=document.getElementById("qr-modal"),n=e?e.querySelector(".qr-modal-backdrop"):null,a=document.getElementById("qr-modal-close");n&&n.addEventListener("click",_e),a&&a.addEventListener("click",_e),document.addEventListener("keydown",function(r){r.key==="Escape"&&e&&!e.classList.contains("hidden")&&_e()})}function Pt(){if(N){var e=document.getElementById("invite-modal"),n=document.getElementById("invite-modal-code"),a=document.getElementById("invite-modal-url");if(!(!e||!n)){n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:N,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',a&&(a.value=N),e.classList.remove("hidden"),document.body.style.overflow="hidden";var r=document.getElementById("invite-modal-close");r&&r.focus()}}}function le(){var e=document.getElementById("invite-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="");var n=document.getElementById("invite-copy-feedback");n&&n.classList.add("hidden")}function Ft(){var e=document.getElementById("invite-modal-url"),n=document.getElementById("invite-copy-feedback");!e||!N||(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(N).then(function(){Je(n)}).catch(function(){Qe(e,n)}):Qe(e,n))}function Qe(e,n){e.select(),e.setSelectionRange(0,99999);try{document.execCommand("copy"),Je(n)}catch(a){console.warn("[Beatify] Copy failed:",a)}}function Je(e){e&&(e.classList.remove("hidden"),setTimeout(function(){e.classList.add("hidden")},2e3))}function Vt(){var e=document.getElementById("invite-modal"),n=e?e.querySelector(".invite-modal-backdrop"):null,a=document.getElementById("invite-modal-close"),r=document.getElementById("invite-players-btn"),i=document.getElementById("invite-copy-btn");n&&n.addEventListener("click",le),a&&a.addEventListener("click",le),r&&r.addEventListener("click",Pt),i&&i.addEventListener("click",Ft),document.addEventListener("keydown",function(s){s.key==="Escape"&&e&&!e.classList.contains("hidden")&&le()})}let ce=null;function Gt(e){W();var n=document.getElementById("timer");if(!n)return;n.classList.remove("timer--warning","timer--critical");function a(){var r=Date.now(),i=Math.max(0,Math.ceil((e-r)/1e3));n.textContent=i,i<=5?(n.classList.remove("timer--warning"),n.classList.add("timer--critical")):i<=10?(n.classList.remove("timer--critical"),n.classList.add("timer--warning")):n.classList.remove("timer--warning","timer--critical"),i===10?n.setAttribute("aria-label","10 seconds remaining"):i===5?n.setAttribute("aria-label","5 seconds!"):i===0?n.setAttribute("aria-label","Time is up!"):n.setAttribute("aria-label","Time remaining: "+i+" seconds"),i<=0&&W()}a(),ce=setInterval(a,1e3)}function W(){ce&&(clearInterval(ce),ce=null)}function Wt(e){var n=document.getElementById("current-round"),a=document.getElementById("total-rounds"),r=document.getElementById("last-round-banner");n&&(n.textContent=e.round||1),a&&(a.textContent=e.total_rounds||10),r&&(e.last_round?r.classList.remove("hidden"):r.classList.add("hidden"));var i=document.getElementById("album-cover"),s=document.getElementById("album-loading");if(i&&e.song){s&&s.classList.remove("hidden");var l=e.song.album_art||"/beatify/static/img/no-artwork.svg";i.onload=function(){s&&s.classList.add("hidden")},i.onerror=function(){i.src="/beatify/static/img/no-artwork.svg",s&&s.classList.add("hidden")},i.src=l}jt(e.players),e.leaderboard&&Ke(e,"leaderboard-list"),$t(e.players)}function qt(e){if(!e)return"?";var n=e.trim();if(!n)return"?";var a=n.split(/[\s-]+/).filter(Boolean);return a.length>=2?(a[0][0]+a[1][0]).toUpperCase():n.slice(0,Math.min(2,n.length)).toUpperCase()}function jt(e){var n=document.getElementById("submission-tracker"),a=document.getElementById("submitted-players"),r=document.getElementById("submission-count");if(!(!n||!a||!r)){var i=e||[],s=i.filter(function(d){return d.submitted}).length,l=i.length;r.textContent=t("game.submittedCount",{count:s,total:l});var o=s===l&&l>0;n.classList.toggle("all-submitted",o);var u=i.length>10;if(n.classList.toggle("is-compact",u),u){a.innerHTML="";return}a.innerHTML=i.map(function(d){var v=qt(d.name),c=d.name===h,g=d.connected===!1,p=["player-indicator",d.submitted?"is-submitted":"",c?"is-current-player":"",d.bet?"is-betting":"",g?"player-indicator--disconnected":""].filter(Boolean).join(" ");return'<div class="'+p+'"><div class="player-avatar"><span class="player-initials">'+_(v)+'</span></div><span class="player-name">'+_(d.name)+"</span></div>"}).join("")}}function Ke(e,n,a){var r=e.leaderboard||[],i=document.getElementById(n||"leaderboard-list");if(i){var s=a&&Lt(),l=s?Mt(r):{};r.forEach(function(c){c.is_current=c.name===h;var g=l[c.name];g&&(c._rankChange=g);var p=x.players[c.name],w=p?p.score:c.score;c._prevScore=w,c._displayScore=a?w:c.score});var o=Ut(r,h),u=r.length>=Q.MIN_PLAYERS_FOR_LAZY;if(u)b.observer||It(i),b.fullData=o,b.isLazyEnabled=!0,b.listEl=i,b.visibleRange=We(o,h),oe();else{b.isLazyEnabled=!1;var d="";o.forEach(function(c){d+=Ge(c)}),i.innerHTML=d}var v=[];s&&o.forEach(function(c){!c.separator&&c._prevScore!==c.score&&v.push({name:c.name,prevScore:c._prevScore,newScore:c.score})}),s&&v.length>0&&requestAnimationFrame(function(){for(var c={},g=i.querySelectorAll(".leaderboard-entry[data-name]"),p=0;p<g.length;p++){var w=g[p],y=w.getAttribute("data-name");y&&(c[y]=w)}v.forEach(function(L){var I=c[L.name];if(I){var S=I.querySelector(".entry-score");S&&Ie(S,L.prevScore,L.newScore,500)}})}),r.length>8&&zt(i),Yt(r),At(e.players||[],r)}}function Ut(e,n){if(e.length<=10)return e;for(var a=e.slice(0,5),r=e.slice(-3),i=-1,s=0;s<e.length;s++)if(e[s].name===n){i=s;break}return i<5||i>=e.length-3?[].concat(a,[{separator:!0}],r):[].concat(a,[{separator:!0}],[e[i]],[{separator:!0}],r)}function zt(e){var n=e.querySelector(".leaderboard-entry.is-current");n&&n.scrollIntoView({behavior:"smooth",block:"center"})}function Yt(e){var n=document.getElementById("leaderboard-you"),a=e.find(function(r){return r.is_current});n&&a&&(n.textContent=t("leaderboard.you")+" #"+a.rank,n.classList.remove("hidden"))}function Qt(){var e=document.getElementById("leaderboard-toggle"),n=document.getElementById("game-leaderboard");e&&n&&e.addEventListener("click",function(){n.classList.toggle("is-expanded");var a=e.querySelector(".toggle-icon");a&&(a.textContent=n.classList.contains("is-expanded")?"\u25B2":"\u25BC")})}let R=!1,J=!1,de=0,K=!1;function Jt(){var e=document.getElementById("year-slider"),n=document.getElementById("selected-year");if(!(!e||!n)){e.addEventListener("input",function(){n.textContent=this.value});var a=document.getElementById("bet-toggle");a&&a.addEventListener("click",function(){R||(J=!J,a.classList.toggle("is-active",J))});var r=document.getElementById("submit-btn");r&&r.addEventListener("click",Kt);var i=document.getElementById("steal-btn");i&&i.addEventListener("click",en);var s=document.getElementById("steal-modal-close");s&&s.addEventListener("click",xe);var l=document.getElementById("steal-modal");if(l){var o=l.querySelector(".steal-modal-backdrop");o&&o.addEventListener("click",xe)}}}function Kt(){if(!R){var e=document.getElementById("year-slider"),n=document.getElementById("submit-btn");if(!(!e||!n)){var a=parseInt(e.value,10);n.disabled=!0,n.classList.add("is-loading"),f&&f.readyState===WebSocket.OPEN?f.send(JSON.stringify({type:"submit",year:a,bet:J})):(ke("Connection lost. Please refresh."),n.disabled=!1,n.classList.remove("is-loading"))}}}function Xe(){R=!0;var e=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation"),r=document.getElementById("bet-toggle");e&&e.classList.add("is-submitted"),n&&n.classList.add("hidden"),r&&r.classList.add("hidden"),a&&a.classList.remove("hidden")}function Xt(e){var n=document.getElementById("submit-btn");n&&(n.disabled=!1,n.classList.remove("is-loading")),e.code==="ROUND_EXPIRED"?(ke("Time's up!"),R=!0,n&&(n.disabled=!0)):e.code==="ALREADY_SUBMITTED"?Xe():ke(e.message||"Submission failed")}function ke(e){var n=document.getElementById("submit-btn");n&&(n.textContent=e,n.classList.add("is-error"),setTimeout(function(){n.textContent=t("game.submitGuess"),n.classList.remove("is-error")},2e3))}function Zt(){R=!1,J=!1;var e=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation"),r=document.getElementById("year-slider"),i=document.getElementById("bet-toggle");if(e&&e.classList.remove("is-submitted"),n&&(n.disabled=!1,n.classList.remove("hidden","is-loading","is-error"),n.textContent=t("game.submitGuess")),i&&i.classList.remove("hidden","is-active"),a&&a.classList.add("hidden"),r){r.value=1990;var s=document.getElementById("selected-year");s&&(s.textContent="1990")}K=!1,Ce()}function $t(e){if(!(!h||!e)){var n=e.find(function(i){return i.name===h});if(n){K=n.steal_available&&!R;var a=document.getElementById("steal-indicator"),r=document.getElementById("steal-btn");K?(a&&a.classList.remove("hidden"),r&&r.classList.remove("hidden")):Ce()}}}function Ce(){var e=document.getElementById("steal-indicator"),n=document.getElementById("steal-btn");e&&e.classList.add("hidden"),n&&n.classList.add("hidden")}function en(){!K||R||f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"get_steal_targets"}))}function tn(e){var n=document.getElementById("steal-modal"),a=document.getElementById("steal-target-list");if(!(!n||!a)){if(a.innerHTML="",!e||e.length===0){var r=document.createElement("p");r.className="steal-no-targets",r.textContent=t("steal.waitForSubmit"),a.appendChild(r)}else e.forEach(function(i){var s=document.createElement("button");s.className="steal-target-btn",s.textContent=i,s.addEventListener("click",function(){nn(i)}),a.appendChild(s)});n.classList.remove("hidden")}}function xe(){var e=document.getElementById("steal-modal");e&&e.classList.add("hidden")}function nn(e){var n=t("steal.confirm").replace("{name}",e);confirm(n)&&(f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"steal",target:e})),xe())}function an(e){if(e.success){K=!1,R=!0,Ce();var n=document.getElementById("year-selector"),a=document.getElementById("submit-btn"),r=document.getElementById("submitted-confirmation");n&&n.classList.add("is-submitted"),a&&a.classList.add("hidden"),r&&r.classList.remove("hidden"),sn(e.target,e.year);var i=document.getElementById("selected-year"),s=document.getElementById("year-slider");i&&(i.textContent=e.year),s&&(s.value=e.year)}}function rn(e){tn(e.targets||[])}function sn(e,n){var a=document.getElementById("steal-confirmation"),r=document.getElementById("steal-confirmation-text");if(!(!a||!r)){var i=t("steal.success").replace("{name}",e).replace("{year}",n);r.textContent=i,a.classList.remove("hidden"),setTimeout(function(){a.classList.add("hidden")},3e3)}}function Ze(e){var n=e.song||{},a=e.players||[],r=document.getElementById("reveal-round"),i=document.getElementById("reveal-total");r&&(r.textContent=e.round||1),i&&(i.textContent=e.total_rounds||10);var s=document.getElementById("reveal-album-cover");s&&(s.src=n.album_art||"/beatify/static/img/no-artwork.svg");var l=document.getElementById("correct-year");l&&(l.textContent=n.year||"????");var o=document.getElementById("song-title"),u=document.getElementById("song-artist");o&&(o.textContent=n.title||"Unknown Song"),u&&(u.textContent=n.artist||"Unknown Artist");var d=document.getElementById("fun-fact-container"),v=document.getElementById("fun-fact"),c=d?d.querySelector(".fun-fact-header"):null,g=De(n,"fun_fact");if(v&&(v.textContent=g||""),c&&(c.style.display=g?"flex":"none"),un(n),dn(e.song_difficulty),d){var p=document.getElementById("song-rich-info"),w=p&&p.innerHTML.trim()!=="",y=g&&g.trim()!=="";d.classList.toggle("hidden",!y&&!w)}for(var L=null,I=0;I<a.length;I++)if(a[I].name===h){L=a[I];break}hn(L,n.year),En(L,n.year),e.game_performance&&e.game_performance.is_new_record&&ge("record"),Ln(a),e.round_analytics&&on(e.round_analytics,n.year),e.leaderboard&&Ke(e,"reveal-leaderboard-list",!0);var S=document.getElementById("reveal-admin-controls"),B=document.getElementById("next-round-btn");S&&L&&L.is_admin?(S.classList.remove("hidden"),B&&(e.last_round?(B.textContent=t("leaderboard.finalResults"),B.classList.add("is-final")):(B.textContent=t("admin.nextRound"),B.classList.remove("is-final")),B.disabled=!1)):S&&S.classList.add("hidden")}function on(e,n){var a=document.getElementById("round-analytics");if(!a||!e){a&&a.classList.add("hidden");return}if(e.total_submitted===0){a.innerHTML='<div class="analytics-empty">'+t("analytics.noSubmissions")+"</div>",a.classList.remove("hidden");return}var r="";if(e.average_guess!==null&&n){var i=Math.round(e.average_guess-n);i===0?r=t("analytics.onTarget"):i>0?r=t("analytics.yearsLate",{years:i}):r=t("analytics.yearsEarly",{years:Math.abs(i)})}var s=ln(e.all_guesses,n),l="";if(e.exact_match_players&&e.exact_match_players.length>0&&(l+='<div class="achievement-item"><span class="achievement-emoji">&#127919;</span><span class="achievement-label">'+t("analytics.exactMatches")+':</span><span class="achievement-names">'+e.exact_match_players.join(", ")+"</span></div>"),e.speed_champion&&e.speed_champion.names){var o=e.speed_champion.names.join(", ");l+='<div class="achievement-item"><span class="achievement-emoji">&#9889;</span><span class="achievement-label">'+t("analytics.speedChampion")+':</span><span class="achievement-names">'+o+'</span><span class="achievement-value">('+e.speed_champion.time+"s)</span></div>"}if(e.furthest_players&&e.furthest_players.length>0&&e.all_guesses&&e.all_guesses.length>0){var u=e.all_guesses[e.all_guesses.length-1].years_off;u>0&&(l+='<div class="achievement-item"><span class="achievement-emoji">&#128517;</span><span class="achievement-label">'+t("analytics.furthestGuess")+':</span><span class="achievement-names">'+e.furthest_players.join(", ")+'</span><span class="achievement-value">('+u+" years)</span></div>")}var d=e.average_guess!==null?Math.round(e.average_guess):"?";a.innerHTML='<h3 class="analytics-title">'+t("analytics.title")+'</h3><div class="analytics-stats-row"><div class="stat-primary"><span class="stat-label">'+t("analytics.averageGuess")+'</span><span class="stat-value">'+d+'</span></div><div class="stat-secondary"><span class="stat-value">'+e.accuracy_percentage+'%</span><span class="stat-label">'+t("analytics.accuracy",{percent:""}).replace("%","")+'</span></div></div><div class="stat-comparison-line">'+r+'</div><div class="analytics-histogram"><h4 class="histogram-title">'+t("analytics.histogram")+"</h4>"+s+"</div>"+(l?'<div class="analytics-achievements">'+l+"</div>":""),a.classList.remove("hidden")}function ln(e,n){var a=7;if(!e||e.length===0)return'<div class="histogram-empty">'+t("analytics.noGuesses")+"</div>";for(var r=e.map(function(na){return na.guess}),i=Math.min.apply(null,r),s=Math.max.apply(null,r),l=s-i,o=Math.max(1,Math.ceil(l/a)),u=o*a,d=u-l-1,v=i-Math.floor(d/2),c=[],g=0;g<a;g++){var p=v+g*o,w=p+o-1;c.push({start:p,end:w,count:0,containsCorrect:n>=p&&n<=w})}for(var y=0;y<r.length;y++)for(var L=r[y],I=0;I<c.length;I++)if(L>=c[I].start&&L<=c[I].end){c[I].count++;break}for(var S=1,B=0;B<c.length;B++)c[B].count>S&&(S=c[B].count);for(var P="",F=0;F<c.length;F++){var T=c[F],V=T.count/S*100,be=F*.05,Zn="histogram-bar"+(T.containsCorrect?" is-correct":""),$n=T.count>0?Math.max(V,10):0,ea=T.count>0?'<span class="bar-count">'+T.count+"</span>":"",ta=o===1?String(T.start):T.start+"-"+String(T.end).slice(-2);P+='<div class="histogram-bar-wrapper" style="animation-delay: '+be+'s"><div class="'+Zn+'" style="height: '+$n+'%">'+ea+'</div><span class="histogram-label">'+ta+"</span></div>"}return'<div class="histogram-bars">'+P+"</div>"}function cn(e){var n=document.getElementById("superlatives-container");if(n){if(!e||e.length===0){n.classList.add("hidden");return}var a="";e.forEach(function(r,i){var s="";switch(r.value_label){case"avg_time":s=r.value+"s "+t("superlatives.avgTime");break;case"streak":s=r.value+" "+t("superlatives.streak");break;case"bets":s=r.value+" "+t("superlatives.bets");break;case"points":s=r.value+" "+t("superlatives.points");break;case"close_guesses":s=r.value+" "+t("superlatives.closeGuesses");break;default:s=r.value}a+='<div class="superlative-card superlative-card--'+r.id+'" style="animation-delay: '+i*.2+'s"><div class="superlative-emoji">'+r.emoji+'</div><div class="superlative-title">'+t("superlatives."+r.title)+'</div><div class="superlative-player">'+_(r.player_name)+'</div><div class="superlative-value">'+s+"</div></div>"}),n.innerHTML=a,n.classList.remove("hidden")}}function dn(e){var n=document.getElementById("song-difficulty");if(n){if(!e){n.classList.add("hidden");return}for(var a="",r=0;r<e.stars;r++)a+='<span class="star">&#9733;</span>';n.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+a+'</div><span class="difficulty-label">'+t("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+t("difficulty.accuracy")+"</span>",n.classList.remove("hidden")}}function un(e){var n=document.getElementById("song-rich-info");if(n){var a=[],r=fn(e.chart_info||{});r.length>0&&(a=a.concat(r));var i=mn(e.certifications||[]);i.length>0&&(a=a.concat(i));var s=De(e,"awards")||[],l=pn(s);l.length>0&&(a=a.concat(l)),a.length>0?n.innerHTML='<div class="song-badges-row">'+a.join("")+"</div>":n.innerHTML=""}}function fn(e){if(!e)return[];var n=[];if(e.billboard_peak&&e.billboard_peak>0){var a=e.weeks_on_chart?' <span class="chart-weeks">\xB7 '+e.weeks_on_chart+" "+t("reveal.weeksShort")+"</span>":"";n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.billboard_peak+" "+t("reveal.chartBillboard")+a+"</span>")}return e.german_peak&&e.german_peak>0&&!e.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.german_peak+" "+t("reveal.chartGerman")+"</span>"),e.uk_peak&&e.uk_peak>0&&!e.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.uk_peak+" "+t("reveal.chartUK")+"</span>"),n}function mn(e){if(!e||e.length===0)return[];for(var n=[],a=0;a<e.length;a++){var r=e[a],i=vn(r),s=gn(r);n.push('<span class="song-badge '+i+'"><span class="song-badge-icon">'+s+"</span>"+_(r)+"</span>")}return n}function vn(e){var n=e.toLowerCase();return n.indexOf("diamond")!==-1?"song-badge--diamond":n.indexOf("platinum")!==-1?"song-badge--platinum":n.indexOf("gold")!==-1?"song-badge--gold":"song-badge--platinum"}function gn(e){var n=e.toLowerCase();return n.indexOf("diamond")!==-1?"\u{1F48E}":n.indexOf("platinum")!==-1?"\u{1F4BF}":n.indexOf("gold")!==-1?"\u{1F947}":"\u{1F4BF}"}function pn(e){if(!e||e.length===0)return[];for(var n=[],a=e.slice(0,3),r=0;r<a.length;r++){var i=a[r],s=bn(i),l=yn(i);n.push('<span class="song-badge '+s+'"><span class="song-badge-icon">'+l+"</span>"+_(i)+"</span>")}return e.length>3&&n.push('<span class="song-badges-more">+'+(e.length-3)+" more</span>"),n}function bn(e){var n=e.toLowerCase();return n.indexOf("grammy")!==-1?"song-badge--grammy":n.indexOf("eurovision")!==-1?"song-badge--eurovision":n.indexOf("oscar")!==-1||n.indexOf("academy award")!==-1?"song-badge--oscar":n.indexOf("hall of fame")!==-1?"song-badge--halloffame":"song-badge--award"}function yn(e){var n=e.toLowerCase();return n.indexOf("eurovision")!==-1?"\u{1F3A4}":n.indexOf("grammy")!==-1?"\u{1F3C6}":n.indexOf("hall of fame")!==-1?"\u2B50":"\u{1F3C6}"}function hn(e,n){var a=document.getElementById("reveal-emotion"),r=document.getElementById("personal-result");if(!a)return;a.className="reveal-emotion",a.innerHTML="",a.classList.add("hidden"),r&&r.classList.remove("is-delayed"),pe();var i=t("reveal.emotions");function s(g){return g[Math.floor(Math.random()*g.length)]}function l(g){return g===1?t("reveal.offByYear"):t("reveal.offByYears",{years:g})}var o="missed",u=s(i.missed),d=s(i.missedSub);if(e&&!e.missed_round){var v=e.years_off||0;v===0?(o="exact",u=s(i.exact),d=s(i.exactSub)):v<=2?(o="close",u=s(i.close),d=s(i.closeSub)+" "+l(v)):v<=5?(o="close",u=s(i.close),d=l(v)):(o="wrong",u=s(i.wrong),d=s(i.wrongSub)+" "+l(v))}else e&&e.missed_round&&(o="missed",u=s(i.missed),d=s(i.missedSub));var c='<span class="reveal-emotion-text">'+u+"</span>";d&&(c+='<div class="reveal-emotion-subtitle">'+d+"</div>"),a.innerHTML=c,a.classList.add("reveal-emotion--"+o),a.classList.remove("hidden"),o==="exact"&&ge(),r&&o!=="missed"&&r.classList.add("is-delayed")}function En(e,n){var a=document.getElementById("result-content");if(a){if(!e){a.innerHTML='<div class="result-missed">Player not found</div>';return}if(e.missed_round){var r='<div class="result-missed-container"><div class="result-missed-icon">\u23F0</div><div class="result-missed-text">'+t("reveal.noSubmission")+"</div></div>",i=e.previous_streak||0;i>=2&&(r+='<div class="streak-broken"><span class="streak-broken-icon">\u{1F494}</span><span class="streak-broken-text">Lost '+i+"-streak!</span></div>"),r+='<div class="result-score is-zero">0 pts</div>',a.innerHTML=r;return}var s=e.years_off||0,l=s===0?t("reveal.exact"):s===1?t("reveal.yearOff",{years:1}):t("reveal.yearsOff",{years:s}),o=s===0?"is-exact":s<=3?"is-close":"is-far",u=e.speed_multiplier||1,d=e.base_score||0,v=u>1,c=e.streak_bonus||0,g="";v&&d>0&&(g='<div class="result-row"><span class="result-label">'+t("reveal.baseScore")+'</span><span class="result-value">'+d+' pts</span></div><div class="result-row"><span class="result-label">'+t("reveal.speedBonus")+'</span><span class="result-value is-bonus">'+u.toFixed(2)+"x</span></div>");var p="";e.bet_outcome==="won"?p='<div class="result-row bet-won-row"><span class="result-label">\u{1F3B2} '+t("reveal.betWon").replace("! 2x points","")+'</span><span class="result-value is-bet-won">2x</span></div>':e.bet_outcome==="lost"&&(p='<div class="result-row bet-lost-row"><span class="result-label">\u{1F3B2} '+t("reveal.betLost")+'</span><span class="result-value is-bet-lost">-</span></div>');var w="";c>0&&(w='<div class="result-row streak-bonus-row"><span class="result-label">'+e.streak+'-streak bonus!</span><span class="result-value is-streak">+'+c+" pts</span></div>");var y=e.round_score+c,L=e.round_score>=20,I=x.players[e.name],S=I?I.score:e.score-y,B=I?I.streak:0,P=Tt(B,e.streak||0);a.innerHTML='<div class="result-row"><span class="result-label">'+t("reveal.yourGuess")+'</span><span class="result-value">'+e.guess+'</span></div><div class="result-row"><span class="result-label">'+t("reveal.correctYear")+'</span><span class="result-value">'+n+'</span></div><div class="result-row"><span class="result-label">'+t("reveal.accuracy")+'</span><span class="result-value '+o+'">'+l+"</span></div>"+g+p+'<div class="result-score" id="personal-result-score">+<span class="score-value">0</span> pts</div>'+w+(c>0?'<div class="result-total">'+t("reveal.total")+': +<span class="total-value">0</span> pts</div>':"");var F=a.querySelector(".score-value");F&&(Et(F,0,e.round_score,{betWon:e.bet_outcome==="won",betLost:e.bet_outcome==="lost",streakMilestone:P,isBigScore:L}),e.bet_outcome==="won"&&e.round_score>0&&setTimeout(function(){var V=document.getElementById("personal-result-score");V&&Fe(V,e.round_score,{isBetWin:!0})},200));var T=a.querySelector(".total-value");T&&c>0&&(setTimeout(function(){Ie(T,0,y,600)},300),P&&setTimeout(function(){var V=a.querySelector(".result-total");if(V){var be={3:20,5:50,10:100}[P]||0;Fe(V,be,{isStreak:!0,text:"+"+be+" "+P+"-Streak!"})}},500))}}function Ln(e){var n=document.getElementById("reveal-results-cards");if(n){if(!e||e.length===0){n.innerHTML="";return}var a=e.slice().sort(function(i,s){return(s.round_score||0)-(i.round_score||0)}),r='<div class="results-cards-header">'+t("reveal.allPlayers")+"</div>";r+='<div class="results-cards-scroll">',a.forEach(function(i){var s=i.name===h,l=i.missed_round===!0,o=i.years_off||0,u=i.round_score||0,d=l?"is-score-zero":u>=10?"is-score-high":u>=1?"is-score-medium":"is-score-zero",v=l?"\u2014":i.guess,c=l?t("reveal.noGuessShort"):o===0?t("reveal.exact"):t("reveal.shortOff",{years:o}),g=i.bet?'<span class="card-bet">\u{1F3B2}</span>':"",p="";if(i.stole_from)p='<div class="steal-badge"><span class="steal-badge-icon">\u{1F977}</span>'+t("steal.stolenFrom",{name:_(i.stole_from)})+"</div>";else if(i.was_stolen_by&&i.was_stolen_by.length>0){var w=i.was_stolen_by.map(_).join(", ");p='<div class="steal-badge steal-badge-victim"><span class="steal-badge-icon">\u{1F3AF}</span>'+t("steal.stolenBy",{name:w})+"</div>"}r+='<div class="result-card '+d+(s?" is-current":"")+'"><div class="card-name">'+_(i.name)+g+'</div><div class="card-guess">'+v+'</div><div class="card-accuracy">'+c+"</div>"+p+'<div class="card-score">+'+u+"</div></div>"}),r+="</div>",n.innerHTML=r}}function In(e){var n=e.leaderboard||[];n.forEach(function(y){y.is_current=y.name===h}),[1,2,3].forEach(function(y){var L=n.find(function(B){return B.rank===y}),I=document.getElementById("podium-"+y+"-name"),S=document.getElementById("podium-"+y+"-score");I&&(I.textContent=L?_(L.name):"---"),S&&(S.textContent=L?L.score:"0")});var a=n.find(function(y){return y.is_current}),r=document.getElementById("your-final-rank"),i=document.getElementById("your-final-score"),s=document.getElementById("stat-best-streak"),l=document.getElementById("stat-rounds"),o=document.getElementById("stat-bets");a&&(r&&(r.textContent="#"+a.rank),i&&(i.textContent=a.score+" "+t("leaderboard.points")),s&&(s.textContent=a.best_streak||0),l&&(l.textContent=a.rounds_played||0),o&&(o.textContent=a.bets_won||0));var u=document.getElementById("final-leaderboard-list");u&&(u.innerHTML=n.map(function(y){var L=y.is_current?"is-current":"",I=y.connected===!1?"final-entry--disconnected":"",S=y.connected===!1?'<span class="away-badge">(away)</span>':"";return'<div class="final-entry '+L+" "+I+'"><span class="final-rank">#'+y.rank+'</span><span class="final-name">'+_(y.name)+S+'</span><span class="final-score">'+y.score+"</span></div>"}).join("")),cn(e.superlatives);var d=document.getElementById("end-admin-controls"),v=document.getElementById("end-player-message");if(a&&a.is_admin){d&&d.classList.remove("hidden"),v&&v.classList.add("hidden");var c=document.getElementById("new-game-btn");c&&(c.onclick=Sn)}else d&&d.classList.add("hidden"),v&&v.classList.remove("hidden");if(a){var g=e.total_rounds||10,p=a.best_streak||0,w=p===g&&g>0;w?ge("perfect"):a.rank===1&&ge("winner")}}function wn(e){var n=document.getElementById("pause-message");n&&(e.pause_reason==="admin_disconnected"?n.textContent="Waiting for host to reconnect...":e.pause_reason==="media_player_error"?n.textContent="Speaker unavailable. Please check your media player and try again.":n.textContent="Game paused. Please wait...")}function Sn(){if(confirm("Start a new game?")){var e=document.getElementById("new-game-btn");e&&(e.disabled=!0,e.textContent="Redirecting...");try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(n){}window.location.href="/beatify/admin"}}var Te=!1,Bn=2e3;function $e(){if(!Te&&f&&f.readyState===WebSocket.OPEN){Te=!0;var e=document.getElementById("next-round-btn"),n=document.getElementById("next-round-admin-btn");if(e&&(e.disabled=!0,e.textContent="Loading..."),n){n.disabled=!0;var a=n.querySelector(".control-label");a&&(a.textContent="Wait...")}f.send(JSON.stringify({type:"admin",action:"next_round"})),setTimeout(function(){Te=!1,e&&(e.disabled=!1),n&&(n.disabled=!1)},Bn)}}let Me=!1;var _n=500;let X=!1,Ae=.5;function ue(){return Me?!1:(Me=!0,setTimeout(function(){Me=!1},_n),!0)}function et(){if(A){var e=document.getElementById("admin-control-bar");e&&(e.classList.remove("hidden"),document.body.classList.add("has-control-bar"))}}function fe(){var e=document.getElementById("admin-control-bar");e&&(e.classList.add("hidden"),document.body.classList.remove("has-control-bar"))}function tt(e){var n=document.getElementById("stop-song-btn"),a=document.getElementById("next-round-admin-btn");if(e==="PLAYING"){if(at(),n&&!X&&(n.classList.remove("is-disabled"),n.disabled=!1),a){a.classList.remove("is-disabled"),a.disabled=!1;var r=a.querySelector(".control-label");r&&(r.textContent="Skip")}}else if(e==="REVEAL"){if(n&&!X&&(n.classList.remove("is-disabled"),n.disabled=!1),a){a.classList.remove("is-disabled"),a.disabled=!1;var r=a.querySelector(".control-label");r&&(r.textContent="Next")}}else if(a){a.classList.add("is-disabled"),a.disabled=!0;var r=a.querySelector(".control-label");r&&(r.textContent="Next")}}function kn(){if(!X&&ue()){if(!f||f.readyState!==WebSocket.OPEN){console.warn("[Beatify] Cannot stop song: WebSocket not connected");return}var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-disabled"),e.disabled=!0;var n=e.querySelector(".control-label");n&&(n.textContent="Stopping...")}f.send(JSON.stringify({type:"admin",action:"stop_song"}))}}function Cn(){if(Ae>=1){nt("max");return}ue()&&(!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"admin",action:"set_volume",direction:"up"})))}function xn(){if(Ae<=0){nt("min");return}ue()&&(!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"admin",action:"set_volume",direction:"down"})))}function nt(e){var n=document.getElementById("volume-indicator");n&&(n.textContent=e==="max"?"\u{1F50A} Max":"\u{1F507} Min",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},1e3))}function Tn(){if(confirm(t("admin.endGameConfirmFull"))&&ue()){if(!f||f.readyState!==WebSocket.OPEN){alert(t("errors.CONNECTION_LOST"));return}var e=document.getElementById("end-game-btn");if(e){e.disabled=!0;var n=e.querySelector(".control-label");n&&(n.textContent="Ending...")}f.send(JSON.stringify({type:"admin",action:"end_game"}))}}function Mn(){$e()}function An(){var e=document.getElementById("stop-song-btn"),n=document.getElementById("volume-up-btn"),a=document.getElementById("volume-down-btn"),r=document.getElementById("next-round-admin-btn"),i=document.getElementById("end-game-btn");e&&e.addEventListener("click",kn),n&&n.addEventListener("click",Cn),a&&a.addEventListener("click",xn),r&&r.addEventListener("click",Mn),i&&i.addEventListener("click",Tn)}function Nn(){X=!0;var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-stopped"),e.classList.add("is-disabled"),e.disabled=!0;var n=e.querySelector(".control-icon"),a=e.querySelector(".control-label");n&&(n.textContent="\u2713"),a&&(a.textContent="Stopped")}}function at(){X=!1;var e=document.getElementById("stop-song-btn");if(e){e.classList.remove("is-stopped"),e.classList.remove("is-disabled"),e.disabled=!1;var n=e.querySelector(".control-icon"),a=e.querySelector(".control-label");n&&(n.textContent="\u23F9\uFE0F"),a&&(a.textContent="Stop")}}function Rn(e){Ae=e,On(e),Hn(e)}function On(e){var n=document.getElementById("volume-indicator");if(n){var a=Math.round(e*100);n.textContent="\u{1F50A} "+a+"%",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},1500)}}function Hn(e){var n=document.getElementById("volume-up-btn"),a=document.getElementById("volume-down-btn");n&&n.classList.toggle("is-at-limit",e>=1),a&&a.classList.toggle("is-at-limit",e<=0)}let A=!1;function Dn(){const e=sessionStorage.getItem("beatify_is_admin"),n=sessionStorage.getItem("beatify_admin_name");return e==="true"&&n&&(A=!0,h=n,sessionStorage.removeItem("beatify_is_admin")),A}function Pn(e){const n=document.getElementById("admin-controls"),a=document.getElementById("lobby-status"),r=document.getElementById("leave-game-container");if(!n)return;const i=e.find(function(l){return l.name===h});(i==null?void 0:i.is_admin)===!0?(n.classList.remove("hidden"),a&&a.classList.add("hidden"),r&&r.classList.add("hidden")):(n.classList.add("hidden"),a&&a.classList.remove("hidden"),r&&r.classList.remove("hidden"))}function Fn(){const e=document.getElementById("start-game-btn");e==null||e.addEventListener("click",function(){!f||f.readyState!==WebSocket.OPEN||(e.disabled=!0,e.textContent="Starting...",f.send(JSON.stringify({type:"admin",action:"start_game"})))});const n=document.getElementById("leave-game-btn");n==null||n.addEventListener("click",function(){zn()})}let f=null,h=null,k=0;const Z=10,Vn=3e4,me="beatify_player_name",ve="beatify_game_id",rt="beatify_language";let O=!1,$=!1;function it(){return Math.min(1e3*Math.pow(2,k),Vn)}function Gn(){try{var e=localStorage.getItem(ve),n=localStorage.getItem(me);if(console.log("[Beatify] Checking localStorage - storedGameId:",e,"currentGameId:",C,"storedName:",n),e&&e===C)return console.log("[Beatify] Game ID match, returning stored name:",n),n;e&&e!==C&&(console.log("[Beatify] Different game ID, clearing stored data"),localStorage.removeItem(me),localStorage.removeItem(ve))}catch(a){console.error("[Beatify] localStorage error:",a)}return null}function st(e){try{localStorage.setItem(me,e),localStorage.setItem(ve,C),console.log("[Beatify] Stored player name:",e,"for game:",C)}catch(n){console.error("[Beatify] Failed to store player name:",n)}}function ee(){try{localStorage.removeItem(me),localStorage.removeItem(ve)}catch(e){}}function Wn(e){try{localStorage.setItem(rt,e)}catch(n){}}function qn(){try{return localStorage.getItem(rt)}catch(e){return null}}function ot(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.remove("hidden")}function te(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.add("hidden")}function lt(e){var n=document.getElementById("reconnect-status");n&&(n.textContent="Reconnecting... (Attempt "+e+"/"+Z+")")}function Ne(){E("connection-lost-view")}function jn(){var e=document.getElementById("retry-connection-btn");e&&e.addEventListener("click",function(){h?(k=0,E("loading-view"),ne(h)):re()})}function ne(e){h=e,st(e);const a=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+"/beatify/ws";f=new WebSocket(a),f.onopen=function(){k=0,O=!1,te();var r={type:"join",name:e};A&&(r.is_admin=!0),f.send(JSON.stringify(r))},f.onmessage=function(r){try{const i=JSON.parse(r.data);ct(i)}catch(i){console.error("Failed to parse WebSocket message:",i)}},f.onclose=function(){if($){$=!1;return}if(h&&k<Z){O=!0,k++,ot(),lt(k);const r=it();console.log("WebSocket closed. Reconnecting in "+r+"ms... (attempt "+k+")"),setTimeout(function(){ne(h)},r)}else k>=Z&&(O=!1,te(),Ne())},f.onerror=function(r){console.error("WebSocket error:",r)}}function ct(e){const n=document.getElementById("join-btn"),a=document.getElementById("name-input");if(e.type==="state"){var r=e.players||[],i=r.find(function(l){return l.name===h});if(i&&(A=i.is_admin===!0),e.language&&(Wn(e.language),e.language!==BeatifyI18n.getLanguage()&&BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),ze(r),e.difficulty&&Be(e.difficulty),e.phase==="REVEAL"&&Ze(e)})),e.phase==="LOBBY")W(),fe(),de=0,q("warmup"),E("lobby-view"),ze(r),e.difficulty&&Be(e.difficulty),e.join_url&&Ht(e.join_url),Pn(r);else if(e.phase==="PLAYING"){var s=e.round||1;s!==de&&(de=s,Zt()),q("party"),E("game-view"),le(),Wt(e),e.difficulty&&Be(e.difficulty),e.deadline&&Gt(e.deadline),Jt(),Qt(),et(),tt("PLAYING")}else e.phase==="REVEAL"?(W(),q("party"),E("reveal-view"),Ze(e),et(),tt("REVEAL")):e.phase==="PAUSED"?(W(),fe(),q("warmup"),E("paused-view"),wn(e)):e.phase==="END"&&(W(),fe(),de=0,q("warmup"),E("end-view"),In(e),ee())}else if(e.type==="join_ack"){e.session_id&&yt(e.session_id);try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(l){}}else if(e.type==="reconnect_ack")e.success&&e.name?(h=e.name,st(e.name),Rt(e.name)):(z(),ee(),h=null,E("join-view"));else if(e.type==="submit_ack")Xe();else if(e.type==="error"){if(e.code==="ROUND_EXPIRED"||e.code==="ALREADY_SUBMITTED"){Xt(e);return}if(e.code==="GAME_ENDED"){E("end-view");return}if(e.code==="NOT_ADMIN"){A=!1,fe(),console.warn("Admin action rejected: not admin");return}if(e.code==="SESSION_TAKEOVER"){O=!1,te(),h=null,Ne(),console.warn("Session taken over by another tab");return}if(e.code==="SESSION_NOT_FOUND"){z(),$=!0,f&&f.close(),E("join-view");return}if(e.code==="ADMIN_CANNOT_LEAVE"){$=!1,alert(e.message||"Host cannot leave. End the game instead.");return}if(e.code==="INVALID_ACTION"&&e.message==="No song playing"){at(),console.warn("[Beatify] Stop song failed: No song playing");return}E("join-view"),Qn(e.message),n&&(n.disabled=!1,n.textContent=t("join.joinButton")),a&&a.focus(),h=null,ee()}else e.type==="song_stopped"?Nn():e.type==="volume_changed"?Rn(e.level):e.type==="game_ended"?Yn():e.type==="left"?Un():e.type==="steal_targets"?rn(e):e.type==="steal_ack"&&an(e)}function Un(){ee(),z(),h=null,A=!1,E("join-view")}function zn(){if(!(!f||f.readyState!==WebSocket.OPEN)){if(A){alert("Host cannot leave. End the game instead.");return}confirm("Leave the game? Your score will be lost.")&&($=!0,f.send(JSON.stringify({type:"leave"})))}}function Yn(){ee(),z();try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(n){}if(wt(),xt(),we.clear(),pe(),h=null,A=!1,f&&f.readyState===WebSocket.OPEN&&f.close(),f=null,!(!Le||!Le.classList.contains("hidden"))){var e=document.getElementById("end-player-message");e&&(e.innerHTML='<p>Thanks for playing!</p><p class="rejoin-hint">Scan the QR code again to join the next game.</p>',e.classList.remove("hidden")),E("end-view")}}function Qn(e){const n=document.getElementById("name-validation-msg");n&&(n.textContent=e,n.classList.remove("hidden"))}function Re(e){const n=(e||"").trim();return n?n.length>Ot?{valid:!1,error:"Name too long (max 20 characters)"}:{valid:!0,name:n}:{valid:!1,error:"Please enter a name"}}function dt(){const e=document.getElementById("name-input"),n=document.getElementById("join-btn"),a=document.getElementById("name-validation-msg");if(!e||!n)return;const r=Re(e.value);r.valid&&(n.disabled=!0,n.textContent="Joining...",a&&a.classList.add("hidden"),ne(r.name))}function Jn(){const e=document.getElementById("name-input"),n=document.getElementById("join-btn"),a=document.getElementById("name-validation-msg");!e||!n||(e.addEventListener("input",function(){const r=Re(this.value);n.disabled=!r.valid,a&&(a.textContent=!r.valid&&this.value?r.error:"",a.classList.toggle("hidden",r.valid||!this.value))}),n.addEventListener("click",dt),e.addEventListener("keypress",function(r){r.key==="Enter"&&!n.disabled&&dt()}))}const Kn=E;E=function(e){Kn(e),(e==="join-view"||e==="loading-view"||e==="not-found-view"||e==="ended-view"||e==="in-progress-view"||e==="connection-lost-view")&&q("calm"),e==="join-view"&&setTimeout(function(){var n=document.getElementById("name-input");n&&n.focus()},100)};function q(e){document.body.classList.remove("energy-calm","energy-warmup","energy-party"),document.body.classList.add("energy-"+e)}var H=null,D=null;function ge(e){if(Y.prefersReducedMotion()){ut();return}if(typeof confetti=="undefined"){console.warn("[Confetti] Library not loaded");return}pe();var n=Y.getQualitySettings(),a=n.confettiParticles;if(a===0){ut();return}var r=Y.getDeviceTier(),i=r==="low"?.5:r==="medium"?.75:1;switch(e=e||"exact",e){case"exact":var s=Math.round(2e3*i),l=Date.now()+s;(function p(){confetti({particleCount:a,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<l&&(H=requestAnimationFrame(p))})();break;case"record":var o=Math.round(3e3*i),u=Date.now()+o;(function p(){confetti({particleCount:Math.round(a*.67),spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<u&&(H=requestAnimationFrame(p))})();break;case"winner":var d=Math.round(4e3*i),v=Date.now()+d;(function p(){confetti({particleCount:Math.round(a*.67),angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:Math.round(a*.67),angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<v&&(H=requestAnimationFrame(p))})();break;case"perfect":var c=Math.round(5e3*i),g=Date.now()+c;D=setInterval(function(){confetti({particleCount:a*2,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},r==="low"?750:500),setTimeout(function(){D&&(clearInterval(D),D=null)},c),function p(){confetti({particleCount:Math.round(a*.5),angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:Math.round(a*.5),angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<g&&(H=requestAnimationFrame(p))}();break;default:console.warn("[Confetti] Unknown type:",e)}}function pe(){H&&(cancelAnimationFrame(H),H=null),D&&(clearInterval(D),D=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function ut(){var e=document.getElementById("reveal-emotion");if(e){var n=e.querySelector(".celebration-icon");if(!n){var a=document.createElement("span");a.className="celebration-icon",a.textContent=" \u{1F389}",e.appendChild(a)}}}function Xn(){var e=document.getElementById("next-round-btn");e&&e.addEventListener("click",$e);var n=document.getElementById("reveal-view");n&&n.addEventListener("click",function(a){a.target.tagName==="BUTTON"||a.target.closest("button")||(we.isRunning()&&we.skipAll(),pe())})}function ft(){return Oe(this,null,function*(){var e=Y.getDeviceTier();document.body.classList.add("device-tier-"+e);var n=qn();yield BeatifyI18n.init(n),BeatifyI18n.initPageTranslations();var a=document.getElementById("dashboard-hint-url");if(a&&(a.textContent=window.location.origin+"/beatify/dashboard"),Jn(),Dt(),Vt(),Fn(),Xn(),An(),jn(),St(),Dn()&&h){ne(h);return}var r=Gn();if(r&&C){console.log("[Beatify] Auto-reconnecting as:",r),ne(r);return}if(r){var i=document.getElementById("name-input"),s=document.getElementById("join-btn");if(i&&(i.value=r,s)){var l=Re(r);s.disabled=!l.valid}}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ft):ft(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Beatify] SW registered:",e.scope)}).catch(function(e){console.warn("[Beatify] SW registration failed:",e)})})})();})();
//# sourceMappingURL=player.min.js.map
