(()=>{var W=(c,Ue,C)=>new Promise((Ce,oe)=>{var ke=N=>{try{Y(C.next(N))}catch(J){oe(J)}},xe=N=>{try{Y(C.throw(N))}catch(J){oe(J)}},Y=N=>N.done?Ce(N.value):Promise.resolve(N.value).then(ke,xe);Y((C=C.apply(c,Ue)).next())});(function(){"use strict";var Bt,St;var c=window.BeatifyUtils||{};const C=new URLSearchParams(window.location.search).get("game"),Ce=document.getElementById("loading-view"),oe=document.getElementById("not-found-view"),ke=document.getElementById("ended-view"),xe=document.getElementById("in-progress-view"),Y=document.getElementById("join-view"),N=document.getElementById("lobby-view"),J=document.getElementById("game-view"),_t=document.getElementById("reveal-view"),Ct=document.getElementById("paused-view"),Te=document.getElementById("end-view"),kt=document.getElementById("connection-lost-view"),xt=[Ce,oe,ke,xe,Y,N,J,_t,Ct,Te,kt];function L(e){c.showView(xt,e)}function Tt(e){return!e||typeof e!="string"?!1:/^[a-zA-Z0-9_-]{8,16}$/.test(e)}function le(e,n,a,r){return new Promise(function(i){var s=document.getElementById("confirm-modal"),l=document.getElementById("confirm-modal-title"),o=document.getElementById("confirm-modal-message"),f=document.getElementById("confirm-modal-yes"),d=document.getElementById("confirm-modal-no");if(!s||!l||!o||!f||!d){i(confirm(n||e));return}l.textContent=e,o.textContent=n,f.textContent=a||c.t("common.confirm")||"Confirm",d.textContent=r||c.t("common.cancel")||"Cancel",s.classList.remove("hidden");function v(){s.classList.add("hidden"),f.removeEventListener("click",u),d.removeEventListener("click",g),y.removeEventListener("click",g)}function u(){v(),i(!0)}function g(){v(),i(!1)}var y=s.querySelector(".modal-backdrop");f.addEventListener("click",u),d.addEventListener("click",g),y&&y.addEventListener("click",g)})}function ce(){return W(this,null,function*(){if(!C){L("not-found-view");return}if(!Tt(C)){L("not-found-view");return}try{const r=yield(yield fetch(`/beatify/api/game-status?game=${encodeURIComponent(C)}`)).json();if(!r.exists){L("not-found-view");return}if(r.phase==="END"){L("ended-view");return}var e=sessionStorage.getItem("beatify_admin_name");if(e)return;var n=ze();if(n){Ze();return}r.can_join?L("join-view"):L("in-progress-view")}catch(a){console.error("Failed to check game status:",a),L("not-found-view")}})}ce(),(Bt=document.getElementById("refresh-btn"))==null||Bt.addEventListener("click",()=>{L("loading-view"),ce()}),(St=document.getElementById("retry-btn"))==null||St.addEventListener("click",()=>{L("loading-view"),ce()});var de="beatify_session";function At(e){var n=location.protocol==="https:"?"; Secure":"";document.cookie=de+"="+e+"; path=/beatify; SameSite=Strict; max-age=86400"+n}function ze(){for(var e=document.cookie.split(";"),n=0;n<e.length;n++){var a=e[n].trim();if(a.indexOf(de+"=")===0)return a.substring(de.length+1)}return null}function Q(){document.cookie=de+"=; path=/beatify; max-age=0"}function ue(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function Mt(e){return 1-Math.pow(1-e,4)}function Ae(e,n,a,r,i){if(ue()||n===a)return e.textContent=a,{cancel:function(){},skipToEnd:function(){e.textContent=a}};var s=K.getQualitySettings();if(s.scoreDuration===0)return e.textContent=a,{cancel:function(){},skipToEnd:function(){e.textContent=a}};var l=Math.min(r,s.scoreDuration||r);i=i||Mt;var o=null,f=null,d=!1,v=a;function u(g){if(!d){o||(o=g);var y=g-o,I=Math.min(y/l,1),h=i(I),w=Math.round(n+(v-n)*h);e.textContent=w,I<1&&(f=requestAnimationFrame(u))}}return f=requestAnimationFrame(u),{cancel:function(){d=!0,f&&cancelAnimationFrame(f)},skipToEnd:function(){d=!0,f&&cancelAnimationFrame(f),e.textContent=v}}}function Nt(e,n,a,r){r=r||{};var i=500;r.betWon?i=800:r.isBigScore?i=700:r.betLost&&(i=400),e.classList.add("score-animating");var s=null;r.betWon?s="score-glow-gold":r.betLost?(s="score-shake",e.classList.add("score-flash-red")):r.streakMilestone?s="score-burst":r.isBigScore&&(s="score-pop"),s&&!ue()&&e.classList.add(s),Ae(e,n,a,i);function l(){e.classList.remove("score-animating"),s&&e.classList.remove(s),e.classList.remove("score-flash-red")}s&&!ue()?e.addEventListener("animationend",function o(){e.removeEventListener("animationend",o),l()}):setTimeout(l,i+50)}function Ye(e,n,a){if(a=a||{},!ue()){var r=document.createElement("div");r.className="points-popup",r.textContent=a.text||"+"+n,a.isStreak?r.classList.add("points-popup--streak"):a.isBetWin&&r.classList.add("points-popup--gold");var i=e.getBoundingClientRect();r.style.left=i.left+i.width/2+"px",r.style.top=i.top+"px",document.body.appendChild(r),r.addEventListener("animationend",function(){r.parentNode&&r.parentNode.removeChild(r)}),setTimeout(function(){r.parentNode&&r.parentNode.removeChild(r)},1200)}}var T={players:{},leaderboard:[],initialized:!1};function Rt(){return T.initialized}var Je=[3,5,10],K=function(){var e=window.matchMedia("(prefers-reduced-motion: reduce)"),n=e.matches;e.addEventListener("change",function(i){n=i.matches});var a=null;function r(){if(a!==null)return a;var i=navigator.hardwareConcurrency||2,s=navigator.deviceMemory||4,l=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return i<=2||s<=2?a="low":i<=4||s<=4||l?a="medium":a="high",a}return r(),{prefersReducedMotion:function(){return n},getDeviceTier:r,getQualitySettings:function(){var i=r();if(n)return{confettiParticles:0,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!1};switch(i){case"low":return{confettiParticles:5,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!0};case"medium":return{confettiParticles:10,scoreDuration:300,leaderboardAnimation:"simplified",neonGlow:!1,enableAnimations:!0};default:return{confettiParticles:15,scoreDuration:500,leaderboardAnimation:"full",neonGlow:!0,enableAnimations:!0}}},ifMotionAllowed:function(i,s){n?s&&s():i()},withWillChange:function(i,s,l){i&&(i.style.willChange=s,setTimeout(function(){i&&i.style&&(i.style.willChange="auto")},(l||500)+100))}}}(),Me=function(){var e=[],n=!1,a=null,r=null,i=2e3;function s(){if(r&&(clearTimeout(r),r=null),e.length===0){n=!1,a=null;return}a=e.shift(),r=setTimeout(function(){a&&a.skipToEnd&&a.skipToEnd(),s()},i),a.run(function(){r&&(clearTimeout(r),r=null),s()})}return{add:function(l){e.push(l),n||(n=!0,s())},skipAll:function(){r&&(clearTimeout(r),r=null),a&&a.skipToEnd&&a.skipToEnd(),e.forEach(function(l){l.skipToEnd&&l.skipToEnd()}),e=[],n=!1,a=null},clear:function(){r&&(clearTimeout(r),r=null),e=[],n=!1,a=null},isRunning:function(){return n},getMaxDuration:function(){return maxDuration}}}(),X={VISIBLE_BUFFER:2,ENTRY_HEIGHT:48,MIN_PLAYERS_FOR_LAZY:10,ROOT_MARGIN:"96px 0px",DEFAULT_VIEWPORT_HEIGHT:280},b={observer:null,fullData:[],visibleRange:{start:0,end:10},listEl:null,isLazyEnabled:!1};function Ot(e){e&&(b.observer&&b.listEl!==e&&(b.observer.disconnect(),b.observer=null),!b.observer&&(b.listEl=e,b.observer=new IntersectionObserver(function(n){n.forEach(function(a){if(!(!a.isIntersecting||!b.isLazyEnabled)){var r=b.fullData,i=b.visibleRange,s=X.VISIBLE_BUFFER;if(a.target.classList.contains("leaderboard-sentinel--top")){if(i.start>0){var l=Math.max(0,i.start-s);b.visibleRange.start=l,fe()}}else if(a.target.classList.contains("leaderboard-sentinel--bottom")&&i.end<r.length){var o=Math.min(r.length,i.end+s);b.visibleRange.end=o,fe()}}})},{root:e,rootMargin:X.ROOT_MARGIN,threshold:0})))}function fe(){var e=b.listEl,n=b.fullData,a=b.visibleRange;if(!(!e||!n.length)){var r=X.ENTRY_HEIGHT,i=a.start*r,s=(n.length-a.end)*r,l=e.scrollTop,o="";i>0&&(o+='<div class="leaderboard-spacer-top" style="height: '+i+'px;"></div>'),o+='<div class="leaderboard-sentinel leaderboard-sentinel--top" style="height: 1px;"></div>';for(var f=a.start;f<a.end&&f<n.length;f++)o+=Qe(n[f]);if(o+='<div class="leaderboard-sentinel leaderboard-sentinel--bottom" style="height: 1px;"></div>',s>0&&(o+='<div class="leaderboard-spacer-bottom" style="height: '+s+'px;"></div>'),e.innerHTML=o,e.scrollTop=l,b.observer){var d=e.querySelectorAll(".leaderboard-sentinel");d.forEach(function(v){b.observer.observe(v)})}}}function Qe(e){if(!e)return"";if(e.separator)return'<div class="leaderboard-separator">...</div>';var n=e.name||"Unknown",a=e.rank||0,r=e.score||0,i=a<=3?"is-top-"+a:"",s=e.is_current?"is-current":"",l="";e.rank_change>0||e._rankChange==="up"?l="leaderboard-entry--climbing leaderboard-entry--slide-up":(e.rank_change<0||e._rankChange==="down")&&(l="leaderboard-entry--falling leaderboard-entry--slide-down");var o="";e.rank_change>0?o='<span class="rank-up">\u25B2'+e.rank_change+"</span>":e.rank_change<0&&(o='<span class="rank-down">\u25BC'+Math.abs(e.rank_change)+"</span>");var f="";if(e.streak>=2){var d=e.streak>=5?"streak-indicator--hot":"";f='<span class="streak-indicator '+d+'">\u{1F525}'+e.streak+"</span>"}var v=e.connected===!1?"leaderboard-entry--disconnected":"",u=e.connected===!1?'<span class="away-badge">(away)</span>':"",g=e._displayScore!==void 0?e._displayScore:r;return'<div class="leaderboard-entry '+i+" "+s+" "+l+" "+v+'" data-rank="'+a+'" data-name="'+k(n)+'"><span class="entry-rank">#'+a+'</span><span class="entry-name">'+k(n)+u+'</span><span class="entry-meta">'+f+o+'</span><span class="entry-score" data-prev-score="'+(e._prevScore||r)+'">'+g+"</span></div>"}function Ke(e,n){for(var a=X,r=b.listEl&&b.listEl.clientHeight||a.DEFAULT_VIEWPORT_HEIGHT,i=Math.ceil(r/a.ENTRY_HEIGHT),s=a.VISIBLE_BUFFER,l=-1,o=0;o<e.length;o++)if(e[o].name===n){l=o;break}var f,d;return l===-1||l<i?(f=0,d=Math.min(e.length,i+s*2)):l>=e.length-i?(f=Math.max(0,e.length-i-s),d=e.length):(f=Math.max(0,l-Math.floor(i/2)-s),d=Math.min(e.length,l+Math.ceil(i/2)+s)),{start:f,end:d}}function Ht(){b.observer&&(b.observer.disconnect(),b.observer=null),b.isLazyEnabled=!1,b.fullData=[]}function Dt(){var e;function n(){clearTimeout(e),e=setTimeout(function(){b.isLazyEnabled&&b.fullData.length>0&&(b.visibleRange=Ke(b.fullData,E),fe())},150)}window.addEventListener("resize",n),window.addEventListener("orientationchange",n)}function Pt(){var e=document.getElementById("qr-share-area");if(!(!e||e.tagName!=="DETAILS")){var n="beatify_qr_expanded",a=768,r=sessionStorage.getItem(n);r!==null?e.open=r==="true":e.open=window.innerWidth>=a,e.addEventListener("toggle",function(){sessionStorage.setItem(n,e.open.toString())})}}var Xe={ITEM_HEIGHT:60,OVERSCAN:3,THRESHOLD:15,CONTAINER_HEIGHT:320},p={container:null,items:[],scrollTop:0,isVirtual:!1,topSpacer:null,bottomSpacer:null,contentWrapper:null,scrollHandler:null,resizeHandler:null};function Gt(e){if(e){p.container=e;var n=!1;p.scrollHandler=function(){p.scrollTop=e.scrollTop,n||(requestAnimationFrame(function(){Ne(),n=!1}),n=!0)};var a;p.resizeHandler=function(){clearTimeout(a),a=setTimeout(function(){p.isVirtual&&Ne()},100)},e.addEventListener("scroll",p.scrollHandler,{passive:!0}),window.addEventListener("resize",p.resizeHandler)}}function Ft(e,n){p.items=e,p.renderItem=n;var a=p.container;if(a){var r=a.scrollTop,i=p.isVirtual;e.length<Xe.THRESHOLD?(p.isVirtual=!1,a.classList.remove("player-list--virtual"),Wt(e,n)):(p.isVirtual=!0,a.classList.add("player-list--virtual"),Vt(),Ne()),i!==p.isVirtual&&r>0&&(a.scrollTop=r,p.scrollTop=r)}}function Vt(){var e=p.container;if(e){e.innerHTML="";var n=document.createElement("div");n.className="virtual-spacer-top",p.topSpacer=n;var a=document.createElement("div");a.className="virtual-content-wrapper",p.contentWrapper=a;var r=document.createElement("div");r.className="virtual-spacer-bottom",p.bottomSpacer=r,e.appendChild(n),e.appendChild(a),e.appendChild(r)}}function Ne(){var e=Xe,n=p.items,a=p.container,r=p.contentWrapper;if(!(!a||!r||!n.length)){var i=a.clientHeight||e.CONTAINER_HEIGHT,s=p.scrollTop,l=e.ITEM_HEIGHT,o=e.OVERSCAN,f=Math.max(0,Math.floor(s/l)-o),d=Math.min(n.length,Math.ceil((s+i)/l)+o);p.topSpacer&&(p.topSpacer.style.height=f*l+"px"),p.bottomSpacer&&(p.bottomSpacer.style.height=(n.length-d)*l+"px");for(var v="",u=f;u<d;u++)v+=p.renderItem(n[u],u);r.innerHTML=v}}function Wt(e,n){var a=p.container;if(a){for(var r="",i=0;i<e.length;i++)r+=n(e[i],i);a.innerHTML=r}}function qt(){var e=p.container;e&&p.scrollHandler&&e.removeEventListener("scroll",p.scrollHandler),p.resizeHandler&&window.removeEventListener("resize",p.resizeHandler),p.container=null,p.items=[],p.isVirtual=!1,p.topSpacer=null,p.bottomSpacer=null,p.contentWrapper=null}function jt(e,n){for(var a=0;a<Je.length;a++){var r=Je[a];if(e<r&&n>=r)return r}return null}function Ut(e){var n=e.map(function(r){return r.name}),a={};return n.forEach(function(r,i){var s=T.leaderboard.indexOf(r);s===-1?a[r]="new":i<s?a[r]="up":i>s&&(a[r]="down")}),a}function zt(e,n){T.players={},e.forEach(function(a){T.players[a.name]={score:a.score,rank:a.rank||0,streak:a.streak||0}}),n&&(T.leaderboard=n.map(function(a){return a.name})),T.initialized=!0}function Ba(){T.players={},T.leaderboard=[],T.initialized=!1}function Yt(e){return!e||typeof e!="string"?!1:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e)||/^[a-f0-9]{32}$/i.test(e)}function Ze(){var e=ze();if(!e||!Yt(e)){e&&Q(),L("join-view");return}var n=window.location.protocol==="https:"?"wss:":"ws:",a=n+"//"+window.location.host+"/beatify/ws";m=new WebSocket(a),m.onopen=function(){x=0,D=!1,re(),m.send(JSON.stringify({type:"reconnect",session_id:e}))},m.onmessage=function(r){try{var i=JSON.parse(r.data);Et(i)}catch(s){console.error("Failed to parse WebSocket message:",s)}},m.onclose=function(){if(E&&x<te){D=!0,x++,bt(),ht(x);var r=pt();console.log("WebSocket closed. Reconnecting in "+r+"ms... (attempt "+x+")"),setTimeout(function(){Ze()},r)}else x>=te?(D=!1,re(),qe()):L("join-view")},m.onerror=function(r){console.error("WebSocket error:",r)}}function Jt(e){var n=document.getElementById("volume-indicator");n&&(n.textContent="Welcome back, "+e+"!",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},2e3))}const Qt=20;let $e=[];function k(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function et(e){const n=document.getElementById("player-list"),a=document.getElementById("player-count");if(!n)return;if((!e||!Array.isArray(e))&&(e=[]),a){const o=e.length;a.textContent=o===1?c.t("lobby.playerJoined"):t("lobby.playersJoined",{count:o})}var r=e.slice().sort(function(o,f){return o.connected!==f.connected?o.connected?-1:1:0});const i=$e.map(function(o){return o.name}),s=r.filter(function(o){return i.indexOf(o.name)===-1}).map(function(o){return o.name});p.container||Gt(n);var l=function(o){var f=s.indexOf(o.name)!==-1,d=o.name===E,v=o.connected===!1,u=["player-card",f?"is-new":"",d?"player-card--you":"",v?"player-card--disconnected":""].filter(Boolean).join(" "),g=v?'<span class="away-badge">(away)</span>':"";return'<div class="'+u+'" data-player="'+k(o.name)+'"><span class="player-name">'+k(o.name)+(d?'<span class="you-badge">'+c.t("leaderboard.you")+"</span>":"")+g+"</span></div>"};Ft(r,l),setTimeout(function(){var o=p.isVirtual?p.contentWrapper:n;if(!o)return;const f=o.querySelectorAll(".is-new");for(let d=0;d<f.length;d++)f[d].classList.remove("is-new")},2e3),$e=e.slice()}function Re(e){var n={easy:"game.difficultyEasy",normal:"game.difficultyNormal",hard:"game.difficultyHard"}[e]||"game.difficultyNormal",a=t(n),r=document.getElementById("lobby-difficulty-badge"),i=document.getElementById("game-difficulty-badge");r&&(r.textContent=a,r.className="difficulty-badge difficulty-badge--"+(e||"normal")),i&&(i.textContent=a,i.className="difficulty-badge difficulty-badge--"+(e||"normal"))}let R=null;function Kt(e){if(e){R=e;var n=document.getElementById("player-qr-code");n&&(n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',n.onclick=tt,n.onkeydown=function(a){(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),tt())})}}function tt(){if(R){var e=document.getElementById("qr-modal"),n=document.getElementById("qr-modal-code");if(!(!e||!n)){n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:R,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',e.classList.remove("hidden"),document.body.style.overflow="hidden";var a=document.getElementById("qr-modal-close");a&&a.focus()}}}function Oe(){var e=document.getElementById("qr-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="")}function Xt(){var e=document.getElementById("qr-modal"),n=e?e.querySelector(".qr-modal-backdrop"):null,a=document.getElementById("qr-modal-close");n&&n.addEventListener("click",Oe),a&&a.addEventListener("click",Oe),document.addEventListener("keydown",function(r){r.key==="Escape"&&e&&!e.classList.contains("hidden")&&Oe()})}function Zt(){if(R){var e=document.getElementById("invite-modal"),n=document.getElementById("invite-modal-code"),a=document.getElementById("invite-modal-url");if(!(!e||!n)){n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:R,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',a&&(a.value=R),e.classList.remove("hidden"),document.body.style.overflow="hidden";var r=document.getElementById("invite-modal-close");r&&r.focus()}}}function me(){var e=document.getElementById("invite-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="");var n=document.getElementById("invite-copy-feedback");n&&n.classList.add("hidden")}function $t(){var e=document.getElementById("invite-modal-url"),n=document.getElementById("invite-copy-feedback");!e||!R||(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(R).then(function(){at(n)}).catch(function(){nt(e,n)}):nt(e,n))}function nt(e,n){e.select(),e.setSelectionRange(0,99999);try{document.execCommand("copy"),at(n)}catch(a){console.warn("[Beatify] Copy failed:",a)}}function at(e){e&&(e.classList.remove("hidden"),setTimeout(function(){e.classList.add("hidden")},2e3))}function en(){var e=document.getElementById("invite-modal"),n=e?e.querySelector(".invite-modal-backdrop"):null,a=document.getElementById("invite-modal-close"),r=document.getElementById("invite-players-btn"),i=document.getElementById("invite-copy-btn");n&&n.addEventListener("click",me),a&&a.addEventListener("click",me),r&&r.addEventListener("click",Zt),i&&i.addEventListener("click",$t),document.addEventListener("keydown",function(s){s.key==="Escape"&&e&&!e.classList.contains("hidden")&&me()})}let ve=null;function tn(e){q();var n=document.getElementById("timer");if(!n)return;n.classList.remove("timer--warning","timer--critical");function a(){var r=Date.now(),i=Math.max(0,Math.ceil((e-r)/1e3));n.textContent=i,i<=5?(n.classList.remove("timer--warning"),n.classList.add("timer--critical")):i<=10?(n.classList.remove("timer--critical"),n.classList.add("timer--warning")):n.classList.remove("timer--warning","timer--critical"),i===10?n.setAttribute("aria-label","10 seconds remaining"):i===5?n.setAttribute("aria-label","5 seconds!"):i===0?n.setAttribute("aria-label","Time is up!"):n.setAttribute("aria-label","Time remaining: "+i+" seconds"),i<=0&&q()}a(),ve=setInterval(a,1e3)}function q(){ve&&(clearInterval(ve),ve=null)}function nn(e){var n=document.getElementById("current-round"),a=document.getElementById("total-rounds"),r=document.getElementById("last-round-banner");n&&(n.textContent=e.round||1),a&&(a.textContent=e.total_rounds||10),r&&(e.last_round?r.classList.remove("hidden"):r.classList.add("hidden"));var i=document.getElementById("album-cover"),s=document.getElementById("album-loading");if(i&&e.song){s&&s.classList.remove("hidden");var l=e.song.album_art||"/beatify/static/img/no-artwork.svg";i.onload=function(){s&&s.classList.add("hidden")},i.onerror=function(){i.src="/beatify/static/img/no-artwork.svg",s&&s.classList.add("hidden")},i.src=l}rn(e.players),e.leaderboard&&rt(e,"leaderboard-list"),En(e.players),e.artist_challenge!==void 0&&gn(e.artist_challenge,"PLAYING")}function an(e){if(!e)return"?";var n=e.trim();if(!n)return"?";var a=n.split(/[\s-]+/).filter(Boolean);return a.length>=2?(a[0][0]+a[1][0]).toUpperCase():n.slice(0,Math.min(2,n.length)).toUpperCase()}function rn(e){var n=document.getElementById("submission-tracker"),a=document.getElementById("submitted-players"),r=document.getElementById("submission-count");if(!(!n||!a||!r)){var i=e||[],s=i.filter(function(d){return d.submitted}).length,l=i.length;r.textContent=c.t("game.submittedCount",{count:s,total:l});var o=s===l&&l>0;n.classList.toggle("all-submitted",o);var f=i.length>10;if(n.classList.toggle("is-compact",f),f){a.innerHTML="";return}a.innerHTML=i.map(function(d){var v=an(d.name),u=d.name===E,g=d.connected===!1,y=["player-indicator",d.submitted?"is-submitted":"",u?"is-current-player":"",d.bet?"is-betting":"",g?"player-indicator--disconnected":""].filter(Boolean).join(" ");return'<div class="'+y+'"><div class="player-avatar"><span class="player-initials">'+k(v)+'</span></div><span class="player-name">'+k(d.name)+"</span></div>"}).join("")}}function rt(e,n,a){var r=e.leaderboard||[],i=document.getElementById(n||"leaderboard-list");if(i){var s=a&&Rt(),l=s?Ut(r):{};r.forEach(function(u){u.is_current=u.name===E;var g=l[u.name];g&&(u._rankChange=g);var y=T.players[u.name],I=y?y.score:u.score;u._prevScore=I,u._displayScore=a?I:u.score});var o=sn(r,E),f=r.length>=X.MIN_PLAYERS_FOR_LAZY;if(f)b.observer||Ot(i),b.fullData=o,b.isLazyEnabled=!0,b.listEl=i,b.visibleRange=Ke(o,E),fe();else{b.isLazyEnabled=!1;var d="";o.forEach(function(u){d+=Qe(u)}),i.innerHTML=d}var v=[];s&&o.forEach(function(u){!u.separator&&u._prevScore!==u.score&&v.push({name:u.name,prevScore:u._prevScore,newScore:u.score})}),s&&v.length>0&&requestAnimationFrame(function(){for(var u={},g=i.querySelectorAll(".leaderboard-entry[data-name]"),y=0;y<g.length;y++){var I=g[y],h=I.getAttribute("data-name");h&&(u[h]=I)}v.forEach(function(w){var B=u[w.name];if(B){var S=B.querySelector(".entry-score");S&&Ae(S,w.prevScore,w.newScore,500)}})}),r.length>8&&on(i),ln(r),zt(e.players||[],r)}}function sn(e,n){if(e.length<=10)return e;for(var a=e.slice(0,5),r=e.slice(-3),i=-1,s=0;s<e.length;s++)if(e[s].name===n){i=s;break}return i<5||i>=e.length-3?[].concat(a,[{separator:!0}],r):[].concat(a,[{separator:!0}],[e[i]],[{separator:!0}],r)}function on(e){var n=e.querySelector(".leaderboard-entry.is-current");n&&n.scrollIntoView({behavior:"smooth",block:"center"})}function ln(e){var n=document.getElementById("leaderboard-you"),a=e.find(function(r){return r.is_current});n&&a&&(n.textContent=c.t("leaderboard.you")+" #"+a.rank,n.classList.remove("hidden"))}function cn(){var e=document.getElementById("leaderboard-toggle"),n=document.getElementById("game-leaderboard");e&&n&&e.addEventListener("click",function(){n.classList.toggle("is-expanded");var a=e.querySelector(".toggle-icon");a&&(a.textContent=n.classList.contains("is-expanded")?"\u25B2":"\u25BC")})}let O=!1,Z=!1,ge=0,$=!1;var j=!1,H=null,pe=null,dn=300,it=0;function un(){var e=document.getElementById("year-slider"),n=document.getElementById("selected-year");if(!(!e||!n)){e.addEventListener("input",function(){n.textContent=this.value});var a=document.getElementById("bet-toggle");a&&a.addEventListener("click",function(){O||(Z=!Z,a.classList.toggle("is-active",Z))});var r=document.getElementById("submit-btn");r&&r.addEventListener("click",fn);var i=document.getElementById("steal-btn");i&&i.addEventListener("click",Ln);var s=document.getElementById("steal-modal-close");s&&s.addEventListener("click",Pe);var l=document.getElementById("steal-modal");if(l){var o=l.querySelector(".steal-modal-backdrop");o&&o.addEventListener("click",Pe)}}}function fn(){if(!O){var e=document.getElementById("year-slider"),n=document.getElementById("submit-btn");if(!(!e||!n)){var a=parseInt(e.value,10);n.disabled=!0,n.classList.add("is-loading"),m&&m.readyState===WebSocket.OPEN?m.send(JSON.stringify({type:"submit",year:a,bet:Z})):(He("Connection lost. Please refresh."),n.disabled=!1,n.classList.remove("is-loading"))}}}function st(){O=!0;var e=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation"),r=document.getElementById("bet-toggle");e&&e.classList.add("is-submitted"),n&&n.classList.add("hidden"),r&&r.classList.add("hidden"),a&&a.classList.remove("hidden")}function mn(e){var n=document.getElementById("submit-btn");n&&(n.disabled=!1,n.classList.remove("is-loading")),e.code==="ROUND_EXPIRED"?(He("Time's up!"),O=!0,n&&(n.disabled=!0)):e.code==="ALREADY_SUBMITTED"?st():He(e.message||"Submission failed")}function He(e){var n=document.getElementById("submit-btn");n&&(n.textContent=e,n.classList.add("is-error"),setTimeout(function(){n.textContent=c.t("game.submitGuess"),n.classList.remove("is-error")},2e3))}function vn(){O=!1,Z=!1;var e=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation"),r=document.getElementById("year-slider"),i=document.getElementById("bet-toggle");if(e&&e.classList.remove("is-submitted"),n&&(n.disabled=!1,n.classList.remove("hidden","is-loading","is-error"),n.textContent=c.t("game.submitGuess")),i&&i.classList.remove("hidden","is-active"),a&&a.classList.add("hidden"),r){r.value=1990;var s=document.getElementById("selected-year");s&&(s.textContent="1990")}$=!1,De(),bn()}function gn(e,n){var a=document.getElementById("artist-challenge-container");if(a){if(!e||!e.options){a.classList.add("hidden");return}a.classList.remove("hidden");var r=document.getElementById("artist-options"),i=document.getElementById("artist-result"),s=Array.from(r.querySelectorAll(".artist-option-btn")).map(function(d){return d.dataset.artist}),l=e.options;if(JSON.stringify(s)!==JSON.stringify(l)&&(r.innerHTML="",l.forEach(function(d,v){var u=document.createElement("button");u.className="artist-option-btn",u.dataset.artist=d,u.dataset.index=v,u.textContent=d,u.addEventListener("click",function(){pn(d)}),r.appendChild(u)})),e.winner){var o=r.querySelectorAll(".artist-option-btn");if(o.forEach(function(d){d.classList.add("is-disabled"),d.classList.remove("is-loading","is-wrong");var v=e.correct_artist||pe;v&&d.dataset.artist===v&&d.classList.add("is-winner")}),e.winner===E)i.textContent=c.t("artistChallenge.youGotIt")||"You got it! +5 points",i.className="artist-result is-winner";else{var f=(c.t("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",e.winner);i.textContent=f,i.className="artist-result is-late"}i.classList.remove("hidden"),j=!0}else j||i.classList.add("hidden")}}function pn(e){var n=Date.now();if(!(n-it<dn)&&(it=n,!j)){var a=document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(e)+'"]');a&&a.classList.add("is-loading"),H=e;try{m&&m.readyState===WebSocket.OPEN&&m.send(JSON.stringify({type:"artist_guess",artist:e}))}catch(r){console.error("Artist guess send failed:",r),a&&a.classList.remove("is-loading"),H=null}}}function yn(e){var n=H?document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(H)+'"]'):null;if(e.correct&&e.first){if(pe=H,n){n.classList.remove("is-loading"),n.classList.add("is-correct");var a=document.createElement("span");a.className="artist-points-badge",a.textContent="+10",n.appendChild(a)}ot(),lt(c.t("artistChallenge.youGotIt")||"You got it! +5 points",!0),j=!0}else if(e.correct&&!e.first){pe=H,n&&(n.classList.remove("is-loading"),n.classList.add("is-correct")),ot();var r=(c.t("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",e.winner||"Someone");lt(r,!1),j=!0}else n&&(n.classList.remove("is-loading"),n.classList.add("is-wrong"),setTimeout(function(){n.classList.remove("is-wrong")},500));H=null}function ot(){document.querySelectorAll(".artist-option-btn").forEach(function(e){e.classList.add("is-disabled"),e.classList.remove("is-loading")})}function lt(e,n){var a=document.getElementById("artist-result");a&&(a.textContent=e,a.className="artist-result "+(n?"is-winner":"is-late"),a.classList.remove("hidden"))}function bn(){j=!1,H=null,pe=null;var e=document.getElementById("artist-challenge-container");e&&e.classList.add("hidden");var n=document.getElementById("artist-options");n&&(n.innerHTML="");var a=document.getElementById("artist-result");a&&(a.classList.add("hidden"),a.className="artist-result hidden")}function hn(e,n){var a=document.getElementById("artist-reveal-section");if(a){if(!e||!e.correct_artist){a.classList.add("hidden");return}a.classList.remove("hidden");var r=document.getElementById("artist-reveal-name");r&&(r.textContent=e.correct_artist);var i=document.getElementById("artist-reveal-winner");if(i)if(e.winner)if(i.classList.remove("hidden"),e.winner===n)i.textContent=c.t("artistChallenge.youGotIt")||"You got it! +5 points",i.className="artist-reveal-winner is-you";else{var s=(c.t("artistChallenge.winnerWas")||"{winner} got it first!").replace("{winner}",e.winner);i.textContent=s,i.className="artist-reveal-winner is-other"}else i.textContent=c.t("artistChallenge.noWinner")||"No one guessed the artist",i.className="artist-reveal-winner artist-reveal-no-winner",i.classList.remove("hidden")}}function En(e){if(!(!E||!e)){var n=e.find(function(i){return i.name===E});if(n){$=n.steal_available&&!O;var a=document.getElementById("steal-indicator"),r=document.getElementById("steal-btn");$?(a&&a.classList.remove("hidden"),r&&r.classList.remove("hidden")):De()}}}function De(){var e=document.getElementById("steal-indicator"),n=document.getElementById("steal-btn");e&&e.classList.add("hidden"),n&&n.classList.add("hidden")}function Ln(){!$||O||m&&m.readyState===WebSocket.OPEN&&m.send(JSON.stringify({type:"get_steal_targets"}))}function wn(e){var n=document.getElementById("steal-modal"),a=document.getElementById("steal-target-list");if(!(!n||!a)){if(a.innerHTML="",!e||e.length===0){var r=document.createElement("p");r.className="steal-no-targets",r.textContent=c.t("steal.waitForSubmit"),a.appendChild(r)}else e.forEach(function(i){var s=document.createElement("button");s.className="steal-target-btn",s.textContent=i,s.addEventListener("click",function(){In(i)}),a.appendChild(s)});n.classList.remove("hidden")}}function Pe(){var e=document.getElementById("steal-modal");e&&e.classList.add("hidden")}function In(e){return W(this,null,function*(){var n=c.t("steal.confirm").replace("{name}",e),a=yield le(c.t("steal.confirmTitle")||"Steal Answer?",n,c.t("steal.confirmButton")||"Steal",c.t("common.cancel"));a&&(m&&m.readyState===WebSocket.OPEN&&m.send(JSON.stringify({type:"steal",target:e})),Pe())})}function Bn(e){if(e.success){$=!1,O=!0,De();var n=document.getElementById("year-selector"),a=document.getElementById("submit-btn"),r=document.getElementById("submitted-confirmation");n&&n.classList.add("is-submitted"),a&&a.classList.add("hidden"),r&&r.classList.remove("hidden"),_n(e.target,e.year);var i=document.getElementById("selected-year"),s=document.getElementById("year-slider");i&&(i.textContent=e.year),s&&(s.value=e.year)}}function Sn(e){wn(e.targets||[])}function _n(e,n){var a=document.getElementById("steal-confirmation"),r=document.getElementById("steal-confirmation-text");if(!(!a||!r)){var i=c.t("steal.success").replace("{name}",e).replace("{year}",n);r.textContent=i,a.classList.remove("hidden"),setTimeout(function(){a.classList.add("hidden")},3e3)}}function ct(e){var n=e.song||{},a=e.players||[],r=document.getElementById("reveal-round"),i=document.getElementById("reveal-total");r&&(r.textContent=e.round||1),i&&(i.textContent=e.total_rounds||10);var s=document.getElementById("reveal-album-cover");s&&(s.src=n.album_art||"/beatify/static/img/no-artwork.svg");var l=document.getElementById("correct-year");l&&(l.textContent=n.year||"????");var o=document.getElementById("song-title"),f=document.getElementById("song-artist");o&&(o.textContent=n.title||"Unknown Song"),f&&(f.textContent=n.artist||"Unknown Artist");var d=document.getElementById("fun-fact-container"),v=document.getElementById("fun-fact"),u=d?d.querySelector(".fun-fact-header"):null,g=c.getLocalizedSongField(n,"fun_fact");if(v&&(v.textContent=g||""),u&&(u.style.display=g?"flex":"none"),An(n),Tn(e.song_difficulty),d){var y=document.getElementById("song-rich-info"),I=y&&y.innerHTML.trim()!=="",h=g&&g.trim()!=="";d.classList.toggle("hidden",!h&&!I)}for(var w=null,B=0;B<a.length;B++)if(a[B].name===E){w=a[B];break}Gn(w,n.year),Fn(w,n.year),e.artist_challenge&&hn(e.artist_challenge,E),e.game_performance&&e.game_performance.is_new_record&&we("record"),Vn(a),e.round_analytics&&Cn(e.round_analytics,n.year),e.leaderboard&&rt(e,"reveal-leaderboard-list",!0);var S=document.getElementById("reveal-admin-controls"),_=document.getElementById("next-round-btn");S&&w&&w.is_admin?(S.classList.remove("hidden"),_&&(e.last_round?(_.textContent=c.t("leaderboard.finalResults"),_.classList.add("is-final")):(_.textContent=c.t("admin.nextRound"),_.classList.remove("is-final")),_.disabled=!1)):S&&S.classList.add("hidden")}function Cn(e,n){var a=document.getElementById("round-analytics");if(!a||!e){a&&a.classList.add("hidden");return}if(e.total_submitted===0){a.innerHTML='<div class="analytics-empty">'+c.t("analytics.noSubmissions")+"</div>",a.classList.remove("hidden");return}var r="";if(e.average_guess!==null&&n){var i=Math.round(e.average_guess-n);i===0?r=c.t("analytics.onTarget"):i>0?r=c.t("analytics.yearsLate",{years:i}):r=c.t("analytics.yearsEarly",{years:Math.abs(i)})}var s=kn(e.all_guesses,n),l="";if(e.exact_match_players&&e.exact_match_players.length>0&&(l+='<div class="achievement-item"><span class="achievement-emoji">&#127919;</span><span class="achievement-label">'+c.t("analytics.exactMatches")+':</span><span class="achievement-names">'+e.exact_match_players.join(", ")+"</span></div>"),e.speed_champion&&e.speed_champion.names){var o=e.speed_champion.names.join(", ");l+='<div class="achievement-item"><span class="achievement-emoji">&#9889;</span><span class="achievement-label">'+c.t("analytics.speedChampion")+':</span><span class="achievement-names">'+o+'</span><span class="achievement-value">('+e.speed_champion.time+"s)</span></div>"}if(e.furthest_players&&e.furthest_players.length>0&&e.all_guesses&&e.all_guesses.length>0){var f=e.all_guesses[e.all_guesses.length-1].years_off;f>0&&(l+='<div class="achievement-item"><span class="achievement-emoji">&#128517;</span><span class="achievement-label">'+c.t("analytics.furthestGuess")+':</span><span class="achievement-names">'+e.furthest_players.join(", ")+'</span><span class="achievement-value">('+f+" years)</span></div>")}var d=e.average_guess!==null?Math.round(e.average_guess):"?";a.innerHTML='<h3 class="analytics-title">'+c.t("analytics.title")+'</h3><div class="analytics-stats-row"><div class="stat-primary"><span class="stat-label">'+c.t("analytics.averageGuess")+'</span><span class="stat-value">'+d+'</span></div><div class="stat-secondary"><span class="stat-value">'+e.accuracy_percentage+'%</span><span class="stat-label">'+c.t("analytics.accuracy",{percent:""}).replace("%","")+'</span></div></div><div class="stat-comparison-line">'+r+'</div><div class="analytics-histogram"><h4 class="histogram-title">'+c.t("analytics.histogram")+"</h4>"+s+"</div>"+(l?'<div class="analytics-achievements">'+l+"</div>":""),a.classList.remove("hidden")}function kn(e,n){var a=7;if(!e||e.length===0)return'<div class="histogram-empty">'+c.t("analytics.noGuesses")+"</div>";for(var r=e.map(function(Ia){return Ia.guess}),i=Math.min.apply(null,r),s=Math.max.apply(null,r),l=s-i,o=Math.max(1,Math.ceil(l/a)),f=o*a,d=f-l-1,v=i-Math.floor(d/2),u=[],g=0;g<a;g++){var y=v+g*o,I=y+o-1;u.push({start:y,end:I,count:0,containsCorrect:n>=y&&n<=I})}for(var h=0;h<r.length;h++)for(var w=r[h],B=0;B<u.length;B++)if(w>=u[B].start&&w<=u[B].end){u[B].count++;break}for(var S=1,_=0;_<u.length;_++)u[_].count>S&&(S=u[_].count);for(var F="",se=0;se<u.length;se++){var M=u[se],z=M.count/S*100,Be=se*.05,Se="histogram-bar"+(M.containsCorrect?" is-correct":""),V=M.count>0?Math.max(z,10):0,_e=M.count>0?'<span class="bar-count">'+M.count+"</span>":"",wa=o===1?String(M.start):M.start+"-"+String(M.end).slice(-2);F+='<div class="histogram-bar-wrapper" style="animation-delay: '+Be+'s"><div class="'+Se+'" style="height: '+V+'%">'+_e+'</div><span class="histogram-label">'+wa+"</span></div>"}return'<div class="histogram-bars">'+F+"</div>"}function xn(e){var n=document.getElementById("superlatives-container");if(n){if(!e||e.length===0){n.classList.add("hidden");return}var a="";e.forEach(function(r,i){var s="";switch(r.value_label){case"avg_time":s=r.value+"s "+c.t("superlatives.avgTime");break;case"streak":s=r.value+" "+c.t("superlatives.streak");break;case"bets":s=r.value+" "+c.t("superlatives.bets");break;case"points":s=r.value+" "+c.t("superlatives.points");break;case"close_guesses":s=r.value+" "+c.t("superlatives.closeGuesses");break;default:s=r.value}a+='<div class="superlative-card superlative-card--'+r.id+'" style="animation-delay: '+i*.2+'s"><div class="superlative-emoji">'+r.emoji+'</div><div class="superlative-title">'+c.t("superlatives."+r.title)+'</div><div class="superlative-player">'+k(r.player_name)+'</div><div class="superlative-value">'+s+"</div></div>"}),n.innerHTML=a,n.classList.remove("hidden")}}function Tn(e){var n=document.getElementById("song-difficulty");if(n){if(!e){n.classList.add("hidden");return}for(var a="",r=0;r<e.stars;r++)a+='<span class="star">&#9733;</span>';n.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+a+'</div><span class="difficulty-label">'+c.t("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+c.t("difficulty.accuracy")+"</span>",n.classList.remove("hidden")}}function An(e){var n=document.getElementById("song-rich-info");if(n){var a=[],r=Mn(e.chart_info||{});r.length>0&&(a=a.concat(r));var i=Nn(e.certifications||[]);i.length>0&&(a=a.concat(i));var s=c.getLocalizedSongField(e,"awards")||[],l=Hn(s);l.length>0&&(a=a.concat(l)),a.length>0?n.innerHTML='<div class="song-badges-row">'+a.join("")+"</div>":n.innerHTML=""}}function Mn(e){if(!e)return[];var n=[];if(e.billboard_peak&&e.billboard_peak>0){var a=e.weeks_on_chart?' <span class="chart-weeks">\xB7 '+e.weeks_on_chart+" "+c.t("reveal.weeksShort")+"</span>":"";n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.billboard_peak+" "+c.t("reveal.chartBillboard")+a+"</span>")}return e.german_peak&&e.german_peak>0&&!e.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.german_peak+" "+c.t("reveal.chartGerman")+"</span>"),e.uk_peak&&e.uk_peak>0&&!e.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.uk_peak+" "+c.t("reveal.chartUK")+"</span>"),n}function Nn(e){if(!e||e.length===0)return[];for(var n=[],a=0;a<e.length;a++){var r=e[a],i=Rn(r),s=On(r);n.push('<span class="song-badge '+i+'"><span class="song-badge-icon">'+s+"</span>"+k(r)+"</span>")}return n}function Rn(e){var n=e.toLowerCase();return n.indexOf("diamond")!==-1?"song-badge--diamond":n.indexOf("platinum")!==-1?"song-badge--platinum":n.indexOf("gold")!==-1?"song-badge--gold":"song-badge--platinum"}function On(e){var n=e.toLowerCase();return n.indexOf("diamond")!==-1?"\u{1F48E}":n.indexOf("platinum")!==-1?"\u{1F4BF}":n.indexOf("gold")!==-1?"\u{1F947}":"\u{1F4BF}"}function Hn(e){if(!e||e.length===0)return[];for(var n=[],a=e.slice(0,3),r=0;r<a.length;r++){var i=a[r],s=Dn(i),l=Pn(i);n.push('<span class="song-badge '+s+'"><span class="song-badge-icon">'+l+"</span>"+k(i)+"</span>")}return e.length>3&&n.push('<span class="song-badges-more">+'+(e.length-3)+" more</span>"),n}function Dn(e){var n=e.toLowerCase();return n.indexOf("grammy")!==-1?"song-badge--grammy":n.indexOf("eurovision")!==-1?"song-badge--eurovision":n.indexOf("oscar")!==-1||n.indexOf("academy award")!==-1?"song-badge--oscar":n.indexOf("hall of fame")!==-1?"song-badge--halloffame":"song-badge--award"}function Pn(e){var n=e.toLowerCase();return n.indexOf("eurovision")!==-1?"\u{1F3A4}":n.indexOf("grammy")!==-1?"\u{1F3C6}":n.indexOf("hall of fame")!==-1?"\u2B50":"\u{1F3C6}"}function Gn(e,n){var a=document.getElementById("reveal-emotion"),r=document.getElementById("personal-result");if(!a)return;a.className="reveal-emotion",a.innerHTML="",a.classList.add("hidden"),r&&r.classList.remove("is-delayed"),Ie();var i=c.t("reveal.emotions");function s(g){return g[Math.floor(Math.random()*g.length)]}function l(g){return g===1?c.t("reveal.offByYear"):c.t("reveal.offByYears",{years:g})}var o="missed",f=s(i.missed),d=s(i.missedSub);if(e&&!e.missed_round){var v=e.years_off||0;v===0?(o="exact",f=s(i.exact),d=s(i.exactSub)):v<=2?(o="close",f=s(i.close),d=s(i.closeSub)+" "+l(v)):v<=5?(o="close",f=s(i.close),d=l(v)):(o="wrong",f=s(i.wrong),d=s(i.wrongSub)+" "+l(v))}else e&&e.missed_round&&(o="missed",f=s(i.missed),d=s(i.missedSub));var u='<span class="reveal-emotion-text">'+f+"</span>";d&&(u+='<div class="reveal-emotion-subtitle">'+d+"</div>"),a.innerHTML=u,a.classList.add("reveal-emotion--"+o),a.classList.remove("hidden"),o==="exact"&&we(),r&&o!=="missed"&&r.classList.add("is-delayed")}function Fn(e,n){var a=document.getElementById("result-content");if(a){if(!e){a.innerHTML='<div class="result-missed">Player not found</div>';return}if(e.missed_round){var r='<div class="result-missed-container"><div class="result-missed-icon">\u23F0</div><div class="result-missed-text">'+c.t("reveal.noSubmission")+"</div></div>",i=e.previous_streak||0;i>=2&&(r+='<div class="streak-broken"><span class="streak-broken-icon">\u{1F494}</span><span class="streak-broken-text">Lost '+i+"-streak!</span></div>"),r+='<div class="result-score is-zero">0 pts</div>',a.innerHTML=r;return}var s=e.years_off||0,l=s===0?c.t("reveal.exact"):s===1?c.t("reveal.yearOff",{years:1}):t("reveal.yearsOff",{years:s}),o=s===0?"is-exact":s<=3?"is-close":"is-far",f=e.speed_multiplier||1,d=e.base_score||0,v=f>1,u=e.streak_bonus||0,g=e.artist_bonus||0,y="";v&&d>0&&(y='<div class="result-row"><span class="result-label">'+c.t("reveal.baseScore")+'</span><span class="result-value">'+d+' pts</span></div><div class="result-row"><span class="result-label">'+c.t("reveal.speedBonus")+'</span><span class="result-value is-bonus">'+f.toFixed(2)+"x</span></div>");var I="";e.bet_outcome==="won"?I='<div class="result-row bet-won-row"><span class="result-label">\u{1F3B2} '+c.t("reveal.betWon").replace("! 2x points","")+'</span><span class="result-value is-bet-won">2x</span></div>':e.bet_outcome==="lost"&&(I='<div class="result-row bet-lost-row"><span class="result-label">\u{1F3B2} '+c.t("reveal.betLost")+'</span><span class="result-value is-bet-lost">-</span></div>');var h="";u>0&&(h='<div class="result-row streak-bonus-row"><span class="result-label">'+e.streak+'-streak bonus!</span><span class="result-value is-streak">+'+u+" pts</span></div>");var w="";g>0&&(w='<div class="result-row artist-bonus-row"><span class="result-label">\u{1F3A4} '+(c.t("artistChallenge.artistBonus")||"Artist Bonus")+'</span><span class="result-value">+'+g+" pts</span></div>");var B=e.round_score+u+g,S=u>0||g>0,_=e.round_score>=20,F=T.players[e.name],se=F?F.score:e.score-B,M=F?F.streak:0,z=jt(M,e.streak||0);a.innerHTML='<div class="result-row"><span class="result-label">'+c.t("reveal.yourGuess")+'</span><span class="result-value">'+e.guess+'</span></div><div class="result-row"><span class="result-label">'+c.t("reveal.correctYear")+'</span><span class="result-value">'+n+'</span></div><div class="result-row"><span class="result-label">'+c.t("reveal.accuracy")+'</span><span class="result-value '+o+'">'+l+"</span></div>"+y+I+'<div class="result-score" id="personal-result-score">+<span class="score-value">0</span> pts</div>'+h+w+(S?'<div class="result-total">'+c.t("reveal.total")+': +<span class="total-value">0</span> pts</div>':"");var Be=a.querySelector(".score-value");Be&&(Nt(Be,0,e.round_score,{betWon:e.bet_outcome==="won",betLost:e.bet_outcome==="lost",streakMilestone:z,isBigScore:_}),e.bet_outcome==="won"&&e.round_score>0&&setTimeout(function(){var V=document.getElementById("personal-result-score");V&&Ye(V,e.round_score,{isBetWin:!0})},200));var Se=a.querySelector(".total-value");Se&&S&&(setTimeout(function(){Ae(Se,0,B,600)},300),z&&setTimeout(function(){var V=a.querySelector(".result-total");if(V){var _e={3:20,5:50,10:100}[z]||0;Ye(V,_e,{isStreak:!0,text:"+"+_e+" "+z+"-Streak!"})}},500))}}function Vn(e){var n=document.getElementById("reveal-results-cards");if(n){if(!e||e.length===0){n.innerHTML="";return}var a=e.slice().sort(function(i,s){return(s.round_score||0)-(i.round_score||0)}),r='<div class="results-cards-header">'+c.t("reveal.allPlayers")+"</div>";r+='<div class="results-cards-scroll">',a.forEach(function(i){var s=i.name===E,l=i.missed_round===!0,o=i.years_off||0,f=i.round_score||0,d=l?"is-score-zero":f>=10?"is-score-high":f>=1?"is-score-medium":"is-score-zero",v=l?"\u2014":i.guess,u=l?c.t("reveal.noGuessShort"):o===0?c.t("reveal.exact"):t("reveal.shortOff",{years:o}),g=i.bet?'<span class="card-bet">\u{1F3B2}</span>':"",y="";i.artist_bonus&&i.artist_bonus>0&&(y='<span class="player-card-artist-badge">\u{1F3A4} +'+i.artist_bonus+"</span>");var I="";if(i.stole_from)I='<div class="steal-badge"><span class="steal-badge-icon">\u{1F977}</span>'+t("steal.stolenFrom",{name:k(i.stole_from)})+"</div>";else if(i.was_stolen_by&&i.was_stolen_by.length>0){var h=i.was_stolen_by.map(k).join(", ");I='<div class="steal-badge steal-badge-victim"><span class="steal-badge-icon">\u{1F3AF}</span>'+t("steal.stolenBy",{name:h})+"</div>"}r+='<div class="result-card '+d+(s?" is-current":"")+'"><div class="card-name">'+k(i.name)+g+'</div><div class="card-guess">'+v+'</div><div class="card-accuracy">'+u+"</div>"+I+'<div class="card-score">+'+f+y+"</div></div>"}),r+="</div>",n.innerHTML=r}}function Wn(e){var n=e.leaderboard||[];n.forEach(function(h){h.is_current=h.name===E}),[1,2,3].forEach(function(h){var w=n.find(function(_){return _.rank===h}),B=document.getElementById("podium-"+h+"-name"),S=document.getElementById("podium-"+h+"-score");B&&(B.textContent=w?k(w.name):"---"),S&&(S.textContent=w?w.score:"0")});var a=n.find(function(h){return h.is_current}),r=document.getElementById("your-final-rank"),i=document.getElementById("your-final-score"),s=document.getElementById("stat-best-streak"),l=document.getElementById("stat-rounds"),o=document.getElementById("stat-bets");a&&(r&&(r.textContent="#"+a.rank),i&&(i.textContent=a.score+" "+c.t("leaderboard.points")),s&&(s.textContent=a.best_streak||0),l&&(l.textContent=a.rounds_played||0),o&&(o.textContent=a.bets_won||0));var f=document.getElementById("final-leaderboard-list");f&&(f.innerHTML=n.map(function(h){var w=h.is_current?"is-current":"",B=h.connected===!1?"final-entry--disconnected":"",S=h.connected===!1?'<span class="away-badge">(away)</span>':"";return'<div class="final-entry '+w+" "+B+'"><span class="final-rank">#'+h.rank+'</span><span class="final-name">'+k(h.name)+S+'</span><span class="final-score">'+h.score+"</span></div>"}).join("")),xn(e.superlatives);var d=document.getElementById("end-admin-controls"),v=document.getElementById("end-player-message");if(a&&a.is_admin){d&&d.classList.remove("hidden"),v&&v.classList.add("hidden");var u=document.getElementById("new-game-btn");u&&(u.onclick=jn)}else d&&d.classList.add("hidden"),v&&v.classList.remove("hidden");if(a){var g=e.total_rounds||10,y=a.best_streak||0,I=y===g&&g>0;I?we("perfect"):a.rank===1&&we("winner")}}function qn(e){var n=document.getElementById("pause-message");n&&(e.pause_reason==="admin_disconnected"?n.textContent="Waiting for host to reconnect...":e.pause_reason==="media_player_error"?n.textContent="Speaker unavailable. Please check your media player and try again.":n.textContent="Game paused. Please wait...")}function jn(){return W(this,null,function*(){var e=yield le(c.t("admin.newGameTitle")||"New Game?",c.t("admin.newGameConfirm")||"Start a new game?",c.t("admin.newGame")||"New Game",c.t("common.cancel"));if(e){var n=document.getElementById("new-game-btn");n&&(n.disabled=!0,n.textContent="Redirecting...");try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(a){}window.location.href="/beatify/admin"}})}var Ge=!1,Un=2e3;function dt(){if(!Ge&&m&&m.readyState===WebSocket.OPEN){Ge=!0;var e=document.getElementById("next-round-btn"),n=document.getElementById("next-round-admin-btn");if(e&&(e.disabled=!0,e.textContent="Loading..."),n){n.disabled=!0;var a=n.querySelector(".control-label");a&&(a.textContent="Wait...")}m.send(JSON.stringify({type:"admin",action:"next_round"})),setTimeout(function(){Ge=!1,e&&(e.disabled=!1),n&&(n.disabled=!1)},Un)}}let Fe=!1;var zn=500;let ee=!1,Ve=.5;function ye(){return Fe?!1:(Fe=!0,setTimeout(function(){Fe=!1},zn),!0)}function ut(){if(A){var e=document.getElementById("admin-control-bar");e&&(e.classList.remove("hidden"),document.body.classList.add("has-control-bar"))}}function be(){var e=document.getElementById("admin-control-bar");e&&(e.classList.add("hidden"),document.body.classList.remove("has-control-bar"))}function Yn(){var e=document.getElementById("reaction-bar");e&&e.classList.remove("hidden")}function he(){var e=document.getElementById("reaction-bar");e&&e.classList.add("hidden")}function Jn(e){We||(We=!0,m&&m.readyState===WebSocket.OPEN&&m.send(JSON.stringify({type:"reaction",emoji:e})))}function Qn(){var e=document.getElementById("reaction-bar");if(e){var n=e.querySelectorAll(".reaction-btn");n.forEach(function(a){a.addEventListener("click",function(){var r=a.getAttribute("data-emoji");r&&Jn(r)})})}}Qn();function Kn(e,n){var a=document.getElementById("reaction-container");if(a){var r=document.createElement("div");r.className="reaction-bubble",r.textContent=e+" "+n,r.style.left=20+Math.random()*60+"%",a.appendChild(r),setTimeout(function(){r.remove()},3e3)}}function ft(e){var n=document.getElementById("stop-song-btn"),a=document.getElementById("next-round-admin-btn");if(e==="PLAYING"){if(vt(),n&&!ee&&(n.classList.remove("is-disabled"),n.disabled=!1),a){a.classList.remove("is-disabled"),a.disabled=!1;var r=a.querySelector(".control-label");r&&(r.textContent="Skip")}}else if(e==="REVEAL"){if(n&&!ee&&(n.classList.remove("is-disabled"),n.disabled=!1),a){a.classList.remove("is-disabled"),a.disabled=!1;var r=a.querySelector(".control-label");r&&(r.textContent="Next")}}else if(a){a.classList.add("is-disabled"),a.disabled=!0;var r=a.querySelector(".control-label");r&&(r.textContent="Next")}}function Xn(){if(!ee&&ye()){if(!m||m.readyState!==WebSocket.OPEN){console.warn("[Beatify] Cannot stop song: WebSocket not connected");return}var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-disabled"),e.disabled=!0;var n=e.querySelector(".control-label");n&&(n.textContent="Stopping...")}m.send(JSON.stringify({type:"admin",action:"stop_song"}))}}function Zn(){if(Ve>=1){mt("max");return}ye()&&(!m||m.readyState!==WebSocket.OPEN||m.send(JSON.stringify({type:"admin",action:"set_volume",direction:"up"})))}function $n(){if(Ve<=0){mt("min");return}ye()&&(!m||m.readyState!==WebSocket.OPEN||m.send(JSON.stringify({type:"admin",action:"set_volume",direction:"down"})))}function mt(e){var n=document.getElementById("volume-indicator");n&&(n.textContent=e==="max"?"\u{1F50A} Max":"\u{1F507} Min",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},1e3))}function ea(){return W(this,null,function*(){var e=yield le(c.t("admin.endGameConfirm")||"End Game?",c.t("admin.endGameWarning")||"All players will be disconnected.",c.t("admin.endGame")||"End Game",c.t("common.cancel"));if(e&&ye()){if(!m||m.readyState!==WebSocket.OPEN){alert(c.t("errors.CONNECTION_LOST"));return}var n=document.getElementById("end-game-btn");if(n){n.disabled=!0;var a=n.querySelector(".control-label");a&&(a.textContent="Ending...")}m.send(JSON.stringify({type:"admin",action:"end_game"}))}})}function ta(){dt()}function na(){var e=document.getElementById("stop-song-btn"),n=document.getElementById("volume-up-btn"),a=document.getElementById("volume-down-btn"),r=document.getElementById("next-round-admin-btn"),i=document.getElementById("end-game-btn");e&&e.addEventListener("click",Xn),n&&n.addEventListener("click",Zn),a&&a.addEventListener("click",$n),r&&r.addEventListener("click",ta),i&&i.addEventListener("click",ea)}function aa(){ee=!0;var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-stopped"),e.classList.add("is-disabled"),e.disabled=!0;var n=e.querySelector(".control-icon"),a=e.querySelector(".control-label");n&&(n.textContent="\u2713"),a&&(a.textContent="Stopped")}}function vt(){ee=!1;var e=document.getElementById("stop-song-btn");if(e){e.classList.remove("is-stopped"),e.classList.remove("is-disabled"),e.disabled=!1;var n=e.querySelector(".control-icon"),a=e.querySelector(".control-label");n&&(n.textContent="\u23F9\uFE0F"),a&&(a.textContent="Stop")}}function ra(e){Ve=e,ia(e),sa(e)}function ia(e){var n=document.getElementById("volume-indicator");if(n){var a=Math.round(e*100);n.textContent="\u{1F50A} "+a+"%",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},1500)}}function sa(e){var n=document.getElementById("volume-up-btn"),a=document.getElementById("volume-down-btn");n&&n.classList.toggle("is-at-limit",e>=1),a&&a.classList.toggle("is-at-limit",e<=0)}let A=!1;function oa(){const e=sessionStorage.getItem("beatify_is_admin"),n=sessionStorage.getItem("beatify_admin_name");return e==="true"&&n&&(A=!0,E=n,sessionStorage.removeItem("beatify_is_admin")),A}function la(e){const n=document.getElementById("admin-controls"),a=document.getElementById("lobby-status"),r=document.getElementById("leave-game-container");if(!n)return;(!e||!Array.isArray(e))&&(e=[]);const i=e.find(function(l){return l.name===E});(i==null?void 0:i.is_admin)===!0?(n.classList.remove("hidden"),a&&a.classList.add("hidden"),r&&r.classList.add("hidden")):(n.classList.add("hidden"),a&&a.classList.remove("hidden"),r&&r.classList.remove("hidden"))}function ca(){const e=document.getElementById("start-game-btn");e==null||e.addEventListener("click",function(){!m||m.readyState!==WebSocket.OPEN||(e.disabled=!0,e.textContent="Starting...",m.send(JSON.stringify({type:"admin",action:"start_game"})))});const n=document.getElementById("leave-game-btn");n==null||n.addEventListener("click",function(){pa()})}let m=null,E=null,x=0;const te=10,da=3e4,Ee="beatify_player_name",Le="beatify_game_id",gt="beatify_language";let D=!1,ne=!1,We=!1;function pt(){return Math.min(1e3*Math.pow(2,x),da)}function ua(){try{var e=localStorage.getItem(Le),n=localStorage.getItem(Ee);if(console.log("[Beatify] Checking localStorage - storedGameId:",e,"currentGameId:",C,"storedName:",n),e&&e===C)return console.log("[Beatify] Game ID match, returning stored name:",n),n;e&&e!==C&&(console.log("[Beatify] Different game ID, clearing stored data"),localStorage.removeItem(Ee),localStorage.removeItem(Le))}catch(a){console.error("[Beatify] localStorage error:",a)}return null}function yt(e){try{localStorage.setItem(Ee,e),localStorage.setItem(Le,C),console.log("[Beatify] Stored player name:",e,"for game:",C)}catch(n){console.error("[Beatify] Failed to store player name:",n)}}function ae(){try{localStorage.removeItem(Ee),localStorage.removeItem(Le)}catch(e){}}function fa(e){try{localStorage.setItem(gt,e)}catch(n){}}function ma(){try{return localStorage.getItem(gt)}catch(e){return null}}function bt(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.remove("hidden")}function re(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.add("hidden")}function ht(e){var n=document.getElementById("reconnect-status");n&&(n.textContent="Reconnecting... (Attempt "+e+"/"+te+")")}function qe(){L("connection-lost-view")}function va(){var e=document.getElementById("retry-connection-btn");e&&e.addEventListener("click",function(){E?(x=0,L("loading-view"),ie(E)):ce()})}function ie(e){E=e,yt(e);const a=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+"/beatify/ws";m=new WebSocket(a),m.onopen=function(){x=0,D=!1,re();var r={type:"join",name:e};A&&(r.is_admin=!0),m.send(JSON.stringify(r))},m.onmessage=function(r){try{const i=JSON.parse(r.data);Et(i)}catch(i){console.error("Failed to parse WebSocket message:",i)}},m.onclose=function(){if(ne){ne=!1;return}if(E&&x<te){D=!0,x++,bt(),ht(x);const r=pt();console.log("WebSocket closed. Reconnecting in "+r+"ms... (attempt "+x+")"),setTimeout(function(){ie(E)},r)}else x>=te&&(D=!1,re(),qe())},m.onerror=function(r){console.error("WebSocket error:",r)}}function Et(e){const n=document.getElementById("join-btn"),a=document.getElementById("name-input");if(e.type==="state"){var r=e.players||[],i=r.find(function(l){return l.name===E});if(i&&(A=i.is_admin===!0),e.language&&(fa(e.language),typeof BeatifyI18n!="undefined"&&e.language!==BeatifyI18n.getLanguage()&&BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),et(r),e.difficulty&&Re(e.difficulty),e.phase==="REVEAL"&&ct(e)})),e.phase==="LOBBY")q(),be(),he(),ge=0,U("warmup"),L("lobby-view"),et(r),e.difficulty&&Re(e.difficulty),e.join_url&&Kt(e.join_url),la(r);else if(e.phase==="PLAYING"){var s=e.round||1;s!==ge&&(ge=s,vn()),U("party"),L("game-view"),me(),nn(e),e.difficulty&&Re(e.difficulty),e.deadline&&tn(e.deadline),un(),cn(),ut(),ft("PLAYING"),he()}else e.phase==="REVEAL"?(q(),U("party"),L("reveal-view"),ct(e),ut(),ft("REVEAL"),We=!1,Yn()):e.phase==="PAUSED"?(q(),be(),he(),U("warmup"),L("paused-view"),qn(e)):e.phase==="END"&&(q(),be(),he(),ge=0,U("warmup"),L("end-view"),Wn(e),ae())}else if(e.type==="join_ack"){e.session_id&&At(e.session_id);try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(l){}}else if(e.type==="reconnect_ack")e.success&&e.name?(E=e.name,yt(e.name),Jt(e.name)):(Q(),ae(),E=null,L("join-view"));else if(e.type==="submit_ack")st();else if(e.type==="error"){if(e.code==="ROUND_EXPIRED"||e.code==="ALREADY_SUBMITTED"){mn(e);return}if(e.code==="GAME_ENDED"){L("end-view");return}if(e.code==="NOT_ADMIN"){A=!1,be(),console.warn("Admin action rejected: not admin");return}if(e.code==="SESSION_TAKEOVER"){D=!1,re(),E=null,qe(),console.warn("Session taken over by another tab");return}if(e.code==="SESSION_NOT_FOUND"){Q(),ne=!0,m&&m.close(),L("join-view");return}if(e.code==="ADMIN_CANNOT_LEAVE"){ne=!1,alert(e.message||"Host cannot leave. End the game instead.");return}if(e.code==="INVALID_ACTION"&&e.message==="No song playing"){vt(),console.warn("[Beatify] Stop song failed: No song playing");return}L("join-view"),ba(e.message),n&&(n.disabled=!1,n.textContent=c.t("join.joinButton")),a&&a.focus(),E=null,ae()}else e.type==="song_stopped"?aa():e.type==="volume_changed"?ra(e.level):e.type==="game_ended"?ya():e.type==="left"?ga():e.type==="steal_targets"?Sn(e):e.type==="steal_ack"?Bn(e):e.type==="artist_guess_ack"?yn(e):e.type==="player_reaction"&&Kn(e.player_name,e.emoji)}function ga(){ae(),Q(),E=null,A=!1,L("join-view")}function pa(){return W(this,null,function*(){if(!(!m||m.readyState!==WebSocket.OPEN)){if(A){alert("Host cannot leave. End the game instead.");return}var e=yield le(c.t("player.leaveGameTitle")||"Leave Game?",c.t("player.leaveGameWarning")||"Your score will be lost.",c.t("player.leaveGame")||"Leave",c.t("common.cancel"));e&&(ne=!0,m.send(JSON.stringify({type:"leave"})))}})}function ya(){var e=A;ae(),Q();try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(a){}if(Ht(),qt(),Me.clear(),Ie(),E=null,A=!1,m&&m.readyState===WebSocket.OPEN&&m.close(),m=null,e){setTimeout(function(){window.location.href="/beatify/admin"},5e3);return}if(!(!Te||!Te.classList.contains("hidden"))){var n=document.getElementById("end-player-message");n&&(n.innerHTML='<p>Thanks for playing!</p><p class="rejoin-hint">Scan the QR code again to join the next game.</p>',n.classList.remove("hidden")),L("end-view")}}function ba(e){const n=document.getElementById("name-validation-msg");n&&(n.textContent=e,n.classList.remove("hidden"))}function je(e){const n=(e||"").trim();return n?n.length>Qt?{valid:!1,error:"Name too long (max 20 characters)"}:{valid:!0,name:n}:{valid:!1,error:"Please enter a name"}}function Lt(){const e=document.getElementById("name-input"),n=document.getElementById("join-btn"),a=document.getElementById("name-validation-msg");if(!e||!n)return;const r=je(e.value);r.valid&&(n.disabled=!0,n.textContent="Joining...",a&&a.classList.add("hidden"),ie(r.name))}function ha(){const e=document.getElementById("name-input"),n=document.getElementById("join-btn"),a=document.getElementById("name-validation-msg");!e||!n||(e.addEventListener("input",function(){const r=je(this.value);n.disabled=!r.valid,a&&(a.textContent=!r.valid&&this.value?r.error:"",a.classList.toggle("hidden",r.valid||!this.value))}),n.addEventListener("click",Lt),e.addEventListener("keypress",function(r){r.key==="Enter"&&!n.disabled&&Lt()}))}const Ea=L;L=function(e){Ea(e),(e==="join-view"||e==="loading-view"||e==="not-found-view"||e==="ended-view"||e==="in-progress-view"||e==="connection-lost-view")&&U("calm"),e==="join-view"&&setTimeout(function(){var n=document.getElementById("name-input");n&&n.focus()},100)};function U(e){document.body.classList.remove("energy-calm","energy-warmup","energy-party"),document.body.classList.add("energy-"+e)}var P=null,G=null;function we(e){if(K.prefersReducedMotion()){wt();return}if(typeof confetti=="undefined"){console.warn("[Confetti] Library not loaded");return}Ie();var n=K.getQualitySettings(),a=n.confettiParticles;if(a===0){wt();return}var r=K.getDeviceTier(),i=r==="low"?.5:r==="medium"?.75:1;switch(e=e||"exact",e){case"exact":var s=Math.round(2e3*i),l=Date.now()+s;(function y(){confetti({particleCount:a,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<l&&(P=requestAnimationFrame(y))})();break;case"record":var o=Math.round(3e3*i),f=Date.now()+o;(function y(){confetti({particleCount:Math.round(a*.67),spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<f&&(P=requestAnimationFrame(y))})();break;case"winner":var d=Math.round(4e3*i),v=Date.now()+d;(function y(){confetti({particleCount:Math.round(a*.67),angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:Math.round(a*.67),angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<v&&(P=requestAnimationFrame(y))})();break;case"perfect":var u=Math.round(5e3*i),g=Date.now()+u;G=setInterval(function(){confetti({particleCount:a*2,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},r==="low"?750:500),setTimeout(function(){G&&(clearInterval(G),G=null)},u),function y(){confetti({particleCount:Math.round(a*.5),angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:Math.round(a*.5),angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<g&&(P=requestAnimationFrame(y))}();break;default:console.warn("[Confetti] Unknown type:",e)}}function Ie(){P&&(cancelAnimationFrame(P),P=null),G&&(clearInterval(G),G=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function wt(){var e=document.getElementById("reveal-emotion");if(e){var n=e.querySelector(".celebration-icon");if(!n){var a=document.createElement("span");a.className="celebration-icon",a.textContent=" \u{1F389}",e.appendChild(a)}}}function La(){var e=document.getElementById("next-round-btn");e&&e.addEventListener("click",dt);var n=document.getElementById("reveal-view");n&&n.addEventListener("click",function(a){a.target.tagName==="BUTTON"||a.target.closest("button")||(Me.isRunning()&&Me.skipAll(),Ie())})}function It(){return W(this,null,function*(){var e=K.getDeviceTier();document.body.classList.add("device-tier-"+e);var n=yield c.waitForI18n();if(!n)console.error("[Player] BeatifyI18n module failed to load - UI will use fallback text");else{var a=ma();yield BeatifyI18n.init(a),BeatifyI18n.initPageTranslations()}var r=document.getElementById("dashboard-hint-url");if(r&&(r.textContent=window.location.origin+"/beatify/dashboard"),ha(),Xt(),en(),ca(),La(),na(),va(),Dt(),Pt(),oa()&&E){ie(E);return}var i=ua();if(i&&C){console.log("[Beatify] Auto-reconnecting as:",i),ie(i);return}if(i){var s=document.getElementById("name-input"),l=document.getElementById("join-btn");if(s&&(s.value=i,l)){var o=je(i);l.disabled=!o.valid}}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",It):It(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Beatify] SW registered:",e.scope)}).catch(function(e){console.warn("[Beatify] SW registration failed:",e)})})})();})();
//# sourceMappingURL=player.min.js.map
