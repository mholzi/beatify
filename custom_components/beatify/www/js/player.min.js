(()=>{var q=(c,Ye,C)=>new Promise((Ce,oe)=>{var ke=N=>{try{Y(C.next(N))}catch(J){oe(J)}},xe=N=>{try{Y(C.throw(N))}catch(J){oe(J)}},Y=N=>N.done?Ce(N.value):Promise.resolve(N.value).then(ke,xe);Y((C=C.apply(c,Ye)).next())});(function(){"use strict";var Bt,St;var c=window.BeatifyUtils||{};const C=new URLSearchParams(window.location.search).get("game"),Ce=document.getElementById("loading-view"),oe=document.getElementById("not-found-view"),ke=document.getElementById("ended-view"),xe=document.getElementById("in-progress-view"),Y=document.getElementById("join-view"),N=document.getElementById("lobby-view"),J=document.getElementById("game-view"),_t=document.getElementById("reveal-view"),Ct=document.getElementById("paused-view"),Te=document.getElementById("end-view"),kt=document.getElementById("connection-lost-view"),xt=[Ce,oe,ke,xe,Y,N,J,_t,Ct,Te,kt];function L(e){c.showView(xt,e)}function Tt(e){return!e||typeof e!="string"?!1:/^[a-zA-Z0-9_-]{8,16}$/.test(e)}function le(e,n,a,i){return new Promise(function(r){var s=document.getElementById("confirm-modal"),o=document.getElementById("confirm-modal-title"),d=document.getElementById("confirm-modal-message"),u=document.getElementById("confirm-modal-yes"),f=document.getElementById("confirm-modal-no");if(!s||!o||!d||!u||!f){r(confirm(n||e));return}o.textContent=e,d.textContent=n,u.textContent=a||c.t("common.confirm")||"Confirm",f.textContent=i||c.t("common.cancel")||"Cancel",s.classList.remove("hidden");function m(){s.classList.add("hidden"),u.removeEventListener("click",l),f.removeEventListener("click",v),p.removeEventListener("click",v)}function l(){m(),r(!0)}function v(){m(),r(!1)}var p=s.querySelector(".modal-backdrop");u.addEventListener("click",l),f.addEventListener("click",v),p&&p.addEventListener("click",v)})}function ce(){return q(this,null,function*(){if(!C){L("not-found-view");return}if(!Tt(C)){L("not-found-view");return}try{const i=yield(yield fetch(`/beatify/api/game-status?game=${encodeURIComponent(C)}`)).json();if(!i.exists){L("not-found-view");return}if(i.phase==="END"){L("ended-view");return}var e=sessionStorage.getItem("beatify_admin_name");if(e)return;var n=Je();if(n){et();return}i.can_join?L("join-view"):L("in-progress-view")}catch(a){console.error("Failed to check game status:",a),L("not-found-view")}})}ce(),(Bt=document.getElementById("refresh-btn"))==null||Bt.addEventListener("click",()=>{L("loading-view"),ce()}),(St=document.getElementById("retry-btn"))==null||St.addEventListener("click",()=>{L("loading-view"),ce()});var de="beatify_session";function At(e){var n=location.protocol==="https:"?"; Secure":"";document.cookie=de+"="+e+"; path=/beatify; SameSite=Strict; max-age=86400"+n}function Je(){for(var e=document.cookie.split(";"),n=0;n<e.length;n++){var a=e[n].trim();if(a.indexOf(de+"=")===0)return a.substring(de.length+1)}return null}function Q(){document.cookie=de+"=; path=/beatify; max-age=0"}function ue(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function Mt(e){return 1-Math.pow(1-e,4)}function Ae(e,n,a,i,r){if(ue()||n===a)return e.textContent=a,{cancel:function(){},skipToEnd:function(){e.textContent=a}};var s=K.getQualitySettings();if(s.scoreDuration===0)return e.textContent=a,{cancel:function(){},skipToEnd:function(){e.textContent=a}};var o=Math.min(i,s.scoreDuration||i);r=r||Mt;var d=null,u=null,f=!1,m=a;function l(v){if(!f){d||(d=v);var p=v-d,w=Math.min(p/o,1),h=r(w),I=Math.round(n+(m-n)*h);e.textContent=I,w<1&&(u=requestAnimationFrame(l))}}return u=requestAnimationFrame(l),{cancel:function(){f=!0,u&&cancelAnimationFrame(u)},skipToEnd:function(){f=!0,u&&cancelAnimationFrame(u),e.textContent=m}}}function Nt(e,n,a,i){i=i||{};var r=500;i.betWon?r=800:i.isBigScore?r=700:i.betLost&&(r=400),e.classList.add("score-animating");var s=null;i.betWon?s="score-glow-gold":i.betLost?(s="score-shake",e.classList.add("score-flash-red")):i.streakMilestone?s="score-burst":i.isBigScore&&(s="score-pop"),s&&!ue()&&e.classList.add(s),Ae(e,n,a,r);function o(){e.classList.remove("score-animating"),s&&e.classList.remove(s),e.classList.remove("score-flash-red")}s&&!ue()?e.addEventListener("animationend",function d(){e.removeEventListener("animationend",d),o()}):setTimeout(o,r+50)}function Qe(e,n,a){if(a=a||{},!ue()){var i=document.createElement("div");i.className="points-popup",i.textContent=a.text||"+"+n,a.isStreak?i.classList.add("points-popup--streak"):a.isBetWin&&i.classList.add("points-popup--gold");var r=e.getBoundingClientRect();i.style.left=r.left+r.width/2+"px",i.style.top=r.top+"px",document.body.appendChild(i),i.addEventListener("animationend",function(){i.parentNode&&i.parentNode.removeChild(i)}),setTimeout(function(){i.parentNode&&i.parentNode.removeChild(i)},1200)}}var T={players:{},leaderboard:[],initialized:!1};function Rt(){return T.initialized}var Ke=[3,5,10],K=function(){var e=window.matchMedia("(prefers-reduced-motion: reduce)"),n=e.matches;e.addEventListener("change",function(r){n=r.matches});var a=null;function i(){if(a!==null)return a;var r=navigator.hardwareConcurrency||2,s=navigator.deviceMemory||4,o=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return r<=2||s<=2?a="low":r<=4||s<=4||o?a="medium":a="high",a}return i(),{prefersReducedMotion:function(){return n},getDeviceTier:i,getQualitySettings:function(){var r=i();if(n)return{confettiParticles:0,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!1};switch(r){case"low":return{confettiParticles:5,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!0};case"medium":return{confettiParticles:10,scoreDuration:300,leaderboardAnimation:"simplified",neonGlow:!1,enableAnimations:!0};default:return{confettiParticles:15,scoreDuration:500,leaderboardAnimation:"full",neonGlow:!0,enableAnimations:!0}}},ifMotionAllowed:function(r,s){n?s&&s():r()},withWillChange:function(r,s,o){r&&(r.style.willChange=s,setTimeout(function(){r&&r.style&&(r.style.willChange="auto")},(o||500)+100))}}}(),Me=function(){var e=[],n=!1,a=null,i=null,r=2e3;function s(){if(i&&(clearTimeout(i),i=null),e.length===0){n=!1,a=null;return}a=e.shift(),i=setTimeout(function(){a&&a.skipToEnd&&a.skipToEnd(),s()},r),a.run(function(){i&&(clearTimeout(i),i=null),s()})}return{add:function(o){e.push(o),n||(n=!0,s())},skipAll:function(){i&&(clearTimeout(i),i=null),a&&a.skipToEnd&&a.skipToEnd(),e.forEach(function(o){o.skipToEnd&&o.skipToEnd()}),e=[],n=!1,a=null},clear:function(){i&&(clearTimeout(i),i=null),e=[],n=!1,a=null},isRunning:function(){return n},getMaxDuration:function(){return maxDuration}}}(),X={VISIBLE_BUFFER:2,ENTRY_HEIGHT:48,MIN_PLAYERS_FOR_LAZY:10,ROOT_MARGIN:"96px 0px",DEFAULT_VIEWPORT_HEIGHT:280},b={observer:null,fullData:[],visibleRange:{start:0,end:10},listEl:null,isLazyEnabled:!1};function Ot(e){e&&(b.observer&&b.listEl!==e&&(b.observer.disconnect(),b.observer=null),!b.observer&&(b.listEl=e,b.observer=new IntersectionObserver(function(n){n.forEach(function(a){if(!(!a.isIntersecting||!b.isLazyEnabled)){var i=b.fullData,r=b.visibleRange,s=X.VISIBLE_BUFFER;if(a.target.classList.contains("leaderboard-sentinel--top")){if(r.start>0){var o=Math.max(0,r.start-s);b.visibleRange.start=o,fe()}}else if(a.target.classList.contains("leaderboard-sentinel--bottom")&&r.end<i.length){var d=Math.min(i.length,r.end+s);b.visibleRange.end=d,fe()}}})},{root:e,rootMargin:X.ROOT_MARGIN,threshold:0})))}function fe(){var e=b.listEl,n=b.fullData,a=b.visibleRange;if(!(!e||!n.length)){var i=X.ENTRY_HEIGHT,r=a.start*i,s=(n.length-a.end)*i,o=e.scrollTop,d="";r>0&&(d+='<div class="leaderboard-spacer-top" style="height: '+r+'px;"></div>'),d+='<div class="leaderboard-sentinel leaderboard-sentinel--top" style="height: 1px;"></div>';for(var u=a.start;u<a.end&&u<n.length;u++)d+=Xe(n[u]);if(d+='<div class="leaderboard-sentinel leaderboard-sentinel--bottom" style="height: 1px;"></div>',s>0&&(d+='<div class="leaderboard-spacer-bottom" style="height: '+s+'px;"></div>'),e.innerHTML=d,e.scrollTop=o,b.observer){var f=e.querySelectorAll(".leaderboard-sentinel");f.forEach(function(m){b.observer.observe(m)})}}}function Xe(e){if(!e)return"";if(e.separator)return'<div class="leaderboard-separator">...</div>';var n=e.name||"Unknown",a=e.rank||0,i=e.score||0,r=a<=3?"is-top-"+a:"",s=e.is_current?"is-current":"",o="";e.rank_change>0||e._rankChange==="up"?o="leaderboard-entry--climbing leaderboard-entry--slide-up":(e.rank_change<0||e._rankChange==="down")&&(o="leaderboard-entry--falling leaderboard-entry--slide-down");var d="";e.rank_change>0?d='<span class="rank-up">\u25B2'+e.rank_change+"</span>":e.rank_change<0&&(d='<span class="rank-down">\u25BC'+Math.abs(e.rank_change)+"</span>");var u="";if(e.streak>=2){var f=e.streak>=5?"streak-indicator--hot":"";u='<span class="streak-indicator '+f+'">\u{1F525}'+e.streak+"</span>"}var m=e.connected===!1?"leaderboard-entry--disconnected":"",l=e.connected===!1?'<span class="away-badge">(away)</span>':"",v=e._displayScore!==void 0?e._displayScore:i;return'<div class="leaderboard-entry '+r+" "+s+" "+o+" "+m+'" data-rank="'+a+'" data-name="'+k(n)+'"><span class="entry-rank">#'+a+'</span><span class="entry-name">'+k(n)+l+'</span><span class="entry-meta">'+u+d+'</span><span class="entry-score" data-prev-score="'+(e._prevScore||i)+'">'+v+"</span></div>"}function Ze(e,n){for(var a=X,i=b.listEl&&b.listEl.clientHeight||a.DEFAULT_VIEWPORT_HEIGHT,r=Math.ceil(i/a.ENTRY_HEIGHT),s=a.VISIBLE_BUFFER,o=-1,d=0;d<e.length;d++)if(e[d].name===n){o=d;break}var u,f;return o===-1||o<r?(u=0,f=Math.min(e.length,r+s*2)):o>=e.length-r?(u=Math.max(0,e.length-r-s),f=e.length):(u=Math.max(0,o-Math.floor(r/2)-s),f=Math.min(e.length,o+Math.ceil(r/2)+s)),{start:u,end:f}}function Ht(){b.observer&&(b.observer.disconnect(),b.observer=null),b.isLazyEnabled=!1,b.fullData=[]}function Dt(){var e;function n(){clearTimeout(e),e=setTimeout(function(){b.isLazyEnabled&&b.fullData.length>0&&(b.visibleRange=Ze(b.fullData,E),fe())},150)}window.addEventListener("resize",n),window.addEventListener("orientationchange",n)}function Pt(){var e=document.getElementById("qr-share-area");if(!(!e||e.tagName!=="DETAILS")){var n="beatify_qr_expanded",a=768,i=sessionStorage.getItem(n);i!==null?e.open=i==="true":e.open=window.innerWidth>=a,e.addEventListener("toggle",function(){sessionStorage.setItem(n,e.open.toString())})}}function Gt(){var e=document.querySelectorAll(".lobby-container--compact .section-header-collapsible");e.forEach(function(n){n.addEventListener("click",function(){var a=n.closest(".section-collapsible");if(a){var i=a.classList.contains("collapsed");a.classList.toggle("collapsed"),n.setAttribute("aria-expanded",i?"true":"false")}})})}var $e={ITEM_HEIGHT:60,OVERSCAN:3,THRESHOLD:15,CONTAINER_HEIGHT:320},y={container:null,items:[],scrollTop:0,isVirtual:!1,topSpacer:null,bottomSpacer:null,contentWrapper:null,scrollHandler:null,resizeHandler:null};function Ft(e){if(e){y.container=e;var n=!1;y.scrollHandler=function(){y.scrollTop=e.scrollTop,n||(requestAnimationFrame(function(){Ne(),n=!1}),n=!0)};var a;y.resizeHandler=function(){clearTimeout(a),a=setTimeout(function(){y.isVirtual&&Ne()},100)},e.addEventListener("scroll",y.scrollHandler,{passive:!0}),window.addEventListener("resize",y.resizeHandler)}}function Vt(e,n){y.items=e,y.renderItem=n;var a=y.container;if(a){var i=a.scrollTop,r=y.isVirtual;e.length<$e.THRESHOLD?(y.isVirtual=!1,a.classList.remove("player-list--virtual"),qt(e,n)):(y.isVirtual=!0,a.classList.add("player-list--virtual"),Wt(),Ne()),r!==y.isVirtual&&i>0&&(a.scrollTop=i,y.scrollTop=i)}}function Wt(){var e=y.container;if(e){e.innerHTML="";var n=document.createElement("div");n.className="virtual-spacer-top",y.topSpacer=n;var a=document.createElement("div");a.className="virtual-content-wrapper",y.contentWrapper=a;var i=document.createElement("div");i.className="virtual-spacer-bottom",y.bottomSpacer=i,e.appendChild(n),e.appendChild(a),e.appendChild(i)}}function Ne(){var e=$e,n=y.items,a=y.container,i=y.contentWrapper;if(!(!a||!i||!n.length)){var r=a.clientHeight||e.CONTAINER_HEIGHT,s=y.scrollTop,o=e.ITEM_HEIGHT,d=e.OVERSCAN,u=Math.max(0,Math.floor(s/o)-d),f=Math.min(n.length,Math.ceil((s+r)/o)+d);y.topSpacer&&(y.topSpacer.style.height=u*o+"px"),y.bottomSpacer&&(y.bottomSpacer.style.height=(n.length-f)*o+"px");for(var m="",l=u;l<f;l++)m+=y.renderItem(n[l],l);i.innerHTML=m}}function qt(e,n){var a=y.container;if(a){for(var i="",r=0;r<e.length;r++)i+=n(e[r],r);a.innerHTML=i}}function jt(){var e=y.container;e&&y.scrollHandler&&e.removeEventListener("scroll",y.scrollHandler),y.resizeHandler&&window.removeEventListener("resize",y.resizeHandler),y.container=null,y.items=[],y.isVirtual=!1,y.topSpacer=null,y.bottomSpacer=null,y.contentWrapper=null}function Ut(e,n){for(var a=0;a<Ke.length;a++){var i=Ke[a];if(e<i&&n>=i)return i}return null}function zt(e){var n=e.map(function(i){return i.name}),a={};return n.forEach(function(i,r){var s=T.leaderboard.indexOf(i);s===-1?a[i]="new":r<s?a[i]="up":r>s&&(a[i]="down")}),a}function Yt(e,n){T.players={},e.forEach(function(a){T.players[a.name]={score:a.score,rank:a.rank||0,streak:a.streak||0}}),n&&(T.leaderboard=n.map(function(a){return a.name})),T.initialized=!0}function xa(){T.players={},T.leaderboard=[],T.initialized=!1}function Jt(e){return!e||typeof e!="string"?!1:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e)||/^[a-f0-9]{32}$/i.test(e)}function et(){var e=Je();if(!e||!Jt(e)){e&&Q(),L("join-view");return}var n=window.location.protocol==="https:"?"wss:":"ws:",a=n+"//"+window.location.host+"/beatify/ws";g=new WebSocket(a),g.onopen=function(){x=0,P=!1,ie(),g.send(JSON.stringify({type:"reconnect",session_id:e}))},g.onmessage=function(i){try{var r=JSON.parse(i.data);Et(r)}catch(s){console.error("Failed to parse WebSocket message:",s)}},g.onclose=function(){if(E&&x<te){P=!0,x++,bt(),ht(x);var i=pt();console.log("WebSocket closed. Reconnecting in "+i+"ms... (attempt "+x+")"),setTimeout(function(){et()},i)}else x>=te?(P=!1,ie(),Ue()):L("join-view")},g.onerror=function(i){console.error("WebSocket error:",i)}}function Qt(e){var n=document.getElementById("volume-indicator");n&&(n.textContent="Welcome back, "+e+"!",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},2e3))}function Kt(){var e=document.getElementById("volume-indicator");e&&(e.textContent=c.t("earlyReveal.message")||"All guesses in!",e.classList.remove("hidden"),e.classList.add("is-visible"),setTimeout(function(){e.classList.remove("is-visible"),setTimeout(function(){e.classList.add("hidden")},300)},1500))}const Xt=20;let tt=[];function k(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function nt(e){const n=document.getElementById("player-list"),a=document.getElementById("player-count"),i=document.getElementById("player-count-badge"),r=document.getElementById("players-summary"),s=document.getElementById("players-empty");if(!n)return;(!e||!Array.isArray(e))&&(e=[]);const o=e.length;a&&(a.textContent=o===1?c.t("lobby.playerJoined"):t("lobby.playersJoined",{count:o})),i&&(i.textContent=o),r&&(r.textContent=o),s&&s.classList.toggle("hidden",o>0);var d=e.slice().sort(function(l,v){return l.connected!==v.connected?l.connected?-1:1:0});const u=tt.map(function(l){return l.name}),f=d.filter(function(l){return u.indexOf(l.name)===-1}).map(function(l){return l.name});y.container||Ft(n);var m=function(l){var v=f.indexOf(l.name)!==-1,p=l.name===E,w=l.connected===!1,h=["player-card",v?"is-new":"",p?"player-card--you":"",w?"player-card--disconnected":""].filter(Boolean).join(" "),I=w?'<span class="away-badge">(away)</span>':"";return'<div class="'+h+'" data-player="'+k(l.name)+'"><span class="player-name">'+k(l.name)+(p?'<span class="you-badge">'+c.t("leaderboard.you")+"</span>":"")+I+"</span></div>"};Vt(d,m),setTimeout(function(){var l=y.isVirtual?y.contentWrapper:n;if(!l)return;const v=l.querySelectorAll(".is-new");for(let p=0;p<v.length;p++)v[p].classList.remove("is-new")},2e3),tt=e.slice()}function Re(e){var n={easy:"game.difficultyEasy",normal:"game.difficultyNormal",hard:"game.difficultyHard"}[e]||"game.difficultyNormal",a=t(n),i=document.getElementById("lobby-difficulty-badge"),r=document.getElementById("game-difficulty-badge");i&&(i.textContent=a,i.className="difficulty-badge difficulty-badge--"+(e||"normal")),r&&(r.textContent=a,r.className="difficulty-badge difficulty-badge--"+(e||"normal"))}let R=null;function Zt(e){if(e){R=e;var n=document.getElementById("player-qr-code");n&&(n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',n.onclick=at,n.onkeydown=function(a){(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),at())})}}function at(){if(R){var e=document.getElementById("qr-modal"),n=document.getElementById("qr-modal-code");if(!(!e||!n)){n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:R,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',e.classList.remove("hidden"),document.body.style.overflow="hidden";var a=document.getElementById("qr-modal-close");a&&a.focus()}}}function Oe(){var e=document.getElementById("qr-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="")}function $t(){var e=document.getElementById("qr-modal"),n=e?e.querySelector(".qr-modal-backdrop"):null,a=document.getElementById("qr-modal-close");n&&n.addEventListener("click",Oe),a&&a.addEventListener("click",Oe),document.addEventListener("keydown",function(i){i.key==="Escape"&&e&&!e.classList.contains("hidden")&&Oe()})}function en(){if(R){var e=document.getElementById("invite-modal"),n=document.getElementById("invite-modal-code"),a=document.getElementById("invite-modal-url");if(!(!e||!n)){n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:R,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML='<p class="status-error">QR code library not loaded</p>',a&&(a.value=R),e.classList.remove("hidden"),document.body.style.overflow="hidden";var i=document.getElementById("invite-modal-close");i&&i.focus()}}}function me(){var e=document.getElementById("invite-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="");var n=document.getElementById("invite-copy-feedback");n&&n.classList.add("hidden")}function tn(){var e=document.getElementById("invite-modal-url"),n=document.getElementById("invite-copy-feedback");!e||!R||(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(R).then(function(){rt(n)}).catch(function(){it(e,n)}):it(e,n))}function it(e,n){e.select(),e.setSelectionRange(0,99999);try{document.execCommand("copy"),rt(n)}catch(a){console.warn("[Beatify] Copy failed:",a)}}function rt(e){e&&(e.classList.remove("hidden"),setTimeout(function(){e.classList.add("hidden")},2e3))}function nn(){var e=document.getElementById("invite-modal"),n=e?e.querySelector(".invite-modal-backdrop"):null,a=document.getElementById("invite-modal-close"),i=document.getElementById("invite-players-btn"),r=document.getElementById("invite-copy-btn");n&&n.addEventListener("click",me),a&&a.addEventListener("click",me),i&&i.addEventListener("click",en),r&&r.addEventListener("click",tn),document.addEventListener("keydown",function(s){s.key==="Escape"&&e&&!e.classList.contains("hidden")&&me()})}let ve=null;function an(e){j();var n=document.getElementById("timer");if(!n)return;n.classList.remove("timer--warning","timer--critical");function a(){var i=Date.now(),r=Math.max(0,Math.ceil((e-i)/1e3));n.textContent=r,r<=5?(n.classList.remove("timer--warning"),n.classList.add("timer--critical")):r<=10?(n.classList.remove("timer--critical"),n.classList.add("timer--warning")):n.classList.remove("timer--warning","timer--critical"),r===10?n.setAttribute("aria-label","10 seconds remaining"):r===5?n.setAttribute("aria-label","5 seconds!"):r===0?n.setAttribute("aria-label","Time is up!"):n.setAttribute("aria-label","Time remaining: "+r+" seconds"),r<=0&&j()}a(),ve=setInterval(a,1e3)}function j(){ve&&(clearInterval(ve),ve=null)}function rn(e){var n=document.getElementById("current-round"),a=document.getElementById("total-rounds"),i=document.getElementById("last-round-banner");n&&(n.textContent=e.round||1),a&&(a.textContent=e.total_rounds||10),i&&(e.last_round?i.classList.remove("hidden"):i.classList.add("hidden"));var r=document.getElementById("album-cover"),s=document.getElementById("album-loading");if(r&&e.song){s&&s.classList.remove("hidden");var o=e.song.album_art||"/beatify/static/img/no-artwork.svg";r.onload=function(){s&&s.classList.add("hidden")},r.onerror=function(){r.src="/beatify/static/img/no-artwork.svg",s&&s.classList.add("hidden")},r.src=o}ln(e.players),e.leaderboard&&st(e,"leaderboard-list"),_n(e.players),e.artist_challenge!==void 0&&Ln(e.artist_challenge,"PLAYING")}function sn(e){if(e){var n=document.getElementById("album-cover"),a=document.getElementById("album-loading");if(n&&e.album_art){var i=e.album_art;if(n.src===i)return;n.style.transition="opacity 0.3s ease-in-out",n.style.opacity="0.5";var r=new Image;r.onload=function(){n.src=i,n.style.opacity="1",a&&a.classList.add("hidden")},r.onerror=function(){n.src="/beatify/static/img/no-artwork.svg",n.style.opacity="1",a&&a.classList.add("hidden")},r.src=i}console.log("[Metadata] Updated:",e.artist,"-",e.title)}}function on(e){if(!e)return"?";var n=e.trim();if(!n)return"?";var a=n.split(/[\s-]+/).filter(Boolean);return a.length>=2?(a[0][0]+a[1][0]).toUpperCase():n.slice(0,Math.min(2,n.length)).toUpperCase()}function ln(e){var n=document.getElementById("submission-tracker"),a=document.getElementById("submitted-players");if(!(!n||!a)){var i=e||[],r=i.filter(function(d){return d.submitted}).length,s=i.length,o=r===s&&s>0;n.classList.toggle("all-submitted",o),a.innerHTML=i.map(function(d){var u=on(d.name),f=d.name===E,m=d.connected===!1,l=["player-indicator",d.submitted?"is-submitted":"",f?"is-current-player":"",m?"player-indicator--disconnected":""].filter(Boolean).join(" "),v="";return d.steal_used&&(v+='<span class="player-badge player-badge--steal">\u{1F977}</span>'),d.bet&&(v+='<span class="player-badge player-badge--bet">\u{1F3B2}</span>'),'<div class="'+l+'">'+v+'<div class="player-avatar"><span class="player-initials">'+k(u)+'</span></div><span class="player-name">'+k(d.name)+"</span></div>"}).join("")}}function st(e,n,a){var i=e.leaderboard||[],r=document.getElementById(n||"leaderboard-list");if(r){var s=a&&Rt(),o=s?zt(i):{};i.forEach(function(l){l.is_current=l.name===E;var v=o[l.name];v&&(l._rankChange=v);var p=T.players[l.name],w=p?p.score:l.score;l._prevScore=w,l._displayScore=a?w:l.score});var d=cn(i,E),u=i.length>=X.MIN_PLAYERS_FOR_LAZY;if(u)b.observer||Ot(r),b.fullData=d,b.isLazyEnabled=!0,b.listEl=r,b.visibleRange=Ze(d,E),fe();else{b.isLazyEnabled=!1;var f="";d.forEach(function(l){f+=Xe(l)}),r.innerHTML=f}var m=[];s&&d.forEach(function(l){!l.separator&&l._prevScore!==l.score&&m.push({name:l.name,prevScore:l._prevScore,newScore:l.score})}),s&&m.length>0&&requestAnimationFrame(function(){for(var l={},v=r.querySelectorAll(".leaderboard-entry[data-name]"),p=0;p<v.length;p++){var w=v[p],h=w.getAttribute("data-name");h&&(l[h]=w)}m.forEach(function(I){var B=l[I.name];if(B){var S=B.querySelector(".entry-score");S&&Ae(S,I.prevScore,I.newScore,500)}})}),i.length>8&&dn(r),un(i),mn(i),Yt(e.players||[],i)}}function cn(e,n){if(e.length<=10)return e;for(var a=e.slice(0,5),i=e.slice(-3),r=-1,s=0;s<e.length;s++)if(e[s].name===n){r=s;break}return r<5||r>=e.length-3?[].concat(a,[{separator:!0}],i):[].concat(a,[{separator:!0}],[e[r]],[{separator:!0}],i)}function dn(e){var n=e.querySelector(".leaderboard-entry.is-current");n&&n.scrollIntoView({behavior:"smooth",block:"center"})}function un(e){var n=document.getElementById("leaderboard-you"),a=e.find(function(i){return i.is_current});n&&a&&(n.textContent=c.t("leaderboard.you")+" #"+a.rank,n.classList.remove("hidden"))}function fn(){var e=document.getElementById("leaderboard-toggle"),n=document.getElementById("game-leaderboard");e&&n&&!e.hasAttribute("data-initialized")&&(e.setAttribute("data-initialized","true"),e.addEventListener("click",function(){var a=n.classList.toggle("collapsed");e.setAttribute("aria-expanded",!a)}))}function mn(e,n){var a=n?[n]:["leaderboard-summary","reveal-leaderboard-summary"];a.forEach(function(i){var r=document.getElementById(i);if(!(!r||!e||e.length===0)){var s=e[0];s&&(r.textContent=s.name+": "+s.score)}})}function vn(){var e=document.getElementById("reveal-leaderboard-toggle"),n=document.getElementById("reveal-leaderboard");e&&n&&!e.hasAttribute("data-initialized")&&(e.setAttribute("data-initialized","true"),e.addEventListener("click",function(){var a=n.classList.toggle("collapsed");e.setAttribute("aria-expanded",!a)}))}function gn(){var e=document.getElementById("round-analytics-toggle"),n=document.getElementById("round-analytics");e&&n&&!e.hasAttribute("data-initialized")&&(e.setAttribute("data-initialized","true"),e.addEventListener("click",function(){var a=n.classList.toggle("collapsed");e.setAttribute("aria-expanded",!a)}))}let O=!1,Z=!1,ge=0,$=!1;var D=!1,H=null,pe=null,pn=300,ot=0;function yn(){var e=document.getElementById("year-slider"),n=document.getElementById("selected-year");if(!(!e||!n)){e.addEventListener("input",function(){n.textContent=this.value});var a=document.getElementById("bet-toggle");a&&a.addEventListener("click",function(){O||(Z=!Z,a.classList.toggle("is-active",Z))});var i=document.getElementById("submit-btn");i&&i.addEventListener("click",bn);var r=document.getElementById("steal-btn");r&&r.addEventListener("click",Cn);var s=document.getElementById("steal-modal-close");s&&s.addEventListener("click",Fe);var o=document.getElementById("steal-modal");if(o){var d=o.querySelector(".steal-modal-backdrop");d&&d.addEventListener("click",Fe)}}}function bn(){if(!O){var e=document.getElementById("year-slider"),n=document.getElementById("submit-btn");if(!(!e||!n)){var a=parseInt(e.value,10);n.disabled=!0,n.classList.add("is-loading"),g&&g.readyState===WebSocket.OPEN?g.send(JSON.stringify({type:"submit",year:a,bet:Z})):(He("Connection lost. Please refresh."),n.disabled=!1,n.classList.remove("is-loading"))}}}function lt(){O=!0;var e=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation"),i=document.getElementById("bet-toggle");e&&e.classList.add("is-submitted"),n&&n.classList.add("hidden"),i&&i.classList.add("hidden"),a&&a.classList.remove("hidden")}function hn(e){var n=document.getElementById("submit-btn");n&&(n.disabled=!1,n.classList.remove("is-loading")),e.code==="ROUND_EXPIRED"?(He("Time's up!"),O=!0,n&&(n.disabled=!0)):e.code==="ALREADY_SUBMITTED"?lt():He(e.message||"Submission failed")}function He(e){var n=document.getElementById("submit-btn");n&&(n.textContent=e,n.classList.add("is-error"),setTimeout(function(){n.textContent=c.t("game.submitGuess"),n.classList.remove("is-error")},2e3))}function En(){O=!1,Z=!1;var e=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation"),i=document.getElementById("year-slider"),r=document.getElementById("bet-toggle");if(e&&e.classList.remove("is-submitted"),n&&(n.disabled=!1,n.classList.remove("hidden","is-loading","is-error"),n.textContent=c.t("game.submitGuess")),r&&r.classList.remove("hidden","is-active"),a&&a.classList.add("hidden"),i){i.value=1990;var s=document.getElementById("selected-year");s&&(s.textContent="1990")}$=!1,Ge(),Bn()}function Ln(e,n){var a=document.getElementById("artist-challenge-container");if(a){if(!e||!e.options){a.classList.add("hidden");return}a.classList.remove("hidden");var i=document.getElementById("artist-options"),r=document.getElementById("artist-result"),s=Array.from(i.querySelectorAll(".artist-option-btn")).map(function(m){return m.dataset.artist}),o=e.options;if(JSON.stringify(s)!==JSON.stringify(o)&&(i.innerHTML="",o.forEach(function(m,l){var v=document.createElement("button");v.className="artist-option-btn",v.dataset.artist=m,v.dataset.index=l,v.textContent=m,v.addEventListener("click",function(){wn(m)}),i.appendChild(v)})),e.winner){var d=i.querySelectorAll(".artist-option-btn");if(d.forEach(function(m){m.classList.add("is-disabled"),m.classList.remove("is-loading","is-wrong");var l=e.correct_artist||pe;l&&m.dataset.artist===l&&m.classList.add("is-winner")}),e.winner===E){var u=e.bonus_points||5;r.textContent=(c.t("artistChallenge.youGotIt")||"You got it! +{points} points").replace("{points}",u),r.className="artist-result is-winner"}else{var f=(c.t("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",e.winner);r.textContent=f,r.className="artist-result is-late"}r.classList.remove("hidden"),D=!0}else D||r.classList.add("hidden")}}function wn(e){var n=Date.now();if(!(n-ot<pn)&&(ot=n,!D)){var a=document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(e)+'"]');a&&a.classList.add("is-loading"),H=e;try{g&&g.readyState===WebSocket.OPEN&&g.send(JSON.stringify({type:"artist_guess",artist:e}))}catch(i){console.error("Artist guess send failed:",i),a&&a.classList.remove("is-loading"),H=null}}}function In(e){var n=H?document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(H)+'"]'):null;if(e.correct&&e.first){if(pe=H,n){n.classList.remove("is-loading"),n.classList.add("is-correct");var a=document.createElement("span");a.className="artist-points-badge",a.textContent="+"+(e.bonus_points||5),n.appendChild(a)}De();var i=(c.t("artistChallenge.youGotIt")||"You got it! +{points} points").replace("{points}",e.bonus_points||5);Pe(i,!0),D=!0}else if(e.correct&&!e.first){pe=H,n&&(n.classList.remove("is-loading"),n.classList.add("is-correct")),De();var r=(c.t("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",e.winner||"Someone");Pe(r,!1),D=!0}else n&&(n.classList.remove("is-loading"),n.classList.add("is-wrong","is-selected")),De(),Pe(c.t("artistChallenge.wrongGuess")||"Wrong guess!",!1),D=!0;H=null}function De(){document.querySelectorAll(".artist-option-btn").forEach(function(e){e.classList.add("is-disabled"),e.classList.remove("is-loading")})}function Pe(e,n){var a=document.getElementById("artist-result");a&&(a.textContent=e,a.className="artist-result "+(n?"is-winner":"is-late"),a.classList.remove("hidden"))}function Bn(){D=!1,H=null,pe=null;var e=document.getElementById("artist-challenge-container");e&&e.classList.add("hidden");var n=document.getElementById("artist-options");n&&(n.innerHTML="");var a=document.getElementById("artist-result");a&&(a.classList.add("hidden"),a.className="artist-result hidden")}function Sn(e,n){var a=document.getElementById("artist-reveal-section");if(a){if(!e||!e.correct_artist){a.classList.add("hidden");return}a.classList.remove("hidden");var i=document.getElementById("artist-reveal-name");i&&(i.textContent=e.correct_artist);var r=document.getElementById("artist-reveal-winner");if(r)if(e.winner)if(r.classList.remove("hidden"),e.winner===n){var s=e.bonus_points||5;r.textContent=(c.t("artistChallenge.youGotIt")||"You got it! +{points} points").replace("{points}",s),r.className="artist-reveal-winner is-you"}else{var o=(c.t("artistChallenge.winnerWas")||"{winner} got it first!").replace("{winner}",e.winner);r.textContent=o,r.className="artist-reveal-winner is-other"}else r.textContent=c.t("artistChallenge.noWinner")||"No one guessed the artist",r.className="artist-reveal-winner artist-reveal-no-winner",r.classList.remove("hidden")}}function _n(e){if(!(!E||!e)){var n=e.find(function(r){return r.name===E});if(n){$=n.steal_available&&!O;var a=document.getElementById("steal-indicator"),i=document.getElementById("steal-btn");$?(a&&a.classList.remove("hidden"),i&&i.classList.remove("hidden")):Ge()}}}function Ge(){var e=document.getElementById("steal-indicator"),n=document.getElementById("steal-btn");e&&e.classList.add("hidden"),n&&n.classList.add("hidden")}function Cn(){!$||O||g&&g.readyState===WebSocket.OPEN&&g.send(JSON.stringify({type:"get_steal_targets"}))}function kn(e){var n=document.getElementById("steal-modal"),a=document.getElementById("steal-target-list");if(!(!n||!a)){if(a.innerHTML="",!e||e.length===0){var i=document.createElement("p");i.className="steal-no-targets",i.textContent=c.t("steal.waitForSubmit"),a.appendChild(i)}else e.forEach(function(r){var s=document.createElement("button");s.className="steal-target-btn",s.textContent=r,s.addEventListener("click",function(){xn(r)}),a.appendChild(s)});n.classList.remove("hidden")}}function Fe(){var e=document.getElementById("steal-modal");e&&e.classList.add("hidden")}function xn(e){return q(this,null,function*(){var n=c.t("steal.confirm").replace("{name}",e),a=yield le(c.t("steal.confirmTitle")||"Steal Answer?",n,c.t("steal.confirmButton")||"Steal",c.t("common.cancel"));a&&(g&&g.readyState===WebSocket.OPEN&&g.send(JSON.stringify({type:"steal",target:e})),Fe())})}function Tn(e){if(e.success){$=!1,O=!0,Ge();var n=document.getElementById("year-selector"),a=document.getElementById("submit-btn"),i=document.getElementById("submitted-confirmation");n&&n.classList.add("is-submitted"),a&&a.classList.add("hidden"),i&&i.classList.remove("hidden"),Mn(e.target,e.year);var r=document.getElementById("selected-year"),s=document.getElementById("year-slider");r&&(r.textContent=e.year),s&&(s.value=e.year)}}function An(e){kn(e.targets||[])}function Mn(e,n){var a=document.getElementById("steal-confirmation"),i=document.getElementById("steal-confirmation-text");if(!(!a||!i)){var r=c.t("steal.success").replace("{name}",e).replace("{year}",n);i.textContent=r,a.classList.remove("hidden"),setTimeout(function(){a.classList.add("hidden")},3e3)}}function ct(e){var n=e.song||{},a=e.players||[],i=document.getElementById("reveal-round"),r=document.getElementById("reveal-total");i&&(i.textContent=e.round||1),r&&(r.textContent=e.total_rounds||10);var s=document.getElementById("reveal-album-cover");s&&(s.src=n.album_art||"/beatify/static/img/no-artwork.svg");var o=document.getElementById("correct-year");o&&(o.textContent=n.year||"????");var d=document.getElementById("song-title"),u=document.getElementById("song-artist");d&&(d.textContent=n.title||"Unknown Song"),u&&(u.textContent=n.artist||"Unknown Artist");var f=document.getElementById("fun-fact-container"),m=document.getElementById("fun-fact"),l=f?f.querySelector(".fun-fact-header"):null,v=c.getLocalizedSongField(n,"fun_fact");if(m&&(m.textContent=v||""),l&&(l.style.display=v?"flex":"none"),Dn(n),Hn(e.song_difficulty),f){var p=document.getElementById("song-rich-info"),w=p&&p.innerHTML.trim()!=="",h=v&&v.trim()!=="";f.classList.toggle("hidden",!h&&!w)}for(var I=null,B=0;B<a.length;B++)if(a[B].name===E){I=a[B];break}Un(I,n.year),zn(I,n.year),e.artist_challenge&&Sn(e.artist_challenge,E),e.game_performance&&e.game_performance.is_new_record&&we("record"),Yn(a),e.round_analytics&&Nn(e.round_analytics,n.year),e.leaderboard&&st(e,"reveal-leaderboard-list",!0);var S=document.getElementById("reveal-admin-controls"),_=document.getElementById("next-round-btn");S&&I&&I.is_admin?(S.classList.remove("hidden"),_&&(e.last_round?(_.textContent=c.t("leaderboard.finalResults"),_.classList.add("is-final")):(_.textContent=c.t("admin.nextRound"),_.classList.remove("is-final")),_.disabled=!1)):S&&S.classList.add("hidden")}function Nn(e,n){var a=document.getElementById("round-analytics"),i=document.getElementById("round-analytics-content");if(!a||!i||!e){a&&a.classList.add("hidden");return}if(e.total_submitted===0){i.innerHTML='<div class="analytics-empty">'+c.t("analytics.noSubmissions")+"</div>",a.classList.remove("hidden");return}var r="";if(e.average_guess!==null&&n){var s=Math.round(e.average_guess-n);s===0?r=c.t("analytics.onTarget"):s>0?r=c.t("analytics.yearsLate",{years:s}):r=c.t("analytics.yearsEarly",{years:Math.abs(s)})}var o=Rn(e.all_guesses,n),d="";if(e.exact_match_players&&e.exact_match_players.length>0&&(d+='<div class="achievement-item"><span class="achievement-emoji">&#127919;</span><span class="achievement-label">'+c.t("analytics.exactMatches")+':</span><span class="achievement-names">'+e.exact_match_players.join(", ")+"</span></div>"),e.speed_champion&&e.speed_champion.names){var u=e.speed_champion.names.join(", ");d+='<div class="achievement-item"><span class="achievement-emoji">&#9889;</span><span class="achievement-label">'+c.t("analytics.speedChampion")+':</span><span class="achievement-names">'+u+'</span><span class="achievement-value">('+e.speed_champion.time+"s)</span></div>"}if(e.furthest_players&&e.furthest_players.length>0&&e.all_guesses&&e.all_guesses.length>0){var f=e.all_guesses[e.all_guesses.length-1].years_off;f>0&&(d+='<div class="achievement-item"><span class="achievement-emoji">&#128517;</span><span class="achievement-label">'+c.t("analytics.furthestGuess")+':</span><span class="achievement-names">'+e.furthest_players.join(", ")+'</span><span class="achievement-value">('+f+" years)</span></div>")}var m=e.average_guess!==null?Math.round(e.average_guess):"?";i.innerHTML='<div class="analytics-stats-row"><div class="stat-primary"><span class="stat-label">'+c.t("analytics.averageGuess")+'</span><span class="stat-value">'+m+'</span></div><div class="stat-secondary"><span class="stat-value">'+e.accuracy_percentage+'%</span><span class="stat-label">'+c.t("analytics.accuracy",{percent:""}).replace("%","")+'</span></div></div><div class="stat-comparison-line">'+r+'</div><div class="analytics-histogram"><h4 class="histogram-title">'+c.t("analytics.histogram")+"</h4>"+o+"</div>"+(d?'<div class="analytics-achievements">'+d+"</div>":""),a.classList.remove("hidden")}function Rn(e,n){var a=7;if(!e||e.length===0)return'<div class="histogram-empty">'+c.t("analytics.noGuesses")+"</div>";for(var i=e.map(function(ka){return ka.guess}),r=Math.min.apply(null,i),s=Math.max.apply(null,i),o=s-r,d=Math.max(1,Math.ceil(o/a)),u=d*a,f=u-o-1,m=r-Math.floor(f/2),l=[],v=0;v<a;v++){var p=m+v*d,w=p+d-1;l.push({start:p,end:w,count:0,containsCorrect:n>=p&&n<=w})}for(var h=0;h<i.length;h++)for(var I=i[h],B=0;B<l.length;B++)if(I>=l[B].start&&I<=l[B].end){l[B].count++;break}for(var S=1,_=0;_<l.length;_++)l[_].count>S&&(S=l[_].count);for(var V="",se=0;se<l.length;se++){var M=l[se],z=M.count/S*100,Be=se*.05,Se="histogram-bar"+(M.containsCorrect?" is-correct":""),W=M.count>0?Math.max(z,10):0,_e=M.count>0?'<span class="bar-count">'+M.count+"</span>":"",Ca=d===1?String(M.start):M.start+"-"+String(M.end).slice(-2);V+='<div class="histogram-bar-wrapper" style="animation-delay: '+Be+'s"><div class="'+Se+'" style="height: '+W+'%">'+_e+'</div><span class="histogram-label">'+Ca+"</span></div>"}return'<div class="histogram-bars">'+V+"</div>"}function On(e){var n=document.getElementById("superlatives-container");if(n){if(!e||e.length===0){n.classList.add("hidden");return}var a="";e.forEach(function(i,r){var s="";switch(i.value_label){case"avg_time":s=i.value+"s "+c.t("superlatives.avgTime");break;case"streak":s=i.value+" "+c.t("superlatives.streak");break;case"bets":s=i.value+" "+c.t("superlatives.bets");break;case"points":s=i.value+" "+c.t("superlatives.points");break;case"close_guesses":s=i.value+" "+c.t("superlatives.closeGuesses");break;default:s=i.value}a+='<div class="superlative-card superlative-card--'+i.id+'" style="animation-delay: '+r*.2+'s"><div class="superlative-emoji">'+i.emoji+'</div><div class="superlative-title">'+c.t("superlatives."+i.title)+'</div><div class="superlative-player">'+k(i.player_name)+'</div><div class="superlative-value">'+s+"</div></div>"}),n.innerHTML=a,n.classList.remove("hidden")}}function Hn(e){var n=document.getElementById("song-difficulty");if(n){if(!e){n.classList.add("hidden");return}for(var a="",i=0;i<e.stars;i++)a+='<span class="star">&#9733;</span>';n.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+a+'</div><span class="difficulty-label">'+c.t("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+c.t("difficulty.accuracy")+"</span>",n.classList.remove("hidden")}}function Dn(e){var n=document.getElementById("song-rich-info");if(n){var a=[],i=Pn(e.chart_info||{});i.length>0&&(a=a.concat(i));var r=Gn(e.certifications||[]);r.length>0&&(a=a.concat(r));var s=c.getLocalizedSongField(e,"awards")||[],o=Wn(s);o.length>0&&(a=a.concat(o)),a.length>0?n.innerHTML='<div class="song-badges-row">'+a.join("")+"</div>":n.innerHTML=""}}function Pn(e){if(!e)return[];var n=[];if(e.billboard_peak&&e.billboard_peak>0){var a=e.weeks_on_chart?' <span class="chart-weeks">\xB7 '+e.weeks_on_chart+" "+c.t("reveal.weeksShort")+"</span>":"";n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.billboard_peak+" "+c.t("reveal.chartBillboard")+a+"</span>")}return e.german_peak&&e.german_peak>0&&!e.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.german_peak+" "+c.t("reveal.chartGerman")+"</span>"),e.uk_peak&&e.uk_peak>0&&!e.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.uk_peak+" "+c.t("reveal.chartUK")+"</span>"),n}function Gn(e){if(!e||e.length===0)return[];for(var n=[],a=0;a<e.length;a++){var i=e[a],r=Fn(i),s=Vn(i);n.push('<span class="song-badge '+r+'"><span class="song-badge-icon">'+s+"</span>"+k(i)+"</span>")}return n}function Fn(e){var n=e.toLowerCase();return n.indexOf("diamond")!==-1?"song-badge--diamond":n.indexOf("platinum")!==-1?"song-badge--platinum":n.indexOf("gold")!==-1?"song-badge--gold":"song-badge--platinum"}function Vn(e){var n=e.toLowerCase();return n.indexOf("diamond")!==-1?"\u{1F48E}":n.indexOf("platinum")!==-1?"\u{1F4BF}":n.indexOf("gold")!==-1?"\u{1F947}":"\u{1F4BF}"}function Wn(e){if(!e||e.length===0)return[];for(var n=[],a=e.slice(0,3),i=0;i<a.length;i++){var r=a[i],s=qn(r),o=jn(r);n.push('<span class="song-badge '+s+'"><span class="song-badge-icon">'+o+"</span>"+k(r)+"</span>")}return e.length>3&&n.push('<span class="song-badges-more">+'+(e.length-3)+" more</span>"),n}function qn(e){var n=e.toLowerCase();return n.indexOf("grammy")!==-1?"song-badge--grammy":n.indexOf("eurovision")!==-1?"song-badge--eurovision":n.indexOf("oscar")!==-1||n.indexOf("academy award")!==-1?"song-badge--oscar":n.indexOf("hall of fame")!==-1?"song-badge--halloffame":"song-badge--award"}function jn(e){var n=e.toLowerCase();return n.indexOf("eurovision")!==-1?"\u{1F3A4}":n.indexOf("grammy")!==-1?"\u{1F3C6}":n.indexOf("hall of fame")!==-1?"\u2B50":"\u{1F3C6}"}function Un(e,n){var a=document.getElementById("reveal-emotion"),i=document.getElementById("personal-result");if(!a)return;var r=a.classList.contains("reveal-emotion-inline")||document.querySelector(".reveal-container--compact");a.className=r?"reveal-emotion-inline":"reveal-emotion",a.innerHTML="",a.classList.add("hidden"),i&&i.classList.remove("is-delayed"),Ie();var s=c.t("reveal.emotions");function o(p){return p[Math.floor(Math.random()*p.length)]}function d(p){return p===1?c.t("reveal.offByYear"):c.t("reveal.offByYears",{years:p})}var u="missed",f=o(s.missed),m=o(s.missedSub);if(e&&!e.missed_round){var l=e.years_off||0;l===0?(u="exact",f=o(s.exact),m=o(s.exactSub)):l<=2?(u="close",f=o(s.close),m=o(s.closeSub)+" "+d(l)):l<=5?(u="close",f=o(s.close),m=d(l)):(u="wrong",f=o(s.wrong),m=o(s.wrongSub)+" "+d(l))}else e&&e.missed_round&&(u="missed",f=o(s.missed),m=o(s.missedSub));var v='<span class="reveal-emotion-text">'+f+"</span>";m&&(v+='<div class="reveal-emotion-subtitle">'+m+"</div>"),a.innerHTML=v,a.classList.add("reveal-emotion--"+u),a.classList.remove("hidden"),u==="exact"&&we(),i&&u!=="missed"&&i.classList.add("is-delayed")}function zn(e,n){var a=document.getElementById("result-content");if(a){if(!e){a.innerHTML='<div class="result-missed">Player not found</div>';return}if(e.missed_round){var i='<div class="result-missed-container"><div class="result-missed-icon">\u23F0</div><div class="result-missed-text">'+c.t("reveal.noSubmission")+"</div></div>",r=e.previous_streak||0;r>=2&&(i+='<div class="streak-broken"><span class="streak-broken-icon">\u{1F494}</span><span class="streak-broken-text">Lost '+r+"-streak!</span></div>"),i+='<div class="result-score is-zero">0 pts</div>',a.innerHTML=i;return}var s=e.years_off||0,o=s===0?c.t("reveal.exact"):s===1?c.t("reveal.yearOff",{years:1}):t("reveal.yearsOff",{years:s}),d=s===0?"is-exact":s<=3?"is-close":"is-far",u=e.speed_multiplier||1,f=e.base_score||0,m=u>1,l=e.streak_bonus||0,v=e.artist_bonus||0,p="";m&&f>0&&(p='<div class="result-row"><span class="result-label">'+c.t("reveal.baseScore")+'</span><span class="result-value">'+f+' pts</span></div><div class="result-row"><span class="result-label">'+c.t("reveal.speedBonus")+'</span><span class="result-value is-bonus">'+u.toFixed(2)+"x</span></div>");var w="";e.bet_outcome==="won"?w='<div class="result-row bet-won-row"><span class="result-label">\u{1F3B2} '+c.t("reveal.betWon").replace("! 2x points","")+'</span><span class="result-value is-bet-won">2x</span></div>':e.bet_outcome==="lost"&&(w='<div class="result-row bet-lost-row"><span class="result-label">\u{1F3B2} '+c.t("reveal.betLost")+'</span><span class="result-value is-bet-lost">-</span></div>');var h="";l>0&&(h='<div class="result-row streak-bonus-row"><span class="result-label">'+e.streak+'-streak bonus!</span><span class="result-value is-streak">+'+l+" pts</span></div>");var I="";v>0&&(I='<div class="result-row artist-bonus-row"><span class="result-label">\u{1F3A4} '+(c.t("artistChallenge.artistBonus")||"Artist Bonus")+'</span><span class="result-value">+'+v+" pts</span></div>");var B=e.round_score+l+v,S=l>0||v>0,_=e.round_score>=20,V=T.players[e.name],se=V?V.score:e.score-B,M=V?V.streak:0,z=Ut(M,e.streak||0);a.innerHTML='<div class="result-row"><span class="result-label">'+c.t("reveal.yourGuess")+'</span><span class="result-value">'+(e.guess||"n/a")+'</span></div><div class="result-row"><span class="result-label">'+c.t("reveal.correctYear")+'</span><span class="result-value">'+n+'</span></div><div class="result-row"><span class="result-label">'+c.t("reveal.accuracy")+'</span><span class="result-value '+d+'">'+o+"</span></div>"+p+w+'<div class="result-score" id="personal-result-score">+<span class="score-value">0</span> pts</div>'+h+I+(S?'<div class="result-total">'+c.t("reveal.total")+': +<span class="total-value">0</span> pts</div>':"");var Be=a.querySelector(".score-value");Be&&(Nt(Be,0,e.round_score,{betWon:e.bet_outcome==="won",betLost:e.bet_outcome==="lost",streakMilestone:z,isBigScore:_}),e.bet_outcome==="won"&&e.round_score>0&&setTimeout(function(){var W=document.getElementById("personal-result-score");W&&Qe(W,e.round_score,{isBetWin:!0})},200));var Se=a.querySelector(".total-value");Se&&S&&(setTimeout(function(){Ae(Se,0,B,600)},300),z&&setTimeout(function(){var W=a.querySelector(".result-total");if(W){var _e={3:20,5:50,10:100}[z]||0;Qe(W,_e,{isStreak:!0,text:"+"+_e+" "+z+"-Streak!"})}},500))}}function Yn(e){var n=document.getElementById("reveal-results-cards");if(n){if(!e||e.length===0){n.innerHTML="";return}var a=e.slice().sort(function(r,s){return(s.round_score||0)-(r.round_score||0)}),i='<div class="results-cards-scroll">';a.forEach(function(r){var s=r.name===E,o=r.missed_round===!0,d=r.years_off||0,u=r.round_score||0,f=o?"is-score-zero":u>=10?"is-score-high":u>=1?"is-score-medium":"is-score-zero",m=o?"\u2014":r.guess||"n/a",l=o?c.t("reveal.noGuessShort"):d===0?c.t("reveal.exact"):t("reveal.shortOff",{years:d}),v=r.bet?'<span class="card-bet">\u{1F3B2}</span>':"",p="";r.artist_bonus&&r.artist_bonus>0&&(p='<span class="player-card-artist-badge">\u{1F3A4} +'+r.artist_bonus+"</span>");var w="";if(r.stole_from)w='<div class="steal-badge"><span class="steal-badge-icon">\u{1F977}</span>'+t("steal.stolenFrom",{name:k(r.stole_from)})+"</div>";else if(r.was_stolen_by&&r.was_stolen_by.length>0){var h=r.was_stolen_by.map(k).join(", ");w='<div class="steal-badge steal-badge-victim"><span class="steal-badge-icon">\u{1F3AF}</span>'+t("steal.stolenBy",{name:h})+"</div>"}i+='<div class="result-card '+f+(s?" is-current":"")+'"><div class="card-name">'+k(r.name)+v+'</div><div class="card-guess">'+m+'</div><div class="card-accuracy">'+l+"</div>"+w+'<div class="card-score">+'+u+p+"</div></div>"}),i+="</div>",n.innerHTML=i}}function Jn(e){var n=e.leaderboard||[];n.forEach(function(h){h.is_current=h.name===E}),[1,2,3].forEach(function(h){var I=n.find(function(_){return _.rank===h}),B=document.getElementById("podium-"+h+"-name"),S=document.getElementById("podium-"+h+"-score");B&&(B.textContent=I?k(I.name):"---"),S&&(S.textContent=I?I.score:"0")});var a=n.find(function(h){return h.is_current}),i=document.getElementById("your-final-rank"),r=document.getElementById("your-final-score"),s=document.getElementById("stat-best-streak"),o=document.getElementById("stat-rounds"),d=document.getElementById("stat-bets");a&&(i&&(i.textContent="#"+a.rank),r&&(r.textContent=a.score+" "+c.t("leaderboard.points")),s&&(s.textContent=a.best_streak||0),o&&(o.textContent=a.rounds_played||0),d&&(d.textContent=a.bets_won||0));var u=document.getElementById("final-leaderboard-list");u&&(u.innerHTML=n.map(function(h){var I=h.is_current?"is-current":"",B=h.connected===!1?"final-entry--disconnected":"",S=h.connected===!1?'<span class="away-badge">(away)</span>':"";return'<div class="final-entry '+I+" "+B+'"><span class="final-rank">#'+h.rank+'</span><span class="final-name">'+k(h.name)+S+'</span><span class="final-score">'+h.score+"</span></div>"}).join("")),On(e.superlatives);var f=document.getElementById("end-admin-controls"),m=document.getElementById("end-player-message");if(a&&a.is_admin){f&&f.classList.remove("hidden"),m&&m.classList.add("hidden");var l=document.getElementById("new-game-btn");l&&(l.onclick=Kn)}else f&&f.classList.add("hidden"),m&&m.classList.remove("hidden");if(a){var v=e.total_rounds||10,p=a.best_streak||0,w=p===v&&v>0;w?we("perfect"):a.rank===1&&we("winner")}}function Qn(e){var n=document.getElementById("pause-message");n&&(e.pause_reason==="admin_disconnected"?n.textContent="Waiting for host to reconnect...":e.pause_reason==="media_player_error"?n.textContent="Speaker unavailable. Please check your media player and try again.":n.textContent="Game paused. Please wait...")}function Kn(){return q(this,null,function*(){var e=yield le(c.t("admin.newGameTitle")||"New Game?",c.t("admin.newGameConfirm")||"Start a new game?",c.t("admin.newGame")||"New Game",c.t("common.cancel"));if(e){var n=document.getElementById("new-game-btn");n&&(n.disabled=!0,n.textContent="Redirecting...");try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(a){}window.location.href="/beatify/admin"}})}var Ve=!1,Xn=2e3;function dt(){if(!Ve&&g&&g.readyState===WebSocket.OPEN){Ve=!0;var e=document.getElementById("next-round-btn"),n=document.getElementById("next-round-admin-btn");if(e&&(e.disabled=!0,e.textContent="Loading..."),n){n.disabled=!0;var a=n.querySelector(".control-label");a&&(a.textContent="Wait...")}g.send(JSON.stringify({type:"admin",action:"next_round"})),setTimeout(function(){Ve=!1,e&&(e.disabled=!1),n&&(n.disabled=!1)},Xn)}}let We=!1;var Zn=500;let ee=!1,qe=.5;function ye(){return We?!1:(We=!0,setTimeout(function(){We=!1},Zn),!0)}function ut(){if(A){var e=document.getElementById("admin-control-bar");e&&(e.classList.remove("hidden"),document.body.classList.add("has-control-bar"))}}function be(){var e=document.getElementById("admin-control-bar");e&&(e.classList.add("hidden"),document.body.classList.remove("has-control-bar"))}function $n(){var e=document.getElementById("reaction-bar");e&&e.classList.remove("hidden")}function he(){var e=document.getElementById("reaction-bar");e&&e.classList.add("hidden")}function ea(e){je||(je=!0,g&&g.readyState===WebSocket.OPEN&&g.send(JSON.stringify({type:"reaction",emoji:e})))}function ta(){var e=document.getElementById("reaction-bar");if(e){var n=e.querySelectorAll(".reaction-btn");n.forEach(function(a){a.addEventListener("click",function(){var i=a.getAttribute("data-emoji");i&&ea(i)})})}}ta();function na(e,n){var a=document.getElementById("reaction-container");if(a){var i=document.createElement("div");i.className="reaction-bubble",i.textContent=e+" "+n,i.style.left=20+Math.random()*60+"%",a.appendChild(i),setTimeout(function(){i.remove()},3e3)}}function ft(e){var n=document.getElementById("stop-song-btn"),a=document.getElementById("next-round-admin-btn");if(e==="PLAYING"){if(vt(),n&&!ee&&(n.classList.remove("is-disabled"),n.disabled=!1),a){a.classList.remove("is-disabled"),a.disabled=!1;var i=a.querySelector(".control-label");i&&(i.textContent="Skip")}}else if(e==="REVEAL"){if(n&&!ee&&(n.classList.remove("is-disabled"),n.disabled=!1),a){a.classList.remove("is-disabled"),a.disabled=!1;var i=a.querySelector(".control-label");i&&(i.textContent="Next")}}else if(a){a.classList.add("is-disabled"),a.disabled=!0;var i=a.querySelector(".control-label");i&&(i.textContent="Next")}}function aa(){if(!ee&&ye()){if(!g||g.readyState!==WebSocket.OPEN){console.warn("[Beatify] Cannot stop song: WebSocket not connected");return}var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-disabled"),e.disabled=!0;var n=e.querySelector(".control-label");n&&(n.textContent="Stopping...")}g.send(JSON.stringify({type:"admin",action:"stop_song"}))}}function ia(){if(qe>=1){mt("max");return}ye()&&(!g||g.readyState!==WebSocket.OPEN||g.send(JSON.stringify({type:"admin",action:"set_volume",direction:"up"})))}function ra(){if(qe<=0){mt("min");return}ye()&&(!g||g.readyState!==WebSocket.OPEN||g.send(JSON.stringify({type:"admin",action:"set_volume",direction:"down"})))}function mt(e){var n=document.getElementById("volume-indicator");n&&(n.textContent=e==="max"?"\u{1F50A} Max":"\u{1F507} Min",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},1e3))}function sa(){return q(this,null,function*(){var e=yield le(c.t("admin.endGameConfirm")||"End Game?",c.t("admin.endGameWarning")||"All players will be disconnected.",c.t("admin.endGame")||"End Game",c.t("common.cancel"));if(e&&ye()){if(!g||g.readyState!==WebSocket.OPEN){alert(c.t("errors.CONNECTION_LOST"));return}var n=document.getElementById("end-game-btn");if(n){n.disabled=!0;var a=n.querySelector(".control-label");a&&(a.textContent="Ending...")}g.send(JSON.stringify({type:"admin",action:"end_game"}))}})}function oa(){dt()}function la(){var e=document.getElementById("stop-song-btn"),n=document.getElementById("volume-up-btn"),a=document.getElementById("volume-down-btn"),i=document.getElementById("next-round-admin-btn"),r=document.getElementById("end-game-btn");e&&e.addEventListener("click",aa),n&&n.addEventListener("click",ia),a&&a.addEventListener("click",ra),i&&i.addEventListener("click",oa),r&&r.addEventListener("click",sa)}function ca(){ee=!0;var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-stopped"),e.classList.add("is-disabled"),e.disabled=!0;var n=e.querySelector(".control-icon"),a=e.querySelector(".control-label");n&&(n.textContent="\u2713"),a&&(a.textContent="Stopped")}}function vt(){ee=!1;var e=document.getElementById("stop-song-btn");if(e){e.classList.remove("is-stopped"),e.classList.remove("is-disabled"),e.disabled=!1;var n=e.querySelector(".control-icon"),a=e.querySelector(".control-label");n&&(n.textContent="\u23F9\uFE0F"),a&&(a.textContent="Stop")}}function da(e){qe=e,ua(e),fa(e)}function ua(e){var n=document.getElementById("volume-indicator");if(n){var a=Math.round(e*100);n.textContent="\u{1F50A} "+a+"%",n.classList.remove("hidden"),n.classList.add("is-visible"),setTimeout(function(){n.classList.remove("is-visible"),setTimeout(function(){n.classList.add("hidden")},300)},1500)}}function fa(e){var n=document.getElementById("volume-up-btn"),a=document.getElementById("volume-down-btn");n&&n.classList.toggle("is-at-limit",e>=1),a&&a.classList.toggle("is-at-limit",e<=0)}let A=!1;function ma(){const e=sessionStorage.getItem("beatify_is_admin"),n=sessionStorage.getItem("beatify_admin_name");return e==="true"&&n&&(A=!0,E=n,sessionStorage.removeItem("beatify_is_admin")),A}function va(e){const n=document.getElementById("admin-controls"),a=document.getElementById("lobby-status");if(!n)return;(!e||!Array.isArray(e))&&(e=[]);const i=e.find(function(s){return s.name===E});(i==null?void 0:i.is_admin)===!0?(n.classList.remove("hidden"),a&&a.classList.add("hidden")):(n.classList.add("hidden"),a&&a.classList.remove("hidden"))}function ga(){const e=document.getElementById("start-game-btn");e==null||e.addEventListener("click",function(){!g||g.readyState!==WebSocket.OPEN||(e.disabled=!0,e.textContent="Starting...",g.send(JSON.stringify({type:"admin",action:"start_game"})))})}let g=null,E=null,x=0;const te=10,pa=3e4,Ee="beatify_player_name",Le="beatify_game_id",gt="beatify_language";let P=!1,ne=!1,je=!1;function pt(){return Math.min(1e3*Math.pow(2,x),pa)}function ya(){try{var e=localStorage.getItem(Le),n=localStorage.getItem(Ee);if(console.log("[Beatify] Checking localStorage - storedGameId:",e,"currentGameId:",C,"storedName:",n),e&&e===C)return console.log("[Beatify] Game ID match, returning stored name:",n),n;e&&e!==C&&(console.log("[Beatify] Different game ID, clearing stored data"),localStorage.removeItem(Ee),localStorage.removeItem(Le))}catch(a){console.error("[Beatify] localStorage error:",a)}return null}function yt(e){try{localStorage.setItem(Ee,e),localStorage.setItem(Le,C),console.log("[Beatify] Stored player name:",e,"for game:",C)}catch(n){console.error("[Beatify] Failed to store player name:",n)}}function ae(){try{localStorage.removeItem(Ee),localStorage.removeItem(Le)}catch(e){}}function ba(e){try{localStorage.setItem(gt,e)}catch(n){}}function ha(){try{return localStorage.getItem(gt)}catch(e){return null}}function bt(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.remove("hidden")}function ie(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.add("hidden")}function ht(e){var n=document.getElementById("reconnect-status");n&&(n.textContent="Reconnecting... (Attempt "+e+"/"+te+")")}function Ue(){L("connection-lost-view")}function Ea(){var e=document.getElementById("retry-connection-btn");e&&e.addEventListener("click",function(){E?(x=0,L("loading-view"),re(E)):ce()})}function re(e){E=e,yt(e);const a=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+"/beatify/ws";g=new WebSocket(a),g.onopen=function(){x=0,P=!1,ie();var i={type:"join",name:e};A&&(i.is_admin=!0),g.send(JSON.stringify(i))},g.onmessage=function(i){try{const r=JSON.parse(i.data);Et(r)}catch(r){console.error("Failed to parse WebSocket message:",r)}},g.onclose=function(){if(ne){ne=!1;return}if(E&&x<te){P=!0,x++,bt(),ht(x);const i=pt();console.log("WebSocket closed. Reconnecting in "+i+"ms... (attempt "+x+")"),setTimeout(function(){re(E)},i)}else x>=te&&(P=!1,ie(),Ue())},g.onerror=function(i){console.error("WebSocket error:",i)}}function Et(e){const n=document.getElementById("join-btn"),a=document.getElementById("name-input");if(e.type==="state"){var i=e.players||[],r=i.find(function(o){return o.name===E});if(r&&(A=r.is_admin===!0),e.language&&(ba(e.language),typeof BeatifyI18n!="undefined"&&e.language!==BeatifyI18n.getLanguage()&&BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),nt(i),e.difficulty&&Re(e.difficulty),e.phase==="REVEAL"&&ct(e)})),e.phase==="LOBBY")j(),be(),he(),ge=0,U("warmup"),L("lobby-view"),nt(i),e.difficulty&&Re(e.difficulty),e.join_url&&Zt(e.join_url),va(i);else if(e.phase==="PLAYING"){var s=e.round||1;s!==ge&&(ge=s,En()),U("party"),L("game-view"),me(),rn(e),e.difficulty&&Re(e.difficulty),e.deadline&&an(e.deadline),yn(),fn(),ut(),ft("PLAYING"),he()}else e.phase==="REVEAL"?(j(),e.early_reveal&&Kt(),U("party"),L("reveal-view"),ct(e),vn(),gn(),ut(),ft("REVEAL"),je=!1,$n()):e.phase==="PAUSED"?(j(),be(),he(),U("warmup"),L("paused-view"),Qn(e)):e.phase==="END"&&(j(),be(),he(),ge=0,U("warmup"),L("end-view"),Jn(e),ae())}else if(e.type==="join_ack"){e.session_id&&At(e.session_id);try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(o){}}else if(e.type==="reconnect_ack")e.success&&e.name?(E=e.name,yt(e.name),Qt(e.name)):(Q(),ae(),E=null,L("join-view"));else if(e.type==="submit_ack")lt();else if(e.type==="metadata_update")sn(e.song);else if(e.type==="error"){if(e.code==="ROUND_EXPIRED"||e.code==="ALREADY_SUBMITTED"){hn(e);return}if(e.code==="GAME_ENDED"){L("end-view");return}if(e.code==="NOT_ADMIN"){A=!1,be(),console.warn("Admin action rejected: not admin");return}if(e.code==="SESSION_TAKEOVER"){P=!1,ie(),E=null,Ue(),console.warn("Session taken over by another tab");return}if(e.code==="SESSION_NOT_FOUND"){Q(),ne=!0,g&&g.close(),L("join-view");return}if(e.code==="ADMIN_CANNOT_LEAVE"){ne=!1,alert(e.message||"Host cannot leave. End the game instead.");return}if(e.code==="INVALID_ACTION"&&e.message==="No song playing"){vt(),console.warn("[Beatify] Stop song failed: No song playing");return}L("join-view"),Ia(e.message),n&&(n.disabled=!1,n.textContent=c.t("join.joinButton")),a&&a.focus(),E=null,ae()}else e.type==="song_stopped"?ca():e.type==="volume_changed"?da(e.level):e.type==="game_ended"?wa():e.type==="left"?La():e.type==="steal_targets"?An(e):e.type==="steal_ack"?Tn(e):e.type==="artist_guess_ack"?In(e):e.type==="player_reaction"&&na(e.player_name,e.emoji)}function La(){ae(),Q(),E=null,A=!1,L("join-view")}function Ta(){return q(this,null,function*(){if(!(!g||g.readyState!==WebSocket.OPEN)){if(A){alert("Host cannot leave. End the game instead.");return}var e=yield le(c.t("player.leaveGameTitle")||"Leave Game?",c.t("player.leaveGameWarning")||"Your score will be lost.",c.t("player.leaveGame")||"Leave",c.t("common.cancel"));e&&(ne=!0,g.send(JSON.stringify({type:"leave"})))}})}function wa(){var e=A;ae(),Q();try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(a){}if(Ht(),jt(),Me.clear(),Ie(),E=null,A=!1,g&&g.readyState===WebSocket.OPEN&&g.close(),g=null,e){setTimeout(function(){window.location.href="/beatify/admin"},5e3);return}if(!(!Te||!Te.classList.contains("hidden"))){var n=document.getElementById("end-player-message");n&&(n.innerHTML='<p>Thanks for playing!</p><p class="rejoin-hint">Scan the QR code again to join the next game.</p>',n.classList.remove("hidden")),L("end-view")}}function Ia(e){const n=document.getElementById("name-validation-msg");n&&(n.textContent=e,n.classList.remove("hidden"))}function ze(e){const n=(e||"").trim();return n?n.length>Xt?{valid:!1,error:"Name too long (max 20 characters)"}:{valid:!0,name:n}:{valid:!1,error:"Please enter a name"}}function Lt(){const e=document.getElementById("name-input"),n=document.getElementById("join-btn"),a=document.getElementById("name-validation-msg");if(!e||!n)return;const i=ze(e.value);i.valid&&(n.disabled=!0,n.textContent="Joining...",a&&a.classList.add("hidden"),re(i.name))}function Ba(){const e=document.getElementById("name-input"),n=document.getElementById("join-btn"),a=document.getElementById("name-validation-msg");!e||!n||(e.addEventListener("input",function(){const i=ze(this.value);n.disabled=!i.valid,a&&(a.textContent=!i.valid&&this.value?i.error:"",a.classList.toggle("hidden",i.valid||!this.value))}),n.addEventListener("click",Lt),e.addEventListener("keypress",function(i){i.key==="Enter"&&!n.disabled&&Lt()}))}const Sa=L;L=function(e){Sa(e),(e==="join-view"||e==="loading-view"||e==="not-found-view"||e==="ended-view"||e==="in-progress-view"||e==="connection-lost-view")&&U("calm"),e==="join-view"&&setTimeout(function(){var n=document.getElementById("name-input");n&&n.focus()},100)};function U(e){document.body.classList.remove("energy-calm","energy-warmup","energy-party"),document.body.classList.add("energy-"+e)}var G=null,F=null;function we(e){if(K.prefersReducedMotion()){wt();return}if(typeof confetti=="undefined"){console.warn("[Confetti] Library not loaded");return}Ie();var n=K.getQualitySettings(),a=n.confettiParticles;if(a===0){wt();return}var i=K.getDeviceTier(),r=i==="low"?.5:i==="medium"?.75:1;switch(e=e||"exact",e){case"exact":var s=Math.round(2e3*r),o=Date.now()+s;(function p(){confetti({particleCount:a,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<o&&(G=requestAnimationFrame(p))})();break;case"record":var d=Math.round(3e3*r),u=Date.now()+d;(function p(){confetti({particleCount:Math.round(a*.67),spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<u&&(G=requestAnimationFrame(p))})();break;case"winner":var f=Math.round(4e3*r),m=Date.now()+f;(function p(){confetti({particleCount:Math.round(a*.67),angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:Math.round(a*.67),angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<m&&(G=requestAnimationFrame(p))})();break;case"perfect":var l=Math.round(5e3*r),v=Date.now()+l;F=setInterval(function(){confetti({particleCount:a*2,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},i==="low"?750:500),setTimeout(function(){F&&(clearInterval(F),F=null)},l),function p(){confetti({particleCount:Math.round(a*.5),angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:Math.round(a*.5),angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<v&&(G=requestAnimationFrame(p))}();break;default:console.warn("[Confetti] Unknown type:",e)}}function Ie(){G&&(cancelAnimationFrame(G),G=null),F&&(clearInterval(F),F=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function wt(){var e=document.getElementById("reveal-emotion");if(e){var n=e.querySelector(".celebration-icon");if(!n){var a=document.createElement("span");a.className="celebration-icon",a.textContent=" \u{1F389}",e.appendChild(a)}}}function _a(){var e=document.getElementById("next-round-btn");e&&e.addEventListener("click",dt);var n=document.getElementById("reveal-view");n&&n.addEventListener("click",function(a){a.target.tagName==="BUTTON"||a.target.closest("button")||(Me.isRunning()&&Me.skipAll(),Ie())})}function It(){return q(this,null,function*(){var e=K.getDeviceTier();document.body.classList.add("device-tier-"+e);var n=yield c.waitForI18n();if(!n)console.error("[Player] BeatifyI18n module failed to load - UI will use fallback text");else{var a=ha();yield BeatifyI18n.init(a),BeatifyI18n.initPageTranslations()}var i=document.getElementById("dashboard-hint-url");i&&(i.textContent=window.location.origin+"/beatify/dashboard");var r=document.getElementById("player-dashboard-url");if(r&&(r.href=window.location.origin+"/beatify/dashboard"),Ba(),$t(),nn(),ga(),_a(),la(),Ea(),Dt(),Pt(),Gt(),ma()&&E){re(E);return}var s=ya();if(s&&C){console.log("[Beatify] Auto-reconnecting as:",s),re(s);return}if(s){var o=document.getElementById("name-input"),d=document.getElementById("join-btn");if(o&&(o.value=s,d)){var u=ze(s);d.disabled=!u.valid}}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",It):It(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Beatify] SW registered:",e.scope)}).catch(function(e){console.warn("[Beatify] SW registration failed:",e)})})})();})();
//# sourceMappingURL=player.min.js.map
