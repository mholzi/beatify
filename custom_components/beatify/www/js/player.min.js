(()=>{var H=(Ue,k,W)=>new Promise((Ce,oe)=>{var ke=M=>{try{z(W.next(M))}catch(J){oe(J)}},xe=M=>{try{z(W.throw(M))}catch(J){oe(J)}},z=M=>M.done?Ce(M.value):Promise.resolve(M.value).then(ke,xe);z((W=W.apply(Ue,k)).next())});(function(){"use strict";var St,_t;const k=new URLSearchParams(window.location.search).get("game"),W=document.getElementById("loading-view"),Ce=document.getElementById("not-found-view"),oe=document.getElementById("ended-view"),ke=document.getElementById("in-progress-view"),xe=document.getElementById("join-view"),z=document.getElementById("lobby-view"),M=document.getElementById("game-view"),J=document.getElementById("reveal-view"),Ct=document.getElementById("paused-view"),Te=document.getElementById("end-view"),kt=document.getElementById("connection-lost-view");function E(e){[W,Ce,oe,ke,xe,z,M,J,Ct,Te,kt].forEach(function(n){n&&n.classList.add("hidden")});const t=document.getElementById(e);t&&t.classList.remove("hidden")}function xt(e){return!e||typeof e!="string"?!1:/^[a-zA-Z0-9_-]{8,16}$/.test(e)}function Tt(e,t){return H(this,null,function*(){e=e||3e3,t=t||50;for(var n=Date.now();typeof BeatifyI18n=="undefined";){if(Date.now()-n>e)return!1;yield new Promise(function(a){setTimeout(a,t)})}return!0})}function l(e,t){if(typeof BeatifyI18n!="undefined"&&BeatifyI18n.t)return BeatifyI18n.t(e,t);var n=e.split(".").pop().replace(/([A-Z])/g," $1").replace(/^./,function(a){return a.toUpperCase()}).trim();return t&&typeof t=="object"&&Object.keys(t).forEach(function(a){n=n.replace(new RegExp("\\{"+a+"\\}","g"),t[a])}),n}function le(e,t,n,a){return new Promise(function(r){var i=document.getElementById("confirm-modal"),o=document.getElementById("confirm-modal-title"),s=document.getElementById("confirm-modal-message"),u=document.getElementById("confirm-modal-yes"),c=document.getElementById("confirm-modal-no");if(!i||!o||!s||!u||!c){r(confirm(t||e));return}o.textContent=e,s.textContent=t,u.textContent=n||l("common.confirm")||"Confirm",c.textContent=a||l("common.cancel")||"Cancel",i.classList.remove("hidden");function m(){i.classList.add("hidden"),u.removeEventListener("click",d),c.removeEventListener("click",v),p.removeEventListener("click",v)}function d(){m(),r(!0)}function v(){m(),r(!1)}var p=i.querySelector(".modal-backdrop");u.addEventListener("click",d),c.addEventListener("click",v),p&&p.addEventListener("click",v)})}function Ye(e,t){if(!e)return null;var n=typeof BeatifyI18n!="undefined"?BeatifyI18n.getLanguage():"en";if(n&&n!=="en"){var a=t+"_"+n;if(e[a])return e[a]}return e[t]||null}function ce(){return H(this,null,function*(){if(!k){E("not-found-view");return}if(!xt(k)){E("not-found-view");return}try{const a=yield(yield fetch(`/beatify/api/game-status?game=${encodeURIComponent(k)}`)).json();if(!a.exists){E("not-found-view");return}if(a.phase==="END"){E("ended-view");return}var e=sessionStorage.getItem("beatify_admin_name");if(e)return;var t=ze();if(t){$e();return}a.can_join?E("join-view"):E("in-progress-view")}catch(n){console.error("Failed to check game status:",n),E("not-found-view")}})}ce(),(St=document.getElementById("refresh-btn"))==null||St.addEventListener("click",()=>{E("loading-view"),ce()}),(_t=document.getElementById("retry-btn"))==null||_t.addEventListener("click",()=>{E("loading-view"),ce()});var de="beatify_session";function At(e){var t=location.protocol==="https:"?"; Secure":"";document.cookie=de+"="+e+"; path=/beatify; SameSite=Strict; max-age=86400"+t}function ze(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){var n=e[t].trim();if(n.indexOf(de+"=")===0)return n.substring(de.length+1)}return null}function Q(){document.cookie=de+"=; path=/beatify; max-age=0"}function ue(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function Mt(e){return 1-Math.pow(1-e,4)}function Ae(e,t,n,a,r){if(ue()||t===n)return e.textContent=n,{cancel:function(){},skipToEnd:function(){e.textContent=n}};var i=K.getQualitySettings();if(i.scoreDuration===0)return e.textContent=n,{cancel:function(){},skipToEnd:function(){e.textContent=n}};var o=Math.min(a,i.scoreDuration||a);r=r||Mt;var s=null,u=null,c=!1,m=n;function d(v){if(!c){s||(s=v);var p=v-s,w=Math.min(p/o,1),b=r(w),L=Math.round(t+(m-t)*b);e.textContent=L,w<1&&(u=requestAnimationFrame(d))}}return u=requestAnimationFrame(d),{cancel:function(){c=!0,u&&cancelAnimationFrame(u)},skipToEnd:function(){c=!0,u&&cancelAnimationFrame(u),e.textContent=m}}}function Nt(e,t,n,a){a=a||{};var r=500;a.betWon?r=800:a.isBigScore?r=700:a.betLost&&(r=400),e.classList.add("score-animating");var i=null;a.betWon?i="score-glow-gold":a.betLost?(i="score-shake",e.classList.add("score-flash-red")):a.streakMilestone?i="score-burst":a.isBigScore&&(i="score-pop"),i&&!ue()&&e.classList.add(i),Ae(e,t,n,r);function o(){e.classList.remove("score-animating"),i&&e.classList.remove(i),e.classList.remove("score-flash-red")}i&&!ue()?e.addEventListener("animationend",function s(){e.removeEventListener("animationend",s),o()}):setTimeout(o,r+50)}function Je(e,t,n){if(n=n||{},!ue()){var a=document.createElement("div");a.className="points-popup",a.textContent=n.text||"+"+t,n.isStreak?a.classList.add("points-popup--streak"):n.isBetWin&&a.classList.add("points-popup--gold");var r=e.getBoundingClientRect();a.style.left=r.left+r.width/2+"px",a.style.top=r.top+"px",document.body.appendChild(a),a.addEventListener("animationend",function(){a.parentNode&&a.parentNode.removeChild(a)}),setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a)},1200)}}var x={players:{},leaderboard:[],initialized:!1};function Rt(){return x.initialized}var Qe=[3,5,10],K=function(){var e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=e.matches;e.addEventListener("change",function(r){t=r.matches});var n=null;function a(){if(n!==null)return n;var r=navigator.hardwareConcurrency||2,i=navigator.deviceMemory||4,o=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return r<=2||i<=2?n="low":r<=4||i<=4||o?n="medium":n="high",n}return a(),{prefersReducedMotion:function(){return t},getDeviceTier:a,getQualitySettings:function(){var r=a();if(t)return{confettiParticles:0,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!1};switch(r){case"low":return{confettiParticles:5,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!0};case"medium":return{confettiParticles:10,scoreDuration:300,leaderboardAnimation:"simplified",neonGlow:!1,enableAnimations:!0};default:return{confettiParticles:15,scoreDuration:500,leaderboardAnimation:"full",neonGlow:!0,enableAnimations:!0}}},ifMotionAllowed:function(r,i){t?i&&i():r()},withWillChange:function(r,i,o){r&&(r.style.willChange=i,setTimeout(function(){r&&r.style&&(r.style.willChange="auto")},(o||500)+100))}}}(),Me=function(){var e=[],t=!1,n=null,a=null,r=2e3;function i(){if(a&&(clearTimeout(a),a=null),e.length===0){t=!1,n=null;return}n=e.shift(),a=setTimeout(function(){n&&n.skipToEnd&&n.skipToEnd(),i()},r),n.run(function(){a&&(clearTimeout(a),a=null),i()})}return{add:function(o){e.push(o),t||(t=!0,i())},skipAll:function(){a&&(clearTimeout(a),a=null),n&&n.skipToEnd&&n.skipToEnd(),e.forEach(function(o){o.skipToEnd&&o.skipToEnd()}),e=[],t=!1,n=null},clear:function(){a&&(clearTimeout(a),a=null),e=[],t=!1,n=null},isRunning:function(){return t},getMaxDuration:function(){return maxDuration}}}(),X={VISIBLE_BUFFER:2,ENTRY_HEIGHT:48,MIN_PLAYERS_FOR_LAZY:10,ROOT_MARGIN:"96px 0px",DEFAULT_VIEWPORT_HEIGHT:280},y={observer:null,fullData:[],visibleRange:{start:0,end:10},listEl:null,isLazyEnabled:!1};function Ot(e){e&&(y.observer&&y.listEl!==e&&(y.observer.disconnect(),y.observer=null),!y.observer&&(y.listEl=e,y.observer=new IntersectionObserver(function(t){t.forEach(function(n){if(!(!n.isIntersecting||!y.isLazyEnabled)){var a=y.fullData,r=y.visibleRange,i=X.VISIBLE_BUFFER;if(n.target.classList.contains("leaderboard-sentinel--top")){if(r.start>0){var o=Math.max(0,r.start-i);y.visibleRange.start=o,fe()}}else if(n.target.classList.contains("leaderboard-sentinel--bottom")&&r.end<a.length){var s=Math.min(a.length,r.end+i);y.visibleRange.end=s,fe()}}})},{root:e,rootMargin:X.ROOT_MARGIN,threshold:0})))}function fe(){var e=y.listEl,t=y.fullData,n=y.visibleRange;if(!(!e||!t.length)){var a=X.ENTRY_HEIGHT,r=n.start*a,i=(t.length-n.end)*a,o=e.scrollTop,s="";r>0&&(s+='<div class="leaderboard-spacer-top" style="height: '+r+'px;"></div>'),s+='<div class="leaderboard-sentinel leaderboard-sentinel--top" style="height: 1px;"></div>';for(var u=n.start;u<n.end&&u<t.length;u++)s+=Ke(t[u]);if(s+='<div class="leaderboard-sentinel leaderboard-sentinel--bottom" style="height: 1px;"></div>',i>0&&(s+='<div class="leaderboard-spacer-bottom" style="height: '+i+'px;"></div>'),e.innerHTML=s,e.scrollTop=o,y.observer){var c=e.querySelectorAll(".leaderboard-sentinel");c.forEach(function(m){y.observer.observe(m)})}}}function Ke(e){if(!e)return"";if(e.separator)return'<div class="leaderboard-separator">...</div>';var t=e.name||"Unknown",n=e.rank||0,a=e.score||0,r=n<=3?"is-top-"+n:"",i=e.is_current?"is-current":"",o="";e.rank_change>0||e._rankChange==="up"?o="leaderboard-entry--climbing leaderboard-entry--slide-up":(e.rank_change<0||e._rankChange==="down")&&(o="leaderboard-entry--falling leaderboard-entry--slide-down");var s="";e.rank_change>0?s='<span class="rank-up">\u25B2'+e.rank_change+"</span>":e.rank_change<0&&(s='<span class="rank-down">\u25BC'+Math.abs(e.rank_change)+"</span>");var u="";if(e.streak>=2){var c=e.streak>=5?"streak-indicator--hot":"";u='<span class="streak-indicator '+c+'">\u{1F525}'+e.streak+"</span>"}var m=e.connected===!1?"leaderboard-entry--disconnected":"",d=e.connected===!1?'<span class="away-badge">(away)</span>':"",v=e._displayScore!==void 0?e._displayScore:a;return'<div class="leaderboard-entry '+r+" "+i+" "+o+" "+m+'" data-rank="'+n+'" data-name="'+_(t)+'"><span class="entry-rank">#'+n+'</span><span class="entry-name">'+_(t)+d+'</span><span class="entry-meta">'+u+s+'</span><span class="entry-score" data-prev-score="'+(e._prevScore||a)+'">'+v+"</span></div>"}function Xe(e,t){for(var n=X,a=y.listEl&&y.listEl.clientHeight||n.DEFAULT_VIEWPORT_HEIGHT,r=Math.ceil(a/n.ENTRY_HEIGHT),i=n.VISIBLE_BUFFER,o=-1,s=0;s<e.length;s++)if(e[s].name===t){o=s;break}var u,c;return o===-1||o<r?(u=0,c=Math.min(e.length,r+i*2)):o>=e.length-r?(u=Math.max(0,e.length-r-i),c=e.length):(u=Math.max(0,o-Math.floor(r/2)-i),c=Math.min(e.length,o+Math.ceil(r/2)+i)),{start:u,end:c}}function Ht(){y.observer&&(y.observer.disconnect(),y.observer=null),y.isLazyEnabled=!1,y.fullData=[]}function Dt(){var e;function t(){clearTimeout(e),e=setTimeout(function(){y.isLazyEnabled&&y.fullData.length>0&&(y.visibleRange=Xe(y.fullData,h),fe())},150)}window.addEventListener("resize",t),window.addEventListener("orientationchange",t)}function Pt(){var e=document.getElementById("qr-share-area");if(!(!e||e.tagName!=="DETAILS")){var t="beatify_qr_expanded",n=768,a=sessionStorage.getItem(t);a!==null?e.open=a==="true":e.open=window.innerWidth>=n,e.addEventListener("toggle",function(){sessionStorage.setItem(t,e.open.toString())})}}var Ze={ITEM_HEIGHT:60,OVERSCAN:3,THRESHOLD:15,CONTAINER_HEIGHT:320},g={container:null,items:[],scrollTop:0,isVirtual:!1,topSpacer:null,bottomSpacer:null,contentWrapper:null,scrollHandler:null,resizeHandler:null};function Gt(e){if(e){g.container=e;var t=!1;g.scrollHandler=function(){g.scrollTop=e.scrollTop,t||(requestAnimationFrame(function(){Ne(),t=!1}),t=!0)};var n;g.resizeHandler=function(){clearTimeout(n),n=setTimeout(function(){g.isVirtual&&Ne()},100)},e.addEventListener("scroll",g.scrollHandler,{passive:!0}),window.addEventListener("resize",g.resizeHandler)}}function Ft(e,t){g.items=e,g.renderItem=t;var n=g.container;if(n){var a=n.scrollTop,r=g.isVirtual;e.length<Ze.THRESHOLD?(g.isVirtual=!1,n.classList.remove("player-list--virtual"),Wt(e,t)):(g.isVirtual=!0,n.classList.add("player-list--virtual"),Vt(),Ne()),r!==g.isVirtual&&a>0&&(n.scrollTop=a,g.scrollTop=a)}}function Vt(){var e=g.container;if(e){e.innerHTML="";var t=document.createElement("div");t.className="virtual-spacer-top",g.topSpacer=t;var n=document.createElement("div");n.className="virtual-content-wrapper",g.contentWrapper=n;var a=document.createElement("div");a.className="virtual-spacer-bottom",g.bottomSpacer=a,e.appendChild(t),e.appendChild(n),e.appendChild(a)}}function Ne(){var e=Ze,t=g.items,n=g.container,a=g.contentWrapper;if(!(!n||!a||!t.length)){var r=n.clientHeight||e.CONTAINER_HEIGHT,i=g.scrollTop,o=e.ITEM_HEIGHT,s=e.OVERSCAN,u=Math.max(0,Math.floor(i/o)-s),c=Math.min(t.length,Math.ceil((i+r)/o)+s);g.topSpacer&&(g.topSpacer.style.height=u*o+"px"),g.bottomSpacer&&(g.bottomSpacer.style.height=(t.length-c)*o+"px");for(var m="",d=u;d<c;d++)m+=g.renderItem(t[d],d);a.innerHTML=m}}function Wt(e,t){var n=g.container;if(n){for(var a="",r=0;r<e.length;r++)a+=t(e[r],r);n.innerHTML=a}}function qt(){var e=g.container;e&&g.scrollHandler&&e.removeEventListener("scroll",g.scrollHandler),g.resizeHandler&&window.removeEventListener("resize",g.resizeHandler),g.container=null,g.items=[],g.isVirtual=!1,g.topSpacer=null,g.bottomSpacer=null,g.contentWrapper=null}function jt(e,t){for(var n=0;n<Qe.length;n++){var a=Qe[n];if(e<a&&t>=a)return a}return null}function Ut(e){var t=e.map(function(a){return a.name}),n={};return t.forEach(function(a,r){var i=x.leaderboard.indexOf(a);i===-1?n[a]="new":r<i?n[a]="up":r>i&&(n[a]="down")}),n}function Yt(e,t){x.players={},e.forEach(function(n){x.players[n.name]={score:n.score,rank:n.rank||0,streak:n.streak||0}}),t&&(x.leaderboard=t.map(function(n){return n.name})),x.initialized=!0}function Ba(){x.players={},x.leaderboard=[],x.initialized=!1}function zt(e){return!e||typeof e!="string"?!1:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e)||/^[a-f0-9]{32}$/i.test(e)}function $e(){var e=ze();if(!e||!zt(e)){e&&Q(),E("join-view");return}var t=window.location.protocol==="https:"?"wss:":"ws:",n=t+"//"+window.location.host+"/beatify/ws";f=new WebSocket(n),f.onopen=function(){C=0,D=!1,re(),f.send(JSON.stringify({type:"reconnect",session_id:e}))},f.onmessage=function(a){try{var r=JSON.parse(a.data);Lt(r)}catch(i){console.error("Failed to parse WebSocket message:",i)}},f.onclose=function(){if(h&&C<te){D=!0,C++,ht(),Et(C);var a=yt();console.log("WebSocket closed. Reconnecting in "+a+"ms... (attempt "+C+")"),setTimeout(function(){$e()},a)}else C>=te?(D=!1,re(),qe()):E("join-view")},f.onerror=function(a){console.error("WebSocket error:",a)}}function Jt(e){var t=document.getElementById("volume-indicator");t&&(t.textContent="Welcome back, "+e+"!",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},2e3))}const Qt=20;let et=[];function _(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function tt(e){const t=document.getElementById("player-list"),n=document.getElementById("player-count");if(!t)return;if((!e||!Array.isArray(e))&&(e=[]),n){const s=e.length;n.textContent=s===1?l("lobby.playerJoined"):l("lobby.playersJoined",{count:s})}var a=e.slice().sort(function(s,u){return s.connected!==u.connected?s.connected?-1:1:0});const r=et.map(function(s){return s.name}),i=a.filter(function(s){return r.indexOf(s.name)===-1}).map(function(s){return s.name});g.container||Gt(t);var o=function(s){var u=i.indexOf(s.name)!==-1,c=s.name===h,m=s.connected===!1,d=["player-card",u?"is-new":"",c?"player-card--you":"",m?"player-card--disconnected":""].filter(Boolean).join(" "),v=m?'<span class="away-badge">(away)</span>':"";return'<div class="'+d+'" data-player="'+_(s.name)+'"><span class="player-name">'+_(s.name)+(c?'<span class="you-badge">'+l("leaderboard.you")+"</span>":"")+v+"</span></div>"};Ft(a,o),setTimeout(function(){var s=g.isVirtual?g.contentWrapper:t;if(!s)return;const u=s.querySelectorAll(".is-new");for(let c=0;c<u.length;c++)u[c].classList.remove("is-new")},2e3),et=e.slice()}function Re(e){var t={easy:"game.difficultyEasy",normal:"game.difficultyNormal",hard:"game.difficultyHard"}[e]||"game.difficultyNormal",n=l(t),a=document.getElementById("lobby-difficulty-badge"),r=document.getElementById("game-difficulty-badge");a&&(a.textContent=n,a.className="difficulty-badge difficulty-badge--"+(e||"normal")),r&&(r.textContent=n,r.className="difficulty-badge difficulty-badge--"+(e||"normal"))}let N=null;function Kt(e){if(e){N=e;var t=document.getElementById("player-qr-code");t&&(t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',t.onclick=nt,t.onkeydown=function(n){(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),nt())})}}function nt(){if(N){var e=document.getElementById("qr-modal"),t=document.getElementById("qr-modal-code");if(!(!e||!t)){t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:N,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',e.classList.remove("hidden"),document.body.style.overflow="hidden";var n=document.getElementById("qr-modal-close");n&&n.focus()}}}function Oe(){var e=document.getElementById("qr-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="")}function Xt(){var e=document.getElementById("qr-modal"),t=e?e.querySelector(".qr-modal-backdrop"):null,n=document.getElementById("qr-modal-close");t&&t.addEventListener("click",Oe),n&&n.addEventListener("click",Oe),document.addEventListener("keydown",function(a){a.key==="Escape"&&e&&!e.classList.contains("hidden")&&Oe()})}function Zt(){if(N){var e=document.getElementById("invite-modal"),t=document.getElementById("invite-modal-code"),n=document.getElementById("invite-modal-url");if(!(!e||!t)){t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:N,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',n&&(n.value=N),e.classList.remove("hidden"),document.body.style.overflow="hidden";var a=document.getElementById("invite-modal-close");a&&a.focus()}}}function me(){var e=document.getElementById("invite-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="");var t=document.getElementById("invite-copy-feedback");t&&t.classList.add("hidden")}function $t(){var e=document.getElementById("invite-modal-url"),t=document.getElementById("invite-copy-feedback");!e||!N||(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(N).then(function(){rt(t)}).catch(function(){at(e,t)}):at(e,t))}function at(e,t){e.select(),e.setSelectionRange(0,99999);try{document.execCommand("copy"),rt(t)}catch(n){console.warn("[Beatify] Copy failed:",n)}}function rt(e){e&&(e.classList.remove("hidden"),setTimeout(function(){e.classList.add("hidden")},2e3))}function en(){var e=document.getElementById("invite-modal"),t=e?e.querySelector(".invite-modal-backdrop"):null,n=document.getElementById("invite-modal-close"),a=document.getElementById("invite-players-btn"),r=document.getElementById("invite-copy-btn");t&&t.addEventListener("click",me),n&&n.addEventListener("click",me),a&&a.addEventListener("click",Zt),r&&r.addEventListener("click",$t),document.addEventListener("keydown",function(i){i.key==="Escape"&&e&&!e.classList.contains("hidden")&&me()})}let ve=null;function tn(e){q();var t=document.getElementById("timer");if(!t)return;t.classList.remove("timer--warning","timer--critical");function n(){var a=Date.now(),r=Math.max(0,Math.ceil((e-a)/1e3));t.textContent=r,r<=5?(t.classList.remove("timer--warning"),t.classList.add("timer--critical")):r<=10?(t.classList.remove("timer--critical"),t.classList.add("timer--warning")):t.classList.remove("timer--warning","timer--critical"),r===10?t.setAttribute("aria-label","10 seconds remaining"):r===5?t.setAttribute("aria-label","5 seconds!"):r===0?t.setAttribute("aria-label","Time is up!"):t.setAttribute("aria-label","Time remaining: "+r+" seconds"),r<=0&&q()}n(),ve=setInterval(n,1e3)}function q(){ve&&(clearInterval(ve),ve=null)}function nn(e){var t=document.getElementById("current-round"),n=document.getElementById("total-rounds"),a=document.getElementById("last-round-banner");t&&(t.textContent=e.round||1),n&&(n.textContent=e.total_rounds||10),a&&(e.last_round?a.classList.remove("hidden"):a.classList.add("hidden"));var r=document.getElementById("album-cover"),i=document.getElementById("album-loading");if(r&&e.song){i&&i.classList.remove("hidden");var o=e.song.album_art||"/beatify/static/img/no-artwork.svg";r.onload=function(){i&&i.classList.add("hidden")},r.onerror=function(){r.src="/beatify/static/img/no-artwork.svg",i&&i.classList.add("hidden")},r.src=o}rn(e.players),e.leaderboard&&it(e,"leaderboard-list"),En(e.players),e.artist_challenge!==void 0&&gn(e.artist_challenge,"PLAYING")}function an(e){if(!e)return"?";var t=e.trim();if(!t)return"?";var n=t.split(/[\s-]+/).filter(Boolean);return n.length>=2?(n[0][0]+n[1][0]).toUpperCase():t.slice(0,Math.min(2,t.length)).toUpperCase()}function rn(e){var t=document.getElementById("submission-tracker"),n=document.getElementById("submitted-players"),a=document.getElementById("submission-count");if(!(!t||!n||!a)){var r=e||[],i=r.filter(function(c){return c.submitted}).length,o=r.length;a.textContent=l("game.submittedCount",{count:i,total:o});var s=i===o&&o>0;t.classList.toggle("all-submitted",s);var u=r.length>10;if(t.classList.toggle("is-compact",u),u){n.innerHTML="";return}n.innerHTML=r.map(function(c){var m=an(c.name),d=c.name===h,v=c.connected===!1,p=["player-indicator",c.submitted?"is-submitted":"",d?"is-current-player":"",c.bet?"is-betting":"",v?"player-indicator--disconnected":""].filter(Boolean).join(" ");return'<div class="'+p+'"><div class="player-avatar"><span class="player-initials">'+_(m)+'</span></div><span class="player-name">'+_(c.name)+"</span></div>"}).join("")}}function it(e,t,n){var a=e.leaderboard||[],r=document.getElementById(t||"leaderboard-list");if(r){var i=n&&Rt(),o=i?Ut(a):{};a.forEach(function(d){d.is_current=d.name===h;var v=o[d.name];v&&(d._rankChange=v);var p=x.players[d.name],w=p?p.score:d.score;d._prevScore=w,d._displayScore=n?w:d.score});var s=sn(a,h),u=a.length>=X.MIN_PLAYERS_FOR_LAZY;if(u)y.observer||Ot(r),y.fullData=s,y.isLazyEnabled=!0,y.listEl=r,y.visibleRange=Xe(s,h),fe();else{y.isLazyEnabled=!1;var c="";s.forEach(function(d){c+=Ke(d)}),r.innerHTML=c}var m=[];i&&s.forEach(function(d){!d.separator&&d._prevScore!==d.score&&m.push({name:d.name,prevScore:d._prevScore,newScore:d.score})}),i&&m.length>0&&requestAnimationFrame(function(){for(var d={},v=r.querySelectorAll(".leaderboard-entry[data-name]"),p=0;p<v.length;p++){var w=v[p],b=w.getAttribute("data-name");b&&(d[b]=w)}m.forEach(function(L){var I=d[L.name];if(I){var B=I.querySelector(".entry-score");B&&Ae(B,L.prevScore,L.newScore,500)}})}),a.length>8&&on(r),ln(a),Yt(e.players||[],a)}}function sn(e,t){if(e.length<=10)return e;for(var n=e.slice(0,5),a=e.slice(-3),r=-1,i=0;i<e.length;i++)if(e[i].name===t){r=i;break}return r<5||r>=e.length-3?[].concat(n,[{separator:!0}],a):[].concat(n,[{separator:!0}],[e[r]],[{separator:!0}],a)}function on(e){var t=e.querySelector(".leaderboard-entry.is-current");t&&t.scrollIntoView({behavior:"smooth",block:"center"})}function ln(e){var t=document.getElementById("leaderboard-you"),n=e.find(function(a){return a.is_current});t&&n&&(t.textContent=l("leaderboard.you")+" #"+n.rank,t.classList.remove("hidden"))}function cn(){var e=document.getElementById("leaderboard-toggle"),t=document.getElementById("game-leaderboard");e&&t&&e.addEventListener("click",function(){t.classList.toggle("is-expanded");var n=e.querySelector(".toggle-icon");n&&(n.textContent=t.classList.contains("is-expanded")?"\u25B2":"\u25BC")})}let R=!1,Z=!1,ge=0,$=!1;var j=!1,O=null,pe=null,dn=300,st=0;function un(){var e=document.getElementById("year-slider"),t=document.getElementById("selected-year");if(!(!e||!t)){e.addEventListener("input",function(){t.textContent=this.value});var n=document.getElementById("bet-toggle");n&&n.addEventListener("click",function(){R||(Z=!Z,n.classList.toggle("is-active",Z))});var a=document.getElementById("submit-btn");a&&a.addEventListener("click",fn);var r=document.getElementById("steal-btn");r&&r.addEventListener("click",Ln);var i=document.getElementById("steal-modal-close");i&&i.addEventListener("click",Pe);var o=document.getElementById("steal-modal");if(o){var s=o.querySelector(".steal-modal-backdrop");s&&s.addEventListener("click",Pe)}}}function fn(){if(!R){var e=document.getElementById("year-slider"),t=document.getElementById("submit-btn");if(!(!e||!t)){var n=parseInt(e.value,10);t.disabled=!0,t.classList.add("is-loading"),f&&f.readyState===WebSocket.OPEN?f.send(JSON.stringify({type:"submit",year:n,bet:Z})):(He("Connection lost. Please refresh."),t.disabled=!1,t.classList.remove("is-loading"))}}}function ot(){R=!0;var e=document.getElementById("year-selector"),t=document.getElementById("submit-btn"),n=document.getElementById("submitted-confirmation"),a=document.getElementById("bet-toggle");e&&e.classList.add("is-submitted"),t&&t.classList.add("hidden"),a&&a.classList.add("hidden"),n&&n.classList.remove("hidden")}function mn(e){var t=document.getElementById("submit-btn");t&&(t.disabled=!1,t.classList.remove("is-loading")),e.code==="ROUND_EXPIRED"?(He("Time's up!"),R=!0,t&&(t.disabled=!0)):e.code==="ALREADY_SUBMITTED"?ot():He(e.message||"Submission failed")}function He(e){var t=document.getElementById("submit-btn");t&&(t.textContent=e,t.classList.add("is-error"),setTimeout(function(){t.textContent=l("game.submitGuess"),t.classList.remove("is-error")},2e3))}function vn(){R=!1,Z=!1;var e=document.getElementById("year-selector"),t=document.getElementById("submit-btn"),n=document.getElementById("submitted-confirmation"),a=document.getElementById("year-slider"),r=document.getElementById("bet-toggle");if(e&&e.classList.remove("is-submitted"),t&&(t.disabled=!1,t.classList.remove("hidden","is-loading","is-error"),t.textContent=l("game.submitGuess")),r&&r.classList.remove("hidden","is-active"),n&&n.classList.add("hidden"),a){a.value=1990;var i=document.getElementById("selected-year");i&&(i.textContent="1990")}$=!1,De(),bn()}function gn(e,t){var n=document.getElementById("artist-challenge-container");if(n){if(!e||!e.options){n.classList.add("hidden");return}n.classList.remove("hidden");var a=document.getElementById("artist-options"),r=document.getElementById("artist-result"),i=Array.from(a.querySelectorAll(".artist-option-btn")).map(function(c){return c.dataset.artist}),o=e.options;if(JSON.stringify(i)!==JSON.stringify(o)&&(a.innerHTML="",o.forEach(function(c,m){var d=document.createElement("button");d.className="artist-option-btn",d.dataset.artist=c,d.dataset.index=m,d.textContent=c,d.addEventListener("click",function(){pn(c)}),a.appendChild(d)})),e.winner){var s=a.querySelectorAll(".artist-option-btn");if(s.forEach(function(c){c.classList.add("is-disabled"),c.classList.remove("is-loading","is-wrong");var m=e.correct_artist||pe;m&&c.dataset.artist===m&&c.classList.add("is-winner")}),e.winner===h)r.textContent=l("artistChallenge.youGotIt")||"You got it! +5 points",r.className="artist-result is-winner";else{var u=(l("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",e.winner);r.textContent=u,r.className="artist-result is-late"}r.classList.remove("hidden"),j=!0}else j||r.classList.add("hidden")}}function pn(e){var t=Date.now();if(!(t-st<dn)&&(st=t,!j)){var n=document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(e)+'"]');n&&n.classList.add("is-loading"),O=e;try{f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"artist_guess",artist:e}))}catch(a){console.error("Artist guess send failed:",a),n&&n.classList.remove("is-loading"),O=null}}}function yn(e){var t=O?document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(O)+'"]'):null;if(e.correct&&e.first){if(pe=O,t){t.classList.remove("is-loading"),t.classList.add("is-correct");var n=document.createElement("span");n.className="artist-points-badge",n.textContent="+10",t.appendChild(n)}lt(),ct(l("artistChallenge.youGotIt")||"You got it! +5 points",!0),j=!0}else if(e.correct&&!e.first){pe=O,t&&(t.classList.remove("is-loading"),t.classList.add("is-correct")),lt();var a=(l("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",e.winner||"Someone");ct(a,!1),j=!0}else t&&(t.classList.remove("is-loading"),t.classList.add("is-wrong"),setTimeout(function(){t.classList.remove("is-wrong")},500));O=null}function lt(){document.querySelectorAll(".artist-option-btn").forEach(function(e){e.classList.add("is-disabled"),e.classList.remove("is-loading")})}function ct(e,t){var n=document.getElementById("artist-result");n&&(n.textContent=e,n.className="artist-result "+(t?"is-winner":"is-late"),n.classList.remove("hidden"))}function bn(){j=!1,O=null,pe=null;var e=document.getElementById("artist-challenge-container");e&&e.classList.add("hidden");var t=document.getElementById("artist-options");t&&(t.innerHTML="");var n=document.getElementById("artist-result");n&&(n.classList.add("hidden"),n.className="artist-result hidden")}function hn(e,t){var n=document.getElementById("artist-reveal-section");if(n){if(!e||!e.correct_artist){n.classList.add("hidden");return}n.classList.remove("hidden");var a=document.getElementById("artist-reveal-name");a&&(a.textContent=e.correct_artist);var r=document.getElementById("artist-reveal-winner");if(r)if(e.winner)if(r.classList.remove("hidden"),e.winner===t)r.textContent=l("artistChallenge.youGotIt")||"You got it! +5 points",r.className="artist-reveal-winner is-you";else{var i=(l("artistChallenge.winnerWas")||"{winner} got it first!").replace("{winner}",e.winner);r.textContent=i,r.className="artist-reveal-winner is-other"}else r.textContent=l("artistChallenge.noWinner")||"No one guessed the artist",r.className="artist-reveal-winner artist-reveal-no-winner",r.classList.remove("hidden")}}function En(e){if(!(!h||!e)){var t=e.find(function(r){return r.name===h});if(t){$=t.steal_available&&!R;var n=document.getElementById("steal-indicator"),a=document.getElementById("steal-btn");$?(n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden")):De()}}}function De(){var e=document.getElementById("steal-indicator"),t=document.getElementById("steal-btn");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}function Ln(){!$||R||f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"get_steal_targets"}))}function wn(e){var t=document.getElementById("steal-modal"),n=document.getElementById("steal-target-list");if(!(!t||!n)){if(n.innerHTML="",!e||e.length===0){var a=document.createElement("p");a.className="steal-no-targets",a.textContent=l("steal.waitForSubmit"),n.appendChild(a)}else e.forEach(function(r){var i=document.createElement("button");i.className="steal-target-btn",i.textContent=r,i.addEventListener("click",function(){In(r)}),n.appendChild(i)});t.classList.remove("hidden")}}function Pe(){var e=document.getElementById("steal-modal");e&&e.classList.add("hidden")}function In(e){return H(this,null,function*(){var t=l("steal.confirm").replace("{name}",e),n=yield le(l("steal.confirmTitle")||"Steal Answer?",t,l("steal.confirmButton")||"Steal",l("common.cancel"));n&&(f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"steal",target:e})),Pe())})}function Bn(e){if(e.success){$=!1,R=!0,De();var t=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation");t&&t.classList.add("is-submitted"),n&&n.classList.add("hidden"),a&&a.classList.remove("hidden"),_n(e.target,e.year);var r=document.getElementById("selected-year"),i=document.getElementById("year-slider");r&&(r.textContent=e.year),i&&(i.value=e.year)}}function Sn(e){wn(e.targets||[])}function _n(e,t){var n=document.getElementById("steal-confirmation"),a=document.getElementById("steal-confirmation-text");if(!(!n||!a)){var r=l("steal.success").replace("{name}",e).replace("{year}",t);a.textContent=r,n.classList.remove("hidden"),setTimeout(function(){n.classList.add("hidden")},3e3)}}function dt(e){var t=e.song||{},n=e.players||[],a=document.getElementById("reveal-round"),r=document.getElementById("reveal-total");a&&(a.textContent=e.round||1),r&&(r.textContent=e.total_rounds||10);var i=document.getElementById("reveal-album-cover");i&&(i.src=t.album_art||"/beatify/static/img/no-artwork.svg");var o=document.getElementById("correct-year");o&&(o.textContent=t.year||"????");var s=document.getElementById("song-title"),u=document.getElementById("song-artist");s&&(s.textContent=t.title||"Unknown Song"),u&&(u.textContent=t.artist||"Unknown Artist");var c=document.getElementById("fun-fact-container"),m=document.getElementById("fun-fact"),d=c?c.querySelector(".fun-fact-header"):null,v=Ye(t,"fun_fact");if(m&&(m.textContent=v||""),d&&(d.style.display=v?"flex":"none"),An(t),Tn(e.song_difficulty),c){var p=document.getElementById("song-rich-info"),w=p&&p.innerHTML.trim()!=="",b=v&&v.trim()!=="";c.classList.toggle("hidden",!b&&!w)}for(var L=null,I=0;I<n.length;I++)if(n[I].name===h){L=n[I];break}Gn(L,t.year),Fn(L,t.year),e.artist_challenge&&hn(e.artist_challenge,h),e.game_performance&&e.game_performance.is_new_record&&we("record"),Vn(n),e.round_analytics&&Cn(e.round_analytics,t.year),e.leaderboard&&it(e,"reveal-leaderboard-list",!0);var B=document.getElementById("reveal-admin-controls"),S=document.getElementById("next-round-btn");B&&L&&L.is_admin?(B.classList.remove("hidden"),S&&(e.last_round?(S.textContent=l("leaderboard.finalResults"),S.classList.add("is-final")):(S.textContent=l("admin.nextRound"),S.classList.remove("is-final")),S.disabled=!1)):B&&B.classList.add("hidden")}function Cn(e,t){var n=document.getElementById("round-analytics");if(!n||!e){n&&n.classList.add("hidden");return}if(e.total_submitted===0){n.innerHTML='<div class="analytics-empty">'+l("analytics.noSubmissions")+"</div>",n.classList.remove("hidden");return}var a="";if(e.average_guess!==null&&t){var r=Math.round(e.average_guess-t);r===0?a=l("analytics.onTarget"):r>0?a=l("analytics.yearsLate",{years:r}):a=l("analytics.yearsEarly",{years:Math.abs(r)})}var i=kn(e.all_guesses,t),o="";if(e.exact_match_players&&e.exact_match_players.length>0&&(o+='<div class="achievement-item"><span class="achievement-emoji">&#127919;</span><span class="achievement-label">'+l("analytics.exactMatches")+':</span><span class="achievement-names">'+e.exact_match_players.join(", ")+"</span></div>"),e.speed_champion&&e.speed_champion.names){var s=e.speed_champion.names.join(", ");o+='<div class="achievement-item"><span class="achievement-emoji">&#9889;</span><span class="achievement-label">'+l("analytics.speedChampion")+':</span><span class="achievement-names">'+s+'</span><span class="achievement-value">('+e.speed_champion.time+"s)</span></div>"}if(e.furthest_players&&e.furthest_players.length>0&&e.all_guesses&&e.all_guesses.length>0){var u=e.all_guesses[e.all_guesses.length-1].years_off;u>0&&(o+='<div class="achievement-item"><span class="achievement-emoji">&#128517;</span><span class="achievement-label">'+l("analytics.furthestGuess")+':</span><span class="achievement-names">'+e.furthest_players.join(", ")+'</span><span class="achievement-value">('+u+" years)</span></div>")}var c=e.average_guess!==null?Math.round(e.average_guess):"?";n.innerHTML='<h3 class="analytics-title">'+l("analytics.title")+'</h3><div class="analytics-stats-row"><div class="stat-primary"><span class="stat-label">'+l("analytics.averageGuess")+'</span><span class="stat-value">'+c+'</span></div><div class="stat-secondary"><span class="stat-value">'+e.accuracy_percentage+'%</span><span class="stat-label">'+l("analytics.accuracy",{percent:""}).replace("%","")+'</span></div></div><div class="stat-comparison-line">'+a+'</div><div class="analytics-histogram"><h4 class="histogram-title">'+l("analytics.histogram")+"</h4>"+i+"</div>"+(o?'<div class="analytics-achievements">'+o+"</div>":""),n.classList.remove("hidden")}function kn(e,t){var n=7;if(!e||e.length===0)return'<div class="histogram-empty">'+l("analytics.noGuesses")+"</div>";for(var a=e.map(function(Ia){return Ia.guess}),r=Math.min.apply(null,a),i=Math.max.apply(null,a),o=i-r,s=Math.max(1,Math.ceil(o/n)),u=s*n,c=u-o-1,m=r-Math.floor(c/2),d=[],v=0;v<n;v++){var p=m+v*s,w=p+s-1;d.push({start:p,end:w,count:0,containsCorrect:t>=p&&t<=w})}for(var b=0;b<a.length;b++)for(var L=a[b],I=0;I<d.length;I++)if(L>=d[I].start&&L<=d[I].end){d[I].count++;break}for(var B=1,S=0;S<d.length;S++)d[S].count>B&&(B=d[S].count);for(var F="",se=0;se<d.length;se++){var A=d[se],Y=A.count/B*100,Be=se*.05,Se="histogram-bar"+(A.containsCorrect?" is-correct":""),V=A.count>0?Math.max(Y,10):0,_e=A.count>0?'<span class="bar-count">'+A.count+"</span>":"",wa=s===1?String(A.start):A.start+"-"+String(A.end).slice(-2);F+='<div class="histogram-bar-wrapper" style="animation-delay: '+Be+'s"><div class="'+Se+'" style="height: '+V+'%">'+_e+'</div><span class="histogram-label">'+wa+"</span></div>"}return'<div class="histogram-bars">'+F+"</div>"}function xn(e){var t=document.getElementById("superlatives-container");if(t){if(!e||e.length===0){t.classList.add("hidden");return}var n="";e.forEach(function(a,r){var i="";switch(a.value_label){case"avg_time":i=a.value+"s "+l("superlatives.avgTime");break;case"streak":i=a.value+" "+l("superlatives.streak");break;case"bets":i=a.value+" "+l("superlatives.bets");break;case"points":i=a.value+" "+l("superlatives.points");break;case"close_guesses":i=a.value+" "+l("superlatives.closeGuesses");break;default:i=a.value}n+='<div class="superlative-card superlative-card--'+a.id+'" style="animation-delay: '+r*.2+'s"><div class="superlative-emoji">'+a.emoji+'</div><div class="superlative-title">'+l("superlatives."+a.title)+'</div><div class="superlative-player">'+_(a.player_name)+'</div><div class="superlative-value">'+i+"</div></div>"}),t.innerHTML=n,t.classList.remove("hidden")}}function Tn(e){var t=document.getElementById("song-difficulty");if(t){if(!e){t.classList.add("hidden");return}for(var n="",a=0;a<e.stars;a++)n+='<span class="star">&#9733;</span>';t.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+n+'</div><span class="difficulty-label">'+l("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+l("difficulty.accuracy")+"</span>",t.classList.remove("hidden")}}function An(e){var t=document.getElementById("song-rich-info");if(t){var n=[],a=Mn(e.chart_info||{});a.length>0&&(n=n.concat(a));var r=Nn(e.certifications||[]);r.length>0&&(n=n.concat(r));var i=Ye(e,"awards")||[],o=Hn(i);o.length>0&&(n=n.concat(o)),n.length>0?t.innerHTML='<div class="song-badges-row">'+n.join("")+"</div>":t.innerHTML=""}}function Mn(e){if(!e)return[];var t=[];if(e.billboard_peak&&e.billboard_peak>0){var n=e.weeks_on_chart?' <span class="chart-weeks">\xB7 '+e.weeks_on_chart+" "+l("reveal.weeksShort")+"</span>":"";t.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.billboard_peak+" "+l("reveal.chartBillboard")+n+"</span>")}return e.german_peak&&e.german_peak>0&&!e.billboard_peak&&t.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.german_peak+" "+l("reveal.chartGerman")+"</span>"),e.uk_peak&&e.uk_peak>0&&!e.billboard_peak&&t.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.uk_peak+" "+l("reveal.chartUK")+"</span>"),t}function Nn(e){if(!e||e.length===0)return[];for(var t=[],n=0;n<e.length;n++){var a=e[n],r=Rn(a),i=On(a);t.push('<span class="song-badge '+r+'"><span class="song-badge-icon">'+i+"</span>"+_(a)+"</span>")}return t}function Rn(e){var t=e.toLowerCase();return t.indexOf("diamond")!==-1?"song-badge--diamond":t.indexOf("platinum")!==-1?"song-badge--platinum":t.indexOf("gold")!==-1?"song-badge--gold":"song-badge--platinum"}function On(e){var t=e.toLowerCase();return t.indexOf("diamond")!==-1?"\u{1F48E}":t.indexOf("platinum")!==-1?"\u{1F4BF}":t.indexOf("gold")!==-1?"\u{1F947}":"\u{1F4BF}"}function Hn(e){if(!e||e.length===0)return[];for(var t=[],n=e.slice(0,3),a=0;a<n.length;a++){var r=n[a],i=Dn(r),o=Pn(r);t.push('<span class="song-badge '+i+'"><span class="song-badge-icon">'+o+"</span>"+_(r)+"</span>")}return e.length>3&&t.push('<span class="song-badges-more">+'+(e.length-3)+" more</span>"),t}function Dn(e){var t=e.toLowerCase();return t.indexOf("grammy")!==-1?"song-badge--grammy":t.indexOf("eurovision")!==-1?"song-badge--eurovision":t.indexOf("oscar")!==-1||t.indexOf("academy award")!==-1?"song-badge--oscar":t.indexOf("hall of fame")!==-1?"song-badge--halloffame":"song-badge--award"}function Pn(e){var t=e.toLowerCase();return t.indexOf("eurovision")!==-1?"\u{1F3A4}":t.indexOf("grammy")!==-1?"\u{1F3C6}":t.indexOf("hall of fame")!==-1?"\u2B50":"\u{1F3C6}"}function Gn(e,t){var n=document.getElementById("reveal-emotion"),a=document.getElementById("personal-result");if(!n)return;n.className="reveal-emotion",n.innerHTML="",n.classList.add("hidden"),a&&a.classList.remove("is-delayed"),Ie();var r=l("reveal.emotions");function i(v){return v[Math.floor(Math.random()*v.length)]}function o(v){return v===1?l("reveal.offByYear"):l("reveal.offByYears",{years:v})}var s="missed",u=i(r.missed),c=i(r.missedSub);if(e&&!e.missed_round){var m=e.years_off||0;m===0?(s="exact",u=i(r.exact),c=i(r.exactSub)):m<=2?(s="close",u=i(r.close),c=i(r.closeSub)+" "+o(m)):m<=5?(s="close",u=i(r.close),c=o(m)):(s="wrong",u=i(r.wrong),c=i(r.wrongSub)+" "+o(m))}else e&&e.missed_round&&(s="missed",u=i(r.missed),c=i(r.missedSub));var d='<span class="reveal-emotion-text">'+u+"</span>";c&&(d+='<div class="reveal-emotion-subtitle">'+c+"</div>"),n.innerHTML=d,n.classList.add("reveal-emotion--"+s),n.classList.remove("hidden"),s==="exact"&&we(),a&&s!=="missed"&&a.classList.add("is-delayed")}function Fn(e,t){var n=document.getElementById("result-content");if(n){if(!e){n.innerHTML='<div class="result-missed">Player not found</div>';return}if(e.missed_round){var a='<div class="result-missed-container"><div class="result-missed-icon">\u23F0</div><div class="result-missed-text">'+l("reveal.noSubmission")+"</div></div>",r=e.previous_streak||0;r>=2&&(a+='<div class="streak-broken"><span class="streak-broken-icon">\u{1F494}</span><span class="streak-broken-text">Lost '+r+"-streak!</span></div>"),a+='<div class="result-score is-zero">0 pts</div>',n.innerHTML=a;return}var i=e.years_off||0,o=i===0?l("reveal.exact"):i===1?l("reveal.yearOff",{years:1}):l("reveal.yearsOff",{years:i}),s=i===0?"is-exact":i<=3?"is-close":"is-far",u=e.speed_multiplier||1,c=e.base_score||0,m=u>1,d=e.streak_bonus||0,v=e.artist_bonus||0,p="";m&&c>0&&(p='<div class="result-row"><span class="result-label">'+l("reveal.baseScore")+'</span><span class="result-value">'+c+' pts</span></div><div class="result-row"><span class="result-label">'+l("reveal.speedBonus")+'</span><span class="result-value is-bonus">'+u.toFixed(2)+"x</span></div>");var w="";e.bet_outcome==="won"?w='<div class="result-row bet-won-row"><span class="result-label">\u{1F3B2} '+l("reveal.betWon").replace("! 2x points","")+'</span><span class="result-value is-bet-won">2x</span></div>':e.bet_outcome==="lost"&&(w='<div class="result-row bet-lost-row"><span class="result-label">\u{1F3B2} '+l("reveal.betLost")+'</span><span class="result-value is-bet-lost">-</span></div>');var b="";d>0&&(b='<div class="result-row streak-bonus-row"><span class="result-label">'+e.streak+'-streak bonus!</span><span class="result-value is-streak">+'+d+" pts</span></div>");var L="";v>0&&(L='<div class="result-row artist-bonus-row"><span class="result-label">\u{1F3A4} '+(l("artistChallenge.artistBonus")||"Artist Bonus")+'</span><span class="result-value">+'+v+" pts</span></div>");var I=e.round_score+d+v,B=d>0||v>0,S=e.round_score>=20,F=x.players[e.name],se=F?F.score:e.score-I,A=F?F.streak:0,Y=jt(A,e.streak||0);n.innerHTML='<div class="result-row"><span class="result-label">'+l("reveal.yourGuess")+'</span><span class="result-value">'+e.guess+'</span></div><div class="result-row"><span class="result-label">'+l("reveal.correctYear")+'</span><span class="result-value">'+t+'</span></div><div class="result-row"><span class="result-label">'+l("reveal.accuracy")+'</span><span class="result-value '+s+'">'+o+"</span></div>"+p+w+'<div class="result-score" id="personal-result-score">+<span class="score-value">0</span> pts</div>'+b+L+(B?'<div class="result-total">'+l("reveal.total")+': +<span class="total-value">0</span> pts</div>':"");var Be=n.querySelector(".score-value");Be&&(Nt(Be,0,e.round_score,{betWon:e.bet_outcome==="won",betLost:e.bet_outcome==="lost",streakMilestone:Y,isBigScore:S}),e.bet_outcome==="won"&&e.round_score>0&&setTimeout(function(){var V=document.getElementById("personal-result-score");V&&Je(V,e.round_score,{isBetWin:!0})},200));var Se=n.querySelector(".total-value");Se&&B&&(setTimeout(function(){Ae(Se,0,I,600)},300),Y&&setTimeout(function(){var V=n.querySelector(".result-total");if(V){var _e={3:20,5:50,10:100}[Y]||0;Je(V,_e,{isStreak:!0,text:"+"+_e+" "+Y+"-Streak!"})}},500))}}function Vn(e){var t=document.getElementById("reveal-results-cards");if(t){if(!e||e.length===0){t.innerHTML="";return}var n=e.slice().sort(function(r,i){return(i.round_score||0)-(r.round_score||0)}),a='<div class="results-cards-header">'+l("reveal.allPlayers")+"</div>";a+='<div class="results-cards-scroll">',n.forEach(function(r){var i=r.name===h,o=r.missed_round===!0,s=r.years_off||0,u=r.round_score||0,c=o?"is-score-zero":u>=10?"is-score-high":u>=1?"is-score-medium":"is-score-zero",m=o?"\u2014":r.guess,d=o?l("reveal.noGuessShort"):s===0?l("reveal.exact"):l("reveal.shortOff",{years:s}),v=r.bet?'<span class="card-bet">\u{1F3B2}</span>':"",p="";r.artist_bonus&&r.artist_bonus>0&&(p='<span class="player-card-artist-badge">\u{1F3A4} +'+r.artist_bonus+"</span>");var w="";if(r.stole_from)w='<div class="steal-badge"><span class="steal-badge-icon">\u{1F977}</span>'+l("steal.stolenFrom",{name:_(r.stole_from)})+"</div>";else if(r.was_stolen_by&&r.was_stolen_by.length>0){var b=r.was_stolen_by.map(_).join(", ");w='<div class="steal-badge steal-badge-victim"><span class="steal-badge-icon">\u{1F3AF}</span>'+l("steal.stolenBy",{name:b})+"</div>"}a+='<div class="result-card '+c+(i?" is-current":"")+'"><div class="card-name">'+_(r.name)+v+'</div><div class="card-guess">'+m+'</div><div class="card-accuracy">'+d+"</div>"+w+'<div class="card-score">+'+u+p+"</div></div>"}),a+="</div>",t.innerHTML=a}}function Wn(e){var t=e.leaderboard||[];t.forEach(function(b){b.is_current=b.name===h}),[1,2,3].forEach(function(b){var L=t.find(function(S){return S.rank===b}),I=document.getElementById("podium-"+b+"-name"),B=document.getElementById("podium-"+b+"-score");I&&(I.textContent=L?_(L.name):"---"),B&&(B.textContent=L?L.score:"0")});var n=t.find(function(b){return b.is_current}),a=document.getElementById("your-final-rank"),r=document.getElementById("your-final-score"),i=document.getElementById("stat-best-streak"),o=document.getElementById("stat-rounds"),s=document.getElementById("stat-bets");n&&(a&&(a.textContent="#"+n.rank),r&&(r.textContent=n.score+" "+l("leaderboard.points")),i&&(i.textContent=n.best_streak||0),o&&(o.textContent=n.rounds_played||0),s&&(s.textContent=n.bets_won||0));var u=document.getElementById("final-leaderboard-list");u&&(u.innerHTML=t.map(function(b){var L=b.is_current?"is-current":"",I=b.connected===!1?"final-entry--disconnected":"",B=b.connected===!1?'<span class="away-badge">(away)</span>':"";return'<div class="final-entry '+L+" "+I+'"><span class="final-rank">#'+b.rank+'</span><span class="final-name">'+_(b.name)+B+'</span><span class="final-score">'+b.score+"</span></div>"}).join("")),xn(e.superlatives);var c=document.getElementById("end-admin-controls"),m=document.getElementById("end-player-message");if(n&&n.is_admin){c&&c.classList.remove("hidden"),m&&m.classList.add("hidden");var d=document.getElementById("new-game-btn");d&&(d.onclick=jn)}else c&&c.classList.add("hidden"),m&&m.classList.remove("hidden");if(n){var v=e.total_rounds||10,p=n.best_streak||0,w=p===v&&v>0;w?we("perfect"):n.rank===1&&we("winner")}}function qn(e){var t=document.getElementById("pause-message");t&&(e.pause_reason==="admin_disconnected"?t.textContent="Waiting for host to reconnect...":e.pause_reason==="media_player_error"?t.textContent="Speaker unavailable. Please check your media player and try again.":t.textContent="Game paused. Please wait...")}function jn(){return H(this,null,function*(){var e=yield le(l("admin.newGameTitle")||"New Game?",l("admin.newGameConfirm")||"Start a new game?",l("admin.newGame")||"New Game",l("common.cancel"));if(e){var t=document.getElementById("new-game-btn");t&&(t.disabled=!0,t.textContent="Redirecting...");try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(n){}window.location.href="/beatify/admin"}})}var Ge=!1,Un=2e3;function ut(){if(!Ge&&f&&f.readyState===WebSocket.OPEN){Ge=!0;var e=document.getElementById("next-round-btn"),t=document.getElementById("next-round-admin-btn");if(e&&(e.disabled=!0,e.textContent="Loading..."),t){t.disabled=!0;var n=t.querySelector(".control-label");n&&(n.textContent="Wait...")}f.send(JSON.stringify({type:"admin",action:"next_round"})),setTimeout(function(){Ge=!1,e&&(e.disabled=!1),t&&(t.disabled=!1)},Un)}}let Fe=!1;var Yn=500;let ee=!1,Ve=.5;function ye(){return Fe?!1:(Fe=!0,setTimeout(function(){Fe=!1},Yn),!0)}function ft(){if(T){var e=document.getElementById("admin-control-bar");e&&(e.classList.remove("hidden"),document.body.classList.add("has-control-bar"))}}function be(){var e=document.getElementById("admin-control-bar");e&&(e.classList.add("hidden"),document.body.classList.remove("has-control-bar"))}function zn(){var e=document.getElementById("reaction-bar");e&&e.classList.remove("hidden")}function he(){var e=document.getElementById("reaction-bar");e&&e.classList.add("hidden")}function Jn(e){We||(We=!0,f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"reaction",emoji:e})))}function Qn(){var e=document.getElementById("reaction-bar");if(e){var t=e.querySelectorAll(".reaction-btn");t.forEach(function(n){n.addEventListener("click",function(){var a=n.getAttribute("data-emoji");a&&Jn(a)})})}}Qn();function Kn(e,t){var n=document.getElementById("reaction-container");if(n){var a=document.createElement("div");a.className="reaction-bubble",a.textContent=e+" "+t,a.style.left=20+Math.random()*60+"%",n.appendChild(a),setTimeout(function(){a.remove()},3e3)}}function mt(e){var t=document.getElementById("stop-song-btn"),n=document.getElementById("next-round-admin-btn");if(e==="PLAYING"){if(gt(),t&&!ee&&(t.classList.remove("is-disabled"),t.disabled=!1),n){n.classList.remove("is-disabled"),n.disabled=!1;var a=n.querySelector(".control-label");a&&(a.textContent="Skip")}}else if(e==="REVEAL"){if(t&&!ee&&(t.classList.remove("is-disabled"),t.disabled=!1),n){n.classList.remove("is-disabled"),n.disabled=!1;var a=n.querySelector(".control-label");a&&(a.textContent="Next")}}else if(n){n.classList.add("is-disabled"),n.disabled=!0;var a=n.querySelector(".control-label");a&&(a.textContent="Next")}}function Xn(){if(!ee&&ye()){if(!f||f.readyState!==WebSocket.OPEN){console.warn("[Beatify] Cannot stop song: WebSocket not connected");return}var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-disabled"),e.disabled=!0;var t=e.querySelector(".control-label");t&&(t.textContent="Stopping...")}f.send(JSON.stringify({type:"admin",action:"stop_song"}))}}function Zn(){if(Ve>=1){vt("max");return}ye()&&(!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"admin",action:"set_volume",direction:"up"})))}function $n(){if(Ve<=0){vt("min");return}ye()&&(!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"admin",action:"set_volume",direction:"down"})))}function vt(e){var t=document.getElementById("volume-indicator");t&&(t.textContent=e==="max"?"\u{1F50A} Max":"\u{1F507} Min",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},1e3))}function ea(){return H(this,null,function*(){var e=yield le(l("admin.endGameConfirm")||"End Game?",l("admin.endGameWarning")||"All players will be disconnected.",l("admin.endGame")||"End Game",l("common.cancel"));if(e&&ye()){if(!f||f.readyState!==WebSocket.OPEN){alert(l("errors.CONNECTION_LOST"));return}var t=document.getElementById("end-game-btn");if(t){t.disabled=!0;var n=t.querySelector(".control-label");n&&(n.textContent="Ending...")}f.send(JSON.stringify({type:"admin",action:"end_game"}))}})}function ta(){ut()}function na(){var e=document.getElementById("stop-song-btn"),t=document.getElementById("volume-up-btn"),n=document.getElementById("volume-down-btn"),a=document.getElementById("next-round-admin-btn"),r=document.getElementById("end-game-btn");e&&e.addEventListener("click",Xn),t&&t.addEventListener("click",Zn),n&&n.addEventListener("click",$n),a&&a.addEventListener("click",ta),r&&r.addEventListener("click",ea)}function aa(){ee=!0;var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-stopped"),e.classList.add("is-disabled"),e.disabled=!0;var t=e.querySelector(".control-icon"),n=e.querySelector(".control-label");t&&(t.textContent="\u2713"),n&&(n.textContent="Stopped")}}function gt(){ee=!1;var e=document.getElementById("stop-song-btn");if(e){e.classList.remove("is-stopped"),e.classList.remove("is-disabled"),e.disabled=!1;var t=e.querySelector(".control-icon"),n=e.querySelector(".control-label");t&&(t.textContent="\u23F9\uFE0F"),n&&(n.textContent="Stop")}}function ra(e){Ve=e,ia(e),sa(e)}function ia(e){var t=document.getElementById("volume-indicator");if(t){var n=Math.round(e*100);t.textContent="\u{1F50A} "+n+"%",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},1500)}}function sa(e){var t=document.getElementById("volume-up-btn"),n=document.getElementById("volume-down-btn");t&&t.classList.toggle("is-at-limit",e>=1),n&&n.classList.toggle("is-at-limit",e<=0)}let T=!1;function oa(){const e=sessionStorage.getItem("beatify_is_admin"),t=sessionStorage.getItem("beatify_admin_name");return e==="true"&&t&&(T=!0,h=t,sessionStorage.removeItem("beatify_is_admin")),T}function la(e){const t=document.getElementById("admin-controls"),n=document.getElementById("lobby-status"),a=document.getElementById("leave-game-container");if(!t)return;(!e||!Array.isArray(e))&&(e=[]);const r=e.find(function(o){return o.name===h});(r==null?void 0:r.is_admin)===!0?(t.classList.remove("hidden"),n&&n.classList.add("hidden"),a&&a.classList.add("hidden")):(t.classList.add("hidden"),n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"))}function ca(){const e=document.getElementById("start-game-btn");e==null||e.addEventListener("click",function(){!f||f.readyState!==WebSocket.OPEN||(e.disabled=!0,e.textContent="Starting...",f.send(JSON.stringify({type:"admin",action:"start_game"})))});const t=document.getElementById("leave-game-btn");t==null||t.addEventListener("click",function(){pa()})}let f=null,h=null,C=0;const te=10,da=3e4,Ee="beatify_player_name",Le="beatify_game_id",pt="beatify_language";let D=!1,ne=!1,We=!1;function yt(){return Math.min(1e3*Math.pow(2,C),da)}function ua(){try{var e=localStorage.getItem(Le),t=localStorage.getItem(Ee);if(console.log("[Beatify] Checking localStorage - storedGameId:",e,"currentGameId:",k,"storedName:",t),e&&e===k)return console.log("[Beatify] Game ID match, returning stored name:",t),t;e&&e!==k&&(console.log("[Beatify] Different game ID, clearing stored data"),localStorage.removeItem(Ee),localStorage.removeItem(Le))}catch(n){console.error("[Beatify] localStorage error:",n)}return null}function bt(e){try{localStorage.setItem(Ee,e),localStorage.setItem(Le,k),console.log("[Beatify] Stored player name:",e,"for game:",k)}catch(t){console.error("[Beatify] Failed to store player name:",t)}}function ae(){try{localStorage.removeItem(Ee),localStorage.removeItem(Le)}catch(e){}}function fa(e){try{localStorage.setItem(pt,e)}catch(t){}}function ma(){try{return localStorage.getItem(pt)}catch(e){return null}}function ht(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.remove("hidden")}function re(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.add("hidden")}function Et(e){var t=document.getElementById("reconnect-status");t&&(t.textContent="Reconnecting... (Attempt "+e+"/"+te+")")}function qe(){E("connection-lost-view")}function va(){var e=document.getElementById("retry-connection-btn");e&&e.addEventListener("click",function(){h?(C=0,E("loading-view"),ie(h)):ce()})}function ie(e){h=e,bt(e);const n=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+"/beatify/ws";f=new WebSocket(n),f.onopen=function(){C=0,D=!1,re();var a={type:"join",name:e};T&&(a.is_admin=!0),f.send(JSON.stringify(a))},f.onmessage=function(a){try{const r=JSON.parse(a.data);Lt(r)}catch(r){console.error("Failed to parse WebSocket message:",r)}},f.onclose=function(){if(ne){ne=!1;return}if(h&&C<te){D=!0,C++,ht(),Et(C);const a=yt();console.log("WebSocket closed. Reconnecting in "+a+"ms... (attempt "+C+")"),setTimeout(function(){ie(h)},a)}else C>=te&&(D=!1,re(),qe())},f.onerror=function(a){console.error("WebSocket error:",a)}}function Lt(e){const t=document.getElementById("join-btn"),n=document.getElementById("name-input");if(e.type==="state"){var a=e.players||[],r=a.find(function(o){return o.name===h});if(r&&(T=r.is_admin===!0),e.language&&(fa(e.language),typeof BeatifyI18n!="undefined"&&e.language!==BeatifyI18n.getLanguage()&&BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),tt(a),e.difficulty&&Re(e.difficulty),e.phase==="REVEAL"&&dt(e)})),e.phase==="LOBBY")q(),be(),he(),ge=0,U("warmup"),E("lobby-view"),tt(a),e.difficulty&&Re(e.difficulty),e.join_url&&Kt(e.join_url),la(a);else if(e.phase==="PLAYING"){var i=e.round||1;i!==ge&&(ge=i,vn()),U("party"),E("game-view"),me(),nn(e),e.difficulty&&Re(e.difficulty),e.deadline&&tn(e.deadline),un(),cn(),ft(),mt("PLAYING"),he()}else e.phase==="REVEAL"?(q(),U("party"),E("reveal-view"),dt(e),ft(),mt("REVEAL"),We=!1,zn()):e.phase==="PAUSED"?(q(),be(),he(),U("warmup"),E("paused-view"),qn(e)):e.phase==="END"&&(q(),be(),he(),ge=0,U("warmup"),E("end-view"),Wn(e),ae())}else if(e.type==="join_ack"){e.session_id&&At(e.session_id);try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(o){}}else if(e.type==="reconnect_ack")e.success&&e.name?(h=e.name,bt(e.name),Jt(e.name)):(Q(),ae(),h=null,E("join-view"));else if(e.type==="submit_ack")ot();else if(e.type==="error"){if(e.code==="ROUND_EXPIRED"||e.code==="ALREADY_SUBMITTED"){mn(e);return}if(e.code==="GAME_ENDED"){E("end-view");return}if(e.code==="NOT_ADMIN"){T=!1,be(),console.warn("Admin action rejected: not admin");return}if(e.code==="SESSION_TAKEOVER"){D=!1,re(),h=null,qe(),console.warn("Session taken over by another tab");return}if(e.code==="SESSION_NOT_FOUND"){Q(),ne=!0,f&&f.close(),E("join-view");return}if(e.code==="ADMIN_CANNOT_LEAVE"){ne=!1,alert(e.message||"Host cannot leave. End the game instead.");return}if(e.code==="INVALID_ACTION"&&e.message==="No song playing"){gt(),console.warn("[Beatify] Stop song failed: No song playing");return}E("join-view"),ba(e.message),t&&(t.disabled=!1,t.textContent=l("join.joinButton")),n&&n.focus(),h=null,ae()}else e.type==="song_stopped"?aa():e.type==="volume_changed"?ra(e.level):e.type==="game_ended"?ya():e.type==="left"?ga():e.type==="steal_targets"?Sn(e):e.type==="steal_ack"?Bn(e):e.type==="artist_guess_ack"?yn(e):e.type==="player_reaction"&&Kn(e.player_name,e.emoji)}function ga(){ae(),Q(),h=null,T=!1,E("join-view")}function pa(){return H(this,null,function*(){if(!(!f||f.readyState!==WebSocket.OPEN)){if(T){alert("Host cannot leave. End the game instead.");return}var e=yield le(l("player.leaveGameTitle")||"Leave Game?",l("player.leaveGameWarning")||"Your score will be lost.",l("player.leaveGame")||"Leave",l("common.cancel"));e&&(ne=!0,f.send(JSON.stringify({type:"leave"})))}})}function ya(){var e=T;ae(),Q();try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(n){}if(Ht(),qt(),Me.clear(),Ie(),h=null,T=!1,f&&f.readyState===WebSocket.OPEN&&f.close(),f=null,e){setTimeout(function(){window.location.href="/beatify/admin"},5e3);return}if(!(!Te||!Te.classList.contains("hidden"))){var t=document.getElementById("end-player-message");t&&(t.innerHTML='<p>Thanks for playing!</p><p class="rejoin-hint">Scan the QR code again to join the next game.</p>',t.classList.remove("hidden")),E("end-view")}}function ba(e){const t=document.getElementById("name-validation-msg");t&&(t.textContent=e,t.classList.remove("hidden"))}function je(e){const t=(e||"").trim();return t?t.length>Qt?{valid:!1,error:"Name too long (max 20 characters)"}:{valid:!0,name:t}:{valid:!1,error:"Please enter a name"}}function wt(){const e=document.getElementById("name-input"),t=document.getElementById("join-btn"),n=document.getElementById("name-validation-msg");if(!e||!t)return;const a=je(e.value);a.valid&&(t.disabled=!0,t.textContent="Joining...",n&&n.classList.add("hidden"),ie(a.name))}function ha(){const e=document.getElementById("name-input"),t=document.getElementById("join-btn"),n=document.getElementById("name-validation-msg");!e||!t||(e.addEventListener("input",function(){const a=je(this.value);t.disabled=!a.valid,n&&(n.textContent=!a.valid&&this.value?a.error:"",n.classList.toggle("hidden",a.valid||!this.value))}),t.addEventListener("click",wt),e.addEventListener("keypress",function(a){a.key==="Enter"&&!t.disabled&&wt()}))}const Ea=E;E=function(e){Ea(e),(e==="join-view"||e==="loading-view"||e==="not-found-view"||e==="ended-view"||e==="in-progress-view"||e==="connection-lost-view")&&U("calm"),e==="join-view"&&setTimeout(function(){var t=document.getElementById("name-input");t&&t.focus()},100)};function U(e){document.body.classList.remove("energy-calm","energy-warmup","energy-party"),document.body.classList.add("energy-"+e)}var P=null,G=null;function we(e){if(K.prefersReducedMotion()){It();return}if(typeof confetti=="undefined"){console.warn("[Confetti] Library not loaded");return}Ie();var t=K.getQualitySettings(),n=t.confettiParticles;if(n===0){It();return}var a=K.getDeviceTier(),r=a==="low"?.5:a==="medium"?.75:1;switch(e=e||"exact",e){case"exact":var i=Math.round(2e3*r),o=Date.now()+i;(function p(){confetti({particleCount:n,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<o&&(P=requestAnimationFrame(p))})();break;case"record":var s=Math.round(3e3*r),u=Date.now()+s;(function p(){confetti({particleCount:Math.round(n*.67),spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<u&&(P=requestAnimationFrame(p))})();break;case"winner":var c=Math.round(4e3*r),m=Date.now()+c;(function p(){confetti({particleCount:Math.round(n*.67),angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:Math.round(n*.67),angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<m&&(P=requestAnimationFrame(p))})();break;case"perfect":var d=Math.round(5e3*r),v=Date.now()+d;G=setInterval(function(){confetti({particleCount:n*2,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},a==="low"?750:500),setTimeout(function(){G&&(clearInterval(G),G=null)},d),function p(){confetti({particleCount:Math.round(n*.5),angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:Math.round(n*.5),angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<v&&(P=requestAnimationFrame(p))}();break;default:console.warn("[Confetti] Unknown type:",e)}}function Ie(){P&&(cancelAnimationFrame(P),P=null),G&&(clearInterval(G),G=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function It(){var e=document.getElementById("reveal-emotion");if(e){var t=e.querySelector(".celebration-icon");if(!t){var n=document.createElement("span");n.className="celebration-icon",n.textContent=" \u{1F389}",e.appendChild(n)}}}function La(){var e=document.getElementById("next-round-btn");e&&e.addEventListener("click",ut);var t=document.getElementById("reveal-view");t&&t.addEventListener("click",function(n){n.target.tagName==="BUTTON"||n.target.closest("button")||(Me.isRunning()&&Me.skipAll(),Ie())})}function Bt(){return H(this,null,function*(){var e=K.getDeviceTier();document.body.classList.add("device-tier-"+e);var t=yield Tt();if(!t)console.error("[Player] BeatifyI18n module failed to load - UI will use fallback text");else{var n=ma();yield BeatifyI18n.init(n),BeatifyI18n.initPageTranslations()}var a=document.getElementById("dashboard-hint-url");if(a&&(a.textContent=window.location.origin+"/beatify/dashboard"),ha(),Xt(),en(),ca(),La(),na(),va(),Dt(),Pt(),oa()&&h){ie(h);return}var r=ua();if(r&&k){console.log("[Beatify] Auto-reconnecting as:",r),ie(r);return}if(r){var i=document.getElementById("name-input"),o=document.getElementById("join-btn");if(i&&(i.value=r,o)){var s=je(r);o.disabled=!s.valid}}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Bt):Bt(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Beatify] SW registered:",e.scope)}).catch(function(e){console.warn("[Beatify] SW registration failed:",e)})})})();})();
//# sourceMappingURL=player.min.js.map
