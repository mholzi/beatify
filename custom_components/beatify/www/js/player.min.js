(()=>{var be=(He,C,G)=>new Promise((he,ae)=>{var Ee=M=>{try{q(G.next(M))}catch(U){ae(U)}},Le=M=>{try{q(G.throw(M))}catch(U){ae(U)}},q=M=>M.done?he(M.value):Promise.resolve(M.value).then(Ee,Le);q((G=G.apply(He,C)).next())});(function(){"use strict";var mt,vt;const C=new URLSearchParams(window.location.search).get("game"),G=document.getElementById("loading-view"),he=document.getElementById("not-found-view"),ae=document.getElementById("ended-view"),Ee=document.getElementById("in-progress-view"),Le=document.getElementById("join-view"),q=document.getElementById("lobby-view"),M=document.getElementById("game-view"),U=document.getElementById("reveal-view"),gt=document.getElementById("paused-view"),Ie=document.getElementById("end-view"),pt=document.getElementById("connection-lost-view");function E(e){[G,he,ae,Ee,Le,q,M,U,gt,Ie,pt].forEach(function(n){n&&n.classList.add("hidden")});const t=document.getElementById(e);t&&t.classList.remove("hidden")}function yt(e){return!e||typeof e!="string"?!1:/^[a-zA-Z0-9_-]{8,16}$/.test(e)}function bt(e,t){return be(this,null,function*(){e=e||3e3,t=t||50;for(var n=Date.now();typeof BeatifyI18n=="undefined";){if(Date.now()-n>e)return!1;yield new Promise(function(a){setTimeout(a,t)})}return!0})}function d(e,t){if(typeof BeatifyI18n!="undefined"&&BeatifyI18n.t)return BeatifyI18n.t(e,t);var n=e.split(".").pop().replace(/([A-Z])/g," $1").replace(/^./,function(a){return a.toUpperCase()}).trim();return t&&typeof t=="object"&&Object.keys(t).forEach(function(a){n=n.replace(new RegExp("\\{"+a+"\\}","g"),t[a])}),n}function De(e,t){if(!e)return null;var n=typeof BeatifyI18n!="undefined"?BeatifyI18n.getLanguage():"en";if(n&&n!=="en"){var a=t+"_"+n;if(e[a])return e[a]}return e[t]||null}function re(){return be(this,null,function*(){if(!C){E("not-found-view");return}if(!yt(C)){E("not-found-view");return}try{const a=yield(yield fetch(`/beatify/api/game-status?game=${encodeURIComponent(C)}`)).json();if(!a.exists){E("not-found-view");return}if(a.phase==="END"){E("ended-view");return}var e=sessionStorage.getItem("beatify_admin_name");if(e)return;var t=Pe();if(t){qe();return}a.can_join?E("join-view"):E("in-progress-view")}catch(n){console.error("Failed to check game status:",n),E("not-found-view")}})}re(),(mt=document.getElementById("refresh-btn"))==null||mt.addEventListener("click",()=>{E("loading-view"),re()}),(vt=document.getElementById("retry-btn"))==null||vt.addEventListener("click",()=>{E("loading-view"),re()});var ie="beatify_session";function ht(e){var t=location.protocol==="https:"?"; Secure":"";document.cookie=ie+"="+e+"; path=/beatify; SameSite=Strict; max-age=86400"+t}function Pe(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){var n=e[t].trim();if(n.indexOf(ie+"=")===0)return n.substring(ie.length+1)}return null}function z(){document.cookie=ie+"=; path=/beatify; max-age=0"}function se(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function Et(e){return 1-Math.pow(1-e,4)}function we(e,t,n,a,r){if(se()||t===n)return e.textContent=n,{cancel:function(){},skipToEnd:function(){e.textContent=n}};var i=Y.getQualitySettings();if(i.scoreDuration===0)return e.textContent=n,{cancel:function(){},skipToEnd:function(){e.textContent=n}};var o=Math.min(a,i.scoreDuration||a);r=r||Et;var s=null,u=null,c=!1,v=n;function l(g){if(!c){s||(s=g);var p=g-s,w=Math.min(p/o,1),b=r(w),L=Math.round(t+(v-t)*b);e.textContent=L,w<1&&(u=requestAnimationFrame(l))}}return u=requestAnimationFrame(l),{cancel:function(){c=!0,u&&cancelAnimationFrame(u)},skipToEnd:function(){c=!0,u&&cancelAnimationFrame(u),e.textContent=v}}}function Lt(e,t,n,a){a=a||{};var r=500;a.betWon?r=800:a.isBigScore?r=700:a.betLost&&(r=400),e.classList.add("score-animating");var i=null;a.betWon?i="score-glow-gold":a.betLost?(i="score-shake",e.classList.add("score-flash-red")):a.streakMilestone?i="score-burst":a.isBigScore&&(i="score-pop"),i&&!se()&&e.classList.add(i),we(e,t,n,r);function o(){e.classList.remove("score-animating"),i&&e.classList.remove(i),e.classList.remove("score-flash-red")}i&&!se()?e.addEventListener("animationend",function s(){e.removeEventListener("animationend",s),o()}):setTimeout(o,r+50)}function Fe(e,t,n){if(n=n||{},!se()){var a=document.createElement("div");a.className="points-popup",a.textContent=n.text||"+"+t,n.isStreak?a.classList.add("points-popup--streak"):n.isBetWin&&a.classList.add("points-popup--gold");var r=e.getBoundingClientRect();a.style.left=r.left+r.width/2+"px",a.style.top=r.top+"px",document.body.appendChild(a),a.addEventListener("animationend",function(){a.parentNode&&a.parentNode.removeChild(a)}),setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a)},1200)}}var x={players:{},leaderboard:[],initialized:!1};function It(){return x.initialized}var Ve=[3,5,10],Y=function(){var e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=e.matches;e.addEventListener("change",function(r){t=r.matches});var n=null;function a(){if(n!==null)return n;var r=navigator.hardwareConcurrency||2,i=navigator.deviceMemory||4,o=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return r<=2||i<=2?n="low":r<=4||i<=4||o?n="medium":n="high",n}return a(),{prefersReducedMotion:function(){return t},getDeviceTier:a,getQualitySettings:function(){var r=a();if(t)return{confettiParticles:0,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!1};switch(r){case"low":return{confettiParticles:5,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!0};case"medium":return{confettiParticles:10,scoreDuration:300,leaderboardAnimation:"simplified",neonGlow:!1,enableAnimations:!0};default:return{confettiParticles:15,scoreDuration:500,leaderboardAnimation:"full",neonGlow:!0,enableAnimations:!0}}},ifMotionAllowed:function(r,i){t?i&&i():r()},withWillChange:function(r,i,o){r&&(r.style.willChange=i,setTimeout(function(){r&&r.style&&(r.style.willChange="auto")},(o||500)+100))}}}(),Be=function(){var e=[],t=!1,n=null,a=null,r=2e3;function i(){if(a&&(clearTimeout(a),a=null),e.length===0){t=!1,n=null;return}n=e.shift(),a=setTimeout(function(){n&&n.skipToEnd&&n.skipToEnd(),i()},r),n.run(function(){a&&(clearTimeout(a),a=null),i()})}return{add:function(o){e.push(o),t||(t=!0,i())},skipAll:function(){a&&(clearTimeout(a),a=null),n&&n.skipToEnd&&n.skipToEnd(),e.forEach(function(o){o.skipToEnd&&o.skipToEnd()}),e=[],t=!1,n=null},clear:function(){a&&(clearTimeout(a),a=null),e=[],t=!1,n=null},isRunning:function(){return t},getMaxDuration:function(){return maxDuration}}}(),Q={VISIBLE_BUFFER:2,ENTRY_HEIGHT:48,MIN_PLAYERS_FOR_LAZY:10,ROOT_MARGIN:"96px 0px",DEFAULT_VIEWPORT_HEIGHT:280},y={observer:null,fullData:[],visibleRange:{start:0,end:10},listEl:null,isLazyEnabled:!1};function wt(e){e&&(y.observer&&y.listEl!==e&&(y.observer.disconnect(),y.observer=null),!y.observer&&(y.listEl=e,y.observer=new IntersectionObserver(function(t){t.forEach(function(n){if(!(!n.isIntersecting||!y.isLazyEnabled)){var a=y.fullData,r=y.visibleRange,i=Q.VISIBLE_BUFFER;if(n.target.classList.contains("leaderboard-sentinel--top")){if(r.start>0){var o=Math.max(0,r.start-i);y.visibleRange.start=o,oe()}}else if(n.target.classList.contains("leaderboard-sentinel--bottom")&&r.end<a.length){var s=Math.min(a.length,r.end+i);y.visibleRange.end=s,oe()}}})},{root:e,rootMargin:Q.ROOT_MARGIN,threshold:0})))}function oe(){var e=y.listEl,t=y.fullData,n=y.visibleRange;if(!(!e||!t.length)){var a=Q.ENTRY_HEIGHT,r=n.start*a,i=(t.length-n.end)*a,o=e.scrollTop,s="";r>0&&(s+='<div class="leaderboard-spacer-top" style="height: '+r+'px;"></div>'),s+='<div class="leaderboard-sentinel leaderboard-sentinel--top" style="height: 1px;"></div>';for(var u=n.start;u<n.end&&u<t.length;u++)s+=Ge(t[u]);if(s+='<div class="leaderboard-sentinel leaderboard-sentinel--bottom" style="height: 1px;"></div>',i>0&&(s+='<div class="leaderboard-spacer-bottom" style="height: '+i+'px;"></div>'),e.innerHTML=s,e.scrollTop=o,y.observer){var c=e.querySelectorAll(".leaderboard-sentinel");c.forEach(function(v){y.observer.observe(v)})}}}function Ge(e){if(!e)return"";if(e.separator)return'<div class="leaderboard-separator">...</div>';var t=e.name||"Unknown",n=e.rank||0,a=e.score||0,r=n<=3?"is-top-"+n:"",i=e.is_current?"is-current":"",o="";e.rank_change>0||e._rankChange==="up"?o="leaderboard-entry--climbing leaderboard-entry--slide-up":(e.rank_change<0||e._rankChange==="down")&&(o="leaderboard-entry--falling leaderboard-entry--slide-down");var s="";e.rank_change>0?s='<span class="rank-up">\u25B2'+e.rank_change+"</span>":e.rank_change<0&&(s='<span class="rank-down">\u25BC'+Math.abs(e.rank_change)+"</span>");var u="";if(e.streak>=2){var c=e.streak>=5?"streak-indicator--hot":"";u='<span class="streak-indicator '+c+'">\u{1F525}'+e.streak+"</span>"}var v=e.connected===!1?"leaderboard-entry--disconnected":"",l=e.connected===!1?'<span class="away-badge">(away)</span>':"",g=e._displayScore!==void 0?e._displayScore:a;return'<div class="leaderboard-entry '+r+" "+i+" "+o+" "+v+'" data-rank="'+n+'" data-name="'+_(t)+'"><span class="entry-rank">#'+n+'</span><span class="entry-name">'+_(t)+l+'</span><span class="entry-meta">'+u+s+'</span><span class="entry-score" data-prev-score="'+(e._prevScore||a)+'">'+g+"</span></div>"}function We(e,t){for(var n=Q,a=y.listEl&&y.listEl.clientHeight||n.DEFAULT_VIEWPORT_HEIGHT,r=Math.ceil(a/n.ENTRY_HEIGHT),i=n.VISIBLE_BUFFER,o=-1,s=0;s<e.length;s++)if(e[s].name===t){o=s;break}var u,c;return o===-1||o<r?(u=0,c=Math.min(e.length,r+i*2)):o>=e.length-r?(u=Math.max(0,e.length-r-i),c=e.length):(u=Math.max(0,o-Math.floor(r/2)-i),c=Math.min(e.length,o+Math.ceil(r/2)+i)),{start:u,end:c}}function Bt(){y.observer&&(y.observer.disconnect(),y.observer=null),y.isLazyEnabled=!1,y.fullData=[]}function St(){var e;function t(){clearTimeout(e),e=setTimeout(function(){y.isLazyEnabled&&y.fullData.length>0&&(y.visibleRange=We(y.fullData,h),oe())},150)}window.addEventListener("resize",t),window.addEventListener("orientationchange",t)}var je={ITEM_HEIGHT:60,OVERSCAN:3,THRESHOLD:15,CONTAINER_HEIGHT:320},m={container:null,items:[],scrollTop:0,isVirtual:!1,topSpacer:null,bottomSpacer:null,contentWrapper:null,scrollHandler:null,resizeHandler:null};function _t(e){if(e){m.container=e;var t=!1;m.scrollHandler=function(){m.scrollTop=e.scrollTop,t||(requestAnimationFrame(function(){Se(),t=!1}),t=!0)};var n;m.resizeHandler=function(){clearTimeout(n),n=setTimeout(function(){m.isVirtual&&Se()},100)},e.addEventListener("scroll",m.scrollHandler,{passive:!0}),window.addEventListener("resize",m.resizeHandler)}}function kt(e,t){m.items=e,m.renderItem=t;var n=m.container;if(n){var a=n.scrollTop,r=m.isVirtual;e.length<je.THRESHOLD?(m.isVirtual=!1,n.classList.remove("player-list--virtual"),xt(e,t)):(m.isVirtual=!0,n.classList.add("player-list--virtual"),Ct(),Se()),r!==m.isVirtual&&a>0&&(n.scrollTop=a,m.scrollTop=a)}}function Ct(){var e=m.container;if(e){e.innerHTML="";var t=document.createElement("div");t.className="virtual-spacer-top",m.topSpacer=t;var n=document.createElement("div");n.className="virtual-content-wrapper",m.contentWrapper=n;var a=document.createElement("div");a.className="virtual-spacer-bottom",m.bottomSpacer=a,e.appendChild(t),e.appendChild(n),e.appendChild(a)}}function Se(){var e=je,t=m.items,n=m.container,a=m.contentWrapper;if(!(!n||!a||!t.length)){var r=n.clientHeight||e.CONTAINER_HEIGHT,i=m.scrollTop,o=e.ITEM_HEIGHT,s=e.OVERSCAN,u=Math.max(0,Math.floor(i/o)-s),c=Math.min(t.length,Math.ceil((i+r)/o)+s);m.topSpacer&&(m.topSpacer.style.height=u*o+"px"),m.bottomSpacer&&(m.bottomSpacer.style.height=(t.length-c)*o+"px");for(var v="",l=u;l<c;l++)v+=m.renderItem(t[l],l);a.innerHTML=v}}function xt(e,t){var n=m.container;if(n){for(var a="",r=0;r<e.length;r++)a+=t(e[r],r);n.innerHTML=a}}function Tt(){var e=m.container;e&&m.scrollHandler&&e.removeEventListener("scroll",m.scrollHandler),m.resizeHandler&&window.removeEventListener("resize",m.resizeHandler),m.container=null,m.items=[],m.isVirtual=!1,m.topSpacer=null,m.bottomSpacer=null,m.contentWrapper=null}function Mt(e,t){for(var n=0;n<Ve.length;n++){var a=Ve[n];if(e<a&&t>=a)return a}return null}function At(e){var t=e.map(function(a){return a.name}),n={};return t.forEach(function(a,r){var i=x.leaderboard.indexOf(a);i===-1?n[a]="new":r<i?n[a]="up":r>i&&(n[a]="down")}),n}function Nt(e,t){x.players={},e.forEach(function(n){x.players[n.name]={score:n.score,rank:n.rank||0,streak:n.streak||0}}),t&&(x.leaderboard=t.map(function(n){return n.name})),x.initialized=!0}function ra(){x.players={},x.leaderboard=[],x.initialized=!1}function Rt(e){return!e||typeof e!="string"?!1:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e)||/^[a-f0-9]{32}$/i.test(e)}function qe(){var e=Pe();if(!e||!Rt(e)){e&&z(),E("join-view");return}var t=window.location.protocol==="https:"?"wss:":"ws:",n=t+"//"+window.location.host+"/beatify/ws";f=new WebSocket(n),f.onopen=function(){k=0,O=!1,te(),f.send(JSON.stringify({type:"reconnect",session_id:e}))},f.onmessage=function(a){try{var r=JSON.parse(a.data);ct(r)}catch(i){console.error("Failed to parse WebSocket message:",i)}},f.onclose=function(){if(h&&k<Z){O=!0,k++,ot(),lt(k);var a=it();console.log("WebSocket closed. Reconnecting in "+a+"ms... (attempt "+k+")"),setTimeout(function(){qe()},a)}else k>=Z?(O=!1,te(),Re()):E("join-view")},f.onerror=function(a){console.error("WebSocket error:",a)}}function Ot(e){var t=document.getElementById("volume-indicator");t&&(t.textContent="Welcome back, "+e+"!",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},2e3))}const Ht=20;let Ue=[];function _(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function ze(e){const t=document.getElementById("player-list"),n=document.getElementById("player-count");if(!t)return;if(n){const s=e.length;n.textContent=s===1?d("lobby.playerJoined"):d("lobby.playersJoined",{count:s})}var a=e.slice().sort(function(s,u){return s.connected!==u.connected?s.connected?-1:1:0});const r=Ue.map(function(s){return s.name}),i=a.filter(function(s){return r.indexOf(s.name)===-1}).map(function(s){return s.name});m.container||_t(t);var o=function(s){var u=i.indexOf(s.name)!==-1,c=s.name===h,v=s.connected===!1,l=["player-card",u?"is-new":"",c?"player-card--you":"",v?"player-card--disconnected":""].filter(Boolean).join(" "),g=v?'<span class="away-badge">(away)</span>':"";return'<div class="'+l+'" data-player="'+_(s.name)+'"><span class="player-name">'+_(s.name)+(c?'<span class="you-badge">'+d("leaderboard.you")+"</span>":"")+g+"</span></div>"};kt(a,o),setTimeout(function(){var s=m.isVirtual?m.contentWrapper:t;if(!s)return;const u=s.querySelectorAll(".is-new");for(let c=0;c<u.length;c++)u[c].classList.remove("is-new")},2e3),Ue=e.slice()}function _e(e){var t={easy:"game.difficultyEasy",normal:"game.difficultyNormal",hard:"game.difficultyHard"}[e]||"game.difficultyNormal",n=d(t),a=document.getElementById("lobby-difficulty-badge"),r=document.getElementById("game-difficulty-badge");a&&(a.textContent=n,a.className="difficulty-badge difficulty-badge--"+(e||"normal")),r&&(r.textContent=n,r.className="difficulty-badge difficulty-badge--"+(e||"normal"))}let N=null;function Dt(e){if(e){N=e;var t=document.getElementById("player-qr-code");t&&(t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',t.onclick=Ye,t.onkeydown=function(n){(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),Ye())})}}function Ye(){if(N){var e=document.getElementById("qr-modal"),t=document.getElementById("qr-modal-code");if(!(!e||!t)){t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:N,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',e.classList.remove("hidden"),document.body.style.overflow="hidden";var n=document.getElementById("qr-modal-close");n&&n.focus()}}}function ke(){var e=document.getElementById("qr-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="")}function Pt(){var e=document.getElementById("qr-modal"),t=e?e.querySelector(".qr-modal-backdrop"):null,n=document.getElementById("qr-modal-close");t&&t.addEventListener("click",ke),n&&n.addEventListener("click",ke),document.addEventListener("keydown",function(a){a.key==="Escape"&&e&&!e.classList.contains("hidden")&&ke()})}function Ft(){if(N){var e=document.getElementById("invite-modal"),t=document.getElementById("invite-modal-code"),n=document.getElementById("invite-modal-url");if(!(!e||!t)){t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:N,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',n&&(n.value=N),e.classList.remove("hidden"),document.body.style.overflow="hidden";var a=document.getElementById("invite-modal-close");a&&a.focus()}}}function le(){var e=document.getElementById("invite-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="");var t=document.getElementById("invite-copy-feedback");t&&t.classList.add("hidden")}function Vt(){var e=document.getElementById("invite-modal-url"),t=document.getElementById("invite-copy-feedback");!e||!N||(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(N).then(function(){Je(t)}).catch(function(){Qe(e,t)}):Qe(e,t))}function Qe(e,t){e.select(),e.setSelectionRange(0,99999);try{document.execCommand("copy"),Je(t)}catch(n){console.warn("[Beatify] Copy failed:",n)}}function Je(e){e&&(e.classList.remove("hidden"),setTimeout(function(){e.classList.add("hidden")},2e3))}function Gt(){var e=document.getElementById("invite-modal"),t=e?e.querySelector(".invite-modal-backdrop"):null,n=document.getElementById("invite-modal-close"),a=document.getElementById("invite-players-btn"),r=document.getElementById("invite-copy-btn");t&&t.addEventListener("click",le),n&&n.addEventListener("click",le),a&&a.addEventListener("click",Ft),r&&r.addEventListener("click",Vt),document.addEventListener("keydown",function(i){i.key==="Escape"&&e&&!e.classList.contains("hidden")&&le()})}let ce=null;function Wt(e){W();var t=document.getElementById("timer");if(!t)return;t.classList.remove("timer--warning","timer--critical");function n(){var a=Date.now(),r=Math.max(0,Math.ceil((e-a)/1e3));t.textContent=r,r<=5?(t.classList.remove("timer--warning"),t.classList.add("timer--critical")):r<=10?(t.classList.remove("timer--critical"),t.classList.add("timer--warning")):t.classList.remove("timer--warning","timer--critical"),r===10?t.setAttribute("aria-label","10 seconds remaining"):r===5?t.setAttribute("aria-label","5 seconds!"):r===0?t.setAttribute("aria-label","Time is up!"):t.setAttribute("aria-label","Time remaining: "+r+" seconds"),r<=0&&W()}n(),ce=setInterval(n,1e3)}function W(){ce&&(clearInterval(ce),ce=null)}function jt(e){var t=document.getElementById("current-round"),n=document.getElementById("total-rounds"),a=document.getElementById("last-round-banner");t&&(t.textContent=e.round||1),n&&(n.textContent=e.total_rounds||10),a&&(e.last_round?a.classList.remove("hidden"):a.classList.add("hidden"));var r=document.getElementById("album-cover"),i=document.getElementById("album-loading");if(r&&e.song){i&&i.classList.remove("hidden");var o=e.song.album_art||"/beatify/static/img/no-artwork.svg";r.onload=function(){i&&i.classList.add("hidden")},r.onerror=function(){r.src="/beatify/static/img/no-artwork.svg",i&&i.classList.add("hidden")},r.src=o}Ut(e.players),e.leaderboard&&Ke(e,"leaderboard-list"),en(e.players)}function qt(e){if(!e)return"?";var t=e.trim();if(!t)return"?";var n=t.split(/[\s-]+/).filter(Boolean);return n.length>=2?(n[0][0]+n[1][0]).toUpperCase():t.slice(0,Math.min(2,t.length)).toUpperCase()}function Ut(e){var t=document.getElementById("submission-tracker"),n=document.getElementById("submitted-players"),a=document.getElementById("submission-count");if(!(!t||!n||!a)){var r=e||[],i=r.filter(function(c){return c.submitted}).length,o=r.length;a.textContent=d("game.submittedCount",{count:i,total:o});var s=i===o&&o>0;t.classList.toggle("all-submitted",s);var u=r.length>10;if(t.classList.toggle("is-compact",u),u){n.innerHTML="";return}n.innerHTML=r.map(function(c){var v=qt(c.name),l=c.name===h,g=c.connected===!1,p=["player-indicator",c.submitted?"is-submitted":"",l?"is-current-player":"",c.bet?"is-betting":"",g?"player-indicator--disconnected":""].filter(Boolean).join(" ");return'<div class="'+p+'"><div class="player-avatar"><span class="player-initials">'+_(v)+'</span></div><span class="player-name">'+_(c.name)+"</span></div>"}).join("")}}function Ke(e,t,n){var a=e.leaderboard||[],r=document.getElementById(t||"leaderboard-list");if(r){var i=n&&It(),o=i?At(a):{};a.forEach(function(l){l.is_current=l.name===h;var g=o[l.name];g&&(l._rankChange=g);var p=x.players[l.name],w=p?p.score:l.score;l._prevScore=w,l._displayScore=n?w:l.score});var s=zt(a,h),u=a.length>=Q.MIN_PLAYERS_FOR_LAZY;if(u)y.observer||wt(r),y.fullData=s,y.isLazyEnabled=!0,y.listEl=r,y.visibleRange=We(s,h),oe();else{y.isLazyEnabled=!1;var c="";s.forEach(function(l){c+=Ge(l)}),r.innerHTML=c}var v=[];i&&s.forEach(function(l){!l.separator&&l._prevScore!==l.score&&v.push({name:l.name,prevScore:l._prevScore,newScore:l.score})}),i&&v.length>0&&requestAnimationFrame(function(){for(var l={},g=r.querySelectorAll(".leaderboard-entry[data-name]"),p=0;p<g.length;p++){var w=g[p],b=w.getAttribute("data-name");b&&(l[b]=w)}v.forEach(function(L){var I=l[L.name];if(I){var B=I.querySelector(".entry-score");B&&we(B,L.prevScore,L.newScore,500)}})}),a.length>8&&Yt(r),Qt(a),Nt(e.players||[],a)}}function zt(e,t){if(e.length<=10)return e;for(var n=e.slice(0,5),a=e.slice(-3),r=-1,i=0;i<e.length;i++)if(e[i].name===t){r=i;break}return r<5||r>=e.length-3?[].concat(n,[{separator:!0}],a):[].concat(n,[{separator:!0}],[e[r]],[{separator:!0}],a)}function Yt(e){var t=e.querySelector(".leaderboard-entry.is-current");t&&t.scrollIntoView({behavior:"smooth",block:"center"})}function Qt(e){var t=document.getElementById("leaderboard-you"),n=e.find(function(a){return a.is_current});t&&n&&(t.textContent=d("leaderboard.you")+" #"+n.rank,t.classList.remove("hidden"))}function Jt(){var e=document.getElementById("leaderboard-toggle"),t=document.getElementById("game-leaderboard");e&&t&&e.addEventListener("click",function(){t.classList.toggle("is-expanded");var n=e.querySelector(".toggle-icon");n&&(n.textContent=t.classList.contains("is-expanded")?"\u25B2":"\u25BC")})}let R=!1,J=!1,de=0,K=!1;function Kt(){var e=document.getElementById("year-slider"),t=document.getElementById("selected-year");if(!(!e||!t)){e.addEventListener("input",function(){t.textContent=this.value});var n=document.getElementById("bet-toggle");n&&n.addEventListener("click",function(){R||(J=!J,n.classList.toggle("is-active",J))});var a=document.getElementById("submit-btn");a&&a.addEventListener("click",Xt);var r=document.getElementById("steal-btn");r&&r.addEventListener("click",tn);var i=document.getElementById("steal-modal-close");i&&i.addEventListener("click",Te);var o=document.getElementById("steal-modal");if(o){var s=o.querySelector(".steal-modal-backdrop");s&&s.addEventListener("click",Te)}}}function Xt(){if(!R){var e=document.getElementById("year-slider"),t=document.getElementById("submit-btn");if(!(!e||!t)){var n=parseInt(e.value,10);t.disabled=!0,t.classList.add("is-loading"),f&&f.readyState===WebSocket.OPEN?f.send(JSON.stringify({type:"submit",year:n,bet:J})):(Ce("Connection lost. Please refresh."),t.disabled=!1,t.classList.remove("is-loading"))}}}function Xe(){R=!0;var e=document.getElementById("year-selector"),t=document.getElementById("submit-btn"),n=document.getElementById("submitted-confirmation"),a=document.getElementById("bet-toggle");e&&e.classList.add("is-submitted"),t&&t.classList.add("hidden"),a&&a.classList.add("hidden"),n&&n.classList.remove("hidden")}function Zt(e){var t=document.getElementById("submit-btn");t&&(t.disabled=!1,t.classList.remove("is-loading")),e.code==="ROUND_EXPIRED"?(Ce("Time's up!"),R=!0,t&&(t.disabled=!0)):e.code==="ALREADY_SUBMITTED"?Xe():Ce(e.message||"Submission failed")}function Ce(e){var t=document.getElementById("submit-btn");t&&(t.textContent=e,t.classList.add("is-error"),setTimeout(function(){t.textContent=d("game.submitGuess"),t.classList.remove("is-error")},2e3))}function $t(){R=!1,J=!1;var e=document.getElementById("year-selector"),t=document.getElementById("submit-btn"),n=document.getElementById("submitted-confirmation"),a=document.getElementById("year-slider"),r=document.getElementById("bet-toggle");if(e&&e.classList.remove("is-submitted"),t&&(t.disabled=!1,t.classList.remove("hidden","is-loading","is-error"),t.textContent=d("game.submitGuess")),r&&r.classList.remove("hidden","is-active"),n&&n.classList.add("hidden"),a){a.value=1990;var i=document.getElementById("selected-year");i&&(i.textContent="1990")}K=!1,xe()}function en(e){if(!(!h||!e)){var t=e.find(function(r){return r.name===h});if(t){K=t.steal_available&&!R;var n=document.getElementById("steal-indicator"),a=document.getElementById("steal-btn");K?(n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden")):xe()}}}function xe(){var e=document.getElementById("steal-indicator"),t=document.getElementById("steal-btn");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}function tn(){!K||R||f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"get_steal_targets"}))}function nn(e){var t=document.getElementById("steal-modal"),n=document.getElementById("steal-target-list");if(!(!t||!n)){if(n.innerHTML="",!e||e.length===0){var a=document.createElement("p");a.className="steal-no-targets",a.textContent=d("steal.waitForSubmit"),n.appendChild(a)}else e.forEach(function(r){var i=document.createElement("button");i.className="steal-target-btn",i.textContent=r,i.addEventListener("click",function(){an(r)}),n.appendChild(i)});t.classList.remove("hidden")}}function Te(){var e=document.getElementById("steal-modal");e&&e.classList.add("hidden")}function an(e){var t=d("steal.confirm").replace("{name}",e);confirm(t)&&(f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"steal",target:e})),Te())}function rn(e){if(e.success){K=!1,R=!0,xe();var t=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation");t&&t.classList.add("is-submitted"),n&&n.classList.add("hidden"),a&&a.classList.remove("hidden"),on(e.target,e.year);var r=document.getElementById("selected-year"),i=document.getElementById("year-slider");r&&(r.textContent=e.year),i&&(i.value=e.year)}}function sn(e){nn(e.targets||[])}function on(e,t){var n=document.getElementById("steal-confirmation"),a=document.getElementById("steal-confirmation-text");if(!(!n||!a)){var r=d("steal.success").replace("{name}",e).replace("{year}",t);a.textContent=r,n.classList.remove("hidden"),setTimeout(function(){n.classList.add("hidden")},3e3)}}function Ze(e){var t=e.song||{},n=e.players||[],a=document.getElementById("reveal-round"),r=document.getElementById("reveal-total");a&&(a.textContent=e.round||1),r&&(r.textContent=e.total_rounds||10);var i=document.getElementById("reveal-album-cover");i&&(i.src=t.album_art||"/beatify/static/img/no-artwork.svg");var o=document.getElementById("correct-year");o&&(o.textContent=t.year||"????");var s=document.getElementById("song-title"),u=document.getElementById("song-artist");s&&(s.textContent=t.title||"Unknown Song"),u&&(u.textContent=t.artist||"Unknown Artist");var c=document.getElementById("fun-fact-container"),v=document.getElementById("fun-fact"),l=c?c.querySelector(".fun-fact-header"):null,g=De(t,"fun_fact");if(v&&(v.textContent=g||""),l&&(l.style.display=g?"flex":"none"),fn(t),un(e.song_difficulty),c){var p=document.getElementById("song-rich-info"),w=p&&p.innerHTML.trim()!=="",b=g&&g.trim()!=="";c.classList.toggle("hidden",!b&&!w)}for(var L=null,I=0;I<n.length;I++)if(n[I].name===h){L=n[I];break}En(L,t.year),Ln(L,t.year),e.game_performance&&e.game_performance.is_new_record&&ge("record"),In(n),e.round_analytics&&ln(e.round_analytics,t.year),e.leaderboard&&Ke(e,"reveal-leaderboard-list",!0);var B=document.getElementById("reveal-admin-controls"),S=document.getElementById("next-round-btn");B&&L&&L.is_admin?(B.classList.remove("hidden"),S&&(e.last_round?(S.textContent=d("leaderboard.finalResults"),S.classList.add("is-final")):(S.textContent=d("admin.nextRound"),S.classList.remove("is-final")),S.disabled=!1)):B&&B.classList.add("hidden")}function ln(e,t){var n=document.getElementById("round-analytics");if(!n||!e){n&&n.classList.add("hidden");return}if(e.total_submitted===0){n.innerHTML='<div class="analytics-empty">'+d("analytics.noSubmissions")+"</div>",n.classList.remove("hidden");return}var a="";if(e.average_guess!==null&&t){var r=Math.round(e.average_guess-t);r===0?a=d("analytics.onTarget"):r>0?a=d("analytics.yearsLate",{years:r}):a=d("analytics.yearsEarly",{years:Math.abs(r)})}var i=cn(e.all_guesses,t),o="";if(e.exact_match_players&&e.exact_match_players.length>0&&(o+='<div class="achievement-item"><span class="achievement-emoji">&#127919;</span><span class="achievement-label">'+d("analytics.exactMatches")+':</span><span class="achievement-names">'+e.exact_match_players.join(", ")+"</span></div>"),e.speed_champion&&e.speed_champion.names){var s=e.speed_champion.names.join(", ");o+='<div class="achievement-item"><span class="achievement-emoji">&#9889;</span><span class="achievement-label">'+d("analytics.speedChampion")+':</span><span class="achievement-names">'+s+'</span><span class="achievement-value">('+e.speed_champion.time+"s)</span></div>"}if(e.furthest_players&&e.furthest_players.length>0&&e.all_guesses&&e.all_guesses.length>0){var u=e.all_guesses[e.all_guesses.length-1].years_off;u>0&&(o+='<div class="achievement-item"><span class="achievement-emoji">&#128517;</span><span class="achievement-label">'+d("analytics.furthestGuess")+':</span><span class="achievement-names">'+e.furthest_players.join(", ")+'</span><span class="achievement-value">('+u+" years)</span></div>")}var c=e.average_guess!==null?Math.round(e.average_guess):"?";n.innerHTML='<h3 class="analytics-title">'+d("analytics.title")+'</h3><div class="analytics-stats-row"><div class="stat-primary"><span class="stat-label">'+d("analytics.averageGuess")+'</span><span class="stat-value">'+c+'</span></div><div class="stat-secondary"><span class="stat-value">'+e.accuracy_percentage+'%</span><span class="stat-label">'+d("analytics.accuracy",{percent:""}).replace("%","")+'</span></div></div><div class="stat-comparison-line">'+a+'</div><div class="analytics-histogram"><h4 class="histogram-title">'+d("analytics.histogram")+"</h4>"+i+"</div>"+(o?'<div class="analytics-achievements">'+o+"</div>":""),n.classList.remove("hidden")}function cn(e,t){var n=7;if(!e||e.length===0)return'<div class="histogram-empty">'+d("analytics.noGuesses")+"</div>";for(var a=e.map(function(aa){return aa.guess}),r=Math.min.apply(null,a),i=Math.max.apply(null,a),o=i-r,s=Math.max(1,Math.ceil(o/n)),u=s*n,c=u-o-1,v=r-Math.floor(c/2),l=[],g=0;g<n;g++){var p=v+g*s,w=p+s-1;l.push({start:p,end:w,count:0,containsCorrect:t>=p&&t<=w})}for(var b=0;b<a.length;b++)for(var L=a[b],I=0;I<l.length;I++)if(L>=l[I].start&&L<=l[I].end){l[I].count++;break}for(var B=1,S=0;S<l.length;S++)l[S].count>B&&(B=l[S].count);for(var P="",F=0;F<l.length;F++){var T=l[F],V=T.count/B*100,ye=F*.05,$n="histogram-bar"+(T.containsCorrect?" is-correct":""),ea=T.count>0?Math.max(V,10):0,ta=T.count>0?'<span class="bar-count">'+T.count+"</span>":"",na=s===1?String(T.start):T.start+"-"+String(T.end).slice(-2);P+='<div class="histogram-bar-wrapper" style="animation-delay: '+ye+'s"><div class="'+$n+'" style="height: '+ea+'%">'+ta+'</div><span class="histogram-label">'+na+"</span></div>"}return'<div class="histogram-bars">'+P+"</div>"}function dn(e){var t=document.getElementById("superlatives-container");if(t){if(!e||e.length===0){t.classList.add("hidden");return}var n="";e.forEach(function(a,r){var i="";switch(a.value_label){case"avg_time":i=a.value+"s "+d("superlatives.avgTime");break;case"streak":i=a.value+" "+d("superlatives.streak");break;case"bets":i=a.value+" "+d("superlatives.bets");break;case"points":i=a.value+" "+d("superlatives.points");break;case"close_guesses":i=a.value+" "+d("superlatives.closeGuesses");break;default:i=a.value}n+='<div class="superlative-card superlative-card--'+a.id+'" style="animation-delay: '+r*.2+'s"><div class="superlative-emoji">'+a.emoji+'</div><div class="superlative-title">'+d("superlatives."+a.title)+'</div><div class="superlative-player">'+_(a.player_name)+'</div><div class="superlative-value">'+i+"</div></div>"}),t.innerHTML=n,t.classList.remove("hidden")}}function un(e){var t=document.getElementById("song-difficulty");if(t){if(!e){t.classList.add("hidden");return}for(var n="",a=0;a<e.stars;a++)n+='<span class="star">&#9733;</span>';t.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+n+'</div><span class="difficulty-label">'+d("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+d("difficulty.accuracy")+"</span>",t.classList.remove("hidden")}}function fn(e){var t=document.getElementById("song-rich-info");if(t){var n=[],a=mn(e.chart_info||{});a.length>0&&(n=n.concat(a));var r=vn(e.certifications||[]);r.length>0&&(n=n.concat(r));var i=De(e,"awards")||[],o=yn(i);o.length>0&&(n=n.concat(o)),n.length>0?t.innerHTML='<div class="song-badges-row">'+n.join("")+"</div>":t.innerHTML=""}}function mn(e){if(!e)return[];var t=[];if(e.billboard_peak&&e.billboard_peak>0){var n=e.weeks_on_chart?' <span class="chart-weeks">\xB7 '+e.weeks_on_chart+" "+d("reveal.weeksShort")+"</span>":"";t.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.billboard_peak+" "+d("reveal.chartBillboard")+n+"</span>")}return e.german_peak&&e.german_peak>0&&!e.billboard_peak&&t.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.german_peak+" "+d("reveal.chartGerman")+"</span>"),e.uk_peak&&e.uk_peak>0&&!e.billboard_peak&&t.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">\u{1F4CA}</span>#'+e.uk_peak+" "+d("reveal.chartUK")+"</span>"),t}function vn(e){if(!e||e.length===0)return[];for(var t=[],n=0;n<e.length;n++){var a=e[n],r=gn(a),i=pn(a);t.push('<span class="song-badge '+r+'"><span class="song-badge-icon">'+i+"</span>"+_(a)+"</span>")}return t}function gn(e){var t=e.toLowerCase();return t.indexOf("diamond")!==-1?"song-badge--diamond":t.indexOf("platinum")!==-1?"song-badge--platinum":t.indexOf("gold")!==-1?"song-badge--gold":"song-badge--platinum"}function pn(e){var t=e.toLowerCase();return t.indexOf("diamond")!==-1?"\u{1F48E}":t.indexOf("platinum")!==-1?"\u{1F4BF}":t.indexOf("gold")!==-1?"\u{1F947}":"\u{1F4BF}"}function yn(e){if(!e||e.length===0)return[];for(var t=[],n=e.slice(0,3),a=0;a<n.length;a++){var r=n[a],i=bn(r),o=hn(r);t.push('<span class="song-badge '+i+'"><span class="song-badge-icon">'+o+"</span>"+_(r)+"</span>")}return e.length>3&&t.push('<span class="song-badges-more">+'+(e.length-3)+" more</span>"),t}function bn(e){var t=e.toLowerCase();return t.indexOf("grammy")!==-1?"song-badge--grammy":t.indexOf("eurovision")!==-1?"song-badge--eurovision":t.indexOf("oscar")!==-1||t.indexOf("academy award")!==-1?"song-badge--oscar":t.indexOf("hall of fame")!==-1?"song-badge--halloffame":"song-badge--award"}function hn(e){var t=e.toLowerCase();return t.indexOf("eurovision")!==-1?"\u{1F3A4}":t.indexOf("grammy")!==-1?"\u{1F3C6}":t.indexOf("hall of fame")!==-1?"\u2B50":"\u{1F3C6}"}function En(e,t){var n=document.getElementById("reveal-emotion"),a=document.getElementById("personal-result");if(!n)return;n.className="reveal-emotion",n.innerHTML="",n.classList.add("hidden"),a&&a.classList.remove("is-delayed"),pe();var r=d("reveal.emotions");function i(g){return g[Math.floor(Math.random()*g.length)]}function o(g){return g===1?d("reveal.offByYear"):d("reveal.offByYears",{years:g})}var s="missed",u=i(r.missed),c=i(r.missedSub);if(e&&!e.missed_round){var v=e.years_off||0;v===0?(s="exact",u=i(r.exact),c=i(r.exactSub)):v<=2?(s="close",u=i(r.close),c=i(r.closeSub)+" "+o(v)):v<=5?(s="close",u=i(r.close),c=o(v)):(s="wrong",u=i(r.wrong),c=i(r.wrongSub)+" "+o(v))}else e&&e.missed_round&&(s="missed",u=i(r.missed),c=i(r.missedSub));var l='<span class="reveal-emotion-text">'+u+"</span>";c&&(l+='<div class="reveal-emotion-subtitle">'+c+"</div>"),n.innerHTML=l,n.classList.add("reveal-emotion--"+s),n.classList.remove("hidden"),s==="exact"&&ge(),a&&s!=="missed"&&a.classList.add("is-delayed")}function Ln(e,t){var n=document.getElementById("result-content");if(n){if(!e){n.innerHTML='<div class="result-missed">Player not found</div>';return}if(e.missed_round){var a='<div class="result-missed-container"><div class="result-missed-icon">\u23F0</div><div class="result-missed-text">'+d("reveal.noSubmission")+"</div></div>",r=e.previous_streak||0;r>=2&&(a+='<div class="streak-broken"><span class="streak-broken-icon">\u{1F494}</span><span class="streak-broken-text">Lost '+r+"-streak!</span></div>"),a+='<div class="result-score is-zero">0 pts</div>',n.innerHTML=a;return}var i=e.years_off||0,o=i===0?d("reveal.exact"):i===1?d("reveal.yearOff",{years:1}):d("reveal.yearsOff",{years:i}),s=i===0?"is-exact":i<=3?"is-close":"is-far",u=e.speed_multiplier||1,c=e.base_score||0,v=u>1,l=e.streak_bonus||0,g="";v&&c>0&&(g='<div class="result-row"><span class="result-label">'+d("reveal.baseScore")+'</span><span class="result-value">'+c+' pts</span></div><div class="result-row"><span class="result-label">'+d("reveal.speedBonus")+'</span><span class="result-value is-bonus">'+u.toFixed(2)+"x</span></div>");var p="";e.bet_outcome==="won"?p='<div class="result-row bet-won-row"><span class="result-label">\u{1F3B2} '+d("reveal.betWon").replace("! 2x points","")+'</span><span class="result-value is-bet-won">2x</span></div>':e.bet_outcome==="lost"&&(p='<div class="result-row bet-lost-row"><span class="result-label">\u{1F3B2} '+d("reveal.betLost")+'</span><span class="result-value is-bet-lost">-</span></div>');var w="";l>0&&(w='<div class="result-row streak-bonus-row"><span class="result-label">'+e.streak+'-streak bonus!</span><span class="result-value is-streak">+'+l+" pts</span></div>");var b=e.round_score+l,L=e.round_score>=20,I=x.players[e.name],B=I?I.score:e.score-b,S=I?I.streak:0,P=Mt(S,e.streak||0);n.innerHTML='<div class="result-row"><span class="result-label">'+d("reveal.yourGuess")+'</span><span class="result-value">'+e.guess+'</span></div><div class="result-row"><span class="result-label">'+d("reveal.correctYear")+'</span><span class="result-value">'+t+'</span></div><div class="result-row"><span class="result-label">'+d("reveal.accuracy")+'</span><span class="result-value '+s+'">'+o+"</span></div>"+g+p+'<div class="result-score" id="personal-result-score">+<span class="score-value">0</span> pts</div>'+w+(l>0?'<div class="result-total">'+d("reveal.total")+': +<span class="total-value">0</span> pts</div>':"");var F=n.querySelector(".score-value");F&&(Lt(F,0,e.round_score,{betWon:e.bet_outcome==="won",betLost:e.bet_outcome==="lost",streakMilestone:P,isBigScore:L}),e.bet_outcome==="won"&&e.round_score>0&&setTimeout(function(){var V=document.getElementById("personal-result-score");V&&Fe(V,e.round_score,{isBetWin:!0})},200));var T=n.querySelector(".total-value");T&&l>0&&(setTimeout(function(){we(T,0,b,600)},300),P&&setTimeout(function(){var V=n.querySelector(".result-total");if(V){var ye={3:20,5:50,10:100}[P]||0;Fe(V,ye,{isStreak:!0,text:"+"+ye+" "+P+"-Streak!"})}},500))}}function In(e){var t=document.getElementById("reveal-results-cards");if(t){if(!e||e.length===0){t.innerHTML="";return}var n=e.slice().sort(function(r,i){return(i.round_score||0)-(r.round_score||0)}),a='<div class="results-cards-header">'+d("reveal.allPlayers")+"</div>";a+='<div class="results-cards-scroll">',n.forEach(function(r){var i=r.name===h,o=r.missed_round===!0,s=r.years_off||0,u=r.round_score||0,c=o?"is-score-zero":u>=10?"is-score-high":u>=1?"is-score-medium":"is-score-zero",v=o?"\u2014":r.guess,l=o?d("reveal.noGuessShort"):s===0?d("reveal.exact"):d("reveal.shortOff",{years:s}),g=r.bet?'<span class="card-bet">\u{1F3B2}</span>':"",p="";if(r.stole_from)p='<div class="steal-badge"><span class="steal-badge-icon">\u{1F977}</span>'+d("steal.stolenFrom",{name:_(r.stole_from)})+"</div>";else if(r.was_stolen_by&&r.was_stolen_by.length>0){var w=r.was_stolen_by.map(_).join(", ");p='<div class="steal-badge steal-badge-victim"><span class="steal-badge-icon">\u{1F3AF}</span>'+d("steal.stolenBy",{name:w})+"</div>"}a+='<div class="result-card '+c+(i?" is-current":"")+'"><div class="card-name">'+_(r.name)+g+'</div><div class="card-guess">'+v+'</div><div class="card-accuracy">'+l+"</div>"+p+'<div class="card-score">+'+u+"</div></div>"}),a+="</div>",t.innerHTML=a}}function wn(e){var t=e.leaderboard||[];t.forEach(function(b){b.is_current=b.name===h}),[1,2,3].forEach(function(b){var L=t.find(function(S){return S.rank===b}),I=document.getElementById("podium-"+b+"-name"),B=document.getElementById("podium-"+b+"-score");I&&(I.textContent=L?_(L.name):"---"),B&&(B.textContent=L?L.score:"0")});var n=t.find(function(b){return b.is_current}),a=document.getElementById("your-final-rank"),r=document.getElementById("your-final-score"),i=document.getElementById("stat-best-streak"),o=document.getElementById("stat-rounds"),s=document.getElementById("stat-bets");n&&(a&&(a.textContent="#"+n.rank),r&&(r.textContent=n.score+" "+d("leaderboard.points")),i&&(i.textContent=n.best_streak||0),o&&(o.textContent=n.rounds_played||0),s&&(s.textContent=n.bets_won||0));var u=document.getElementById("final-leaderboard-list");u&&(u.innerHTML=t.map(function(b){var L=b.is_current?"is-current":"",I=b.connected===!1?"final-entry--disconnected":"",B=b.connected===!1?'<span class="away-badge">(away)</span>':"";return'<div class="final-entry '+L+" "+I+'"><span class="final-rank">#'+b.rank+'</span><span class="final-name">'+_(b.name)+B+'</span><span class="final-score">'+b.score+"</span></div>"}).join("")),dn(e.superlatives);var c=document.getElementById("end-admin-controls"),v=document.getElementById("end-player-message");if(n&&n.is_admin){c&&c.classList.remove("hidden"),v&&v.classList.add("hidden");var l=document.getElementById("new-game-btn");l&&(l.onclick=Sn)}else c&&c.classList.add("hidden"),v&&v.classList.remove("hidden");if(n){var g=e.total_rounds||10,p=n.best_streak||0,w=p===g&&g>0;w?ge("perfect"):n.rank===1&&ge("winner")}}function Bn(e){var t=document.getElementById("pause-message");t&&(e.pause_reason==="admin_disconnected"?t.textContent="Waiting for host to reconnect...":e.pause_reason==="media_player_error"?t.textContent="Speaker unavailable. Please check your media player and try again.":t.textContent="Game paused. Please wait...")}function Sn(){if(confirm("Start a new game?")){var e=document.getElementById("new-game-btn");e&&(e.disabled=!0,e.textContent="Redirecting...");try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(t){}window.location.href="/beatify/admin"}}var Me=!1,_n=2e3;function $e(){if(!Me&&f&&f.readyState===WebSocket.OPEN){Me=!0;var e=document.getElementById("next-round-btn"),t=document.getElementById("next-round-admin-btn");if(e&&(e.disabled=!0,e.textContent="Loading..."),t){t.disabled=!0;var n=t.querySelector(".control-label");n&&(n.textContent="Wait...")}f.send(JSON.stringify({type:"admin",action:"next_round"})),setTimeout(function(){Me=!1,e&&(e.disabled=!1),t&&(t.disabled=!1)},_n)}}let Ae=!1;var kn=500;let X=!1,Ne=.5;function ue(){return Ae?!1:(Ae=!0,setTimeout(function(){Ae=!1},kn),!0)}function et(){if(A){var e=document.getElementById("admin-control-bar");e&&(e.classList.remove("hidden"),document.body.classList.add("has-control-bar"))}}function fe(){var e=document.getElementById("admin-control-bar");e&&(e.classList.add("hidden"),document.body.classList.remove("has-control-bar"))}function tt(e){var t=document.getElementById("stop-song-btn"),n=document.getElementById("next-round-admin-btn");if(e==="PLAYING"){if(at(),t&&!X&&(t.classList.remove("is-disabled"),t.disabled=!1),n){n.classList.remove("is-disabled"),n.disabled=!1;var a=n.querySelector(".control-label");a&&(a.textContent="Skip")}}else if(e==="REVEAL"){if(t&&!X&&(t.classList.remove("is-disabled"),t.disabled=!1),n){n.classList.remove("is-disabled"),n.disabled=!1;var a=n.querySelector(".control-label");a&&(a.textContent="Next")}}else if(n){n.classList.add("is-disabled"),n.disabled=!0;var a=n.querySelector(".control-label");a&&(a.textContent="Next")}}function Cn(){if(!X&&ue()){if(!f||f.readyState!==WebSocket.OPEN){console.warn("[Beatify] Cannot stop song: WebSocket not connected");return}var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-disabled"),e.disabled=!0;var t=e.querySelector(".control-label");t&&(t.textContent="Stopping...")}f.send(JSON.stringify({type:"admin",action:"stop_song"}))}}function xn(){if(Ne>=1){nt("max");return}ue()&&(!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"admin",action:"set_volume",direction:"up"})))}function Tn(){if(Ne<=0){nt("min");return}ue()&&(!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"admin",action:"set_volume",direction:"down"})))}function nt(e){var t=document.getElementById("volume-indicator");t&&(t.textContent=e==="max"?"\u{1F50A} Max":"\u{1F507} Min",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},1e3))}function Mn(){if(confirm(d("admin.endGameConfirmFull"))&&ue()){if(!f||f.readyState!==WebSocket.OPEN){alert(d("errors.CONNECTION_LOST"));return}var e=document.getElementById("end-game-btn");if(e){e.disabled=!0;var t=e.querySelector(".control-label");t&&(t.textContent="Ending...")}f.send(JSON.stringify({type:"admin",action:"end_game"}))}}function An(){$e()}function Nn(){var e=document.getElementById("stop-song-btn"),t=document.getElementById("volume-up-btn"),n=document.getElementById("volume-down-btn"),a=document.getElementById("next-round-admin-btn"),r=document.getElementById("end-game-btn");e&&e.addEventListener("click",Cn),t&&t.addEventListener("click",xn),n&&n.addEventListener("click",Tn),a&&a.addEventListener("click",An),r&&r.addEventListener("click",Mn)}function Rn(){X=!0;var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-stopped"),e.classList.add("is-disabled"),e.disabled=!0;var t=e.querySelector(".control-icon"),n=e.querySelector(".control-label");t&&(t.textContent="\u2713"),n&&(n.textContent="Stopped")}}function at(){X=!1;var e=document.getElementById("stop-song-btn");if(e){e.classList.remove("is-stopped"),e.classList.remove("is-disabled"),e.disabled=!1;var t=e.querySelector(".control-icon"),n=e.querySelector(".control-label");t&&(t.textContent="\u23F9\uFE0F"),n&&(n.textContent="Stop")}}function On(e){Ne=e,Hn(e),Dn(e)}function Hn(e){var t=document.getElementById("volume-indicator");if(t){var n=Math.round(e*100);t.textContent="\u{1F50A} "+n+"%",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},1500)}}function Dn(e){var t=document.getElementById("volume-up-btn"),n=document.getElementById("volume-down-btn");t&&t.classList.toggle("is-at-limit",e>=1),n&&n.classList.toggle("is-at-limit",e<=0)}let A=!1;function Pn(){const e=sessionStorage.getItem("beatify_is_admin"),t=sessionStorage.getItem("beatify_admin_name");return e==="true"&&t&&(A=!0,h=t,sessionStorage.removeItem("beatify_is_admin")),A}function Fn(e){const t=document.getElementById("admin-controls"),n=document.getElementById("lobby-status"),a=document.getElementById("leave-game-container");if(!t)return;const r=e.find(function(o){return o.name===h});(r==null?void 0:r.is_admin)===!0?(t.classList.remove("hidden"),n&&n.classList.add("hidden"),a&&a.classList.add("hidden")):(t.classList.add("hidden"),n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"))}function Vn(){const e=document.getElementById("start-game-btn");e==null||e.addEventListener("click",function(){!f||f.readyState!==WebSocket.OPEN||(e.disabled=!0,e.textContent="Starting...",f.send(JSON.stringify({type:"admin",action:"start_game"})))});const t=document.getElementById("leave-game-btn");t==null||t.addEventListener("click",function(){Yn()})}let f=null,h=null,k=0;const Z=10,Gn=3e4,me="beatify_player_name",ve="beatify_game_id",rt="beatify_language";let O=!1,$=!1;function it(){return Math.min(1e3*Math.pow(2,k),Gn)}function Wn(){try{var e=localStorage.getItem(ve),t=localStorage.getItem(me);if(console.log("[Beatify] Checking localStorage - storedGameId:",e,"currentGameId:",C,"storedName:",t),e&&e===C)return console.log("[Beatify] Game ID match, returning stored name:",t),t;e&&e!==C&&(console.log("[Beatify] Different game ID, clearing stored data"),localStorage.removeItem(me),localStorage.removeItem(ve))}catch(n){console.error("[Beatify] localStorage error:",n)}return null}function st(e){try{localStorage.setItem(me,e),localStorage.setItem(ve,C),console.log("[Beatify] Stored player name:",e,"for game:",C)}catch(t){console.error("[Beatify] Failed to store player name:",t)}}function ee(){try{localStorage.removeItem(me),localStorage.removeItem(ve)}catch(e){}}function jn(e){try{localStorage.setItem(rt,e)}catch(t){}}function qn(){try{return localStorage.getItem(rt)}catch(e){return null}}function ot(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.remove("hidden")}function te(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.add("hidden")}function lt(e){var t=document.getElementById("reconnect-status");t&&(t.textContent="Reconnecting... (Attempt "+e+"/"+Z+")")}function Re(){E("connection-lost-view")}function Un(){var e=document.getElementById("retry-connection-btn");e&&e.addEventListener("click",function(){h?(k=0,E("loading-view"),ne(h)):re()})}function ne(e){h=e,st(e);const n=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+"/beatify/ws";f=new WebSocket(n),f.onopen=function(){k=0,O=!1,te();var a={type:"join",name:e};A&&(a.is_admin=!0),f.send(JSON.stringify(a))},f.onmessage=function(a){try{const r=JSON.parse(a.data);ct(r)}catch(r){console.error("Failed to parse WebSocket message:",r)}},f.onclose=function(){if($){$=!1;return}if(h&&k<Z){O=!0,k++,ot(),lt(k);const a=it();console.log("WebSocket closed. Reconnecting in "+a+"ms... (attempt "+k+")"),setTimeout(function(){ne(h)},a)}else k>=Z&&(O=!1,te(),Re())},f.onerror=function(a){console.error("WebSocket error:",a)}}function ct(e){const t=document.getElementById("join-btn"),n=document.getElementById("name-input");if(e.type==="state"){var a=e.players||[],r=a.find(function(o){return o.name===h});if(r&&(A=r.is_admin===!0),e.language&&(jn(e.language),typeof BeatifyI18n!="undefined"&&e.language!==BeatifyI18n.getLanguage()&&BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),ze(a),e.difficulty&&_e(e.difficulty),e.phase==="REVEAL"&&Ze(e)})),e.phase==="LOBBY")W(),fe(),de=0,j("warmup"),E("lobby-view"),ze(a),e.difficulty&&_e(e.difficulty),e.join_url&&Dt(e.join_url),Fn(a);else if(e.phase==="PLAYING"){var i=e.round||1;i!==de&&(de=i,$t()),j("party"),E("game-view"),le(),jt(e),e.difficulty&&_e(e.difficulty),e.deadline&&Wt(e.deadline),Kt(),Jt(),et(),tt("PLAYING")}else e.phase==="REVEAL"?(W(),j("party"),E("reveal-view"),Ze(e),et(),tt("REVEAL")):e.phase==="PAUSED"?(W(),fe(),j("warmup"),E("paused-view"),Bn(e)):e.phase==="END"&&(W(),fe(),de=0,j("warmup"),E("end-view"),wn(e),ee())}else if(e.type==="join_ack"){e.session_id&&ht(e.session_id);try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(o){}}else if(e.type==="reconnect_ack")e.success&&e.name?(h=e.name,st(e.name),Ot(e.name)):(z(),ee(),h=null,E("join-view"));else if(e.type==="submit_ack")Xe();else if(e.type==="error"){if(e.code==="ROUND_EXPIRED"||e.code==="ALREADY_SUBMITTED"){Zt(e);return}if(e.code==="GAME_ENDED"){E("end-view");return}if(e.code==="NOT_ADMIN"){A=!1,fe(),console.warn("Admin action rejected: not admin");return}if(e.code==="SESSION_TAKEOVER"){O=!1,te(),h=null,Re(),console.warn("Session taken over by another tab");return}if(e.code==="SESSION_NOT_FOUND"){z(),$=!0,f&&f.close(),E("join-view");return}if(e.code==="ADMIN_CANNOT_LEAVE"){$=!1,alert(e.message||"Host cannot leave. End the game instead.");return}if(e.code==="INVALID_ACTION"&&e.message==="No song playing"){at(),console.warn("[Beatify] Stop song failed: No song playing");return}E("join-view"),Jn(e.message),t&&(t.disabled=!1,t.textContent=d("join.joinButton")),n&&n.focus(),h=null,ee()}else e.type==="song_stopped"?Rn():e.type==="volume_changed"?On(e.level):e.type==="game_ended"?Qn():e.type==="left"?zn():e.type==="steal_targets"?sn(e):e.type==="steal_ack"&&rn(e)}function zn(){ee(),z(),h=null,A=!1,E("join-view")}function Yn(){if(!(!f||f.readyState!==WebSocket.OPEN)){if(A){alert("Host cannot leave. End the game instead.");return}confirm("Leave the game? Your score will be lost.")&&($=!0,f.send(JSON.stringify({type:"leave"})))}}function Qn(){ee(),z();try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(t){}if(Bt(),Tt(),Be.clear(),pe(),h=null,A=!1,f&&f.readyState===WebSocket.OPEN&&f.close(),f=null,!(!Ie||!Ie.classList.contains("hidden"))){var e=document.getElementById("end-player-message");e&&(e.innerHTML='<p>Thanks for playing!</p><p class="rejoin-hint">Scan the QR code again to join the next game.</p>',e.classList.remove("hidden")),E("end-view")}}function Jn(e){const t=document.getElementById("name-validation-msg");t&&(t.textContent=e,t.classList.remove("hidden"))}function Oe(e){const t=(e||"").trim();return t?t.length>Ht?{valid:!1,error:"Name too long (max 20 characters)"}:{valid:!0,name:t}:{valid:!1,error:"Please enter a name"}}function dt(){const e=document.getElementById("name-input"),t=document.getElementById("join-btn"),n=document.getElementById("name-validation-msg");if(!e||!t)return;const a=Oe(e.value);a.valid&&(t.disabled=!0,t.textContent="Joining...",n&&n.classList.add("hidden"),ne(a.name))}function Kn(){const e=document.getElementById("name-input"),t=document.getElementById("join-btn"),n=document.getElementById("name-validation-msg");!e||!t||(e.addEventListener("input",function(){const a=Oe(this.value);t.disabled=!a.valid,n&&(n.textContent=!a.valid&&this.value?a.error:"",n.classList.toggle("hidden",a.valid||!this.value))}),t.addEventListener("click",dt),e.addEventListener("keypress",function(a){a.key==="Enter"&&!t.disabled&&dt()}))}const Xn=E;E=function(e){Xn(e),(e==="join-view"||e==="loading-view"||e==="not-found-view"||e==="ended-view"||e==="in-progress-view"||e==="connection-lost-view")&&j("calm"),e==="join-view"&&setTimeout(function(){var t=document.getElementById("name-input");t&&t.focus()},100)};function j(e){document.body.classList.remove("energy-calm","energy-warmup","energy-party"),document.body.classList.add("energy-"+e)}var H=null,D=null;function ge(e){if(Y.prefersReducedMotion()){ut();return}if(typeof confetti=="undefined"){console.warn("[Confetti] Library not loaded");return}pe();var t=Y.getQualitySettings(),n=t.confettiParticles;if(n===0){ut();return}var a=Y.getDeviceTier(),r=a==="low"?.5:a==="medium"?.75:1;switch(e=e||"exact",e){case"exact":var i=Math.round(2e3*r),o=Date.now()+i;(function p(){confetti({particleCount:n,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<o&&(H=requestAnimationFrame(p))})();break;case"record":var s=Math.round(3e3*r),u=Date.now()+s;(function p(){confetti({particleCount:Math.round(n*.67),spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<u&&(H=requestAnimationFrame(p))})();break;case"winner":var c=Math.round(4e3*r),v=Date.now()+c;(function p(){confetti({particleCount:Math.round(n*.67),angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:Math.round(n*.67),angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<v&&(H=requestAnimationFrame(p))})();break;case"perfect":var l=Math.round(5e3*r),g=Date.now()+l;D=setInterval(function(){confetti({particleCount:n*2,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},a==="low"?750:500),setTimeout(function(){D&&(clearInterval(D),D=null)},l),function p(){confetti({particleCount:Math.round(n*.5),angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:Math.round(n*.5),angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<g&&(H=requestAnimationFrame(p))}();break;default:console.warn("[Confetti] Unknown type:",e)}}function pe(){H&&(cancelAnimationFrame(H),H=null),D&&(clearInterval(D),D=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function ut(){var e=document.getElementById("reveal-emotion");if(e){var t=e.querySelector(".celebration-icon");if(!t){var n=document.createElement("span");n.className="celebration-icon",n.textContent=" \u{1F389}",e.appendChild(n)}}}function Zn(){var e=document.getElementById("next-round-btn");e&&e.addEventListener("click",$e);var t=document.getElementById("reveal-view");t&&t.addEventListener("click",function(n){n.target.tagName==="BUTTON"||n.target.closest("button")||(Be.isRunning()&&Be.skipAll(),pe())})}function ft(){return be(this,null,function*(){var e=Y.getDeviceTier();document.body.classList.add("device-tier-"+e);var t=yield bt();if(!t)console.error("[Player] BeatifyI18n module failed to load - UI will use fallback text");else{var n=qn();yield BeatifyI18n.init(n),BeatifyI18n.initPageTranslations()}var a=document.getElementById("dashboard-hint-url");if(a&&(a.textContent=window.location.origin+"/beatify/dashboard"),Kn(),Pt(),Gt(),Vn(),Zn(),Nn(),Un(),St(),Pn()&&h){ne(h);return}var r=Wn();if(r&&C){console.log("[Beatify] Auto-reconnecting as:",r),ne(r);return}if(r){var i=document.getElementById("name-input"),o=document.getElementById("join-btn");if(i&&(i.value=r,o)){var s=Oe(r);o.disabled=!s.valid}}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ft):ft(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Beatify] SW registered:",e.scope)}).catch(function(e){console.warn("[Beatify] SW registration failed:",e)})})})();})();
//# sourceMappingURL=player.min.js.map
