<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title data-i18n="join.title">Beatify - Join Game</title>
    <!-- Preconnect for faster font loading (Story 9.8) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/beatify/static/css/styles.css">
    <!-- Confetti library for celebrations (Story 14.5) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</head>
<body class="theme-dark">
    <main class="player-container">
        <!-- Loading state -->
        <div id="loading-view" class="view">
            <h1 class="wordmark wordmark-hero logo-loading">
                <span class="wordmark-beat">Beat</span><span class="wordmark-gradient">ify</span>
            </h1>
            <p data-i18n="common.connecting">Connecting to game...</p>
        </div>

        <!-- Error: Game not found -->
        <div id="not-found-view" class="view hidden">
            <div class="error-icon">üéµ</div>
            <h1 data-i18n="errors.gameNotFound">Game Not Found</h1>
            <p data-i18n="errors.gameNotFoundHint">This game doesn't exist or the link is incorrect.</p>
            <p class="hint" data-i18n="errors.askHostQr">Ask the host for a new QR code.</p>
            <button id="refresh-btn" class="btn btn-primary btn-glow" data-i18n="common.retry">Try Again</button>
        </div>

        <!-- Error: Game ended -->
        <div id="ended-view" class="view hidden">
            <div class="error-icon">üéâ</div>
            <h1 data-i18n="errors.gameHasEnded">Game Has Ended</h1>
            <p data-i18n="errors.thanksForPlaying">Thanks for playing Beatify!</p>
            <p class="hint" data-i18n="errors.askHostNewGame">Ask the host to start a new game.</p>
        </div>

        <!-- Error: Game in progress (can't join mid-reveal) -->
        <div id="in-progress-view" class="view hidden">
            <div class="error-icon">‚è≥</div>
            <h1 data-i18n="errors.gameInProgress">Game In Progress</h1>
            <p data-i18n="errors.gameInProgressHint">The game is currently in a round. Try again in a moment.</p>
            <button id="retry-btn" class="btn btn-primary btn-glow" data-i18n="common.retry">Try Again</button>
        </div>

        <!-- Join form -->
        <div id="join-view" class="view hidden">
            <div class="join-form">
                <h1 class="wordmark wordmark-hero">
                    <span class="wordmark-beat">Beat</span><span class="wordmark-gradient">ify</span>
                </h1>
                <p data-i18n="join.enterName">Enter your name to play</p>
                <div class="form-group">
                    <input type="text" id="name-input" class="name-input"
                           data-i18n-placeholder="join.namePlaceholder"
                           placeholder="Your name" maxlength="20"
                           autocomplete="off" autocapitalize="words"
                           aria-describedby="name-validation-msg">
                    <p id="name-validation-msg" class="validation-msg hidden"></p>
                </div>
                <button id="join-btn" class="btn btn-primary btn-glow join-btn" disabled data-i18n="join.joinButton">Join Game</button>
            </div>
        </div>

        <!-- Lobby view -->
        <div id="lobby-view" class="view hidden">
            <div class="lobby-container">
                <header class="lobby-header">
                    <h1 data-i18n="lobby.gameLobby">Game Lobby</h1>
                    <p id="player-count" class="player-count">0 players</p>
                    <!-- Difficulty Badge (Story 14.1) -->
                    <span id="lobby-difficulty-badge" class="difficulty-badge"></span>
                </header>

                <div id="player-list" class="player-list">
                    <!-- Player cards rendered by JS -->
                </div>

                <div id="qr-share-area" class="qr-share-area">
                    <p class="qr-label">
                        <span class="qr-icon">üì≤</span>
                        <span data-i18n="lobby.inviteFriends">Invite friends</span>
                    </p>
                    <div id="player-qr-code" class="qr-container" role="button" tabindex="0"
                         aria-label="Tap to enlarge QR code">
                        <!-- QR code rendered here by JS -->
                    </div>
                    <p class="qr-hint" data-i18n="lobby.tapToEnlarge">Tap to enlarge</p>
                </div>

                <!-- Dashboard hint (Story 16.4) -->
                <div class="dashboard-hint-container">
                    <div class="dashboard-hint-text">
                        <span class="dashboard-hint-label">
                            <span class="dashboard-hint-icon">üì∫</span>
                            <span data-i18n="dashboard.castToTv">Cast to TV:</span>
                        </span>
                        <span id="dashboard-hint-url" class="dashboard-hint-url"></span>
                    </div>
                </div>

                <div id="lobby-status" class="lobby-status">
                    <p data-i18n="lobby.waitingForHost">Waiting for host to start the game...</p>
                </div>

                <!-- Leave Game button (Story 11.5) - hidden for admin -->
                <div id="leave-game-container" class="leave-game-container hidden">
                    <button id="leave-game-btn" class="btn btn-secondary btn-leave"
                            aria-label="Leave game and return to join screen"
                            data-i18n="lobby.leaveGame">
                        Leave Game
                    </button>
                </div>

                <div id="admin-controls" class="admin-controls hidden">
                    <button id="start-game-btn" class="btn btn-primary btn-glow btn-large">
                        <span class="btn-icon">üéâ</span>
                        <span data-i18n="lobby.startGame">Start Game</span>
                    </button>
                    <p class="admin-hint" data-i18n="lobby.pressWhenReady">Press when everyone is ready</p>
                </div>
            </div>
        </div>

        <!-- Game view (Epic 4) -->
        <div id="game-view" class="view hidden">
            <div class="game-container">
                <!-- Round Indicator -->
                <div id="round-indicator" class="round-indicator">
                    <span data-i18n="game.roundLabel">Round</span> <span id="current-round">1</span> <span data-i18n="game.ofLabel">of</span> <span id="total-rounds">10</span>
                    <!-- Difficulty Badge (Story 14.1) -->
                    <span id="game-difficulty-badge" class="difficulty-badge"></span>
                </div>
                <div id="last-round-banner" class="last-round-banner hidden" data-i18n="game.finalRound">
                    Final Round!
                </div>

                <!-- Steal Available Indicator (Story 15.3 AC1) -->
                <div id="steal-indicator" class="steal-indicator hidden">
                    <span class="steal-indicator-icon">ü•∑</span>
                    <span class="steal-indicator-text" data-i18n="steal.available">Steal Available!</span>
                </div>

                <!-- Album Cover -->
                <div class="album-cover-container">
                    <img id="album-cover"
                         src="/beatify/static/img/no-artwork.svg"
                         alt="Album Cover"
                         class="album-cover">
                    <div id="album-loading" class="album-loading hidden">
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <!-- Timer with ARIA support (Story 9.7) -->
                <div class="timer-container">
                    <div id="timer" class="timer" role="timer" aria-live="polite" aria-label="Time remaining: 30 seconds">30</div>
                </div>

                <!-- Submission Tracker (Story 4.4) -->
                <div id="submission-tracker" class="submission-tracker">
                    <div class="submission-header">
                        <span id="submission-count" class="submission-count">0/0 submitted</span>
                    </div>
                    <div id="submitted-players" class="submitted-players">
                        <!-- Player indicators populated dynamically -->
                    </div>
                </div>

                <!-- Year Selector (Story 4.3) -->
                <div id="year-selector-container" class="year-selector-container">
                    <div id="year-selector" class="year-selector">
                        <div class="year-display">
                            <span id="selected-year">1990</span>
                        </div>

                        <div class="slider-container">
                            <span class="slider-label slider-label--min">1950</span>
                            <input type="range"
                                   id="year-slider"
                                   min="1950"
                                   max="2025"
                                   value="1990"
                                   class="year-slider">
                            <span class="slider-label slider-label--max">2025</span>
                        </div>

                        <!-- Bet Toggle (Story 5.3) -->
                        <div class="bet-container">
                            <button id="bet-toggle" class="bet-toggle" type="button">
                                <span class="bet-icon">üé≤</span>
                                <span class="bet-label" data-i18n="game.bet">Double or Nothing</span>
                            </button>
                        </div>

                        <button id="submit-btn" class="submit-btn" data-i18n="game.submitGuess">
                            Submit Guess
                        </button>

                        <!-- Steal Power-up Button (Story 15.3) -->
                        <button id="steal-btn" class="steal-btn hidden" type="button">
                            <span class="steal-btn-icon">ü•∑</span>
                            <span class="steal-btn-label" data-i18n="steal.button">Steal Answer</span>
                        </button>

                        <div id="submitted-confirmation" class="submitted-confirmation hidden">
                            <span class="checkmark">‚úì</span>
                            <span data-i18n="game.submitted">Submitted!</span>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard (Story 5.5 - moved below year selector per Story 9.10) -->
                <div id="game-leaderboard" class="leaderboard is-compact">
                    <div class="leaderboard-header">
                        <span class="leaderboard-title" data-i18n="leaderboard.title">Leaderboard</span>
                        <button id="leaderboard-toggle" class="leaderboard-toggle" type="button">
                            <span class="toggle-icon">‚ñº</span>
                        </button>
                    </div>
                    <div id="leaderboard-list" class="leaderboard-list">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div id="leaderboard-you" class="leaderboard-you hidden">
                        <!-- Quick "You: #X" indicator when scrolled -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Reveal View (Story 4.6) -->
        <div id="reveal-view" class="view hidden">
            <div class="reveal-container">
                <!-- Round Info -->
                <div class="reveal-round-info">
                    <span data-i18n="game.roundLabel">Round</span> <span id="reveal-round">1</span> <span data-i18n="game.ofLabel">of</span> <span id="reveal-total">10</span>
                </div>

                <!-- Album Cover (smaller) -->
                <div class="reveal-album">
                    <img id="reveal-album-cover"
                         src="/beatify/static/img/no-artwork.svg"
                         alt="Album Cover"
                         class="reveal-album-cover">
                </div>

                <!-- Song Info (Story 9.10: moved above year) -->
                <div class="song-info">
                    <div id="song-title" class="song-title">Unknown Song</div>
                    <div id="song-artist" class="song-artist">Unknown Artist</div>
                </div>

                <!-- Correct Year -->
                <div class="correct-year-container">
                    <div class="correct-year-label" data-i18n="reveal.theYearWas">The year was</div>
                    <div id="correct-year" class="correct-year text-glow">1984</div>
                </div>

                <!-- Song difficulty rating (Story 15.1) -->
                <div id="song-difficulty" class="song-difficulty hidden"></div>

                <!-- Fun Fact + Rich Song Info (Story 14.3) -->
                <div id="fun-fact-container" class="fun-fact-container hidden">
                    <div class="fun-fact-header">
                        <div class="fun-fact-icon">&#128161;</div>
                        <div id="fun-fact" class="fun-fact-text"></div>
                    </div>
                    <!-- Rich Song Info inside fun fact box -->
                    <div id="song-rich-info" class="song-rich-info">
                        <!-- Populated by JavaScript: chart info, certifications, awards -->
                    </div>
                </div>

                <!-- Celebration Emotion (Story 9.4) -->
                <div id="reveal-emotion" class="reveal-emotion hidden" aria-live="polite" aria-atomic="true">
                    <!-- Populated by JS: NAILED IT!, SO CLOSE!, Oops!, etc. -->
                </div>

                <!-- Confetti Canvas (Story 9.4) -->
                <canvas id="confetti-canvas" class="confetti-canvas"></canvas>

                <!-- Personal Result -->
                <div id="personal-result" class="personal-result">
                    <div class="result-header" data-i18n="reveal.yourResult">Your Result</div>
                    <div id="result-content" class="result-content">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Player Results Cards (Story 9.10) -->
                <div id="reveal-results-cards" class="reveal-results-cards">
                    <!-- Populated by JavaScript: shows all player guesses -->
                </div>

                <!-- Reveal Leaderboard (Story 5.5) -->
                <div id="reveal-leaderboard" class="leaderboard is-prominent">
                    <div class="leaderboard-header">
                        <span class="leaderboard-title" data-i18n="leaderboard.standings">Standings</span>
                    </div>
                    <div id="reveal-leaderboard-list" class="leaderboard-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Round Analytics (Story 13.3) - moved above admin controls -->
                <div id="round-analytics" class="round-analytics hidden">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Admin Controls -->
                <div id="reveal-admin-controls" class="reveal-admin-controls hidden">
                    <div class="reveal-admin-buttons">
                        <button id="invite-players-btn" class="invite-btn" type="button"
                                aria-label="Invite players to join the game">
                            <span class="invite-btn-icon">üì≤</span>
                            <span class="invite-btn-label" data-i18n="lobby.invitePlayers">Invite Players</span>
                        </button>
                        <button id="next-round-btn" class="next-round-btn" data-i18n="admin.nextRound">
                            Next Round
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paused View (Story 7-1) -->
        <div id="paused-view" class="view hidden">
            <div class="paused-container">
                <div class="paused-icon">‚è∏Ô∏è</div>
                <h1 data-i18n="game.paused">Game Paused</h1>
                <p id="pause-message" data-i18n="game.waitingForHost">Waiting for host to reconnect...</p>
                <div class="paused-spinner">
                    <div class="spinner"></div>
                </div>
                <p class="paused-hint" data-i18n="game.pausedHint">The game will resume when the host returns</p>
            </div>
        </div>

        <!-- End View (Story 5.6) -->
        <div id="end-view" class="view hidden">
            <div class="end-container">
                <!-- Header -->
                <div class="end-header">
                    <h1 class="end-title" data-i18n="leaderboard.gameOver">Game Over!</h1>
                    <p class="end-subtitle" data-i18n="leaderboard.thanksForPlaying">Thanks for playing Beatify</p>
                </div>

                <!-- Podium for top 3 -->
                <div class="podium">
                    <div class="podium-place podium-2">
                        <div class="podium-medal">ü•à</div>
                        <div class="podium-name" id="podium-2-name">---</div>
                        <div class="podium-score" id="podium-2-score">0</div>
                        <div class="podium-stand">2</div>
                    </div>
                    <div class="podium-place podium-1">
                        <div class="podium-medal">ü•á</div>
                        <div class="podium-name" id="podium-1-name">---</div>
                        <div class="podium-score" id="podium-1-score">0</div>
                        <div class="podium-stand">1</div>
                    </div>
                    <div class="podium-place podium-3">
                        <div class="podium-medal">ü•â</div>
                        <div class="podium-name" id="podium-3-name">---</div>
                        <div class="podium-score" id="podium-3-score">0</div>
                        <div class="podium-stand">3</div>
                    </div>
                </div>

                <!-- Your result -->
                <div class="your-result">
                    <div class="your-result-header" data-i18n="reveal.yourResult">Your Result</div>
                    <div class="your-result-rank" id="your-final-rank">#?</div>
                    <div class="your-result-score" id="your-final-score">0 points</div>
                    <div class="your-result-stats">
                        <div class="stat">
                            <span class="stat-value" id="stat-best-streak">0</span>
                            <span class="stat-label" data-i18n="leaderboard.bestStreak">Best Streak</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="stat-rounds">0</span>
                            <span class="stat-label" data-i18n="leaderboard.roundsPlayed">Rounds Played</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="stat-bets">0</span>
                            <span class="stat-label" data-i18n="leaderboard.betsWon">Bets Won</span>
                        </div>
                    </div>
                </div>

                <!-- Superlatives / Fun Awards (Story 15.2) -->
                <div id="superlatives-container" class="superlatives-container hidden">
                    <!-- Rendered by JS: award cards with emoji, title, player name, value -->
                </div>

                <!-- Full leaderboard -->
                <div class="final-leaderboard">
                    <div class="final-leaderboard-header" data-i18n="leaderboard.fullRankings">Full Rankings</div>
                    <div id="final-leaderboard-list" class="final-leaderboard-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Admin controls -->
                <div id="end-admin-controls" class="end-admin-controls hidden">
                    <button id="new-game-btn" class="new-game-btn" data-i18n="admin.startNewGame">
                        Start New Game
                    </button>
                </div>

                <!-- Player message -->
                <div id="end-player-message" class="end-player-message hidden">
                    <p data-i18n="leaderboard.thanksEmoji">Thanks for playing! üéâ</p>
                    <p class="end-hint" data-i18n="leaderboard.waitForHost">Wait for the host to start a new game</p>
                </div>
            </div>
        </div>

        <!-- Admin Control Bar (Story 6.1) - visible across PLAYING/REVEAL for admin -->
        <div id="admin-control-bar" class="admin-control-bar hidden">
            <!-- Volume feedback indicator (Story 6.4) -->
            <div id="volume-indicator" class="volume-indicator hidden">üîä 50%</div>
            <button id="stop-song-btn" class="control-btn" type="button">
                <span class="control-icon">‚èπÔ∏è</span>
                <span class="control-label" data-i18n="admin.stop">Stop</span>
            </button>
            <button id="volume-down-btn" class="control-btn" type="button">
                <span class="control-icon">üîâ</span>
            </button>
            <button id="volume-up-btn" class="control-btn" type="button">
                <span class="control-icon">üîä</span>
            </button>
            <button id="next-round-admin-btn" class="control-btn" type="button">
                <span class="control-icon">‚è≠Ô∏è</span>
                <span class="control-label" data-i18n="admin.next">Next</span>
            </button>
            <button id="end-game-btn" class="control-btn control-btn--danger" type="button">
                <span class="control-icon">üõë</span>
                <span class="control-label" data-i18n="admin.end">End</span>
            </button>
        </div>
    </main>

    <!-- Reconnecting Overlay (Story 7-3) -->
    <div id="reconnecting-overlay" class="reconnecting-overlay hidden">
        <div class="reconnecting-content">
            <div class="reconnecting-spinner">
                <div class="spinner"></div>
            </div>
            <p id="reconnect-status" class="reconnect-status" data-i18n="errors.RECONNECTING">Reconnecting...</p>
        </div>
    </div>

    <!-- Connection Lost View (Story 7-4) -->
    <div id="connection-lost-view" class="view hidden">
        <div class="connection-lost-container">
            <div class="connection-lost-icon">üì°</div>
            <h1 data-i18n="errors.CONNECTION_LOST">Connection Lost</h1>
            <p data-i18n="errors.connectionLostHint">We couldn't reconnect to the game server.</p>
            <button id="retry-connection-btn" class="btn btn-primary btn-glow" data-i18n="common.retry">Try Again</button>
            <p class="connection-lost-hint" data-i18n="errors.checkNetwork">Make sure you're connected to the network</p>
        </div>
    </div>

    <!-- QR Modal (Lobby - full screen) -->
    <div id="qr-modal" class="qr-modal hidden" role="dialog" aria-modal="true"
         aria-labelledby="qr-modal-title">
        <div class="qr-modal-backdrop"></div>
        <div class="qr-modal-content">
            <h2 id="qr-modal-title" class="sr-only" data-i18n="lobby.joinGameQr">Join Game QR Code</h2>
            <div id="qr-modal-code" class="qr-modal-code">
                <!-- Large QR code rendered here -->
            </div>
            <p class="qr-modal-label" data-i18n="lobby.scanToJoin">Scan to join the game</p>
            <button id="qr-modal-close" class="btn btn-secondary qr-modal-close"
                    aria-label="Close QR code" data-i18n="common.close">Close</button>
        </div>
    </div>

    <!-- Invite Modal (Story 16.5 - QR code during active game for admin) -->
    <div id="invite-modal" class="invite-modal hidden" role="dialog" aria-modal="true"
         aria-labelledby="invite-modal-title">
        <div class="invite-modal-backdrop"></div>
        <div class="invite-modal-content">
            <h2 id="invite-modal-title" class="invite-modal-title" data-i18n="lobby.invitePlayers">Invite Players</h2>
            <p class="invite-modal-hint" data-i18n="lobby.invitePlayersHint">Share this QR code or link with friends</p>
            <div id="invite-modal-code" class="invite-modal-code">
                <!-- QR code rendered here -->
            </div>
            <div class="invite-modal-url-container">
                <input type="text" id="invite-modal-url" class="invite-modal-url" readonly
                       aria-label="Join URL">
                <button id="invite-copy-btn" class="invite-copy-btn" type="button"
                        aria-label="Copy join link">
                    <span class="invite-copy-icon">üìã</span>
                </button>
            </div>
            <p id="invite-copy-feedback" class="invite-copy-feedback hidden">Copied!</p>
            <button id="invite-modal-close" class="btn btn-secondary invite-modal-close"
                    aria-label="Close invite popup" data-i18n="common.close">Close</button>
        </div>
    </div>

    <!-- Steal Target Modal (Story 15.3 AC2, AC5) -->
    <div id="steal-modal" class="steal-modal hidden" role="dialog" aria-modal="true"
         aria-labelledby="steal-modal-title">
        <div class="steal-modal-backdrop"></div>
        <div class="steal-modal-content">
            <h2 id="steal-modal-title" class="steal-modal-title" data-i18n="steal.selectTarget">Select a target</h2>
            <p class="steal-modal-subtitle" data-i18n="steal.selectTargetHint">Copy their answer for this round</p>
            <div id="steal-target-list" class="steal-target-list">
                <!-- Populated by JavaScript -->
            </div>
            <button id="steal-modal-close" class="btn btn-secondary steal-modal-cancel"
                    aria-label="Cancel steal" data-i18n="common.cancel">Cancel</button>
        </div>
    </div>

    <!-- Steal Confirmation Toast (Story 15.3 AC3) -->
    <div id="steal-confirmation" class="steal-confirmation hidden">
        <span class="steal-confirmation-icon">ü•∑</span>
        <span id="steal-confirmation-text" class="steal-confirmation-text"></span>
    </div>

    <script src="/beatify/static/js/vendor/qrcode.min.js"></script>
    <script src="/beatify/static/js/i18n.js"></script>
    <script src="/beatify/static/js/player.js"></script>
</body>
</html>
